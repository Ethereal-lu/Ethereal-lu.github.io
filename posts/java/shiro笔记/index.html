<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Shrio学习笔记 | lu</title>
<meta name=keywords content><meta name=description content="

作者  小陈


微信 chenxu521600


B站 编程不良人  |  百知教育


资料 http://www.baizhiedu.xin



1.权限的管理
1.1 什么是权限管理
基本上涉及到用户参与的系统都要进行权限管理，权限管理属于系统安全的范畴，权限管理实现对用户访问系统的控制，按照安全规则或者安全策略控制用户可以访问而且只能访问自己被授权的资源。
权限管理包括用户身份认证和授权两部分，简称认证授权。对于需要访问控制的资源用户首先经过身份认证，认证通过后用户具有该资源的访问权限方可访问。
1.2 什么是身份认证
身份认证，就是判断一个用户是否为合法用户的处理过程。最常用的简单身份认证方式是系统通过核对用户输入的用户名和口令，看其是否与系统中存储的该用户的用户名和口令一致，来判断用户身份是否正确。对于采用指纹等系统，则出示指纹；对于硬件Key等刷卡系统，则需要刷卡。
1.3 什么是授权
授权，即访问控制，控制谁能访问哪些资源。主体进行身份认证后需要分配权限方可访问系统的资源，对于某些资源没有权限是无法访问的

2.什么是shiro

Apache Shiro™ is a powerful and easy-to-use Java security framework that performs authentication, authorization, cryptography, and session management. With Shiro’s easy-to-understand API, you can quickly and easily secure any application – from the smallest mobile applications to the largest web and enterprise applications.
Shiro 是一个功能强大且易于使用的Java安全框架，它执行身份验证、授权、加密和会话管理。使用Shiro易于理解的API，您可以快速轻松地保护任何应用程序—从最小的移动应用程序到最大的web和企业应用程序。

Shiro是apache旗下一个开源框架，它将软件系统的安全认证相关的功能抽取出来，实现用户身份认证，权限授权、加密、会话管理等功能，组成了一个通用的安全认证框架。

3.shiro的核心架构
"><meta name=author content="lu"><link rel=canonical href=https://ethereal-lu.github.io/posts/java/shiro%E7%AC%94%E8%AE%B0/><link crossorigin=anonymous href=/assets/css/stylesheet.d72444526d7ecbdb0015438a7fa89054a658bf759d0542e2e5df81ce94b493ee.css integrity="sha256-1yREUm1+y9sAFUOKf6iQVKZYv3WdBULi5d+BzpS0k+4=" rel="preload stylesheet" as=style><link rel=icon href=https://ethereal-lu.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ethereal-lu.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ethereal-lu.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://ethereal-lu.github.io/apple-touch-icon.png><link rel=mask-icon href=https://ethereal-lu.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://ethereal-lu.github.io/posts/java/shiro%E7%AC%94%E8%AE%B0/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://ethereal-lu.github.io/posts/java/shiro%E7%AC%94%E8%AE%B0/"><meta property="og:site_name" content="lu"><meta property="og:title" content="Shrio学习笔记"><meta property="og:description" content=" 作者 小陈
微信 chenxu521600
B站 编程不良人 | 百知教育
资料 http://www.baizhiedu.xin
1.权限的管理 1.1 什么是权限管理 基本上涉及到用户参与的系统都要进行权限管理，权限管理属于系统安全的范畴，权限管理实现对用户访问系统的控制，按照安全规则或者安全策略控制用户可以访问而且只能访问自己被授权的资源。
权限管理包括用户身份认证和授权两部分，简称认证授权。对于需要访问控制的资源用户首先经过身份认证，认证通过后用户具有该资源的访问权限方可访问。
1.2 什么是身份认证 身份认证，就是判断一个用户是否为合法用户的处理过程。最常用的简单身份认证方式是系统通过核对用户输入的用户名和口令，看其是否与系统中存储的该用户的用户名和口令一致，来判断用户身份是否正确。对于采用指纹等系统，则出示指纹；对于硬件Key等刷卡系统，则需要刷卡。
1.3 什么是授权 授权，即访问控制，控制谁能访问哪些资源。主体进行身份认证后需要分配权限方可访问系统的资源，对于某些资源没有权限是无法访问的
2.什么是shiro Apache Shiro™ is a powerful and easy-to-use Java security framework that performs authentication, authorization, cryptography, and session management. With Shiro’s easy-to-understand API, you can quickly and easily secure any application – from the smallest mobile applications to the largest web and enterprise applications.
Shiro 是一个功能强大且易于使用的Java安全框架，它执行身份验证、授权、加密和会话管理。使用Shiro易于理解的API，您可以快速轻松地保护任何应用程序—从最小的移动应用程序到最大的web和企业应用程序。
Shiro是apache旗下一个开源框架，它将软件系统的安全认证相关的功能抽取出来，实现用户身份认证，权限授权、加密、会话管理等功能，组成了一个通用的安全认证框架。
3.shiro的核心架构 "><meta property="og:locale" content="zh-CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-07-27T18:48:13+00:00"><meta property="article:modified_time" content="2021-07-27T18:48:13+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Shrio学习笔记"><meta name=twitter:description content="

作者  小陈


微信 chenxu521600


B站 编程不良人  |  百知教育


资料 http://www.baizhiedu.xin



1.权限的管理
1.1 什么是权限管理
基本上涉及到用户参与的系统都要进行权限管理，权限管理属于系统安全的范畴，权限管理实现对用户访问系统的控制，按照安全规则或者安全策略控制用户可以访问而且只能访问自己被授权的资源。
权限管理包括用户身份认证和授权两部分，简称认证授权。对于需要访问控制的资源用户首先经过身份认证，认证通过后用户具有该资源的访问权限方可访问。
1.2 什么是身份认证
身份认证，就是判断一个用户是否为合法用户的处理过程。最常用的简单身份认证方式是系统通过核对用户输入的用户名和口令，看其是否与系统中存储的该用户的用户名和口令一致，来判断用户身份是否正确。对于采用指纹等系统，则出示指纹；对于硬件Key等刷卡系统，则需要刷卡。
1.3 什么是授权
授权，即访问控制，控制谁能访问哪些资源。主体进行身份认证后需要分配权限方可访问系统的资源，对于某些资源没有权限是无法访问的

2.什么是shiro

Apache Shiro™ is a powerful and easy-to-use Java security framework that performs authentication, authorization, cryptography, and session management. With Shiro’s easy-to-understand API, you can quickly and easily secure any application – from the smallest mobile applications to the largest web and enterprise applications.
Shiro 是一个功能强大且易于使用的Java安全框架，它执行身份验证、授权、加密和会话管理。使用Shiro易于理解的API，您可以快速轻松地保护任何应用程序—从最小的移动应用程序到最大的web和企业应用程序。

Shiro是apache旗下一个开源框架，它将软件系统的安全认证相关的功能抽取出来，实现用户身份认证，权限授权、加密、会话管理等功能，组成了一个通用的安全认证框架。

3.shiro的核心架构
"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ethereal-lu.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Shrio学习笔记","item":"https://ethereal-lu.github.io/posts/java/shiro%E7%AC%94%E8%AE%B0/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Shrio学习笔记","name":"Shrio学习笔记","description":" 作者 小陈\n微信 chenxu521600\nB站 编程不良人 | 百知教育\n资料 http://www.baizhiedu.xin\n1.权限的管理 1.1 什么是权限管理 基本上涉及到用户参与的系统都要进行权限管理，权限管理属于系统安全的范畴，权限管理实现对用户访问系统的控制，按照安全规则或者安全策略控制用户可以访问而且只能访问自己被授权的资源。\n权限管理包括用户身份认证和授权两部分，简称认证授权。对于需要访问控制的资源用户首先经过身份认证，认证通过后用户具有该资源的访问权限方可访问。\n1.2 什么是身份认证 身份认证，就是判断一个用户是否为合法用户的处理过程。最常用的简单身份认证方式是系统通过核对用户输入的用户名和口令，看其是否与系统中存储的该用户的用户名和口令一致，来判断用户身份是否正确。对于采用指纹等系统，则出示指纹；对于硬件Key等刷卡系统，则需要刷卡。\n1.3 什么是授权 授权，即访问控制，控制谁能访问哪些资源。主体进行身份认证后需要分配权限方可访问系统的资源，对于某些资源没有权限是无法访问的\n2.什么是shiro Apache Shiro™ is a powerful and easy-to-use Java security framework that performs authentication, authorization, cryptography, and session management. With Shiro’s easy-to-understand API, you can quickly and easily secure any application – from the smallest mobile applications to the largest web and enterprise applications.\nShiro 是一个功能强大且易于使用的Java安全框架，它执行身份验证、授权、加密和会话管理。使用Shiro易于理解的API，您可以快速轻松地保护任何应用程序—从最小的移动应用程序到最大的web和企业应用程序。\nShiro是apache旗下一个开源框架，它将软件系统的安全认证相关的功能抽取出来，实现用户身份认证，权限授权、加密、会话管理等功能，组成了一个通用的安全认证框架。\n3.shiro的核心架构 ","keywords":[],"articleBody":" 作者 小陈\n微信 chenxu521600\nB站 编程不良人 | 百知教育\n资料 http://www.baizhiedu.xin\n1.权限的管理 1.1 什么是权限管理 基本上涉及到用户参与的系统都要进行权限管理，权限管理属于系统安全的范畴，权限管理实现对用户访问系统的控制，按照安全规则或者安全策略控制用户可以访问而且只能访问自己被授权的资源。\n权限管理包括用户身份认证和授权两部分，简称认证授权。对于需要访问控制的资源用户首先经过身份认证，认证通过后用户具有该资源的访问权限方可访问。\n1.2 什么是身份认证 身份认证，就是判断一个用户是否为合法用户的处理过程。最常用的简单身份认证方式是系统通过核对用户输入的用户名和口令，看其是否与系统中存储的该用户的用户名和口令一致，来判断用户身份是否正确。对于采用指纹等系统，则出示指纹；对于硬件Key等刷卡系统，则需要刷卡。\n1.3 什么是授权 授权，即访问控制，控制谁能访问哪些资源。主体进行身份认证后需要分配权限方可访问系统的资源，对于某些资源没有权限是无法访问的\n2.什么是shiro Apache Shiro™ is a powerful and easy-to-use Java security framework that performs authentication, authorization, cryptography, and session management. With Shiro’s easy-to-understand API, you can quickly and easily secure any application – from the smallest mobile applications to the largest web and enterprise applications.\nShiro 是一个功能强大且易于使用的Java安全框架，它执行身份验证、授权、加密和会话管理。使用Shiro易于理解的API，您可以快速轻松地保护任何应用程序—从最小的移动应用程序到最大的web和企业应用程序。\nShiro是apache旗下一个开源框架，它将软件系统的安全认证相关的功能抽取出来，实现用户身份认证，权限授权、加密、会话管理等功能，组成了一个通用的安全认证框架。\n3.shiro的核心架构 3.1 Subject Subject即主体，外部应用与subject进行交互，subject记录了当前操作用户，将用户的概念理解为当前操作的主体，可能是一个通过浏览器请求的用户，也可能是一个运行的程序。\tSubject在shiro中是一个接口，接口中定义了很多认证授相关的方法，外部程序通过subject进行认证授，而subject是通过SecurityManager安全管理器进行认证授权\n3.2 SecurityManager SecurityManager即安全管理器，对全部的subject进行安全管理，它是shiro的核心，负责对所有的subject进行安全管理。通过SecurityManager可以完成subject的认证、授权等，实质上SecurityManager是通过Authenticator进行认证，通过Authorizer进行授权，通过SessionManager进行会话管理等。\nSecurityManager是一个接口，继承了Authenticator, Authorizer, SessionManager这三个接口。\n3.3 Authenticator Authenticator即认证器，对用户身份进行认证，Authenticator是一个接口，shiro提供ModularRealmAuthenticator实现类，通过ModularRealmAuthenticator基本上可以满足大多数需求，也可以自定义认证器。\n3.4 Authorizer Authorizer即授权器，用户通过认证器认证通过，在访问功能时需要通过授权器判断用户是否有此功能的操作权限。\n3.5 Realm Realm即领域，相当于datasource数据源，securityManager进行安全认证需要通过Realm获取用户权限数据，比如：如果用户身份数据在数据库那么realm就需要从数据库获取用户身份信息。\n​\t注意：不要把realm理解成只是从数据源取数据，在realm中还有认证授权校验的相关的代码。 3.6 SessionManager sessionManager即会话管理，shiro框架定义了一套会话管理，它不依赖web容器的session，所以shiro可以使用在非web应用上，也可以将分布式应用的会话集中在一点管理，此特性可使它实现单点登录。\n3.7 SessionDAO SessionDAO即会话dao，是对session会话操作的一套接口，比如要将session存储到数据库，可以通过jdbc将会话存储到数据库。\n3.8 CacheManager CacheManager即缓存管理，将用户权限数据存储在缓存，这样可以提高性能。\n3.9 Cryptography ​\tCryptography即密码管理，shiro提供了一套加密/解密的组件，方便开发。比如提供常用的散列、加/解密等功能。\n4. shiro中的认证 4.1 认证 身份认证，就是判断一个用户是否为合法用户的处理过程。最常用的简单身份认证方式是系统通过核对用户输入的用户名和口令，看其是否与系统中存储的该用户的用户名和口令一致，来判断用户身份是否正确。\n4.2 shiro中认证的关键对象 Subject：主体 访问系统的用户，主体可以是用户、程序等，进行认证的都称为主体；\nPrincipal：身份信息 是主体（subject）进行身份认证的标识，标识必须具有唯一性，如用户名、手机号、邮箱地址等，一个主体可以有多个身份，但是必须有一个主身份（Primary Principal）。\ncredential：凭证信息 是只有主体自己知道的安全信息，如密码、证书等。\n4.3 认证流程 4.4 认证的开发 1. 创建项目并引入依赖 org.apache.shiro shiro-core 1.5.3 2. 引入shiro配置文件并加入如下配置 [users] xiaochen=123 zhangsan=456 3.开发认证代码 public class TestAuthenticator { public static void main(String[] args) { //创建securityManager DefaultSecurityManager defaultSecurityManager = new DefaultSecurityManager(); defaultSecurityManager.setRealm(new IniRealm(\"classpath:shiro.ini\")); //将安装工具类中设置默认安全管理器 SecurityUtils.setSecurityManager(defaultSecurityManager); //获取主体对象 Subject subject = SecurityUtils.getSubject(); //创建token令牌 UsernamePasswordToken token = new UsernamePasswordToken(\"xiaochen1\", \"123\"); try { subject.login(token);//用户登录 System.out.println(\"登录成功~~\"); } catch (UnknownAccountException e) { e.printStackTrace(); System.out.println(\"用户名错误!!\"); }catch (IncorrectCredentialsException e){ e.printStackTrace(); System.out.println(\"密码错误!!!\"); } } } DisabledAccountException（帐号被禁用）\nLockedAccountException（帐号被锁定）\nExcessiveAttemptsException（登录失败次数过多）\nExpiredCredentialsException（凭证过期）等\n4.5 自定义Realm 上边的程序使用的是Shiro自带的IniRealm，IniRealm从ini配置文件中读取用户的信息，大部分情况下需要从系统的数据库中读取用户信息，所以需要自定义realm。\n1.shiro提供的Realm 2.根据认证源码认证使用的是SimpleAccountRealm SimpleAccountRealm的部分源码中有两个方法一个是 认证 一个是 授权,\npublic class SimpleAccountRealm extends AuthorizingRealm { //.......省略 protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken token) throws AuthenticationException { UsernamePasswordToken upToken = (UsernamePasswordToken) token; SimpleAccount account = getUser(upToken.getUsername()); if (account != null) { if (account.isLocked()) { throw new LockedAccountException(\"Account [\" + account + \"] is locked.\"); } if (account.isCredentialsExpired()) { String msg = \"The credentials for account [\" + account + \"] are expired\"; throw new ExpiredCredentialsException(msg); } } return account; } protected AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principals) { String username = getUsername(principals); USERS_LOCK.readLock().lock(); try { return this.users.get(username); } finally { USERS_LOCK.readLock().unlock(); } } } 3.自定义realm /** * 自定义realm */ public class CustomerRealm extends AuthorizingRealm { //认证方法 @Override protected AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principals) { return null; } //授权方法 @Override protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken token) throws AuthenticationException { String principal = (String) token.getPrincipal(); if(\"xiaochen\".equals(principal)){ return new SimpleAuthenticationInfo(principal,\"123\",this.getName()); } return null; } } 4.使用自定义Realm认证 public class TestAuthenticatorCusttomerRealm { public static void main(String[] args) { //创建securityManager DefaultSecurityManager defaultSecurityManager = new DefaultSecurityManager(); //IniRealm realm = new IniRealm(\"classpath:shiro.ini\"); //设置为自定义realm获取认证数据 defaultSecurityManager.setRealm(new CustomerRealm()); //将安装工具类中设置默认安全管理器 SecurityUtils.setSecurityManager(defaultSecurityManager); //获取主体对象 Subject subject = SecurityUtils.getSubject(); //创建token令牌 UsernamePasswordToken token = new UsernamePasswordToken(\"xiaochen\", \"123\"); try { subject.login(token);//用户登录 System.out.println(\"登录成功~~\"); } catch (UnknownAccountException e) { e.printStackTrace(); System.out.println(\"用户名错误!!\"); }catch (IncorrectCredentialsException e){ e.printStackTrace(); System.out.println(\"密码错误!!!\"); } } } 4.6 使用MD5和Salt 实际应用是将盐和散列后的值存在数据库中，自动realm从数据库取出盐和加密后的值由shiro完成密码校验。\n1.自定义md5+salt的realm /** * 自定义md5+salt realm */ public class CustomerRealm extends AuthorizingRealm { //认证方法 @Override protected AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principals) { return null; } //授权方法 @Override protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken token) throws AuthenticationException { String principal = (String) token.getPrincipal(); if(\"xiaochen\".equals(principal)){ String password = \"3c88b338102c1a343bcb88cd3878758e\"; String salt = \"Q4F%\"; return new SimpleAuthenticationInfo(principal,password, ByteSource.Util.bytes(salt),this.getName()); } return null; } 2.使用md5 + salt 认证 public class TestAuthenticatorCusttomerRealm { public static void main(String[] args) { //创建securityManager DefaultSecurityManager defaultSecurityManager = new DefaultSecurityManager(); //IniRealm realm = new IniRealm(\"classpath:shiro.ini\"); //设置为自定义realm获取认证数据 CustomerRealm customerRealm = new CustomerRealm(); //设置md5加密 HashedCredentialsMatcher credentialsMatcher = new HashedCredentialsMatcher(); credentialsMatcher.setHashAlgorithmName(\"MD5\"); credentialsMatcher.setHashIterations(1024);//设置散列次数 customerRealm.setCredentialsMatcher(credentialsMatcher); defaultSecurityManager.setRealm(customerRealm); //将安装工具类中设置默认安全管理器 SecurityUtils.setSecurityManager(defaultSecurityManager); //获取主体对象 Subject subject = SecurityUtils.getSubject(); //创建token令牌 UsernamePasswordToken token = new UsernamePasswordToken(\"xiaochen\", \"123\"); try { subject.login(token);//用户登录 System.out.println(\"登录成功~~\"); } catch (UnknownAccountException e) { e.printStackTrace(); System.out.println(\"用户名错误!!\"); }catch (IncorrectCredentialsException e){ e.printStackTrace(); System.out.println(\"密码错误!!!\"); } } } 5. shiro中的授权 5.1 授权 授权，即访问控制，控制谁能访问哪些资源。主体进行身份认证后需要分配权限方可访问系统的资源，对于某些资源没有权限是无法访问的。\n5.2 关键对象 授权可简单理解为who对what(which)进行How操作：\nWho，即主体（Subject），主体需要访问系统中的资源。\nWhat，即资源（Resource)，如系统菜单、页面、按钮、类方法、系统商品信息等。资源包括资源类型和资源实例，比如商品信息为资源类型，类型为t01的商品为资源实例，编号为001的商品信息也属于资源实例。\nHow，权限/许可（Permission)，规定了主体对资源的操作许可，权限离开资源没有意义，如用户查询权限、用户添加权限、某个类方法的调用权限、编号为001用户的修改权限等，通过权限可知主体对哪些资源都有哪些操作许可。\n5.3 授权流程 5.4 授权方式 基于角色的访问控制\nRBAC基于角色的访问控制（Role-Based Access Control）是以角色为中心进行访问控制\nif(subject.hasRole(\"admin\")){ //操作什么资源 } 基于资源的访问控制\nRBAC基于资源的访问控制（Resource-Based Access Control）是以资源为中心进行访问控制\nif(subject.isPermission(\"user:update:01\")){ //资源实例 //对01用户进行修改 } if(subject.isPermission(\"user:update:*\")){ //资源类型 //对01用户进行修改 } 5.5 权限字符串 ​\t权限字符串的规则是：资源标识符：操作：资源实例标识符，意思是对哪个资源的哪个实例具有什么操作，“:”是资源/操作/实例的分割符，权限字符串也可以使用*通配符。\n例子：\n用户创建权限：user:create，或user:create:* 用户修改实例001的权限：user:update:001 用户实例001的所有权限：user:*：001 5.6 shiro中授权编程实现方式 编程式\nSubject subject = SecurityUtils.getSubject(); if(subject.hasRole(“admin”)) { //有权限 } else { //无权限 } 注解式\n@RequiresRoles(\"admin\") public void hello() { //有权限 } 标签式\nJSP/GSP 标签：在JSP/GSP 页面通过相应的标签完成：\r\u003c!— 有权限—\u003e\r注意: Thymeleaf 中使用shiro需要额外集成! 5.7 开发授权 1.realm的实现 public class CustomerRealm extends AuthorizingRealm { //授权方法 @Override protected AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principals) { String primaryPrincipal = (String) principals.getPrimaryPrincipal(); System.out.println(\"primaryPrincipal = \" + primaryPrincipal); SimpleAuthorizationInfo simpleAuthorizationInfo = new SimpleAuthorizationInfo(); simpleAuthorizationInfo.addRole(\"admin\"); simpleAuthorizationInfo.addStringPermission(\"user:update:*\"); simpleAuthorizationInfo.addStringPermission(\"product:*:*\"); return simpleAuthorizationInfo; } //认证方法 @Override protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken token) throws AuthenticationException { String principal = (String) token.getPrincipal(); if(\"xiaochen\".equals(principal)){ String password = \"3c88b338102c1a343bcb88cd3878758e\"; String salt = \"Q4F%\"; return new SimpleAuthenticationInfo(principal,password, ByteSource.Util.bytes(salt),this.getName()); } return null; } } 2.授权 public class TestAuthenticatorCusttomerRealm { public static void main(String[] args) { //创建securityManager DefaultSecurityManager defaultSecurityManager = new DefaultSecurityManager(); //IniRealm realm = new IniRealm(\"classpath:shiro.ini\"); //设置为自定义realm获取认证数据 CustomerRealm customerRealm = new CustomerRealm(); //设置md5加密 HashedCredentialsMatcher credentialsMatcher = new HashedCredentialsMatcher(); credentialsMatcher.setHashAlgorithmName(\"MD5\"); credentialsMatcher.setHashIterations(1024);//设置散列次数 customerRealm.setCredentialsMatcher(credentialsMatcher); defaultSecurityManager.setRealm(customerRealm); //将安装工具类中设置默认安全管理器 SecurityUtils.setSecurityManager(defaultSecurityManager); //获取主体对象 Subject subject = SecurityUtils.getSubject(); //创建token令牌 UsernamePasswordToken token = new UsernamePasswordToken(\"xiaochen\", \"123\"); try { subject.login(token);//用户登录 System.out.println(\"登录成功~~\"); } catch (UnknownAccountException e) { e.printStackTrace(); System.out.println(\"用户名错误!!\"); }catch (IncorrectCredentialsException e){ e.printStackTrace(); System.out.println(\"密码错误!!!\"); } //认证通过 if(subject.isAuthenticated()){ //基于角色权限管理 boolean admin = subject.hasRole(\"admin\"); System.out.println(admin); boolean permitted = subject.isPermitted(\"product:create:001\"); System.out.println(permitted); } } } 6.整合SpringBoot项目实战 6.0 整合思路 6.1 创建springboot项目 6.2 引入shiro依赖 org.apache.shiro shiro-spring-boot-starter 1.5.3 6.3 配置shiro环境 0.创建配置类 1.配置shiroFilterFactoryBean @Bean public ShiroFilterFactoryBean getShiroFilterFactoryBean(SecurityManager securityManager){ //创建shiro的filter ShiroFilterFactoryBean shiroFilterFactoryBean = new ShiroFilterFactoryBean(); //注入安全管理器 shiroFilterFactoryBean.setSecurityManager(securityManager); return shiroFilterFactoryBean; } 2.配置WebSecurityManager @Bean public DefaultWebSecurityManager getSecurityManager(Realm realm){ DefaultWebSecurityManager defaultWebSecurityManager = new DefaultWebSecurityManager(); defaultWebSecurityManager.setRealm(realm); return defaultWebSecurityManager; } 3.创建自定义realm public class CustomerRealm extends AuthorizingRealm { //处理授权 @Override protected AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principals) { return null; } //处理认证 @Override protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken token) throws AuthenticationException { return null; } } 4.配置自定义realm //创建自定义realm @Bean public Realm getRealm(){ return new CustomerRealm(); } 5.编写控制器跳转至index.html @Controller public class IndexController { @RequestMapping(\"index\") public String index(){ System.out.println(\"跳转至主页\"); return \"index\"; } } 6.启动springboot应用访问index 注意: 默认在配置好shiro环境后默认环境中没有对项目中任何资源进行权限控制,所有现在项目中所有资源都可以通过路径访问 7.加入权限控制 修改ShiroFilterFactoryBean配置\n//注入安全管理器 shiroFilterFactoryBean.setSecurityManager(securityManager); Map\u003cString,String\u003e map = new LinkedHashMap\u003c\u003e(); map.put(\"/**\",\"authc\"); //配置认证和授权规则 shiroFilterFactoryBean.setFilterChainDefinitionMap(map); /** 代表拦截项目中一切资源 authc 代表shiro中的一个filter的别名,详细内容看文档的shirofilter列表 8.重启项目访问查看 6.4 常见过滤器 注意: shiro提供多个默认的过滤器，我们可以用这些过滤器来配置控制指定url的权限： 配置缩写 对应的过滤器 功能 anon AnonymousFilter 指定url可以匿名访问 authc FormAuthenticationFilter 指定url需要form表单登录，默认会从请求中获取username、password,rememberMe等参数并尝试登录，如果登录不了就会跳转到loginUrl配置的路径。我们也可以用这个过滤器做默认的登录逻辑，但是一般都是我们自己在控制器写登录逻辑的，自己写的话出错返回的信息都可以定制嘛。 authcBasic BasicHttpAuthenticationFilter 指定url需要basic登录 logout LogoutFilter 登出过滤器，配置指定url就可以实现退出功能，非常方便 noSessionCreation NoSessionCreationFilter 禁止创建会话 perms PermissionsAuthorizationFilter 需要指定权限才能访问 port PortFilter 需要指定端口才能访问 rest HttpMethodPermissionFilter 将http请求方法转化成相应的动词来构造一个权限字符串，这个感觉意义不大，有兴趣自己看源码的注释 roles RolesAuthorizationFilter 需要指定角色才能访问 ssl SslFilter 需要https请求才能访问 user UserFilter 需要已登录或“记住我”的用户才能访问 6.5 认证实现 1. 在login.jsp中开发认证界面 \u003cform action=\"${pageContext.request.contextPath}/user/login\" method=\"post\"\u003e 用户名:\u003cinput type=\"text\" name=\"username\" \u003e \u003cbr/\u003e 密码 : \u003cinput type=\"text\" name=\"password\"\u003e \u003cbr\u003e \u003cinput type=\"submit\" value=\"登录\"\u003e \u003c/form\u003e 2. 开发controller @Controller @RequestMapping(\"user\") public class UserController { /** * 用来处理身份认证 * @param username * @param password * @return */ @RequestMapping(\"login\") public String login(String username,String password){ //获取主体对象 Subject subject = SecurityUtils.getSubject(); try { subject.login(new UsernamePasswordToken(username,password)); return \"redirect:/index.jsp\"; } catch (UnknownAccountException e) { e.printStackTrace(); System.out.println(\"用户名错误!\"); }catch (IncorrectCredentialsException e){ e.printStackTrace(); System.out.println(\"密码错误!\"); } return \"redirect:/login.jsp\"; } } 在认证过程中使用subject.login进行认证 3.开发realm中返回静态数据(未连接数据库) @Override protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken token) throws AuthenticationException { System.out.println(\"==========================\"); String principal = (String) token.getPrincipal(); if(\"xiaochen\".equals(principal)){ return new SimpleAuthenticationInfo(principal,\"123\",this.getName()); } return null; } } 4.启动项目以realm中定义静态数据进行认证 认证功能没有md5和随机盐的认证就实现啦 6.6 退出认证 1.开发页面退出连接 2.开发controller @Controller @RequestMapping(\"user\") public class UserController { /** * 退出登录 * */ @RequestMapping(\"logout\") public String logout(){ Subject subject = SecurityUtils.getSubject(); subject.logout();//退出用户 return \"redirect:/login.jsp\"; } } 3.修改退出连接访问退出路径 4.退出之后访问受限资源立即返回认证界面 6.7 MD5、Salt的认证实现 1.开发数据库注册 0.开发注册界面 \u003ch1\u003e用户注册\u003c/h1\u003e \u003cform action=\"${pageContext.request.contextPath}/user/register\" method=\"post\"\u003e 用户名:\u003cinput type=\"text\" name=\"username\" \u003e \u003cbr/\u003e 密码 : \u003cinput type=\"text\" name=\"password\"\u003e \u003cbr\u003e \u003cinput type=\"submit\" value=\"立即注册\"\u003e \u003c/form\u003e 1.创建数据表结构 SET NAMES utf8mb4; SET FOREIGN_KEY_CHECKS = 0; -- ---------------------------- -- Table structure for t_user -- ---------------------------- DROP TABLE IF EXISTS `t_user`; CREATE TABLE `t_user` ( `id` int(6) NOT NULL AUTO_INCREMENT, `username` varchar(40) DEFAULT NULL, `password` varchar(40) DEFAULT NULL, `salt` varchar(255) DEFAULT NULL, PRIMARY KEY (`id`) ) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8; SET FOREIGN_KEY_CHECKS = 1; 2.项目引入依赖 org.mybatis.spring.boot mybatis-spring-boot-starter 2.1.2 mysql mysql-connector-java 5.1.38 com.alibaba druid 1.1.19 3.配置application.properties配置文件 server.port=8888 server.servlet.context-path=/shiro spring.application.name=shiro spring.mvc.view.prefix=/ spring.mvc.view.suffix=.jsp #新增配置 spring.datasource.type=com.alibaba.druid.pool.DruidDataSource spring.datasource.driver-class-name=com.mysql.jdbc.Driver spring.datasource.url=jdbc:mysql://localhost:3306/shiro?characterEncoding=UTF-8 spring.datasource.username=root spring.datasource.password=root mybatis.type-aliases-package=com.baizhi.springboot_jsp_shiro.entity mybatis.mapper-locations=classpath:com/baizhi/mapper/*.xml 4.创建entity @Data @Accessors(chain = true) @AllArgsConstructor @NoArgsConstructor public class User { private String id; private String username; private String password; private String salt; } 5.创建DAO接口 @Mapper public interface UserDAO { void save(User user); } 6.开发mapper配置文件 ","wordCount":"2810","inLanguage":"en","datePublished":"2021-07-27T18:48:13Z","dateModified":"2021-07-27T18:48:13Z","author":{"@type":"Person","name":"lu"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ethereal-lu.github.io/posts/java/shiro%E7%AC%94%E8%AE%B0/"},"publisher":{"@type":"Organization","name":"lu","logo":{"@type":"ImageObject","url":"https://ethereal-lu.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://ethereal-lu.github.io/ accesskey=h title="lu (Alt + H)">lu</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://ethereal-lu.github.io/categories/ title=categories><span>categories</span></a></li><li><a href=https://ethereal-lu.github.io/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://ethereal-lu.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://ethereal-lu.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Shrio学习笔记</h1><div class=post-meta><span title='2021-07-27 18:48:13 +0000 UTC'>2021-07-27</span>&nbsp;·&nbsp;2810 words&nbsp;·&nbsp;lu</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#1权限的管理>1.权限的管理</a><ul><li><a href=#11-什么是权限管理>1.1 什么是权限管理</a></li><li><a href=#12-什么是身份认证>1.2 什么是身份认证</a></li><li><a href=#13-什么是授权>1.3 什么是授权</a></li></ul></li><li><a href=#2什么是shiro>2.什么是shiro</a></li><li><a href=#3shiro的核心架构>3.shiro的核心架构</a><ul><li><a href=#31-subject>3.1 Subject</a></li><li><a href=#32-securitymanager>3.2 SecurityManager</a></li><li><a href=#33-authenticator>3.3 Authenticator</a></li><li><a href=#34-authorizer>3.4 Authorizer</a></li><li><a href=#35-realm>3.5 Realm</a></li><li><a href=#36-sessionmanager>3.6 SessionManager</a></li><li><a href=#37-sessiondao>3.7 SessionDAO</a></li><li><a href=#38-cachemanager>3.8 CacheManager</a></li><li><a href=#39-cryptography>3.9 Cryptography</a></li></ul></li><li><a href=#4-shiro中的认证>4. shiro中的认证</a><ul><li><a href=#41-认证>4.1 认证</a></li><li><a href=#42-shiro中认证的关键对象>4.2 shiro中认证的关键对象</a></li><li><a href=#43-认证流程>4.3 认证流程</a></li><li><a href=#44-认证的开发>4.4 认证的开发</a></li><li><a href=#45-自定义realm>4.5 自定义Realm</a></li><li><a href=#46-使用md5和salt>4.6 使用MD5和Salt</a></li></ul></li><li><a href=#5-shiro中的授权>5. shiro中的授权</a><ul><li><a href=#51-授权>5.1 授权</a></li><li><a href=#52-关键对象>5.2 关键对象</a></li><li><a href=#53-授权流程>5.3 授权流程</a></li><li><a href=#54-授权方式>5.4 授权方式</a></li><li><a href=#55-权限字符串>5.5 权限字符串</a></li><li><a href=#56-shiro中授权编程实现方式>5.6 shiro中授权编程实现方式</a></li><li><a href=#57-开发授权>5.7 开发授权</a></li></ul></li><li><a href=#6整合springboot项目实战>6.整合SpringBoot项目实战</a><ul><li><a href=#60-整合思路>6.0 整合思路</a></li><li><a href=#61-创建springboot项目>6.1 创建springboot项目</a></li><li><a href=#62-引入shiro依赖>6.2 引入shiro依赖</a></li><li><a href=#63-配置shiro环境>6.3 配置shiro环境</a></li><li><a href=#64-常见过滤器>6.4 常见过滤器</a></li><li><a href=#65-认证实现>6.5 认证实现</a></li><li><a href=#66-退出认证>6.6 退出认证</a></li><li><a href=#67-md5salt的认证实现>6.7 MD5、Salt的认证实现</a></li><li><a href=#68-授权实现>6.8 授权实现</a></li><li><a href=#69-使用cachemanager>6.9 使用CacheManager</a></li></ul></li><li><a href=#7shiro整合springboot之thymeleaf权限控制>7.Shiro整合springboot之thymeleaf权限控制</a><ul><li><a href=#1引入扩展依赖>1.引入扩展依赖</a></li><li><a href=#2页面中引入命名空间>2.页面中引入命名空间</a></li><li><a href=#3常见权限控制标签使用>3.常见权限控制标签使用</a></li><li><a href=#4加入shiro的方言配置>4.加入shiro的方言配置</a></li></ul></li></ul></nav></div></details></div><div class=post-content><ul><li><p>作者 小陈</p></li><li><p>微信 chenxu521600</p></li><li><p>B站 编程不良人 | 百知教育</p></li><li><p>资料 <a href=http://www.baizhiedu.xin>http://www.baizhiedu.xin</a></p><p><img alt=image-20200520220106539 loading=lazy src=/posts/java/shiro%E7%AC%94%E8%AE%B0/image-20200520220106539.png></p></li></ul><h2 id=1权限的管理>1.权限的管理<a hidden class=anchor aria-hidden=true href=#1权限的管理>#</a></h2><h3 id=11-什么是权限管理>1.1 什么是权限管理<a hidden class=anchor aria-hidden=true href=#11-什么是权限管理>#</a></h3><p>基本上涉及到用户参与的系统都要进行权限管理，权限管理属于系统安全的范畴，权限管理实现<code>对用户访问系统的控制</code>，按照安全规则或者<a href=http://baike.baidu.com/view/160028.htm>安全策略</a>控制用户可以访问而且只能访问自己被授权的资源。</p><p>权限管理包括用户<code>身份认证</code>和<code>授权</code>两部分，简称<code>认证授权</code>。对于需要访问控制的资源用户首先经过身份认证，认证通过后用户具有该资源的访问权限方可访问。</p><h3 id=12-什么是身份认证>1.2 什么是身份认证<a hidden class=anchor aria-hidden=true href=#12-什么是身份认证>#</a></h3><p><code>身份认证</code>，就是判断一个用户是否为合法用户的处理过程。最常用的简单身份认证方式是系统通过核对用户输入的用户名和口令，看其是否与系统中存储的该用户的用户名和口令一致，来判断用户身份是否正确。对于采用<a href=http://baike.baidu.com/view/5628.htm>指纹</a>等系统，则出示指纹；对于硬件Key等刷卡系统，则需要刷卡。</p><h3 id=13-什么是授权>1.3 什么是授权<a hidden class=anchor aria-hidden=true href=#13-什么是授权>#</a></h3><p><code>授权，即访问控制</code>，控制谁能访问哪些资源。主体进行身份认证后需要分配权限方可访问系统的资源，对于某些资源没有权限是无法访问的</p><hr><h2 id=2什么是shiro>2.什么是shiro<a hidden class=anchor aria-hidden=true href=#2什么是shiro>#</a></h2><blockquote><p><strong>Apache Shiro™</strong> is a powerful and easy-to-use Java security framework that performs authentication, authorization, cryptography, and session management. With Shiro’s easy-to-understand API, you can quickly and easily secure any application – from the smallest mobile applications to the largest web and enterprise applications.</p><p>Shiro 是一个功能强大且易于使用的Java安全框架，它执行身份验证、授权、加密和会话管理。使用Shiro易于理解的API，您可以快速轻松地保护任何应用程序—从最小的移动应用程序到最大的web和企业应用程序。</p></blockquote><p><code>Shiro是apache旗下一个开源框架，它将软件系统的安全认证相关的功能抽取出来，实现用户身份认证，权限授权、加密、会话管理等功能，组成了一个通用的安全认证框架。</code></p><hr><h2 id=3shiro的核心架构>3.shiro的核心架构<a hidden class=anchor aria-hidden=true href=#3shiro的核心架构>#</a></h2><p><img alt=image-20200520220413190 loading=lazy src=/posts/java/shiro%E7%AC%94%E8%AE%B0/image-20200520220413190.png></p><h3 id=31-subject>3.1 Subject<a hidden class=anchor aria-hidden=true href=#31-subject>#</a></h3><p><code>Subject即主体</code>，外部应用与subject进行交互，subject记录了当前操作用户，将用户的概念理解为当前操作的主体，可能是一个通过浏览器请求的用户，也可能是一个运行的程序。 Subject在shiro中是一个接口，接口中定义了很多认证授相关的方法，外部程序通过subject进行认证授，而subject是通过SecurityManager安全管理器进行认证授权</p><h3 id=32-securitymanager>3.2 SecurityManager<a hidden class=anchor aria-hidden=true href=#32-securitymanager>#</a></h3><p><code>SecurityManager即安全管理器</code>，对全部的subject进行安全管理，它是shiro的核心，负责对所有的subject进行安全管理。通过SecurityManager可以完成subject的认证、授权等，实质上SecurityManager是通过Authenticator进行认证，通过Authorizer进行授权，通过SessionManager进行会话管理等。</p><p><code>SecurityManager是一个接口，继承了Authenticator, Authorizer, SessionManager这三个接口。</code></p><h3 id=33-authenticator>3.3 Authenticator<a hidden class=anchor aria-hidden=true href=#33-authenticator>#</a></h3><p><code>Authenticator即认证器</code>，对用户身份进行认证，Authenticator是一个接口，shiro提供ModularRealmAuthenticator实现类，通过ModularRealmAuthenticator基本上可以满足大多数需求，也可以自定义认证器。</p><h3 id=34-authorizer>3.4 Authorizer<a hidden class=anchor aria-hidden=true href=#34-authorizer>#</a></h3><p><code>Authorizer即授权器</code>，用户通过认证器认证通过，在访问功能时需要通过授权器判断用户是否有此功能的操作权限。</p><h3 id=35-realm>3.5 Realm<a hidden class=anchor aria-hidden=true href=#35-realm>#</a></h3><p><code>Realm即领域</code>，相当于datasource数据源，securityManager进行安全认证需要通过Realm获取用户权限数据，比如：如果用户身份数据在数据库那么realm就需要从数据库获取用户身份信息。</p><ul><li>​ 注意：不要把realm理解成只是从数据源取数据，在realm中还有认证授权校验的相关的代码。</li></ul><h3 id=36-sessionmanager>3.6 SessionManager<a hidden class=anchor aria-hidden=true href=#36-sessionmanager>#</a></h3><p><code>sessionManager即会话管理</code>，shiro框架定义了一套会话管理，它不依赖web容器的session，所以shiro可以使用在非web应用上，也可以将分布式应用的会话集中在一点管理，此特性可使它实现单点登录。</p><h3 id=37-sessiondao>3.7 SessionDAO<a hidden class=anchor aria-hidden=true href=#37-sessiondao>#</a></h3><p><code>SessionDAO即会话dao</code>，是对session会话操作的一套接口，比如要将session存储到数据库，可以通过jdbc将会话存储到数据库。</p><h3 id=38-cachemanager>3.8 CacheManager<a hidden class=anchor aria-hidden=true href=#38-cachemanager>#</a></h3><p><code>CacheManager即缓存管理</code>，将用户权限数据存储在缓存，这样可以提高性能。</p><h3 id=39-cryptography>3.9 Cryptography<a hidden class=anchor aria-hidden=true href=#39-cryptography>#</a></h3><p>​ <code>Cryptography即密码管理</code>，shiro提供了一套加密/解密的组件，方便开发。比如提供常用的散列、加/解密等功能。</p><hr><h2 id=4-shiro中的认证>4. shiro中的认证<a hidden class=anchor aria-hidden=true href=#4-shiro中的认证>#</a></h2><h3 id=41-认证>4.1 认证<a hidden class=anchor aria-hidden=true href=#41-认证>#</a></h3><p>身份认证，就是判断一个用户是否为合法用户的处理过程。最常用的简单身份认证方式是系统通过核对用户输入的用户名和口令，看其是否与系统中存储的该用户的用户名和口令一致，来判断用户身份是否正确。</p><h3 id=42-shiro中认证的关键对象>4.2 shiro中认证的关键对象<a hidden class=anchor aria-hidden=true href=#42-shiro中认证的关键对象>#</a></h3><ul><li><strong>Subject：主体</strong></li></ul><p>访问系统的用户，主体可以是用户、程序等，进行认证的都称为主体；</p><ul><li><strong>Principal：身份信息</strong></li></ul><p>是主体（subject）进行身份认证的标识，标识必须具有<code>唯一性</code>，如用户名、手机号、邮箱地址等，一个主体可以有多个身份，但是必须有一个主身份（Primary Principal）。</p><ul><li><strong>credential：凭证信息</strong></li></ul><p>是只有主体自己知道的安全信息，如密码、证书等。</p><h3 id=43-认证流程>4.3 认证流程<a hidden class=anchor aria-hidden=true href=#43-认证流程>#</a></h3><p><img alt=image-20200521204452288 loading=lazy src=/posts/java/shiro%E7%AC%94%E8%AE%B0/image-20200521204452288.png></p><h3 id=44-认证的开发>4.4 认证的开发<a hidden class=anchor aria-hidden=true href=#44-认证的开发>#</a></h3><h5 id=1-创建项目并引入依赖>1. 创建项目并引入依赖<a hidden class=anchor aria-hidden=true href=#1-创建项目并引入依赖>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;groupId&gt;</span>org.apache.shiro<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;artifactId&gt;</span>shiro-core<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;version&gt;</span>1.5.3<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></div><h5 id=2-引入shiro配置文件并加入如下配置>2. 引入shiro配置文件并加入如下配置<a hidden class=anchor aria-hidden=true href=#2-引入shiro配置文件并加入如下配置>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#66d9ef>[users]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>xiaochen</span><span style=color:#f92672>=</span><span style=color:#e6db74>123</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>zhangsan</span><span style=color:#f92672>=</span><span style=color:#e6db74>456</span>
</span></span></code></pre></div><p><img alt=image-20200521205219719 loading=lazy src=/posts/java/shiro%E7%AC%94%E8%AE%B0/image-20200521205219719.png></p><h5 id=3开发认证代码>3.开发认证代码<a hidden class=anchor aria-hidden=true href=#3开发认证代码>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TestAuthenticator</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>//创建securityManager</span>
</span></span><span style=display:flex><span>        DefaultSecurityManager defaultSecurityManager <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> DefaultSecurityManager();
</span></span><span style=display:flex><span>        defaultSecurityManager.<span style=color:#a6e22e>setRealm</span>(<span style=color:#66d9ef>new</span> IniRealm(<span style=color:#e6db74>&#34;classpath:shiro.ini&#34;</span>));
</span></span><span style=display:flex><span>        <span style=color:#75715e>//将安装工具类中设置默认安全管理器</span>
</span></span><span style=display:flex><span>        SecurityUtils.<span style=color:#a6e22e>setSecurityManager</span>(defaultSecurityManager);
</span></span><span style=display:flex><span>        <span style=color:#75715e>//获取主体对象</span>
</span></span><span style=display:flex><span>        Subject subject <span style=color:#f92672>=</span> SecurityUtils.<span style=color:#a6e22e>getSubject</span>();
</span></span><span style=display:flex><span>        <span style=color:#75715e>//创建token令牌</span>
</span></span><span style=display:flex><span>        UsernamePasswordToken token <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> UsernamePasswordToken(<span style=color:#e6db74>&#34;xiaochen1&#34;</span>, <span style=color:#e6db74>&#34;123&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            subject.<span style=color:#a6e22e>login</span>(token);<span style=color:#75715e>//用户登录</span>
</span></span><span style=display:flex><span>            System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;登录成功~~&#34;</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (UnknownAccountException e) {
</span></span><span style=display:flex><span>            e.<span style=color:#a6e22e>printStackTrace</span>();
</span></span><span style=display:flex><span>            System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;用户名错误!!&#34;</span>);
</span></span><span style=display:flex><span>        }<span style=color:#66d9ef>catch</span> (IncorrectCredentialsException e){
</span></span><span style=display:flex><span>            e.<span style=color:#a6e22e>printStackTrace</span>();
</span></span><span style=display:flex><span>            System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;密码错误!!!&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><p>DisabledAccountException（帐号被禁用）</p></li><li><p>LockedAccountException（帐号被锁定）</p></li><li><p>ExcessiveAttemptsException（登录失败次数过多）</p></li><li><p>ExpiredCredentialsException（凭证过期）等</p></li></ul><hr><h3 id=45-自定义realm>4.5 自定义Realm<a hidden class=anchor aria-hidden=true href=#45-自定义realm>#</a></h3><p>上边的程序使用的是Shiro自带的IniRealm，IniRealm从ini配置文件中读取用户的信息，大部分情况下需要从系统的数据库中读取用户信息，所以需要自定义realm。</p><h5 id=1shiro提供的realm>1.shiro提供的Realm<a hidden class=anchor aria-hidden=true href=#1shiro提供的realm>#</a></h5><p><img alt=image-20200521212728541 loading=lazy src=/posts/java/shiro%E7%AC%94%E8%AE%B0/image-20200521212728541.png></p><h5 id=2根据认证源码认证使用的是simpleaccountrealm>2.根据认证源码认证使用的是SimpleAccountRealm<a hidden class=anchor aria-hidden=true href=#2根据认证源码认证使用的是simpleaccountrealm>#</a></h5><p><img alt=image-20200521213451998 loading=lazy src=/posts/java/shiro%E7%AC%94%E8%AE%B0/image-20200521213451998.png></p><p><code>SimpleAccountRealm的部分源码中有两个方法一个是 认证 一个是 授权</code>,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SimpleAccountRealm</span> <span style=color:#66d9ef>extends</span> AuthorizingRealm {
</span></span><span style=display:flex><span>		<span style=color:#75715e>//.......省略</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> AuthenticationInfo <span style=color:#a6e22e>doGetAuthenticationInfo</span>(AuthenticationToken token) <span style=color:#66d9ef>throws</span> AuthenticationException {
</span></span><span style=display:flex><span>        UsernamePasswordToken upToken <span style=color:#f92672>=</span> (UsernamePasswordToken) token;
</span></span><span style=display:flex><span>        SimpleAccount account <span style=color:#f92672>=</span> getUser(upToken.<span style=color:#a6e22e>getUsername</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (account <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (account.<span style=color:#a6e22e>isLocked</span>()) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> LockedAccountException(<span style=color:#e6db74>&#34;Account [&#34;</span> <span style=color:#f92672>+</span> account <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;] is locked.&#34;</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (account.<span style=color:#a6e22e>isCredentialsExpired</span>()) {
</span></span><span style=display:flex><span>                String msg <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;The credentials for account [&#34;</span> <span style=color:#f92672>+</span> account <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;] are expired&#34;</span>;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ExpiredCredentialsException(msg);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> account;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> AuthorizationInfo <span style=color:#a6e22e>doGetAuthorizationInfo</span>(PrincipalCollection principals) {
</span></span><span style=display:flex><span>        String username <span style=color:#f92672>=</span> getUsername(principals);
</span></span><span style=display:flex><span>        USERS_LOCK.<span style=color:#a6e22e>readLock</span>().<span style=color:#a6e22e>lock</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>users</span>.<span style=color:#a6e22e>get</span>(username);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>finally</span> {
</span></span><span style=display:flex><span>            USERS_LOCK.<span style=color:#a6e22e>readLock</span>().<span style=color:#a6e22e>unlock</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=3自定义realm>3.自定义realm<a hidden class=anchor aria-hidden=true href=#3自定义realm>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 自定义realm
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CustomerRealm</span> <span style=color:#66d9ef>extends</span> AuthorizingRealm {
</span></span><span style=display:flex><span>    <span style=color:#75715e>//认证方法</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> AuthorizationInfo <span style=color:#a6e22e>doGetAuthorizationInfo</span>(PrincipalCollection principals) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//授权方法</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> AuthenticationInfo <span style=color:#a6e22e>doGetAuthenticationInfo</span>(AuthenticationToken token) <span style=color:#66d9ef>throws</span> AuthenticationException {
</span></span><span style=display:flex><span>        String principal <span style=color:#f92672>=</span> (String) token.<span style=color:#a6e22e>getPrincipal</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(<span style=color:#e6db74>&#34;xiaochen&#34;</span>.<span style=color:#a6e22e>equals</span>(principal)){
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> SimpleAuthenticationInfo(principal,<span style=color:#e6db74>&#34;123&#34;</span>,<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getName</span>());
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=4使用自定义realm认证>4.使用自定义Realm认证<a hidden class=anchor aria-hidden=true href=#4使用自定义realm认证>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TestAuthenticatorCusttomerRealm</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>//创建securityManager</span>
</span></span><span style=display:flex><span>        DefaultSecurityManager defaultSecurityManager <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> DefaultSecurityManager();
</span></span><span style=display:flex><span>        <span style=color:#75715e>//IniRealm realm = new IniRealm(&#34;classpath:shiro.ini&#34;);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//设置为自定义realm获取认证数据</span>
</span></span><span style=display:flex><span>        defaultSecurityManager.<span style=color:#a6e22e>setRealm</span>(<span style=color:#66d9ef>new</span> CustomerRealm());
</span></span><span style=display:flex><span>        <span style=color:#75715e>//将安装工具类中设置默认安全管理器</span>
</span></span><span style=display:flex><span>        SecurityUtils.<span style=color:#a6e22e>setSecurityManager</span>(defaultSecurityManager);
</span></span><span style=display:flex><span>        <span style=color:#75715e>//获取主体对象</span>
</span></span><span style=display:flex><span>        Subject subject <span style=color:#f92672>=</span> SecurityUtils.<span style=color:#a6e22e>getSubject</span>();
</span></span><span style=display:flex><span>        <span style=color:#75715e>//创建token令牌</span>
</span></span><span style=display:flex><span>        UsernamePasswordToken token <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> UsernamePasswordToken(<span style=color:#e6db74>&#34;xiaochen&#34;</span>, <span style=color:#e6db74>&#34;123&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            subject.<span style=color:#a6e22e>login</span>(token);<span style=color:#75715e>//用户登录</span>
</span></span><span style=display:flex><span>            System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;登录成功~~&#34;</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (UnknownAccountException e) {
</span></span><span style=display:flex><span>            e.<span style=color:#a6e22e>printStackTrace</span>();
</span></span><span style=display:flex><span>            System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;用户名错误!!&#34;</span>);
</span></span><span style=display:flex><span>        }<span style=color:#66d9ef>catch</span> (IncorrectCredentialsException e){
</span></span><span style=display:flex><span>            e.<span style=color:#a6e22e>printStackTrace</span>();
</span></span><span style=display:flex><span>            System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;密码错误!!!&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=46-使用md5和salt>4.6 使用MD5和Salt<a hidden class=anchor aria-hidden=true href=#46-使用md5和salt>#</a></h3><blockquote><p>实际应用是将盐和散列后的值存在数据库中，自动realm从数据库取出盐和加密后的值由shiro完成密码校验。</p></blockquote><h5 id=1自定义md5salt的realm>1.自定义md5+salt的realm<a hidden class=anchor aria-hidden=true href=#1自定义md5salt的realm>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 自定义md5+salt realm
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CustomerRealm</span> <span style=color:#66d9ef>extends</span> AuthorizingRealm {
</span></span><span style=display:flex><span>    <span style=color:#75715e>//认证方法</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> AuthorizationInfo <span style=color:#a6e22e>doGetAuthorizationInfo</span>(PrincipalCollection principals) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//授权方法</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> AuthenticationInfo <span style=color:#a6e22e>doGetAuthenticationInfo</span>(AuthenticationToken token) <span style=color:#66d9ef>throws</span> AuthenticationException {
</span></span><span style=display:flex><span>        String principal <span style=color:#f92672>=</span> (String) token.<span style=color:#a6e22e>getPrincipal</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(<span style=color:#e6db74>&#34;xiaochen&#34;</span>.<span style=color:#a6e22e>equals</span>(principal)){
</span></span><span style=display:flex><span>            String password <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;3c88b338102c1a343bcb88cd3878758e&#34;</span>;
</span></span><span style=display:flex><span>            String salt <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Q4F%&#34;</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> SimpleAuthenticationInfo(principal,password, 
</span></span><span style=display:flex><span>                                                ByteSource.<span style=color:#a6e22e>Util</span>.<span style=color:#a6e22e>bytes</span>(salt),<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getName</span>());
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><h5 id=2使用md5--salt-认证>2.使用md5 + salt 认证<a hidden class=anchor aria-hidden=true href=#2使用md5--salt-认证>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TestAuthenticatorCusttomerRealm</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>//创建securityManager</span>
</span></span><span style=display:flex><span>        DefaultSecurityManager defaultSecurityManager <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> DefaultSecurityManager();
</span></span><span style=display:flex><span>        <span style=color:#75715e>//IniRealm realm = new IniRealm(&#34;classpath:shiro.ini&#34;);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//设置为自定义realm获取认证数据</span>
</span></span><span style=display:flex><span>        CustomerRealm customerRealm <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CustomerRealm();
</span></span><span style=display:flex><span>        <span style=color:#75715e>//设置md5加密</span>
</span></span><span style=display:flex><span>        HashedCredentialsMatcher credentialsMatcher <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashedCredentialsMatcher();
</span></span><span style=display:flex><span>        credentialsMatcher.<span style=color:#a6e22e>setHashAlgorithmName</span>(<span style=color:#e6db74>&#34;MD5&#34;</span>);
</span></span><span style=display:flex><span>        credentialsMatcher.<span style=color:#a6e22e>setHashIterations</span>(1024);<span style=color:#75715e>//设置散列次数</span>
</span></span><span style=display:flex><span>        customerRealm.<span style=color:#a6e22e>setCredentialsMatcher</span>(credentialsMatcher);
</span></span><span style=display:flex><span>        defaultSecurityManager.<span style=color:#a6e22e>setRealm</span>(customerRealm);
</span></span><span style=display:flex><span>        <span style=color:#75715e>//将安装工具类中设置默认安全管理器</span>
</span></span><span style=display:flex><span>        SecurityUtils.<span style=color:#a6e22e>setSecurityManager</span>(defaultSecurityManager);
</span></span><span style=display:flex><span>        <span style=color:#75715e>//获取主体对象</span>
</span></span><span style=display:flex><span>        Subject subject <span style=color:#f92672>=</span> SecurityUtils.<span style=color:#a6e22e>getSubject</span>();
</span></span><span style=display:flex><span>        <span style=color:#75715e>//创建token令牌</span>
</span></span><span style=display:flex><span>        UsernamePasswordToken token <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> UsernamePasswordToken(<span style=color:#e6db74>&#34;xiaochen&#34;</span>, <span style=color:#e6db74>&#34;123&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            subject.<span style=color:#a6e22e>login</span>(token);<span style=color:#75715e>//用户登录</span>
</span></span><span style=display:flex><span>            System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;登录成功~~&#34;</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (UnknownAccountException e) {
</span></span><span style=display:flex><span>            e.<span style=color:#a6e22e>printStackTrace</span>();
</span></span><span style=display:flex><span>            System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;用户名错误!!&#34;</span>);
</span></span><span style=display:flex><span>        }<span style=color:#66d9ef>catch</span> (IncorrectCredentialsException e){
</span></span><span style=display:flex><span>            e.<span style=color:#a6e22e>printStackTrace</span>();
</span></span><span style=display:flex><span>            System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;密码错误!!!&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><hr><h2 id=5-shiro中的授权>5. shiro中的授权<a hidden class=anchor aria-hidden=true href=#5-shiro中的授权>#</a></h2><h3 id=51-授权>5.1 授权<a hidden class=anchor aria-hidden=true href=#51-授权>#</a></h3><p>授权，即访问控制，控制谁能访问哪些资源。主体进行身份认证后需要分配权限方可访问系统的资源，对于某些资源没有权限是无法访问的。</p><h3 id=52-关键对象>5.2 关键对象<a hidden class=anchor aria-hidden=true href=#52-关键对象>#</a></h3><p><strong>授权可简单理解为who对what(which)进行How操作：</strong></p><p><code>Who，即主体（Subject）</code>，主体需要访问系统中的资源。</p><p><code>What，即资源（Resource)</code>，如系统菜单、页面、按钮、类方法、系统商品信息等。资源包括<code>资源类型</code>和<code>资源实例</code>，比如<code>商品信息为资源类型</code>，类型为t01的商品为<code>资源实例</code>，编号为001的商品信息也属于资源实例。</p><p><code>How，权限/许可（Permission)</code>，规定了主体对资源的操作许可，权限离开资源没有意义，如用户查询权限、用户添加权限、某个类方法的调用权限、编号为001用户的修改权限等，通过权限可知主体对哪些资源都有哪些操作许可。</p><h3 id=53-授权流程>5.3 授权流程<a hidden class=anchor aria-hidden=true href=#53-授权流程>#</a></h3><p><img alt=image-20200521230705964 loading=lazy src=/posts/java/shiro%E7%AC%94%E8%AE%B0/image-20200521230705964.png></p><h3 id=54-授权方式>5.4 授权方式<a hidden class=anchor aria-hidden=true href=#54-授权方式>#</a></h3><ul><li><p><strong>基于角色的访问控制</strong></p><ul><li><p>RBAC基于角色的访问控制（Role-Based Access Control）是以角色为中心进行访问控制</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>if</span>(subject.<span style=color:#a6e22e>hasRole</span>(<span style=color:#e6db74>&#34;admin&#34;</span>)){
</span></span><span style=display:flex><span>   <span style=color:#75715e>//操作什么资源</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li></ul></li><li><p><strong>基于资源的访问控制</strong></p><ul><li><p>RBAC基于资源的访问控制（Resource-Based Access Control）是以资源为中心进行访问控制</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>if</span>(subject.<span style=color:#a6e22e>isPermission</span>(<span style=color:#e6db74>&#34;user:update:01&#34;</span>)){ <span style=color:#75715e>//资源实例</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>//对01用户进行修改</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span>(subject.<span style=color:#a6e22e>isPermission</span>(<span style=color:#e6db74>&#34;user:update:*&#34;</span>)){  <span style=color:#75715e>//资源类型</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>//对01用户进行修改</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li></ul></li></ul><h3 id=55-权限字符串>5.5 权限字符串<a hidden class=anchor aria-hidden=true href=#55-权限字符串>#</a></h3><p>​ 权限字符串的规则是：<strong>资源标识符：操作：资源实例标识符</strong>，意思是对哪个资源的哪个实例具有什么操作，“:”是资源/操作/实例的分割符，权限字符串也可以使用*通配符。</p><p>例子：</p><ul><li>用户创建权限：user:create，或user:create:*</li><li>用户修改实例001的权限：user:update:001</li><li>用户实例001的所有权限：user:*：001</li></ul><h3 id=56-shiro中授权编程实现方式>5.6 shiro中授权编程实现方式<a hidden class=anchor aria-hidden=true href=#56-shiro中授权编程实现方式>#</a></h3><ul><li><p><strong>编程式</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Subject subject <span style=color:#f92672>=</span> SecurityUtils.<span style=color:#a6e22e>getSubject</span>();
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span>(subject.<span style=color:#a6e22e>hasRole</span>(<span style=color:#960050;background-color:#1e0010>“</span>admin<span style=color:#960050;background-color:#1e0010>”</span>)) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>//有权限</span>
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>//无权限</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li><li><p><strong>注解式</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@RequiresRoles</span>(<span style=color:#e6db74>&#34;admin&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>hello</span>() {
</span></span><span style=display:flex><span>	<span style=color:#75715e>//有权限</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li><li><p><strong>标签式</strong></p><pre tabindex=0><code class=language-jsp data-lang=jsp>JSP/GSP 标签：在JSP/GSP 页面通过相应的标签完成：
&lt;shiro:hasRole name=&#34;admin&#34;&gt;
	&lt;!— 有权限—&gt;
&lt;/shiro:hasRole&gt;
注意: Thymeleaf 中使用shiro需要额外集成!
</code></pre></li><li></li></ul><h3 id=57-开发授权>5.7 开发授权<a hidden class=anchor aria-hidden=true href=#57-开发授权>#</a></h3><h5 id=1realm的实现>1.realm的实现<a hidden class=anchor aria-hidden=true href=#1realm的实现>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CustomerRealm</span> <span style=color:#66d9ef>extends</span> AuthorizingRealm {
</span></span><span style=display:flex><span>    <span style=color:#75715e>//授权方法</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> AuthorizationInfo <span style=color:#a6e22e>doGetAuthorizationInfo</span>(PrincipalCollection principals) {
</span></span><span style=display:flex><span>        String primaryPrincipal <span style=color:#f92672>=</span> (String) principals.<span style=color:#a6e22e>getPrimaryPrincipal</span>();
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;primaryPrincipal = &#34;</span> <span style=color:#f92672>+</span> primaryPrincipal);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        SimpleAuthorizationInfo simpleAuthorizationInfo <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SimpleAuthorizationInfo();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        simpleAuthorizationInfo.<span style=color:#a6e22e>addRole</span>(<span style=color:#e6db74>&#34;admin&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        simpleAuthorizationInfo.<span style=color:#a6e22e>addStringPermission</span>(<span style=color:#e6db74>&#34;user:update:*&#34;</span>);
</span></span><span style=display:flex><span>        simpleAuthorizationInfo.<span style=color:#a6e22e>addStringPermission</span>(<span style=color:#e6db74>&#34;product:*:*&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> simpleAuthorizationInfo;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//认证方法</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> AuthenticationInfo <span style=color:#a6e22e>doGetAuthenticationInfo</span>(AuthenticationToken token) <span style=color:#66d9ef>throws</span> AuthenticationException {
</span></span><span style=display:flex><span>        String principal <span style=color:#f92672>=</span> (String) token.<span style=color:#a6e22e>getPrincipal</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(<span style=color:#e6db74>&#34;xiaochen&#34;</span>.<span style=color:#a6e22e>equals</span>(principal)){
</span></span><span style=display:flex><span>            String password <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;3c88b338102c1a343bcb88cd3878758e&#34;</span>;
</span></span><span style=display:flex><span>            String salt <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Q4F%&#34;</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> SimpleAuthenticationInfo(principal,password, 
</span></span><span style=display:flex><span>                                                ByteSource.<span style=color:#a6e22e>Util</span>.<span style=color:#a6e22e>bytes</span>(salt),<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getName</span>());
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=2授权>2.授权<a hidden class=anchor aria-hidden=true href=#2授权>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TestAuthenticatorCusttomerRealm</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>//创建securityManager</span>
</span></span><span style=display:flex><span>        DefaultSecurityManager defaultSecurityManager <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> DefaultSecurityManager();
</span></span><span style=display:flex><span>        <span style=color:#75715e>//IniRealm realm = new IniRealm(&#34;classpath:shiro.ini&#34;);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//设置为自定义realm获取认证数据</span>
</span></span><span style=display:flex><span>        CustomerRealm customerRealm <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CustomerRealm();
</span></span><span style=display:flex><span>        <span style=color:#75715e>//设置md5加密</span>
</span></span><span style=display:flex><span>        HashedCredentialsMatcher credentialsMatcher <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashedCredentialsMatcher();
</span></span><span style=display:flex><span>        credentialsMatcher.<span style=color:#a6e22e>setHashAlgorithmName</span>(<span style=color:#e6db74>&#34;MD5&#34;</span>);
</span></span><span style=display:flex><span>        credentialsMatcher.<span style=color:#a6e22e>setHashIterations</span>(1024);<span style=color:#75715e>//设置散列次数</span>
</span></span><span style=display:flex><span>        customerRealm.<span style=color:#a6e22e>setCredentialsMatcher</span>(credentialsMatcher);
</span></span><span style=display:flex><span>        defaultSecurityManager.<span style=color:#a6e22e>setRealm</span>(customerRealm);
</span></span><span style=display:flex><span>        <span style=color:#75715e>//将安装工具类中设置默认安全管理器</span>
</span></span><span style=display:flex><span>        SecurityUtils.<span style=color:#a6e22e>setSecurityManager</span>(defaultSecurityManager);
</span></span><span style=display:flex><span>        <span style=color:#75715e>//获取主体对象</span>
</span></span><span style=display:flex><span>        Subject subject <span style=color:#f92672>=</span> SecurityUtils.<span style=color:#a6e22e>getSubject</span>();
</span></span><span style=display:flex><span>        <span style=color:#75715e>//创建token令牌</span>
</span></span><span style=display:flex><span>        UsernamePasswordToken token <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> UsernamePasswordToken(<span style=color:#e6db74>&#34;xiaochen&#34;</span>, <span style=color:#e6db74>&#34;123&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            subject.<span style=color:#a6e22e>login</span>(token);<span style=color:#75715e>//用户登录</span>
</span></span><span style=display:flex><span>            System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;登录成功~~&#34;</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (UnknownAccountException e) {
</span></span><span style=display:flex><span>            e.<span style=color:#a6e22e>printStackTrace</span>();
</span></span><span style=display:flex><span>            System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;用户名错误!!&#34;</span>);
</span></span><span style=display:flex><span>        }<span style=color:#66d9ef>catch</span> (IncorrectCredentialsException e){
</span></span><span style=display:flex><span>            e.<span style=color:#a6e22e>printStackTrace</span>();
</span></span><span style=display:flex><span>            System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;密码错误!!!&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>//认证通过</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(subject.<span style=color:#a6e22e>isAuthenticated</span>()){
</span></span><span style=display:flex><span>            <span style=color:#75715e>//基于角色权限管理</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>boolean</span> admin <span style=color:#f92672>=</span> subject.<span style=color:#a6e22e>hasRole</span>(<span style=color:#e6db74>&#34;admin&#34;</span>);
</span></span><span style=display:flex><span>            System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(admin);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>boolean</span> permitted <span style=color:#f92672>=</span> subject.<span style=color:#a6e22e>isPermitted</span>(<span style=color:#e6db74>&#34;product:create:001&#34;</span>);
</span></span><span style=display:flex><span>            System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(permitted);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=6整合springboot项目实战>6.整合SpringBoot项目实战<a hidden class=anchor aria-hidden=true href=#6整合springboot项目实战>#</a></h2><h3 id=60-整合思路>6.0 整合思路<a hidden class=anchor aria-hidden=true href=#60-整合思路>#</a></h3><p><img alt=image-20200525185630463 loading=lazy src=/posts/java/shiro%E7%AC%94%E8%AE%B0/image-20200525185630463.png></p><h3 id=61-创建springboot项目>6.1 创建springboot项目<a hidden class=anchor aria-hidden=true href=#61-创建springboot项目>#</a></h3><p><img alt=image-20200523100842032 loading=lazy src=/posts/java/shiro%E7%AC%94%E8%AE%B0/image-20200523100842032.png></p><h3 id=62-引入shiro依赖>6.2 引入shiro依赖<a hidden class=anchor aria-hidden=true href=#62-引入shiro依赖>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;groupId&gt;</span>org.apache.shiro<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;artifactId&gt;</span>shiro-spring-boot-starter<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;version&gt;</span>1.5.3<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></div><h3 id=63-配置shiro环境>6.3 配置shiro环境<a hidden class=anchor aria-hidden=true href=#63-配置shiro环境>#</a></h3><h5 id=0创建配置类>0.创建配置类<a hidden class=anchor aria-hidden=true href=#0创建配置类>#</a></h5><p><img alt=image-20200523101256446 loading=lazy src=/posts/java/shiro%E7%AC%94%E8%AE%B0/image-20200523101256446.png></p><h5 id=1配置shirofilterfactorybean>1.配置shiroFilterFactoryBean<a hidden class=anchor aria-hidden=true href=#1配置shirofilterfactorybean>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> ShiroFilterFactoryBean <span style=color:#a6e22e>getShiroFilterFactoryBean</span>(SecurityManager securityManager){
</span></span><span style=display:flex><span>  <span style=color:#75715e>//创建shiro的filter</span>
</span></span><span style=display:flex><span>  ShiroFilterFactoryBean shiroFilterFactoryBean <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ShiroFilterFactoryBean();
</span></span><span style=display:flex><span>  <span style=color:#75715e>//注入安全管理器</span>
</span></span><span style=display:flex><span>  shiroFilterFactoryBean.<span style=color:#a6e22e>setSecurityManager</span>(securityManager);
</span></span><span style=display:flex><span> 	
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> shiroFilterFactoryBean;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=2配置websecuritymanager>2.配置WebSecurityManager<a hidden class=anchor aria-hidden=true href=#2配置websecuritymanager>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> DefaultWebSecurityManager <span style=color:#a6e22e>getSecurityManager</span>(Realm realm){
</span></span><span style=display:flex><span>  DefaultWebSecurityManager defaultWebSecurityManager <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> DefaultWebSecurityManager();
</span></span><span style=display:flex><span>  defaultWebSecurityManager.<span style=color:#a6e22e>setRealm</span>(realm);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> defaultWebSecurityManager;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=3创建自定义realm>3.创建自定义realm<a hidden class=anchor aria-hidden=true href=#3创建自定义realm>#</a></h5><p><img alt=image-20200523101402213 loading=lazy src=/posts/java/shiro%E7%AC%94%E8%AE%B0/image-20200523101402213.png></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CustomerRealm</span> <span style=color:#66d9ef>extends</span> AuthorizingRealm {
</span></span><span style=display:flex><span>    <span style=color:#75715e>//处理授权</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> AuthorizationInfo <span style=color:#a6e22e>doGetAuthorizationInfo</span>(PrincipalCollection principals) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>		<span style=color:#75715e>//处理认证</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> AuthenticationInfo <span style=color:#a6e22e>doGetAuthenticationInfo</span>(AuthenticationToken token) <span style=color:#66d9ef>throws</span> 
</span></span><span style=display:flex><span>      																																		AuthenticationException {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=4配置自定义realm>4.配置自定义realm<a hidden class=anchor aria-hidden=true href=#4配置自定义realm>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>//创建自定义realm</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Realm <span style=color:#a6e22e>getRealm</span>(){
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> CustomerRealm();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=5编写控制器跳转至indexhtml>5.编写控制器跳转至index.html<a hidden class=anchor aria-hidden=true href=#5编写控制器跳转至indexhtml>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Controller</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>IndexController</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequestMapping</span>(<span style=color:#e6db74>&#34;index&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>index</span>(){
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;跳转至主页&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;index&#34;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><img alt=image-20200523101733157 loading=lazy src=/posts/java/shiro%E7%AC%94%E8%AE%B0/image-20200523101733157.png></p><p><img alt=image-20200523101857528 loading=lazy src=/posts/java/shiro%E7%AC%94%E8%AE%B0/image-20200523101857528.png></p><h5 id=6启动springboot应用访问index>6.启动springboot应用访问index<a hidden class=anchor aria-hidden=true href=#6启动springboot应用访问index>#</a></h5><p><img alt=image-20200523101955121 loading=lazy src=/posts/java/shiro%E7%AC%94%E8%AE%B0/image-20200523101955121.png></p><ul><li>注意:<ul><li><strong>默认在配置好shiro环境后默认环境中没有对项目中任何资源进行权限控制,所有现在项目中所有资源都可以通过路径访问</strong></li></ul></li></ul><h5 id=7加入权限控制>7.加入权限控制<a hidden class=anchor aria-hidden=true href=#7加入权限控制>#</a></h5><ul><li><p>修改ShiroFilterFactoryBean配置</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>//注入安全管理器</span>
</span></span><span style=display:flex><span>shiroFilterFactoryBean.<span style=color:#a6e22e>setSecurityManager</span>(securityManager);
</span></span><span style=display:flex><span>Map<span style=color:#f92672>&lt;</span>String,String<span style=color:#f92672>&gt;</span> map <span style=color:#f92672>=</span>  <span style=color:#66d9ef>new</span> LinkedHashMap<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>map.<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>&#34;/**&#34;</span>,<span style=color:#e6db74>&#34;authc&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#75715e>//配置认证和授权规则</span>
</span></span><span style=display:flex><span>shiroFilterFactoryBean.<span style=color:#a6e22e>setFilterChainDefinitionMap</span>(map);
</span></span></code></pre></div><p><img alt=image-20200523102303320 loading=lazy src=/posts/java/shiro%E7%AC%94%E8%AE%B0/image-20200523102303320.png></p><ul><li><strong>/*</strong>* 代表拦截项目中一切资源 <strong>authc</strong> 代表shiro中的一个filter的别名,详细内容看文档的shirofilter列表</li></ul></li></ul><h5 id=8重启项目访问查看>8.重启项目访问查看<a hidden class=anchor aria-hidden=true href=#8重启项目访问查看>#</a></h5><p><img alt=image-20200523102831750 loading=lazy src=/posts/java/shiro%E7%AC%94%E8%AE%B0/image-20200523102831750.png></p><h3 id=64-常见过滤器>6.4 常见过滤器<a hidden class=anchor aria-hidden=true href=#64-常见过滤器>#</a></h3><ul><li>注意: <strong>shiro提供多个默认的过滤器，我们可以用这些过滤器来配置控制指定url的权限：</strong></li></ul><table><thead><tr><th>配置缩写</th><th>对应的过滤器</th><th>功能</th></tr></thead><tbody><tr><td>anon</td><td>AnonymousFilter</td><td>指定url可以匿名访问</td></tr><tr><td>authc</td><td>FormAuthenticationFilter</td><td>指定url需要form表单登录，默认会从请求中获取<code>username</code>、<code>password</code>,<code>rememberMe</code>等参数并尝试登录，如果登录不了就会跳转到loginUrl配置的路径。我们也可以用这个过滤器做默认的登录逻辑，但是一般都是我们自己在控制器写登录逻辑的，自己写的话出错返回的信息都可以定制嘛。</td></tr><tr><td>authcBasic</td><td>BasicHttpAuthenticationFilter</td><td>指定url需要basic登录</td></tr><tr><td>logout</td><td>LogoutFilter</td><td>登出过滤器，配置指定url就可以实现退出功能，非常方便</td></tr><tr><td>noSessionCreation</td><td>NoSessionCreationFilter</td><td>禁止创建会话</td></tr><tr><td>perms</td><td>PermissionsAuthorizationFilter</td><td>需要指定权限才能访问</td></tr><tr><td>port</td><td>PortFilter</td><td>需要指定端口才能访问</td></tr><tr><td>rest</td><td>HttpMethodPermissionFilter</td><td>将http请求方法转化成相应的动词来构造一个权限字符串，这个感觉意义不大，有兴趣自己看源码的注释</td></tr><tr><td>roles</td><td>RolesAuthorizationFilter</td><td>需要指定角色才能访问</td></tr><tr><td>ssl</td><td>SslFilter</td><td>需要https请求才能访问</td></tr><tr><td>user</td><td>UserFilter</td><td>需要已登录或“记住我”的用户才能访问</td></tr></tbody></table><h3 id=65-认证实现>6.5 认证实现<a hidden class=anchor aria-hidden=true href=#65-认证实现>#</a></h3><h5 id=1-在loginjsp中开发认证界面>1. 在login.jsp中开发认证界面<a hidden class=anchor aria-hidden=true href=#1-在loginjsp中开发认证界面>#</a></h5><p><img alt=image-20200526082345776 loading=lazy src=/posts/java/shiro%E7%AC%94%E8%AE%B0/image-20200526082345776.png></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#f92672>form</span> <span style=color:#a6e22e>action</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;${pageContext.request.contextPath}/user/login&#34;</span> <span style=color:#a6e22e>method</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;post&#34;</span>&gt;
</span></span><span style=display:flex><span>  用户名:&lt;<span style=color:#f92672>input</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;text&#34;</span> <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;username&#34;</span> &gt; &lt;<span style=color:#f92672>br</span>/&gt;
</span></span><span style=display:flex><span>  密码  : &lt;<span style=color:#f92672>input</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;text&#34;</span> <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;password&#34;</span>&gt; &lt;<span style=color:#f92672>br</span>&gt;
</span></span><span style=display:flex><span>  &lt;<span style=color:#f92672>input</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;submit&#34;</span> <span style=color:#a6e22e>value</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;登录&#34;</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>form</span>&gt;
</span></span></code></pre></div><h5 id=2-开发controller>2. 开发controller<a hidden class=anchor aria-hidden=true href=#2-开发controller>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Controller</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RequestMapping</span>(<span style=color:#e6db74>&#34;user&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UserController</span> {
</span></span><span style=display:flex><span>  <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>    * 用来处理身份认证
</span></span></span><span style=display:flex><span><span style=color:#75715e>    * @param username
</span></span></span><span style=display:flex><span><span style=color:#75715e>    * @param password
</span></span></span><span style=display:flex><span><span style=color:#75715e>    * @return
</span></span></span><span style=display:flex><span><span style=color:#75715e>    */</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@RequestMapping</span>(<span style=color:#e6db74>&#34;login&#34;</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>login</span>(String username,String password){
</span></span><span style=display:flex><span>    <span style=color:#75715e>//获取主体对象</span>
</span></span><span style=display:flex><span>    Subject subject <span style=color:#f92672>=</span> SecurityUtils.<span style=color:#a6e22e>getSubject</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      subject.<span style=color:#a6e22e>login</span>(<span style=color:#66d9ef>new</span> UsernamePasswordToken(username,password));
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span>  <span style=color:#e6db74>&#34;redirect:/index.jsp&#34;</span>;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (UnknownAccountException e) {
</span></span><span style=display:flex><span>      e.<span style=color:#a6e22e>printStackTrace</span>();
</span></span><span style=display:flex><span>      System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;用户名错误!&#34;</span>);
</span></span><span style=display:flex><span>    }<span style=color:#66d9ef>catch</span> (IncorrectCredentialsException e){
</span></span><span style=display:flex><span>      e.<span style=color:#a6e22e>printStackTrace</span>();
</span></span><span style=display:flex><span>      System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;密码错误!&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;redirect:/login.jsp&#34;</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><strong>在认证过程中使用subject.login进行认证</strong></li></ul><h5 id=3开发realm中返回静态数据未连接数据库>3.开发realm中返回静态数据(未连接数据库)<a hidden class=anchor aria-hidden=true href=#3开发realm中返回静态数据未连接数据库>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> AuthenticationInfo <span style=color:#a6e22e>doGetAuthenticationInfo</span>(AuthenticationToken token) <span style=color:#66d9ef>throws</span> AuthenticationException {
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;==========================&#34;</span>);
</span></span><span style=display:flex><span>        String principal <span style=color:#f92672>=</span> (String) token.<span style=color:#a6e22e>getPrincipal</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(<span style=color:#e6db74>&#34;xiaochen&#34;</span>.<span style=color:#a6e22e>equals</span>(principal)){
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> SimpleAuthenticationInfo(principal,<span style=color:#e6db74>&#34;123&#34;</span>,<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getName</span>());
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=4启动项目以realm中定义静态数据进行认证>4.启动项目以realm中定义静态数据进行认证<a hidden class=anchor aria-hidden=true href=#4启动项目以realm中定义静态数据进行认证>#</a></h5><p><img alt=image-20200526082550343 loading=lazy src=/posts/java/shiro%E7%AC%94%E8%AE%B0/image-20200526082550343.png></p><p><img alt=image-20200526082639318 loading=lazy src=/posts/java/shiro%E7%AC%94%E8%AE%B0/image-20200526082639318.png></p><p><img alt=image-20200526082620621 loading=lazy src=/posts/java/shiro%E7%AC%94%E8%AE%B0/image-20200526082620621.png></p><ul><li><strong>认证功能没有md5和随机盐的认证就实现啦</strong></li></ul><h3 id=66-退出认证>6.6 退出认证<a hidden class=anchor aria-hidden=true href=#66-退出认证>#</a></h3><h5 id=1开发页面退出连接>1.开发页面退出连接<a hidden class=anchor aria-hidden=true href=#1开发页面退出连接>#</a></h5><p><img alt=image-20200526082851800 loading=lazy src=/posts/java/shiro%E7%AC%94%E8%AE%B0/image-20200526082851800.png></p><h5 id=2开发controller>2.开发controller<a hidden class=anchor aria-hidden=true href=#2开发controller>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Controller</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RequestMapping</span>(<span style=color:#e6db74>&#34;user&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UserController</span> {
</span></span><span style=display:flex><span>  <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>    * 退出登录
</span></span></span><span style=display:flex><span><span style=color:#75715e>    *
</span></span></span><span style=display:flex><span><span style=color:#75715e>    */</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@RequestMapping</span>(<span style=color:#e6db74>&#34;logout&#34;</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>logout</span>(){
</span></span><span style=display:flex><span>    Subject subject <span style=color:#f92672>=</span> SecurityUtils.<span style=color:#a6e22e>getSubject</span>();
</span></span><span style=display:flex><span>    subject.<span style=color:#a6e22e>logout</span>();<span style=color:#75715e>//退出用户</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;redirect:/login.jsp&#34;</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=3修改退出连接访问退出路径>3.修改退出连接访问退出路径<a hidden class=anchor aria-hidden=true href=#3修改退出连接访问退出路径>#</a></h5><p><img alt=image-20200526083056062 loading=lazy src=/posts/java/shiro%E7%AC%94%E8%AE%B0/image-20200526083056062.png></p><h5 id=4退出之后访问受限资源立即返回认证界面>4.退出之后访问受限资源立即返回认证界面<a hidden class=anchor aria-hidden=true href=#4退出之后访问受限资源立即返回认证界面>#</a></h5><p><img alt=image-20200526083148253 loading=lazy src=/posts/java/shiro%E7%AC%94%E8%AE%B0/image-20200526083148253.png></p><h3 id=67-md5salt的认证实现>6.7 MD5、Salt的认证实现<a hidden class=anchor aria-hidden=true href=#67-md5salt的认证实现>#</a></h3><h4 id=1开发数据库注册>1.开发数据库注册<a hidden class=anchor aria-hidden=true href=#1开发数据库注册>#</a></h4><h5 id=0开发注册界面>0.开发注册界面<a hidden class=anchor aria-hidden=true href=#0开发注册界面>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#f92672>h1</span>&gt;用户注册&lt;/<span style=color:#f92672>h1</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>form</span> <span style=color:#a6e22e>action</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;${pageContext.request.contextPath}/user/register&#34;</span> <span style=color:#a6e22e>method</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;post&#34;</span>&gt;
</span></span><span style=display:flex><span>  用户名:&lt;<span style=color:#f92672>input</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;text&#34;</span> <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;username&#34;</span> &gt; &lt;<span style=color:#f92672>br</span>/&gt;
</span></span><span style=display:flex><span>  密码  : &lt;<span style=color:#f92672>input</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;text&#34;</span> <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;password&#34;</span>&gt; &lt;<span style=color:#f92672>br</span>&gt;
</span></span><span style=display:flex><span>  &lt;<span style=color:#f92672>input</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;submit&#34;</span> <span style=color:#a6e22e>value</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;立即注册&#34;</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>form</span>&gt;
</span></span></code></pre></div><p><img alt=image-20200526200230982 loading=lazy src=/posts/java/shiro%E7%AC%94%E8%AE%B0/image-20200526200230982.png></p><h5 id=1创建数据表结构>1.创建数据表结构<a hidden class=anchor aria-hidden=true href=#1创建数据表结构>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SET</span> <span style=color:#66d9ef>NAMES</span> utf8mb4;
</span></span><span style=display:flex><span><span style=color:#66d9ef>SET</span> FOREIGN_KEY_CHECKS <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span><span style=color:#75715e>-- ----------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e>-- Table structure for t_user
</span></span></span><span style=display:flex><span><span style=color:#75715e>-- ----------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>EXISTS</span> <span style=color:#f92672>`</span>t_user<span style=color:#f92672>`</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#f92672>`</span>t_user<span style=color:#f92672>`</span> (
</span></span><span style=display:flex><span>  <span style=color:#f92672>`</span>id<span style=color:#f92672>`</span> int(<span style=color:#ae81ff>6</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> AUTO_INCREMENT,
</span></span><span style=display:flex><span>  <span style=color:#f92672>`</span>username<span style=color:#f92672>`</span> varchar(<span style=color:#ae81ff>40</span>) <span style=color:#66d9ef>DEFAULT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>`</span>password<span style=color:#f92672>`</span> varchar(<span style=color:#ae81ff>40</span>) <span style=color:#66d9ef>DEFAULT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>`</span>salt<span style=color:#f92672>`</span> varchar(<span style=color:#ae81ff>255</span>) <span style=color:#66d9ef>DEFAULT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> (<span style=color:#f92672>`</span>id<span style=color:#f92672>`</span>)
</span></span><span style=display:flex><span>) ENGINE<span style=color:#f92672>=</span>InnoDB AUTO_INCREMENT<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> <span style=color:#66d9ef>DEFAULT</span> CHARSET<span style=color:#f92672>=</span>utf8;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SET</span> FOREIGN_KEY_CHECKS <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span></code></pre></div><p><img alt=image-20200526200425569 loading=lazy src=/posts/java/shiro%E7%AC%94%E8%AE%B0/image-20200526200425569.png></p><h5 id=2项目引入依赖>2.项目引入依赖<a hidden class=anchor aria-hidden=true href=#2项目引入依赖>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;!--mybatis相关依赖--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;groupId&gt;</span>org.mybatis.spring.boot<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;artifactId&gt;</span>mybatis-spring-boot-starter<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;version&gt;</span>2.1.2<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--mysql--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;groupId&gt;</span>mysql<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;artifactId&gt;</span>mysql-connector-java<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;version&gt;</span>5.1.38<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--druid--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;groupId&gt;</span>com.alibaba<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;artifactId&gt;</span>druid<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;version&gt;</span>1.1.19<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></div><h5 id=3配置applicationproperties配置文件>3.配置application.properties配置文件<a hidden class=anchor aria-hidden=true href=#3配置applicationproperties配置文件>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-properties data-lang=properties><span style=display:flex><span><span style=color:#a6e22e>server.port</span><span style=color:#f92672>=</span><span style=color:#e6db74>8888</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>server.servlet.context-path</span><span style=color:#f92672>=</span><span style=color:#e6db74>/shiro</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.application.name</span><span style=color:#f92672>=</span><span style=color:#e6db74>shiro</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.mvc.view.prefix</span><span style=color:#f92672>=</span><span style=color:#e6db74>/</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.mvc.view.suffix</span><span style=color:#f92672>=</span><span style=color:#e6db74>.jsp</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#新增配置</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.type</span><span style=color:#f92672>=</span><span style=color:#e6db74>com.alibaba.druid.pool.DruidDataSource</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.driver-class-name</span><span style=color:#f92672>=</span><span style=color:#e6db74>com.mysql.jdbc.Driver</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.url</span><span style=color:#f92672>=</span><span style=color:#e6db74>jdbc:mysql://localhost:3306/shiro?characterEncoding=UTF-8</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.username</span><span style=color:#f92672>=</span><span style=color:#e6db74>root</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.password</span><span style=color:#f92672>=</span><span style=color:#e6db74>root</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>mybatis.type-aliases-package</span><span style=color:#f92672>=</span><span style=color:#e6db74>com.baizhi.springboot_jsp_shiro.entity</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>mybatis.mapper-locations</span><span style=color:#f92672>=</span><span style=color:#e6db74>classpath:com/baizhi/mapper/*.xml</span>
</span></span></code></pre></div><p><img alt=image-20200526200558712 loading=lazy src=/posts/java/shiro%E7%AC%94%E8%AE%B0/image-20200526200558712.png></p><h5 id=4创建entity>4.创建entity<a hidden class=anchor aria-hidden=true href=#4创建entity>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Data</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Accessors</span>(chain <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@AllArgsConstructor</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@NoArgsConstructor</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>User</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String  id;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String username;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String password;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String salt;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=5创建dao接口>5.创建DAO接口<a hidden class=anchor aria-hidden=true href=#5创建dao接口>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Mapper</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>UserDAO</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>save</span>(User user);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=6开发mapper配置文件>6.开发mapper配置文件<a hidden class=anchor aria-hidden=true href=#6开发mapper配置文件>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;insert</span> <span style=color:#a6e22e>id=</span><span style=color:#e6db74>&#34;save&#34;</span> <span style=color:#a6e22e>parameterType=</span><span style=color:#e6db74>&#34;User&#34;</span> <span style=color:#a6e22e>useGeneratedKeys=</span><span style=color:#e6db74>&#34;true&#34;</span> <span style=color:#a6e22e>keyProperty=</span><span style=color:#e6db74>&#34;id&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>  insert into t_user values(#{id},#{username},#{password},#{salt})
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/insert&gt;</span>
</span></span></code></pre></div><h5 id=7开发service接口>7.开发service接口<a hidden class=anchor aria-hidden=true href=#7开发service接口>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>UserService</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>//注册用户方法</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>register</span>(User user);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=8创建salt工具类>8.创建salt工具类<a hidden class=anchor aria-hidden=true href=#8创建salt工具类>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SaltUtils</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 生成salt的静态方法
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param n
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> String <span style=color:#a6e22e>getSalt</span>(<span style=color:#66d9ef>int</span> n){
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>char</span><span style=color:#f92672>[]</span> chars <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz01234567890!@#$%^&amp;*()&#34;</span>.<span style=color:#a6e22e>toCharArray</span>();
</span></span><span style=display:flex><span>        StringBuilder sb <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> StringBuilder();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0; i <span style=color:#f92672>&lt;</span> n; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>char</span> aChar <span style=color:#f92672>=</span> chars<span style=color:#f92672>[</span><span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Random</span>().<span style=color:#a6e22e>nextInt</span>(chars.<span style=color:#a6e22e>length</span>)<span style=color:#f92672>]</span>;
</span></span><span style=display:flex><span>            sb.<span style=color:#a6e22e>append</span>(aChar);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> sb.<span style=color:#a6e22e>toString</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=9开发service实现类>9.开发service实现类<a hidden class=anchor aria-hidden=true href=#9开发service实现类>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Service</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Transactional</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UserServiceImpl</span> <span style=color:#66d9ef>implements</span> UserService {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> UserDAO userDAO;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>register</span>(User user) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>//处理业务调用dao</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//1.生成随机盐</span>
</span></span><span style=display:flex><span>        String salt <span style=color:#f92672>=</span> SaltUtils.<span style=color:#a6e22e>getSalt</span>(8);
</span></span><span style=display:flex><span>        <span style=color:#75715e>//2.将随机盐保存到数据</span>
</span></span><span style=display:flex><span>        user.<span style=color:#a6e22e>setSalt</span>(salt);
</span></span><span style=display:flex><span>        <span style=color:#75715e>//3.明文密码进行md5 + salt + hash散列</span>
</span></span><span style=display:flex><span>        Md5Hash md5Hash <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Md5Hash(user.<span style=color:#a6e22e>getPassword</span>(),salt,1024);
</span></span><span style=display:flex><span>        user.<span style=color:#a6e22e>setPassword</span>(md5Hash.<span style=color:#a6e22e>toHex</span>());
</span></span><span style=display:flex><span>        userDAO.<span style=color:#a6e22e>save</span>(user);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=10开发controller>10.开发Controller<a hidden class=anchor aria-hidden=true href=#10开发controller>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Controller</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RequestMapping</span>(<span style=color:#e6db74>&#34;user&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UserController</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> UserService userService;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 用户注册
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequestMapping</span>(<span style=color:#e6db74>&#34;register&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>register</span>(User user) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            userService.<span style=color:#a6e22e>register</span>(user);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;redirect:/login.jsp&#34;</span>;
</span></span><span style=display:flex><span>        }<span style=color:#66d9ef>catch</span> (Exception e){
</span></span><span style=display:flex><span>            e.<span style=color:#a6e22e>printStackTrace</span>();
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;redirect:/register.jsp&#34;</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=11启动项目进行注册>11.启动项目进行注册<a hidden class=anchor aria-hidden=true href=#11启动项目进行注册>#</a></h5><p><img alt=image-20200526200946730 loading=lazy src=/posts/java/shiro%E7%AC%94%E8%AE%B0/image-20200526200946730.png></p><hr><h4 id=2开发数据库认证>2.开发数据库认证<a hidden class=anchor aria-hidden=true href=#2开发数据库认证>#</a></h4><h5 id=0开发dao>0.开发DAO<a hidden class=anchor aria-hidden=true href=#0开发dao>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Mapper</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>UserDAO</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>save</span>(User user);
</span></span><span style=display:flex><span>		<span style=color:#75715e>//根据身份信息认证的方法</span>
</span></span><span style=display:flex><span>    User <span style=color:#a6e22e>findByUserName</span>(String username);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=1开发mapper配置文件>1.开发mapper配置文件<a hidden class=anchor aria-hidden=true href=#1开发mapper配置文件>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;select</span> <span style=color:#a6e22e>id=</span><span style=color:#e6db74>&#34;findByUserName&#34;</span> <span style=color:#a6e22e>parameterType=</span><span style=color:#e6db74>&#34;String&#34;</span> <span style=color:#a6e22e>resultType=</span><span style=color:#e6db74>&#34;User&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>  select id,username,password,salt from t_user
</span></span><span style=display:flex><span>  where username = #{username}
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/select&gt;</span>
</span></span></code></pre></div><h5 id=2开发service接口>2.开发Service接口<a hidden class=anchor aria-hidden=true href=#2开发service接口>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>UserService</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>//注册用户方法</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>register</span>(User user);
</span></span><span style=display:flex><span>    <span style=color:#75715e>//根据用户名查询业务的方法</span>
</span></span><span style=display:flex><span>    User <span style=color:#a6e22e>findByUserName</span>(String username);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=3开发service实现类>3.开发Service实现类<a hidden class=anchor aria-hidden=true href=#3开发service实现类>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Service</span>(<span style=color:#e6db74>&#34;userService&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Transactional</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UserServiceImpl</span> <span style=color:#66d9ef>implements</span> UserService {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> UserDAO userDAO;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> User <span style=color:#a6e22e>findByUserName</span>(String username) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> userDAO.<span style=color:#a6e22e>findByUserName</span>(username);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=4开发在工厂中获取bean对象的工具类>4.开发在工厂中获取bean对象的工具类<a hidden class=anchor aria-hidden=true href=#4开发在工厂中获取bean对象的工具类>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ApplicationContextUtils</span> <span style=color:#66d9ef>implements</span> ApplicationContextAware {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> ApplicationContext context;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setApplicationContext</span>(ApplicationContext applicationContext) <span style=color:#66d9ef>throws</span> BeansException {
</span></span><span style=display:flex><span>        context <span style=color:#f92672>=</span> applicationContext;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//根据bean名字获取工厂中指定bean 对象</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> Object <span style=color:#a6e22e>getBean</span>(String beanName){
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> context.<span style=color:#a6e22e>getBean</span>(beanName);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=5修改自定义realm>5.修改自定义realm<a hidden class=anchor aria-hidden=true href=#5修改自定义realm>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span> <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> AuthenticationInfo <span style=color:#a6e22e>doGetAuthenticationInfo</span>(AuthenticationToken token) <span style=color:#66d9ef>throws</span> AuthenticationException {
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;==========================&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//根据身份信息</span>
</span></span><span style=display:flex><span>        String principal <span style=color:#f92672>=</span> (String) token.<span style=color:#a6e22e>getPrincipal</span>();
</span></span><span style=display:flex><span>        <span style=color:#75715e>//在工厂中获取service对象</span>
</span></span><span style=display:flex><span>        UserService userService <span style=color:#f92672>=</span> (UserService) ApplicationContextUtils.<span style=color:#a6e22e>getBean</span>(<span style=color:#e6db74>&#34;userService&#34;</span>);
</span></span><span style=display:flex><span>				<span style=color:#75715e>//根据身份信息查询</span>
</span></span><span style=display:flex><span>        User user <span style=color:#f92672>=</span> userService.<span style=color:#a6e22e>findByUserName</span>(principal);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span>ObjectUtils.<span style=color:#a6e22e>isEmpty</span>(user)){
</span></span><span style=display:flex><span>            <span style=color:#75715e>//返回数据库信息</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> SimpleAuthenticationInfo(user.<span style=color:#a6e22e>getUsername</span>(),user.<span style=color:#a6e22e>getPassword</span>(), 
</span></span><span style=display:flex><span>                                               ByteSource.<span style=color:#a6e22e>Util</span>.<span style=color:#a6e22e>bytes</span>(user.<span style=color:#a6e22e>getSalt</span>()),<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getName</span>());
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><h5 id=6修改shiroconfig中realm使用凭证匹配器以及hash散列>6.修改ShiroConfig中realm使用凭证匹配器以及hash散列<a hidden class=anchor aria-hidden=true href=#6修改shiroconfig中realm使用凭证匹配器以及hash散列>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Realm <span style=color:#a6e22e>getRealm</span>(){
</span></span><span style=display:flex><span>  CustomerRealm customerRealm <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CustomerRealm();
</span></span><span style=display:flex><span>  <span style=color:#75715e>//设置hashed凭证匹配器</span>
</span></span><span style=display:flex><span>  HashedCredentialsMatcher credentialsMatcher <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashedCredentialsMatcher();
</span></span><span style=display:flex><span>  <span style=color:#75715e>//设置md5加密</span>
</span></span><span style=display:flex><span>  credentialsMatcher.<span style=color:#a6e22e>setHashAlgorithmName</span>(<span style=color:#e6db74>&#34;md5&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#75715e>//设置散列次数</span>
</span></span><span style=display:flex><span>  credentialsMatcher.<span style=color:#a6e22e>setHashIterations</span>(1024);
</span></span><span style=display:flex><span>  customerRealm.<span style=color:#a6e22e>setCredentialsMatcher</span>(credentialsMatcher);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> customerRealm;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><img alt=image-20200526204958726 loading=lazy src=/posts/java/shiro%E7%AC%94%E8%AE%B0/image-20200526204958726.png></p><h3 id=68-授权实现>6.8 授权实现<a hidden class=anchor aria-hidden=true href=#68-授权实现>#</a></h3><h5 id=0页面资源授权>0.页面资源授权<a hidden class=anchor aria-hidden=true href=#0页面资源授权>#</a></h5><pre tabindex=0><code class=language-jsp data-lang=jsp>&lt;%@taglib prefix=&#34;shiro&#34; uri=&#34;http://shiro.apache.org/tags&#34; %&gt;

&lt;shiro:hasAnyRoles name=&#34;user,admin&#34;&gt;
        &lt;li&gt;&lt;a href=&#34;&#34;&gt;用户管理&lt;/a&gt;
            &lt;ul&gt;
                &lt;shiro:hasPermission name=&#34;user:add:*&#34;&gt;
                &lt;li&gt;&lt;a href=&#34;&#34;&gt;添加&lt;/a&gt;&lt;/li&gt;
                &lt;/shiro:hasPermission&gt;
                &lt;shiro:hasPermission name=&#34;user:delete:*&#34;&gt;
                    &lt;li&gt;&lt;a href=&#34;&#34;&gt;删除&lt;/a&gt;&lt;/li&gt;
                &lt;/shiro:hasPermission&gt;
                &lt;shiro:hasPermission name=&#34;user:update:*&#34;&gt;
                    &lt;li&gt;&lt;a href=&#34;&#34;&gt;修改&lt;/a&gt;&lt;/li&gt;
                &lt;/shiro:hasPermission&gt;
                &lt;shiro:hasPermission name=&#34;user:find:*&#34;&gt;
                    &lt;li&gt;&lt;a href=&#34;&#34;&gt;查询&lt;/a&gt;&lt;/li&gt;
                &lt;/shiro:hasPermission&gt;
            &lt;/ul&gt;
        &lt;/li&gt;
        &lt;/shiro:hasAnyRoles&gt;
        &lt;shiro:hasRole name=&#34;admin&#34;&gt;
            &lt;li&gt;&lt;a href=&#34;&#34;&gt;商品管理&lt;/a&gt;&lt;/li&gt;
            &lt;li&gt;&lt;a href=&#34;&#34;&gt;订单管理&lt;/a&gt;&lt;/li&gt;
            &lt;li&gt;&lt;a href=&#34;&#34;&gt;物流管理&lt;/a&gt;&lt;/li&gt;
        &lt;/shiro:hasRole&gt;
</code></pre><h5 id=1代码方式授权>1.代码方式授权<a hidden class=anchor aria-hidden=true href=#1代码方式授权>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@RequestMapping</span>(<span style=color:#e6db74>&#34;save&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>save</span>(){
</span></span><span style=display:flex><span>  System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;进入方法&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#75715e>//获取主体对象</span>
</span></span><span style=display:flex><span>  Subject subject <span style=color:#f92672>=</span> SecurityUtils.<span style=color:#a6e22e>getSubject</span>();
</span></span><span style=display:flex><span>  <span style=color:#75715e>//代码方式</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (subject.<span style=color:#a6e22e>hasRole</span>(<span style=color:#e6db74>&#34;admin&#34;</span>)) {
</span></span><span style=display:flex><span>    System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;保存订单!&#34;</span>);
</span></span><span style=display:flex><span>  }<span style=color:#66d9ef>else</span>{
</span></span><span style=display:flex><span>    System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;无权访问!&#34;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#75715e>//基于权限字符串</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>//....</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;redirect:/index.jsp&#34;</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><img alt=image-20200527203343928 loading=lazy src=/posts/java/shiro%E7%AC%94%E8%AE%B0/image-20200527203343928.png></p><h5 id=2方法调用授权>2.方法调用授权<a hidden class=anchor aria-hidden=true href=#2方法调用授权>#</a></h5><ul><li>@RequiresRoles 用来基于角色进行授权</li><li>@RequiresPermissions 用来基于权限进行授权</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@RequiresRoles</span>(value<span style=color:#f92672>=</span>{<span style=color:#e6db74>&#34;admin&#34;</span>,<span style=color:#e6db74>&#34;user&#34;</span>})<span style=color:#75715e>//用来判断角色  同时具有 admin user</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RequiresPermissions</span>(<span style=color:#e6db74>&#34;user:update:01&#34;</span>) <span style=color:#75715e>//用来判断权限字符串</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RequestMapping</span>(<span style=color:#e6db74>&#34;save&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>save</span>(){
</span></span><span style=display:flex><span>  System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;进入方法&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;redirect:/index.jsp&#34;</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><img alt=image-20200527203415114 loading=lazy src=/posts/java/shiro%E7%AC%94%E8%AE%B0/image-20200527203415114.png></p><hr><h5 id=3授权数据持久化>3.授权数据持久化<a hidden class=anchor aria-hidden=true href=#3授权数据持久化>#</a></h5><p><img alt=image-20200527204839080 loading=lazy src=/posts/java/shiro%E7%AC%94%E8%AE%B0/image-20200527204839080.png></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SET</span> <span style=color:#66d9ef>NAMES</span> utf8mb4;
</span></span><span style=display:flex><span><span style=color:#66d9ef>SET</span> FOREIGN_KEY_CHECKS <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- ----------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e>-- Table structure for t_pers
</span></span></span><span style=display:flex><span><span style=color:#75715e>-- ----------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>EXISTS</span> <span style=color:#f92672>`</span>t_pers<span style=color:#f92672>`</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#f92672>`</span>t_pers<span style=color:#f92672>`</span> (
</span></span><span style=display:flex><span>  <span style=color:#f92672>`</span>id<span style=color:#f92672>`</span> int(<span style=color:#ae81ff>6</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> AUTO_INCREMENT,
</span></span><span style=display:flex><span>  <span style=color:#f92672>`</span>name<span style=color:#f92672>`</span> varchar(<span style=color:#ae81ff>80</span>) <span style=color:#66d9ef>DEFAULT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>`</span>url<span style=color:#f92672>`</span> varchar(<span style=color:#ae81ff>255</span>) <span style=color:#66d9ef>DEFAULT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> (<span style=color:#f92672>`</span>id<span style=color:#f92672>`</span>)
</span></span><span style=display:flex><span>) ENGINE<span style=color:#f92672>=</span>InnoDB <span style=color:#66d9ef>DEFAULT</span> CHARSET<span style=color:#f92672>=</span>utf8;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- ----------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e>-- Table structure for t_role
</span></span></span><span style=display:flex><span><span style=color:#75715e>-- ----------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>EXISTS</span> <span style=color:#f92672>`</span>t_role<span style=color:#f92672>`</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#f92672>`</span>t_role<span style=color:#f92672>`</span> (
</span></span><span style=display:flex><span>  <span style=color:#f92672>`</span>id<span style=color:#f92672>`</span> int(<span style=color:#ae81ff>6</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> AUTO_INCREMENT,
</span></span><span style=display:flex><span>  <span style=color:#f92672>`</span>name<span style=color:#f92672>`</span> varchar(<span style=color:#ae81ff>60</span>) <span style=color:#66d9ef>DEFAULT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> (<span style=color:#f92672>`</span>id<span style=color:#f92672>`</span>)
</span></span><span style=display:flex><span>) ENGINE<span style=color:#f92672>=</span>InnoDB <span style=color:#66d9ef>DEFAULT</span> CHARSET<span style=color:#f92672>=</span>utf8;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- ----------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e>-- Table structure for t_role_perms
</span></span></span><span style=display:flex><span><span style=color:#75715e>-- ----------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>EXISTS</span> <span style=color:#f92672>`</span>t_role_perms<span style=color:#f92672>`</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#f92672>`</span>t_role_perms<span style=color:#f92672>`</span> (
</span></span><span style=display:flex><span>  <span style=color:#f92672>`</span>id<span style=color:#f92672>`</span> int(<span style=color:#ae81ff>6</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>`</span>roleid<span style=color:#f92672>`</span> int(<span style=color:#ae81ff>6</span>) <span style=color:#66d9ef>DEFAULT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>`</span>permsid<span style=color:#f92672>`</span> int(<span style=color:#ae81ff>6</span>) <span style=color:#66d9ef>DEFAULT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> (<span style=color:#f92672>`</span>id<span style=color:#f92672>`</span>)
</span></span><span style=display:flex><span>) ENGINE<span style=color:#f92672>=</span>InnoDB <span style=color:#66d9ef>DEFAULT</span> CHARSET<span style=color:#f92672>=</span>utf8;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- ----------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e>-- Table structure for t_user
</span></span></span><span style=display:flex><span><span style=color:#75715e>-- ----------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>EXISTS</span> <span style=color:#f92672>`</span>t_user<span style=color:#f92672>`</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#f92672>`</span>t_user<span style=color:#f92672>`</span> (
</span></span><span style=display:flex><span>  <span style=color:#f92672>`</span>id<span style=color:#f92672>`</span> int(<span style=color:#ae81ff>6</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> AUTO_INCREMENT,
</span></span><span style=display:flex><span>  <span style=color:#f92672>`</span>username<span style=color:#f92672>`</span> varchar(<span style=color:#ae81ff>40</span>) <span style=color:#66d9ef>DEFAULT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>`</span>password<span style=color:#f92672>`</span> varchar(<span style=color:#ae81ff>40</span>) <span style=color:#66d9ef>DEFAULT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>`</span>salt<span style=color:#f92672>`</span> varchar(<span style=color:#ae81ff>255</span>) <span style=color:#66d9ef>DEFAULT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> (<span style=color:#f92672>`</span>id<span style=color:#f92672>`</span>)
</span></span><span style=display:flex><span>) ENGINE<span style=color:#f92672>=</span>InnoDB AUTO_INCREMENT<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> <span style=color:#66d9ef>DEFAULT</span> CHARSET<span style=color:#f92672>=</span>utf8;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- ----------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e>-- Table structure for t_user_role
</span></span></span><span style=display:flex><span><span style=color:#75715e>-- ----------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>EXISTS</span> <span style=color:#f92672>`</span>t_user_role<span style=color:#f92672>`</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#f92672>`</span>t_user_role<span style=color:#f92672>`</span> (
</span></span><span style=display:flex><span>  <span style=color:#f92672>`</span>id<span style=color:#f92672>`</span> int(<span style=color:#ae81ff>6</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>`</span>userid<span style=color:#f92672>`</span> int(<span style=color:#ae81ff>6</span>) <span style=color:#66d9ef>DEFAULT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>`</span>roleid<span style=color:#f92672>`</span> int(<span style=color:#ae81ff>6</span>) <span style=color:#66d9ef>DEFAULT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> (<span style=color:#f92672>`</span>id<span style=color:#f92672>`</span>)
</span></span><span style=display:flex><span>) ENGINE<span style=color:#f92672>=</span>InnoDB <span style=color:#66d9ef>DEFAULT</span> CHARSET<span style=color:#f92672>=</span>utf8;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SET</span> FOREIGN_KEY_CHECKS <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span></code></pre></div><hr><h5 id=4创建dao方法>4.创建dao方法<a hidden class=anchor aria-hidden=true href=#4创建dao方法>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span> <span style=color:#75715e>//根据用户名查询所有角色</span>
</span></span><span style=display:flex><span>User <span style=color:#a6e22e>findRolesByUserName</span>(String username);
</span></span><span style=display:flex><span><span style=color:#75715e>//根据角色id查询权限集合</span>
</span></span><span style=display:flex><span>List<span style=color:#f92672>&lt;</span>Perms<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>findPermsByRoleId</span>(String id);
</span></span></code></pre></div><h5 id=5mapper实现>5.mapper实现<a hidden class=anchor aria-hidden=true href=#5mapper实现>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;resultMap</span> <span style=color:#a6e22e>id=</span><span style=color:#e6db74>&#34;userMap&#34;</span> <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#34;User&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;id</span> <span style=color:#a6e22e>column=</span><span style=color:#e6db74>&#34;uid&#34;</span> <span style=color:#a6e22e>property=</span><span style=color:#e6db74>&#34;id&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;result</span> <span style=color:#a6e22e>column=</span><span style=color:#e6db74>&#34;username&#34;</span> <span style=color:#a6e22e>property=</span><span style=color:#e6db74>&#34;username&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>&lt;!--角色信息--&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;collection</span> <span style=color:#a6e22e>property=</span><span style=color:#e6db74>&#34;roles&#34;</span> <span style=color:#a6e22e>javaType=</span><span style=color:#e6db74>&#34;list&#34;</span> <span style=color:#a6e22e>ofType=</span><span style=color:#e6db74>&#34;Role&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;id</span> <span style=color:#a6e22e>column=</span><span style=color:#e6db74>&#34;id&#34;</span> <span style=color:#a6e22e>property=</span><span style=color:#e6db74>&#34;id&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;result</span> <span style=color:#a6e22e>column=</span><span style=color:#e6db74>&#34;rname&#34;</span> <span style=color:#a6e22e>property=</span><span style=color:#e6db74>&#34;name&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/collection&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/resultMap&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;select</span> <span style=color:#a6e22e>id=</span><span style=color:#e6db74>&#34;findRolesByUserName&#34;</span> <span style=color:#a6e22e>parameterType=</span><span style=color:#e6db74>&#34;String&#34;</span> <span style=color:#a6e22e>resultMap=</span><span style=color:#e6db74>&#34;userMap&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>  SELECT u.id uid,u.username,r.id,r.NAME rname
</span></span><span style=display:flex><span>  FROM t_user u
</span></span><span style=display:flex><span>  LEFT JOIN t_user_role ur
</span></span><span style=display:flex><span>  ON u.id=ur.userid
</span></span><span style=display:flex><span>  LEFT JOIN t_role r
</span></span><span style=display:flex><span>  ON ur.roleid=r.id
</span></span><span style=display:flex><span>  WHERE u.username=#{username}
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/select&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;select</span> <span style=color:#a6e22e>id=</span><span style=color:#e6db74>&#34;findPermsByRoleId&#34;</span> <span style=color:#a6e22e>parameterType=</span><span style=color:#e6db74>&#34;String&#34;</span> <span style=color:#a6e22e>resultType=</span><span style=color:#e6db74>&#34;Perms&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>  SELECT p.id,p.NAME,p.url,r.NAME
</span></span><span style=display:flex><span>  FROM t_role r
</span></span><span style=display:flex><span>  LEFT JOIN t_role_perms rp
</span></span><span style=display:flex><span>  ON r.id=rp.roleid
</span></span><span style=display:flex><span>  LEFT JOIN t_perms p ON rp.permsid=p.id
</span></span><span style=display:flex><span>  WHERE r.id=#{id}
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/select&gt;</span>
</span></span></code></pre></div><h5 id=6service接口>6.Service接口<a hidden class=anchor aria-hidden=true href=#6service接口>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>//根据用户名查询所有角色</span>
</span></span><span style=display:flex><span>User <span style=color:#a6e22e>findRolesByUserName</span>(String username);
</span></span><span style=display:flex><span><span style=color:#75715e>//根据角色id查询权限集合</span>
</span></span><span style=display:flex><span>List<span style=color:#f92672>&lt;</span>Perms<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>findPermsByRoleId</span>(String id);
</span></span></code></pre></div><h5 id=7service实现>7.Service实现<a hidden class=anchor aria-hidden=true href=#7service实现>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> List<span style=color:#f92672>&lt;</span>Perms<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>findPermsByRoleId</span>(String id) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> userDAO.<span style=color:#a6e22e>findPermsByRoleId</span>(id);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> User <span style=color:#a6e22e>findRolesByUserName</span>(String username) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> userDAO.<span style=color:#a6e22e>findRolesByUserName</span>(username);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=8修改自定义realm>8.修改自定义realm<a hidden class=anchor aria-hidden=true href=#8修改自定义realm>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CustomerRealm</span> <span style=color:#66d9ef>extends</span> AuthorizingRealm {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> AuthorizationInfo <span style=color:#a6e22e>doGetAuthorizationInfo</span>(PrincipalCollection principals) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>//获取身份信息</span>
</span></span><span style=display:flex><span>        String primaryPrincipal <span style=color:#f92672>=</span> (String) principals.<span style=color:#a6e22e>getPrimaryPrincipal</span>();
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;调用授权验证: &#34;</span><span style=color:#f92672>+</span>primaryPrincipal);
</span></span><span style=display:flex><span>        <span style=color:#75715e>//根据主身份信息获取角色 和 权限信息</span>
</span></span><span style=display:flex><span>        UserService userService <span style=color:#f92672>=</span> (UserService) ApplicationContextUtils.<span style=color:#a6e22e>getBean</span>(<span style=color:#e6db74>&#34;userService&#34;</span>);
</span></span><span style=display:flex><span>        User user <span style=color:#f92672>=</span> userService.<span style=color:#a6e22e>findRolesByUserName</span>(primaryPrincipal);
</span></span><span style=display:flex><span>        <span style=color:#75715e>//授权角色信息</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span>CollectionUtils.<span style=color:#a6e22e>isEmpty</span>(user.<span style=color:#a6e22e>getRoles</span>())){
</span></span><span style=display:flex><span>            SimpleAuthorizationInfo simpleAuthorizationInfo <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SimpleAuthorizationInfo();
</span></span><span style=display:flex><span>            user.<span style=color:#a6e22e>getRoles</span>().<span style=color:#a6e22e>forEach</span>(role<span style=color:#f92672>-&gt;</span>{
</span></span><span style=display:flex><span>                simpleAuthorizationInfo.<span style=color:#a6e22e>addRole</span>(role.<span style=color:#a6e22e>getName</span>());
</span></span><span style=display:flex><span>                <span style=color:#75715e>//权限信息</span>
</span></span><span style=display:flex><span>                List<span style=color:#f92672>&lt;</span>Perms<span style=color:#f92672>&gt;</span> perms <span style=color:#f92672>=</span> userService.<span style=color:#a6e22e>findPermsByRoleId</span>(role.<span style=color:#a6e22e>getId</span>());
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span>CollectionUtils.<span style=color:#a6e22e>isEmpty</span>(perms)){
</span></span><span style=display:flex><span>                    perms.<span style=color:#a6e22e>forEach</span>(perm<span style=color:#f92672>-&gt;</span>{
</span></span><span style=display:flex><span>                        simpleAuthorizationInfo.<span style=color:#a6e22e>addStringPermission</span>(perm.<span style=color:#a6e22e>getName</span>());
</span></span><span style=display:flex><span>                    });
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            });
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> simpleAuthorizationInfo;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><img alt=image-20200527213821611 loading=lazy src=/posts/java/shiro%E7%AC%94%E8%AE%B0/image-20200527213821611.png></p><h5 id=9启动测试>9.启动测试<a hidden class=anchor aria-hidden=true href=#9启动测试>#</a></h5><hr><h3 id=69-使用cachemanager>6.9 使用CacheManager<a hidden class=anchor aria-hidden=true href=#69-使用cachemanager>#</a></h3><h4 id=1cache-作用>1.Cache 作用<a hidden class=anchor aria-hidden=true href=#1cache-作用>#</a></h4><ul><li>Cache 缓存: <strong>计算机内存中一段数据</strong></li><li>作用: <strong>用来减轻DB的访问压力,从而提高系统的查询效率</strong></li><li>流程:</li></ul><p><img alt=image-20200530090656417 loading=lazy src=/posts/java/shiro%E7%AC%94%E8%AE%B0/image-20200530090656417.png></p><h4 id=2使用shiro中默认ehcache实现缓存>2.使用shiro中默认EhCache实现缓存<a hidden class=anchor aria-hidden=true href=#2使用shiro中默认ehcache实现缓存>#</a></h4><h5 id=1引入依赖>1.引入依赖<a hidden class=anchor aria-hidden=true href=#1引入依赖>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;!--引入shiro和ehcache--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;groupId&gt;</span>org.apache.shiro<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;artifactId&gt;</span>shiro-ehcache<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;version&gt;</span>1.5.3<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></div><h5 id=2开启缓存>2.开启缓存<a hidden class=anchor aria-hidden=true href=#2开启缓存>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>//3.创建自定义realm</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Realm <span style=color:#a6e22e>getRealm</span>(){
</span></span><span style=display:flex><span>        CustomerRealm customerRealm <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CustomerRealm();
</span></span><span style=display:flex><span>        <span style=color:#75715e>//修改凭证校验匹配器</span>
</span></span><span style=display:flex><span>        HashedCredentialsMatcher credentialsMatcher <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashedCredentialsMatcher();
</span></span><span style=display:flex><span>        <span style=color:#75715e>//设置加密算法为md5</span>
</span></span><span style=display:flex><span>        credentialsMatcher.<span style=color:#a6e22e>setHashAlgorithmName</span>(<span style=color:#e6db74>&#34;MD5&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#75715e>//设置散列次数</span>
</span></span><span style=display:flex><span>        credentialsMatcher.<span style=color:#a6e22e>setHashIterations</span>(1024);
</span></span><span style=display:flex><span>        customerRealm.<span style=color:#a6e22e>setCredentialsMatcher</span>(credentialsMatcher);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//开启缓存管理器</span>
</span></span><span style=display:flex><span>        customerRealm.<span style=color:#a6e22e>setCachingEnabled</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>        customerRealm.<span style=color:#a6e22e>setAuthorizationCachingEnabled</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>        customerRealm.<span style=color:#a6e22e>setAuthorizationCachingEnabled</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>        customerRealm.<span style=color:#a6e22e>setCacheManager</span>(<span style=color:#66d9ef>new</span> EhCacheManager());
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> customerRealm;
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p><img alt=image-20200529173859939 loading=lazy src=/posts/java/shiro%E7%AC%94%E8%AE%B0/image-20200529173859939.png></p><h5 id=3启动刷新页面进行测试>3.启动刷新页面进行测试<a hidden class=anchor aria-hidden=true href=#3启动刷新页面进行测试>#</a></h5><ul><li>注意:如果控制台没有任何sql展示说明缓存已经开启</li></ul><h4 id=3shiro中使用redis作为缓存实现>3.shiro中使用Redis作为缓存实现<a hidden class=anchor aria-hidden=true href=#3shiro中使用redis作为缓存实现>#</a></h4><h5 id=1引入redis依赖>1.引入redis依赖<a hidden class=anchor aria-hidden=true href=#1引入redis依赖>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;!--redis整合springboot--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;artifactId&gt;</span>spring-boot-starter-data-redis<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></div><h5 id=2配置redis连接>2.配置redis连接<a hidden class=anchor aria-hidden=true href=#2配置redis连接>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-properties data-lang=properties><span style=display:flex><span><span style=color:#a6e22e>spring.redis.port</span><span style=color:#f92672>=</span><span style=color:#e6db74>6379</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.redis.host</span><span style=color:#f92672>=</span><span style=color:#e6db74>localhost</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.redis.database</span><span style=color:#f92672>=</span><span style=color:#e6db74>0</span>
</span></span></code></pre></div><p><img alt=image-20200530084616799 loading=lazy src=/posts/java/shiro%E7%AC%94%E8%AE%B0/image-20200530084616799.png></p><h5 id=3启动redis服务>3.启动redis服务<a hidden class=anchor aria-hidden=true href=#3启动redis服务>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>➜</span>  bin ls
</span></span><span style=display:flex><span>dump.rdb        redis-check-aof redis-cli       redis-server    redis.conf
</span></span><span style=display:flex><span>redis-benchmark redis-check-rdb redis-sentinel  redis-trib.rb
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>➜</span>  bin ./redis-server redis.conf
</span></span></code></pre></div><p><img alt=image-20200530081954871 loading=lazy src=/posts/java/shiro%E7%AC%94%E8%AE%B0/image-20200530081954871.png></p><h5 id=4开发rediscachemanager>4.开发RedisCacheManager<a hidden class=anchor aria-hidden=true href=#4开发rediscachemanager>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RedisCacheManager</span> <span style=color:#66d9ef>implements</span> CacheManager {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#f92672>&lt;</span>K, V<span style=color:#f92672>&gt;</span> Cache<span style=color:#f92672>&lt;</span>K, V<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getCache</span>(String cacheName) <span style=color:#66d9ef>throws</span> CacheException {
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;缓存名称: &#34;</span><span style=color:#f92672>+</span>cacheName);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> RedisCache<span style=color:#f92672>&lt;</span>K,V<span style=color:#f92672>&gt;</span>(cacheName);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=5开rediscache实现>5.开RedisCache实现<a hidden class=anchor aria-hidden=true href=#5开rediscache实现>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RedisCache</span><span style=color:#f92672>&lt;</span>K,V<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>implements</span> Cache<span style=color:#f92672>&lt;</span>K,V<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String cacheName;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>RedisCache</span>() {
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>RedisCache</span>(String cacheName) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>cacheName</span> <span style=color:#f92672>=</span> cacheName;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> V <span style=color:#a6e22e>get</span>(K k) <span style=color:#66d9ef>throws</span> CacheException {
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;获取缓存:&#34;</span><span style=color:#f92672>+</span> k);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> (V) getRedisTemplate().<span style=color:#a6e22e>opsForHash</span>().<span style=color:#a6e22e>get</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>cacheName</span>,k.<span style=color:#a6e22e>toString</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> V <span style=color:#a6e22e>put</span>(K k, V v) <span style=color:#66d9ef>throws</span> CacheException {
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;设置缓存key: &#34;</span><span style=color:#f92672>+</span>k<span style=color:#f92672>+</span><span style=color:#e6db74>&#34; value:&#34;</span><span style=color:#f92672>+</span>v);
</span></span><span style=display:flex><span>        getRedisTemplate().<span style=color:#a6e22e>opsForHash</span>().<span style=color:#a6e22e>put</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>cacheName</span>,k.<span style=color:#a6e22e>toString</span>(),v);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> V <span style=color:#a6e22e>remove</span>(K k) <span style=color:#66d9ef>throws</span> CacheException {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> (V) getRedisTemplate().<span style=color:#a6e22e>opsForHash</span>().<span style=color:#a6e22e>delete</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>cacheName</span>,k.<span style=color:#a6e22e>toString</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> v <span style=color:#a6e22e>remove</span>(k k) <span style=color:#66d9ef>throws</span> CacheException {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> (v) getRedisTemplate().<span style=color:#a6e22e>opsForHash</span>().<span style=color:#a6e22e>delete</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>cacheName</span>,k.<span style=color:#a6e22e>toString</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>clear</span>() <span style=color:#66d9ef>throws</span> CacheException {
</span></span><span style=display:flex><span>        getRedisTemplate().<span style=color:#a6e22e>delete</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>cacheName</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>size</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> getRedisTemplate().<span style=color:#a6e22e>opsForHash</span>().<span style=color:#a6e22e>size</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>cacheName</span>).<span style=color:#a6e22e>intValue</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Set<span style=color:#f92672>&lt;</span>k<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>keys</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> getRedisTemplate().<span style=color:#a6e22e>opsForHash</span>().<span style=color:#a6e22e>keys</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>cacheName</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Collection<span style=color:#f92672>&lt;</span>v<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>values</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> getRedisTemplate().<span style=color:#a6e22e>opsForHash</span>().<span style=color:#a6e22e>values</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>cacheName</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> RedisTemplate <span style=color:#a6e22e>getRedisTemplate</span>(){
</span></span><span style=display:flex><span>        RedisTemplate redisTemplate <span style=color:#f92672>=</span> (RedisTemplate) ApplicationContextUtils.<span style=color:#a6e22e>getBean</span>(<span style=color:#e6db74>&#34;redisTemplate&#34;</span>);
</span></span><span style=display:flex><span>        redisTemplate.<span style=color:#a6e22e>setKeySerializer</span>(<span style=color:#66d9ef>new</span> StringRedisSerializer());
</span></span><span style=display:flex><span>        redisTemplate.<span style=color:#a6e22e>setHashKeySerializer</span>(<span style=color:#66d9ef>new</span> StringRedisSerializer());
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> redisTemplate;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//封装获取redisTemplate</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> RedisTemplate <span style=color:#a6e22e>getRedisTemplate</span>(){
</span></span><span style=display:flex><span>        RedisTemplate redisTemplate <span style=color:#f92672>=</span> (RedisTemplate) ApplicationContextUtils.<span style=color:#a6e22e>getBean</span>(<span style=color:#e6db74>&#34;redisTemplate&#34;</span>);
</span></span><span style=display:flex><span>        redisTemplate.<span style=color:#a6e22e>setKeySerializer</span>(<span style=color:#66d9ef>new</span> StringRedisSerializer());
</span></span><span style=display:flex><span>        redisTemplate.<span style=color:#a6e22e>setHashKeySerializer</span>(<span style=color:#66d9ef>new</span> StringRedisSerializer());
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> redisTemplate;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=6启动项目测试发现报错>6.启动项目测试发现报错<a hidden class=anchor aria-hidden=true href=#6启动项目测试发现报错>#</a></h5><p><img alt=image-20200530100850618 loading=lazy src=/posts/java/shiro%E7%AC%94%E8%AE%B0/image-20200530100850618.png></p><p><img alt=image-20200530100948598 loading=lazy src=/posts/java/shiro%E7%AC%94%E8%AE%B0/image-20200530100948598.png></p><ul><li><p>错误解释: <strong>由于shiro中提供的simpleByteSource实现没有实现序列化,所有在认证时出现错误信息</strong></p></li><li><p>解决方案: <strong>需要自动salt实现序列化</strong></p><ul><li><p>自定义salt实现序列化</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>//自定义salt实现  实现序列化接口</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyByteSource</span> <span style=color:#66d9ef>extends</span> SimpleByteSource <span style=color:#66d9ef>implements</span> Serializable {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>MyByteSource</span>(String string) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span>(string);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li><li><p>在realm中使用自定义salt</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span> <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>protected</span> AuthenticationInfo <span style=color:#a6e22e>doGetAuthenticationInfo</span>(AuthenticationToken token) <span style=color:#66d9ef>throws</span> AuthenticationException {
</span></span><span style=display:flex><span>  System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;==========================&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#75715e>//根据身份信息</span>
</span></span><span style=display:flex><span>  String principal <span style=color:#f92672>=</span> (String) token.<span style=color:#a6e22e>getPrincipal</span>();
</span></span><span style=display:flex><span>  <span style=color:#75715e>//在工厂中获取service对象</span>
</span></span><span style=display:flex><span>  UserService userService <span style=color:#f92672>=</span> (UserService) ApplicationContextUtils.<span style=color:#a6e22e>getBean</span>(<span style=color:#e6db74>&#34;userService&#34;</span>);
</span></span><span style=display:flex><span>  User user <span style=color:#f92672>=</span> userService.<span style=color:#a6e22e>findByUserName</span>(principal);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span>ObjectUtils.<span style=color:#a6e22e>isEmpty</span>(user)){
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> SimpleAuthenticationInfo(user.<span style=color:#a6e22e>getUsername</span>(),user.<span style=color:#a6e22e>getPassword</span>(), 
</span></span><span style=display:flex><span>                                      <span style=color:#66d9ef>new</span> MyByteSource(user.<span style=color:#a6e22e>getSalt</span>()),<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getName</span>());
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><img alt=image-20200530101301543 loading=lazy src=/posts/java/shiro%E7%AC%94%E8%AE%B0/image-20200530101301543.png></p></li></ul></li></ul><h5 id=7再次启动测试发现可以成功放入redis缓存>7.再次启动测试,发现可以成功放入redis缓存<a hidden class=anchor aria-hidden=true href=#7再次启动测试发现可以成功放入redis缓存>#</a></h5><p><img alt=image-20200530101617692 loading=lazy src=/posts/java/shiro%E7%AC%94%E8%AE%B0/image-20200530101617692.png></p><hr><h4 id=4-加入验证码验证>4. 加入验证码验证<a hidden class=anchor aria-hidden=true href=#4-加入验证码验证>#</a></h4><h5 id=0开发页面加入验证码>0.开发页面加入验证码<a hidden class=anchor aria-hidden=true href=#0开发页面加入验证码>#</a></h5><ul><li><p>开发控制器</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@RequestMapping</span>(<span style=color:#e6db74>&#34;getImage&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>getImage</span>(HttpSession session, HttpServletResponse response) <span style=color:#66d9ef>throws</span> IOException {
</span></span><span style=display:flex><span>  <span style=color:#75715e>//生成验证码</span>
</span></span><span style=display:flex><span>  String code <span style=color:#f92672>=</span> VerifyCodeUtils.<span style=color:#a6e22e>generateVerifyCode</span>(4);
</span></span><span style=display:flex><span>  <span style=color:#75715e>//验证码放入session</span>
</span></span><span style=display:flex><span>  session.<span style=color:#a6e22e>setAttribute</span>(<span style=color:#e6db74>&#34;code&#34;</span>,code);
</span></span><span style=display:flex><span>  <span style=color:#75715e>//验证码存入图片</span>
</span></span><span style=display:flex><span>  ServletOutputStream os <span style=color:#f92672>=</span> response.<span style=color:#a6e22e>getOutputStream</span>();
</span></span><span style=display:flex><span>  response.<span style=color:#a6e22e>setContentType</span>(<span style=color:#e6db74>&#34;image/png&#34;</span>);
</span></span><span style=display:flex><span>  VerifyCodeUtils.<span style=color:#a6e22e>outputImage</span>(220,60,os,code);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li><li><p>放行验证码</p><p><img alt=image-20200530141757606 loading=lazy src=/posts/java/shiro%E7%AC%94%E8%AE%B0/image-20200530141757606.png></p></li><li><p>开发页面</p><p><img alt=image-20200530141828004 loading=lazy src=/posts/java/shiro%E7%AC%94%E8%AE%B0/image-20200530141828004.png></p></li><li><p>修改认证流程</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@RequestMapping</span>(<span style=color:#e6db74>&#34;login&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>login</span>(String username, String password,String code,HttpSession session) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>//比较验证码</span>
</span></span><span style=display:flex><span>        String codes <span style=color:#f92672>=</span> (String) session.<span style=color:#a6e22e>getAttribute</span>(<span style=color:#e6db74>&#34;code&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (codes.<span style=color:#a6e22e>equalsIgnoreCase</span>(code)){
</span></span><span style=display:flex><span>                <span style=color:#75715e>//获取主体对象</span>
</span></span><span style=display:flex><span>                Subject subject <span style=color:#f92672>=</span> SecurityUtils.<span style=color:#a6e22e>getSubject</span>();
</span></span><span style=display:flex><span>                    subject.<span style=color:#a6e22e>login</span>(<span style=color:#66d9ef>new</span> UsernamePasswordToken(username, password));
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;redirect:/index.jsp&#34;</span>;
</span></span><span style=display:flex><span>            }<span style=color:#66d9ef>else</span>{
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException(<span style=color:#e6db74>&#34;验证码错误!&#34;</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (UnknownAccountException e) {
</span></span><span style=display:flex><span>            e.<span style=color:#a6e22e>printStackTrace</span>();
</span></span><span style=display:flex><span>            System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;用户名错误!&#34;</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (IncorrectCredentialsException e) {
</span></span><span style=display:flex><span>            e.<span style=color:#a6e22e>printStackTrace</span>();
</span></span><span style=display:flex><span>            System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;密码错误!&#34;</span>);
</span></span><span style=display:flex><span>        }<span style=color:#66d9ef>catch</span> (Exception e){
</span></span><span style=display:flex><span>            e.<span style=color:#a6e22e>printStackTrace</span>();
</span></span><span style=display:flex><span>            System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(e.<span style=color:#a6e22e>getMessage</span>());
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;redirect:/login.jsp&#34;</span>;
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div></li><li><p>修改salt不能序列化的问题</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>//自定义salt实现  实现序列化接口</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyByteSource</span> <span style=color:#66d9ef>implements</span> ByteSource,Serializable {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span>  <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> bytes;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String cachedHex;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String cachedBase64;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//加入无参数构造方法实现序列化和反序列化</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>MyByteSource</span>(){
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>MyByteSource</span>(<span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> bytes) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>bytes</span> <span style=color:#f92672>=</span> bytes;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>MyByteSource</span>(<span style=color:#66d9ef>char</span><span style=color:#f92672>[]</span> chars) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>bytes</span> <span style=color:#f92672>=</span> CodecSupport.<span style=color:#a6e22e>toBytes</span>(chars);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>MyByteSource</span>(String string) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>bytes</span> <span style=color:#f92672>=</span> CodecSupport.<span style=color:#a6e22e>toBytes</span>(string);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>MyByteSource</span>(ByteSource source) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>bytes</span> <span style=color:#f92672>=</span> source.<span style=color:#a6e22e>getBytes</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>MyByteSource</span>(File file) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>bytes</span> <span style=color:#f92672>=</span> (<span style=color:#66d9ef>new</span> MyByteSource.<span style=color:#a6e22e>BytesHelper</span>()).<span style=color:#a6e22e>getBytes</span>(file);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>MyByteSource</span>(InputStream stream) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>bytes</span> <span style=color:#f92672>=</span> (<span style=color:#66d9ef>new</span> MyByteSource.<span style=color:#a6e22e>BytesHelper</span>()).<span style=color:#a6e22e>getBytes</span>(stream);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isCompatible</span>(Object o) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> o <span style=color:#66d9ef>instanceof</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> <span style=color:#f92672>||</span> o <span style=color:#66d9ef>instanceof</span> <span style=color:#66d9ef>char</span><span style=color:#f92672>[]</span> <span style=color:#f92672>||</span> o <span style=color:#66d9ef>instanceof</span> String <span style=color:#f92672>||</span> o <span style=color:#66d9ef>instanceof</span> ByteSource <span style=color:#f92672>||</span> o <span style=color:#66d9ef>instanceof</span> File <span style=color:#f92672>||</span> o <span style=color:#66d9ef>instanceof</span> InputStream;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> <span style=color:#a6e22e>getBytes</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>bytes</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isEmpty</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>bytes</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>==</span> 0;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>toHex</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>cachedHex</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>cachedHex</span> <span style=color:#f92672>=</span> Hex.<span style=color:#a6e22e>encodeToString</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getBytes</span>());
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>cachedHex</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>toBase64</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>cachedBase64</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>cachedBase64</span> <span style=color:#f92672>=</span> Base64.<span style=color:#a6e22e>encodeToString</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getBytes</span>());
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>cachedBase64</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>toString</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>toBase64</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>hashCode</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>bytes</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>!=</span> 0 <span style=color:#f92672>?</span> Arrays.<span style=color:#a6e22e>hashCode</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>bytes</span>) : 0;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>equals</span>(Object o) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (o <span style=color:#f92672>==</span> <span style=color:#66d9ef>this</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (o <span style=color:#66d9ef>instanceof</span> ByteSource) {
</span></span><span style=display:flex><span>            ByteSource bs <span style=color:#f92672>=</span> (ByteSource)o;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> Arrays.<span style=color:#a6e22e>equals</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getBytes</span>(), bs.<span style=color:#a6e22e>getBytes</span>());
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BytesHelper</span> <span style=color:#66d9ef>extends</span> CodecSupport {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>BytesHelper</span>() {
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> <span style=color:#a6e22e>getBytes</span>(File file) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>toBytes</span>(file);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> <span style=color:#a6e22e>getBytes</span>(InputStream stream) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>toBytes</span>(stream);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><hr></li></ul><h2 id=7shiro整合springboot之thymeleaf权限控制>7.Shiro整合springboot之thymeleaf权限控制<a hidden class=anchor aria-hidden=true href=#7shiro整合springboot之thymeleaf权限控制>#</a></h2><h3 id=1引入扩展依赖>1.引入扩展依赖<a hidden class=anchor aria-hidden=true href=#1引入扩展依赖>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>com.github.theborakompanioni<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>thymeleaf-extras-shiro<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;version&gt;</span>2.0.0<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></div><h3 id=2页面中引入命名空间>2.页面中引入命名空间<a hidden class=anchor aria-hidden=true href=#2页面中引入命名空间>#</a></h3><ul><li>xmlns:shiro=&ldquo;<a href=http://www.pollix.at/thymeleaf/shiro%22>http://www.pollix.at/thymeleaf/shiro"</a></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#f92672>html</span> <span style=color:#a6e22e>xmlns</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://www.w3.org/1999/xhtml&#34;</span> <span style=color:#a6e22e>xmlns:th</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://www.thymeleaf.org&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>xmlns:shiro</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://www.pollix.at/thymeleaf/shiro&#34;</span>&gt;
</span></span><span style=display:flex><span>......
</span></span></code></pre></div><h3 id=3常见权限控制标签使用>3.常见权限控制标签使用<a hidden class=anchor aria-hidden=true href=#3常见权限控制标签使用>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span><span style=color:#75715e>&lt;!-- 验证当前用户是否为“访客”，即未认证（包含未记住）的用户。 --&gt;</span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>p</span> <span style=color:#a6e22e>shiro:guest</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;</span>&gt;Please &lt;<span style=color:#f92672>a</span> <span style=color:#a6e22e>href</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;login.html&#34;</span>&gt;login&lt;/<span style=color:#f92672>a</span>&gt;&lt;/<span style=color:#f92672>p</span>&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!-- 认证通过或已记住的用户。 --&gt;</span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>p</span> <span style=color:#a6e22e>shiro:user</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;</span>&gt;
</span></span><span style=display:flex><span>    Welcome back John! Not John? Click &lt;<span style=color:#f92672>a</span> <span style=color:#a6e22e>href</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;login.html&#34;</span>&gt;here&lt;/<span style=color:#f92672>a</span>&gt; to login.
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>p</span>&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!-- 已认证通过的用户。不包含已记住的用户，这是与user标签的区别所在。 --&gt;</span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>p</span> <span style=color:#a6e22e>shiro:authenticated</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;</span>&gt;
</span></span><span style=display:flex><span>    Hello, &lt;<span style=color:#f92672>span</span> <span style=color:#a6e22e>shiro:principal</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;</span>&gt;&lt;/<span style=color:#f92672>span</span>&gt;, how are you today?
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>p</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>a</span> <span style=color:#a6e22e>shiro:authenticated</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;</span> <span style=color:#a6e22e>href</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;updateAccount.html&#34;</span>&gt;Update your contact information&lt;/<span style=color:#f92672>a</span>&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!-- 输出当前用户信息，通常为登录帐号信息。 --&gt;</span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>p</span>&gt;Hello, &lt;<span style=color:#f92672>shiro:principal</span>/&gt;, how are you today?&lt;/<span style=color:#f92672>p</span>&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!-- 未认证通过用户，与authenticated标签相对应。与guest标签的区别是，该标签包含已记住用户。 --&gt;</span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>p</span> <span style=color:#a6e22e>shiro:notAuthenticated</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;</span>&gt;
</span></span><span style=display:flex><span>    Please &lt;<span style=color:#f92672>a</span> <span style=color:#a6e22e>href</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;login.html&#34;</span>&gt;login&lt;/<span style=color:#f92672>a</span>&gt; in order to update your credit card information.
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>p</span>&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!-- 验证当前用户是否属于该角色。 --&gt;</span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>a</span> <span style=color:#a6e22e>shiro:hasRole</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;admin&#34;</span> <span style=color:#a6e22e>href</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;admin.html&#34;</span>&gt;Administer the system&lt;/<span style=color:#f92672>a</span>&gt;<span style=color:#75715e>&lt;!-- 拥有该角色 --&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!-- 与hasRole标签逻辑相反，当用户不属于该角色时验证通过。 --&gt;</span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>p</span> <span style=color:#a6e22e>shiro:lacksRole</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;developer&#34;</span>&gt;<span style=color:#75715e>&lt;!-- 没有该角色 --&gt;</span>
</span></span><span style=display:flex><span>    Sorry, you are not allowed to developer the system.
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>p</span>&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!-- 验证当前用户是否属于以下所有角色。 --&gt;</span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>p</span> <span style=color:#a6e22e>shiro:hasAllRoles</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;developer, 2&#34;</span>&gt;<span style=color:#75715e>&lt;!-- 角色与判断 --&gt;</span>
</span></span><span style=display:flex><span>    You are a developer and a admin.
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>p</span>&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!-- 验证当前用户是否属于以下任意一个角色。  --&gt;</span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>p</span> <span style=color:#a6e22e>shiro:hasAnyRoles</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;admin, vip, developer,1&#34;</span>&gt;<span style=color:#75715e>&lt;!-- 角色或判断 --&gt;</span>
</span></span><span style=display:flex><span>    You are a admin, vip, or developer.
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>p</span>&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--验证当前用户是否拥有指定权限。  --&gt;</span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>a</span> <span style=color:#a6e22e>shiro:hasPermission</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;userInfo:add&#34;</span> <span style=color:#a6e22e>href</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;createUser.html&#34;</span>&gt;添加用户&lt;/<span style=color:#f92672>a</span>&gt;<span style=color:#75715e>&lt;!-- 拥有权限 --&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!-- 与hasPermission标签逻辑相反，当前用户没有制定权限时，验证通过。 --&gt;</span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>p</span> <span style=color:#a6e22e>shiro:lacksPermission</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;userInfo:del&#34;</span>&gt;<span style=color:#75715e>&lt;!-- 没有权限 --&gt;</span>
</span></span><span style=display:flex><span>    Sorry, you are not allowed to delete user accounts.
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>p</span>&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!-- 验证当前用户是否拥有以下所有角色。 --&gt;</span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>p</span> <span style=color:#a6e22e>shiro:hasAllPermissions</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;userInfo:view, userInfo:add&#34;</span>&gt;<span style=color:#75715e>&lt;!-- 权限与判断 --&gt;</span>
</span></span><span style=display:flex><span>    You can see or add users.
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>p</span>&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!-- 验证当前用户是否拥有以下任意一个权限。  --&gt;</span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>p</span> <span style=color:#a6e22e>shiro:hasAnyPermissions</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;userInfo:view, userInfo:del&#34;</span>&gt;<span style=color:#75715e>&lt;!-- 权限或判断 --&gt;</span>
</span></span><span style=display:flex><span>    You can see or delete users.
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>p</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>a</span> <span style=color:#a6e22e>shiro:hasPermission</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;pp&#34;</span> <span style=color:#a6e22e>href</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;createUser.html&#34;</span>&gt;Create a new User&lt;/<span style=color:#f92672>a</span>&gt;
</span></span></code></pre></div><h3 id=4加入shiro的方言配置>4.加入shiro的方言配置<a hidden class=anchor aria-hidden=true href=#4加入shiro的方言配置>#</a></h3><ul><li>页面标签不起作用一定要记住加入方言处理</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Bean</span>(name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;shiroDialect&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> ShiroDialect <span style=color:#a6e22e>shiroDialect</span>(){
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ShiroDialect();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><img alt=image-20200601210335151 loading=lazy src=/posts/java/shiro%E7%AC%94%E8%AE%B0/image-20200601210335151.png></p></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://ethereal-lu.github.io/posts/%E5%B0%8F%E7%A2%8E%E7%89%87%E7%9F%A5%E8%AF%86/enum%E8%B5%8B%E5%80%BC/><span class=title>« Prev</span><br><span>Enum 向注解赋值问题</span>
</a><a class=next href=https://ethereal-lu.github.io/posts/java/mybatisplus%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/><span class=title>Next »</span><br><span>MyBatisPlus学习笔记</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://ethereal-lu.github.io/>lu</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>