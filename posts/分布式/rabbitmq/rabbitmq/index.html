<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>RabbitMQåŸºç¡€ | lu</title>
<meta name=keywords content><meta name=description content="ä¸€ã€æ¦‚è¿°
1.1ã€ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—
æ¶ˆæ¯ï¼šæŒ‡çš„æ˜¯ä¸¤ä¸ªåº”ç”¨é—´ä¼ é€’çš„æ•°æ®ã€‚æ•°æ®çš„ç±»å‹æœ‰å¾ˆå¤šç§å½¢å¼ï¼Œå¯èƒ½åªåŒ…å«æ–‡æœ¬å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯èƒ½åŒ…å«åµŒå…¥å¯¹è±¡ã€‚
æ¶ˆæ¯åè®®ï¼šä¸ºäº†è®©æ¶ˆæ¯å‘é€è€…å’Œæ¶ˆæ¯æ¥æ”¶è€…éƒ½èƒ½å¤Ÿæ˜ç™½æ¶ˆæ¯æ‰€æ‰¿è½½çš„ä¿¡æ¯ï¼Œå®ƒä»¬å°±éœ€è¦æŒ‰ç…§ä¸€ç§ç»Ÿä¸€çš„æ ¼å¼æè¿°æ¶ˆæ¯ã€‚
æ¶ˆæ¯é˜Ÿåˆ—ï¼šï¼ˆMessage Queueï¼Œç®€ç§°MQï¼‰ï¼Œä»å­—é¢æ„æ€ä¸Šçœ‹ï¼Œæœ¬è´¨æ˜¯ä¸ªé˜Ÿåˆ—ï¼ŒFIFOå…ˆå…¥å…ˆå‡ºï¼Œåªä¸è¿‡é˜Ÿåˆ—ä¸­å­˜æ”¾çš„å†…å®¹æ˜¯messageã€‚
æ¶ˆæ¯ä»å‘é€è€…åˆ°æ¥æ”¶è€…çš„æ–¹å¼ä¹Ÿæœ‰ä¸¤ç§ã€‚
ä¸€ç§ä¸ºå³æ—¶æ¶ˆæ¯é€šè®¯ï¼Œä¹Ÿå°±æ˜¯è¯´æ¶ˆæ¯ä»ä¸€ç«¯å‘å‡ºåï¼ˆæ¶ˆæ¯å‘é€è€…ï¼‰ç«‹å³å°±å¯ä»¥è¾¾åˆ°å¦ä¸€ç«¯ï¼ˆæ¶ˆæ¯æ¥æ”¶è€…ï¼‰ï¼Œè¿™ç§æ–¹å¼çš„å…·ä½“å®ç°å°±æ˜¯RPCï¼ˆå½“ç„¶å•çº¯çš„httpé€šè®¯ä¹Ÿæ»¡è¶³è¿™ä¸ªå®šä¹‰ï¼‰ï¼›
å¦ä¸€ç§ä¸ºå»¶è¿Ÿæ¶ˆæ¯é€šè®¯ï¼Œå³æ¶ˆæ¯ä»æŸä¸€ç«¯å‘å‡ºåï¼Œé¦–å…ˆè¿›å…¥ä¸€ä¸ªå®¹å™¨è¿›è¡Œä¸´æ—¶å­˜å‚¨ï¼Œå½“è¾¾åˆ°æŸç§æ¡ä»¶åï¼Œå†ç”±è¿™ä¸ªå®¹å™¨å‘é€ç»™å¦ä¸€ç«¯ã€‚ è¿™ä¸ªå®¹å™¨çš„ä¸€ç§å…·ä½“å®ç°å°±æ˜¯æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¦‚RabbitMQã€‚
1.2ã€ä¸ºä»€ä¹ˆä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—

åº”ç”¨è§£è€¦ï¼šä¸åŒè¿›ç¨‹ï¼ˆprocessï¼‰ä¹‹é—´ä¼ é€’æ¶ˆæ¯æ—¶ï¼Œä¸¤ä¸ªè¿›ç¨‹ä¹‹é—´è€¦åˆç¨‹åº¦è¿‡é«˜ï¼Œæ”¹åŠ¨ä¸€ä¸ªè¿›ç¨‹ï¼Œå¼•å‘å¿…é¡»ä¿®æ”¹å¦ä¸€ä¸ªè¿›ç¨‹ï¼Œä¸ºäº†éš”ç¦»è¿™ä¸¤ä¸ªè¿›ç¨‹ï¼Œåœ¨ä¸¤è¿›ç¨‹é—´æŠ½ç¦»å‡ºä¸€å±‚ï¼ˆä¸€ä¸ªæ¨¡å—ï¼‰ï¼Œæ‰€æœ‰ä¸¤è¿›ç¨‹ä¹‹é—´ä¼ é€’çš„æ¶ˆæ¯ï¼Œéƒ½å¿…é¡»é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—æ¥ä¼ é€’ï¼Œå•ç‹¬ä¿®æ”¹æŸä¸€ä¸ªè¿›ç¨‹ï¼Œä¸ä¼šå½±å“å¦ä¸€ä¸ªï¼›
æµé‡å‰Šå³°ï¼šå¦‚æ•°æ®åº“åªèƒ½åŒæ—¶å¤„ç†ä¸€ä¸‡æ¡è¯·æ±‚ï¼Œå¦‚æœæ¥äº†ä¸¤ä¸‡æ¡è¯·æ±‚å°±æ‰§è¡Œä¸€ä¸‡æ¡ï¼Œå°†å‰©ä½™ä¸€ä¸‡æ¡æ”¾åœ¨æ¶ˆæ¯é˜Ÿåˆ—é¡ºåºæ‰§è¡Œã€‚
å¼‚æ­¥å¤„ç†ï¼šA è°ƒç”¨ B å¤„ç†æ•°æ®ï¼Œä½† B å¤„ç†æ—¶é—´å¾ˆé•¿ï¼›Aå¯ä»¥ä¸ç”¨ç­‰ï¼Œå½“Bæ‰§è¡Œå®Œå°†ç»“æœæ”¾åœ¨æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå†ç”±æ¶ˆæ¯é˜Ÿåˆ—å°†ç»“æœç»™Aï¼Œè¿™æ ·å°±ä¸ç”¨è½®è¯¢æˆ–æä¾›å›è°ƒå‡½æ•°äº†ã€‚
å¹¿æ’­
æœ€ç»ˆä¸€è‡´æ€§

1.3ã€mqtt ä¸ MQ çš„åŒºåˆ«
mqttï¼šä¸€ç§é€šä¿¡åè®®ï¼Œç±»ä¼¼äººç±»äº¤è°ˆä¸­çš„æ±‰è¯­ã€è‹±è¯­ã€ä¿„è¯­ä¸­çš„ä¸€ç§è¯­è¨€è§„èŒƒ
MQï¼šä¸€ç§é€šä¿¡é€šé“ï¼Œä¹Ÿå«æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç±»ä¼¼äººç±»äº¤è°ˆä¸­çš„ç”¨ç”µè¯ã€emailã€å¾®ä¿¡çš„ä¸€ç§é€šä¿¡æ–¹å¼
jsonï¼šä¸€ç§å†…å®¹æ ¼å¼ï¼Œç±»ä¼¼äººç±»äº¤è°ˆä¸­çš„æ’æ¯”å¥ç­‰æ–¹å¼
1.4ã€RPC æ‰§è¡Œæµç¨‹
RPCï¼ˆRemote Procedure Callï¼‰è¿œç¨‹è¿‡ç¨‹è°ƒç”¨åè®®ï¼Œä¸€ç§é€šè¿‡ç½‘ç»œä»è¿œç¨‹è®¡ç®—æœºä¸Šè¯·æ±‚æœåŠ¡ï¼Œè€Œä¸éœ€è¦äº†è§£åº•å±‚ç½‘ç»œæŠ€æœ¯çš„åè®®ã€‚å…¶ä¸»è¦ç›®çš„æ˜¯åšåˆ°ä¸åŒæœåŠ¡é—´è°ƒç”¨æ–¹æ³•åƒåŒä¸€æœåŠ¡é—´è°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·ã€‚
å½“ä¸šåŠ¡éœ€è¦å¼ºä¸€è‡´æ€§ï¼Œå…³æ³¨ä¸šåŠ¡é€»è¾‘çš„å¤„ç†ç»“æœï¼Œåˆ™ RPC æ¯”æ¶ˆæ¯é˜Ÿåˆ—æ›´åˆé€‚ã€‚
å¼ºä¸€è‡´æ€§æŒ‡ä¸è®ºåœ¨ä»»ä½•æ—¶å€™è¯»å–çš„éƒ½æ˜¯æœ€æ–°çš„æ•°æ®ï¼Œæœ€ç»ˆä¸€è‡´æ€§æ˜¯å…è®¸å¯ä»¥åœ¨ä¸€æ®µæ—¶é—´å†…æ¯ä¸ªç»“ç‚¹çš„æ•°æ®ä¸ä¸€è‡´ï¼Œä½†æ˜¯ç»è¿‡ä¸€æ®µæ—¶é—´æ¯ä¸ªç»“ç‚¹çš„æ•°æ®å¿…é¡»ä¸€è‡´ï¼Œå®ƒå¼ºè°ƒçš„æ˜¯æœ€ç»ˆæ•°æ®çš„ä¸€è‡´æ€§ã€‚

å®¢æˆ·ç«¯å¤„ç†è¿‡ç¨‹ä¸­è°ƒç”¨client subï¼Œå°±åƒè°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·ï¼Œä¼ å…¥å‚æ•°
client subå°†å‚æ•°ç¼–ç»„ä¸ºæ¶ˆæ¯ï¼Œç„¶åé€šè¿‡ç³»ç»Ÿè°ƒç”¨å‘æœåŠ¡ç«¯å‘é€æ¶ˆæ¯
æœåŠ¡ç«¯å°†æ¥æ”¶åˆ°çš„æ•°æ®åŒ…ä¼ é€’ç»™server sub
server subå°†æ¥æ”¶åˆ°çš„æ•°æ®è§£ç»„ä¸ºå‚æ•°
server subå†è°ƒç”¨æœåŠ¡ç«¯çš„è¿‡ç¨‹ï¼Œè¿‡ç¨‹æ‰§è¡Œçš„ç»“æœä»¥åæ–¹å‘çš„ç›¸åŒæ­¥éª¤å“åº”ç»™å®¢æˆ·ç«¯

ä»¥ Google çš„ grpc ä¸ºä¾‹ï¼šå…ˆåœ¨ proto æ–‡ä»¶ä¸­å£°æ˜æ¥å£ï¼ŒåŒ…æ‹¬æ–¹æ³•åã€å‚æ•°å’Œè¿”å›å€¼ï¼Œç„¶åä½¿ç”¨å·¥å…·ç”Ÿæˆ go å¯ä»¥ç”¨çš„åº“ï¼›æœåŠ¡ç«¯åˆ›å»º grpc æœåŠ¡å®ä¾‹å¹¶å°†æœ¬åœ°å®ç°çš„æœåŠ¡æ³¨å†Œè¿›è¯¥å®ä¾‹ä¸­ï¼Œç„¶åç›‘å¬æœ¬åœ°ç«¯å£ï¼Œæ”¶åˆ°è¯·æ±‚åå°±æ‰§è¡Œæœ¬åœ°æ–¹æ³•å¹¶å°†ç»“æœè¿”å›ï¼›å®¢æˆ·ç«¯åˆ›å»º grpc å®¢æˆ·ç«¯å®ä¾‹ï¼Œç„¶åè°ƒç”¨ proto ä¸­å£°æ˜çš„æ–¹æ³•å³å¯è·å¾—ç»“æœã€‚
1.5ã€MQ åˆ†ç±»

ActiveMQï¼šè€ã€è¾ƒå°‘ä½¿ç”¨
Kafkaï¼šå¤§æ•°æ®å®æ—¶è®¡ç®—å’Œæ—¥å¿—é‡‡é›†æ–¹é¢å“è¶Š
RocketMQï¼šé˜¿é‡Œå¼€æºäº§å“
RabbitMQï¼šä¸»æµ

äºŒã€RabbitMQä»‹ç»
2.1ã€RabbitMQ ç®€ä»‹
RabbitMQæ˜¯ä¸€ä¸ªåœ¨AMQPï¼ˆAdvanced Message Queuing Protocol ï¼‰åŸºç¡€ä¸Šå®ç°çš„ï¼Œå¯å¤ç”¨çš„ä¼ä¸šæ¶ˆæ¯ç³»ç»Ÿã€‚å®ƒå¯ä»¥ç”¨äºå¤§å‹è½¯ä»¶ç³»ç»Ÿå„ä¸ªæ¨¡å—ä¹‹é—´çš„é«˜æ•ˆé€šä¿¡ï¼Œæ”¯æŒé«˜å¹¶å‘ï¼Œæ”¯æŒå¯æ‰©å±•ã€‚"><meta name=author content="lu"><link rel=canonical href=https://ethereal-lu.github.io/posts/%E5%88%86%E5%B8%83%E5%BC%8F/rabbitmq/rabbitmq/><link crossorigin=anonymous href=/assets/css/stylesheet.d72444526d7ecbdb0015438a7fa89054a658bf759d0542e2e5df81ce94b493ee.css integrity rel="preload stylesheet" as=style><link rel=icon href=https://ethereal-lu.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ethereal-lu.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ethereal-lu.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://ethereal-lu.github.io/apple-touch-icon.png><link rel=mask-icon href=https://ethereal-lu.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://ethereal-lu.github.io/posts/%E5%88%86%E5%B8%83%E5%BC%8F/rabbitmq/rabbitmq/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://ethereal-lu.github.io/posts/%E5%88%86%E5%B8%83%E5%BC%8F/rabbitmq/rabbitmq/"><meta property="og:site_name" content="lu"><meta property="og:title" content="RabbitMQåŸºç¡€"><meta property="og:description" content="ä¸€ã€æ¦‚è¿° 1.1ã€ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ— æ¶ˆæ¯ï¼šæŒ‡çš„æ˜¯ä¸¤ä¸ªåº”ç”¨é—´ä¼ é€’çš„æ•°æ®ã€‚æ•°æ®çš„ç±»å‹æœ‰å¾ˆå¤šç§å½¢å¼ï¼Œå¯èƒ½åªåŒ…å«æ–‡æœ¬å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯èƒ½åŒ…å«åµŒå…¥å¯¹è±¡ã€‚
æ¶ˆæ¯åè®®ï¼šä¸ºäº†è®©æ¶ˆæ¯å‘é€è€…å’Œæ¶ˆæ¯æ¥æ”¶è€…éƒ½èƒ½å¤Ÿæ˜ç™½æ¶ˆæ¯æ‰€æ‰¿è½½çš„ä¿¡æ¯ï¼Œå®ƒä»¬å°±éœ€è¦æŒ‰ç…§ä¸€ç§ç»Ÿä¸€çš„æ ¼å¼æè¿°æ¶ˆæ¯ã€‚
æ¶ˆæ¯é˜Ÿåˆ—ï¼šï¼ˆMessage Queueï¼Œç®€ç§°MQï¼‰ï¼Œä»å­—é¢æ„æ€ä¸Šçœ‹ï¼Œæœ¬è´¨æ˜¯ä¸ªé˜Ÿåˆ—ï¼ŒFIFOå…ˆå…¥å…ˆå‡ºï¼Œåªä¸è¿‡é˜Ÿåˆ—ä¸­å­˜æ”¾çš„å†…å®¹æ˜¯messageã€‚
æ¶ˆæ¯ä»å‘é€è€…åˆ°æ¥æ”¶è€…çš„æ–¹å¼ä¹Ÿæœ‰ä¸¤ç§ã€‚ ä¸€ç§ä¸ºå³æ—¶æ¶ˆæ¯é€šè®¯ï¼Œä¹Ÿå°±æ˜¯è¯´æ¶ˆæ¯ä»ä¸€ç«¯å‘å‡ºåï¼ˆæ¶ˆæ¯å‘é€è€…ï¼‰ç«‹å³å°±å¯ä»¥è¾¾åˆ°å¦ä¸€ç«¯ï¼ˆæ¶ˆæ¯æ¥æ”¶è€…ï¼‰ï¼Œè¿™ç§æ–¹å¼çš„å…·ä½“å®ç°å°±æ˜¯RPCï¼ˆå½“ç„¶å•çº¯çš„httpé€šè®¯ä¹Ÿæ»¡è¶³è¿™ä¸ªå®šä¹‰ï¼‰ï¼› å¦ä¸€ç§ä¸ºå»¶è¿Ÿæ¶ˆæ¯é€šè®¯ï¼Œå³æ¶ˆæ¯ä»æŸä¸€ç«¯å‘å‡ºåï¼Œé¦–å…ˆè¿›å…¥ä¸€ä¸ªå®¹å™¨è¿›è¡Œä¸´æ—¶å­˜å‚¨ï¼Œå½“è¾¾åˆ°æŸç§æ¡ä»¶åï¼Œå†ç”±è¿™ä¸ªå®¹å™¨å‘é€ç»™å¦ä¸€ç«¯ã€‚ è¿™ä¸ªå®¹å™¨çš„ä¸€ç§å…·ä½“å®ç°å°±æ˜¯æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¦‚RabbitMQã€‚
1.2ã€ä¸ºä»€ä¹ˆä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ— åº”ç”¨è§£è€¦ï¼šä¸åŒè¿›ç¨‹ï¼ˆprocessï¼‰ä¹‹é—´ä¼ é€’æ¶ˆæ¯æ—¶ï¼Œä¸¤ä¸ªè¿›ç¨‹ä¹‹é—´è€¦åˆç¨‹åº¦è¿‡é«˜ï¼Œæ”¹åŠ¨ä¸€ä¸ªè¿›ç¨‹ï¼Œå¼•å‘å¿…é¡»ä¿®æ”¹å¦ä¸€ä¸ªè¿›ç¨‹ï¼Œä¸ºäº†éš”ç¦»è¿™ä¸¤ä¸ªè¿›ç¨‹ï¼Œåœ¨ä¸¤è¿›ç¨‹é—´æŠ½ç¦»å‡ºä¸€å±‚ï¼ˆä¸€ä¸ªæ¨¡å—ï¼‰ï¼Œæ‰€æœ‰ä¸¤è¿›ç¨‹ä¹‹é—´ä¼ é€’çš„æ¶ˆæ¯ï¼Œéƒ½å¿…é¡»é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—æ¥ä¼ é€’ï¼Œå•ç‹¬ä¿®æ”¹æŸä¸€ä¸ªè¿›ç¨‹ï¼Œä¸ä¼šå½±å“å¦ä¸€ä¸ªï¼› æµé‡å‰Šå³°ï¼šå¦‚æ•°æ®åº“åªèƒ½åŒæ—¶å¤„ç†ä¸€ä¸‡æ¡è¯·æ±‚ï¼Œå¦‚æœæ¥äº†ä¸¤ä¸‡æ¡è¯·æ±‚å°±æ‰§è¡Œä¸€ä¸‡æ¡ï¼Œå°†å‰©ä½™ä¸€ä¸‡æ¡æ”¾åœ¨æ¶ˆæ¯é˜Ÿåˆ—é¡ºåºæ‰§è¡Œã€‚ å¼‚æ­¥å¤„ç†ï¼šA è°ƒç”¨ B å¤„ç†æ•°æ®ï¼Œä½† B å¤„ç†æ—¶é—´å¾ˆé•¿ï¼›Aå¯ä»¥ä¸ç”¨ç­‰ï¼Œå½“Bæ‰§è¡Œå®Œå°†ç»“æœæ”¾åœ¨æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå†ç”±æ¶ˆæ¯é˜Ÿåˆ—å°†ç»“æœç»™Aï¼Œè¿™æ ·å°±ä¸ç”¨è½®è¯¢æˆ–æä¾›å›è°ƒå‡½æ•°äº†ã€‚ å¹¿æ’­ æœ€ç»ˆä¸€è‡´æ€§ 1.3ã€mqtt ä¸ MQ çš„åŒºåˆ« mqttï¼šä¸€ç§é€šä¿¡åè®®ï¼Œç±»ä¼¼äººç±»äº¤è°ˆä¸­çš„æ±‰è¯­ã€è‹±è¯­ã€ä¿„è¯­ä¸­çš„ä¸€ç§è¯­è¨€è§„èŒƒ MQï¼šä¸€ç§é€šä¿¡é€šé“ï¼Œä¹Ÿå«æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç±»ä¼¼äººç±»äº¤è°ˆä¸­çš„ç”¨ç”µè¯ã€emailã€å¾®ä¿¡çš„ä¸€ç§é€šä¿¡æ–¹å¼ jsonï¼šä¸€ç§å†…å®¹æ ¼å¼ï¼Œç±»ä¼¼äººç±»äº¤è°ˆä¸­çš„æ’æ¯”å¥ç­‰æ–¹å¼
1.4ã€RPC æ‰§è¡Œæµç¨‹ RPCï¼ˆRemote Procedure Callï¼‰è¿œç¨‹è¿‡ç¨‹è°ƒç”¨åè®®ï¼Œä¸€ç§é€šè¿‡ç½‘ç»œä»è¿œç¨‹è®¡ç®—æœºä¸Šè¯·æ±‚æœåŠ¡ï¼Œè€Œä¸éœ€è¦äº†è§£åº•å±‚ç½‘ç»œæŠ€æœ¯çš„åè®®ã€‚å…¶ä¸»è¦ç›®çš„æ˜¯åšåˆ°ä¸åŒæœåŠ¡é—´è°ƒç”¨æ–¹æ³•åƒåŒä¸€æœåŠ¡é—´è°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·ã€‚
å½“ä¸šåŠ¡éœ€è¦å¼ºä¸€è‡´æ€§ï¼Œå…³æ³¨ä¸šåŠ¡é€»è¾‘çš„å¤„ç†ç»“æœï¼Œåˆ™ RPC æ¯”æ¶ˆæ¯é˜Ÿåˆ—æ›´åˆé€‚ã€‚
å¼ºä¸€è‡´æ€§æŒ‡ä¸è®ºåœ¨ä»»ä½•æ—¶å€™è¯»å–çš„éƒ½æ˜¯æœ€æ–°çš„æ•°æ®ï¼Œæœ€ç»ˆä¸€è‡´æ€§æ˜¯å…è®¸å¯ä»¥åœ¨ä¸€æ®µæ—¶é—´å†…æ¯ä¸ªç»“ç‚¹çš„æ•°æ®ä¸ä¸€è‡´ï¼Œä½†æ˜¯ç»è¿‡ä¸€æ®µæ—¶é—´æ¯ä¸ªç»“ç‚¹çš„æ•°æ®å¿…é¡»ä¸€è‡´ï¼Œå®ƒå¼ºè°ƒçš„æ˜¯æœ€ç»ˆæ•°æ®çš„ä¸€è‡´æ€§ã€‚
å®¢æˆ·ç«¯å¤„ç†è¿‡ç¨‹ä¸­è°ƒç”¨client subï¼Œå°±åƒè°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·ï¼Œä¼ å…¥å‚æ•° client subå°†å‚æ•°ç¼–ç»„ä¸ºæ¶ˆæ¯ï¼Œç„¶åé€šè¿‡ç³»ç»Ÿè°ƒç”¨å‘æœåŠ¡ç«¯å‘é€æ¶ˆæ¯ æœåŠ¡ç«¯å°†æ¥æ”¶åˆ°çš„æ•°æ®åŒ…ä¼ é€’ç»™server sub server subå°†æ¥æ”¶åˆ°çš„æ•°æ®è§£ç»„ä¸ºå‚æ•° server subå†è°ƒç”¨æœåŠ¡ç«¯çš„è¿‡ç¨‹ï¼Œè¿‡ç¨‹æ‰§è¡Œçš„ç»“æœä»¥åæ–¹å‘çš„ç›¸åŒæ­¥éª¤å“åº”ç»™å®¢æˆ·ç«¯ ä»¥ Google çš„ grpc ä¸ºä¾‹ï¼šå…ˆåœ¨ proto æ–‡ä»¶ä¸­å£°æ˜æ¥å£ï¼ŒåŒ…æ‹¬æ–¹æ³•åã€å‚æ•°å’Œè¿”å›å€¼ï¼Œç„¶åä½¿ç”¨å·¥å…·ç”Ÿæˆ go å¯ä»¥ç”¨çš„åº“ï¼›æœåŠ¡ç«¯åˆ›å»º grpc æœåŠ¡å®ä¾‹å¹¶å°†æœ¬åœ°å®ç°çš„æœåŠ¡æ³¨å†Œè¿›è¯¥å®ä¾‹ä¸­ï¼Œç„¶åç›‘å¬æœ¬åœ°ç«¯å£ï¼Œæ”¶åˆ°è¯·æ±‚åå°±æ‰§è¡Œæœ¬åœ°æ–¹æ³•å¹¶å°†ç»“æœè¿”å›ï¼›å®¢æˆ·ç«¯åˆ›å»º grpc å®¢æˆ·ç«¯å®ä¾‹ï¼Œç„¶åè°ƒç”¨ proto ä¸­å£°æ˜çš„æ–¹æ³•å³å¯è·å¾—ç»“æœã€‚
1.5ã€MQ åˆ†ç±» ActiveMQï¼šè€ã€è¾ƒå°‘ä½¿ç”¨ Kafkaï¼šå¤§æ•°æ®å®æ—¶è®¡ç®—å’Œæ—¥å¿—é‡‡é›†æ–¹é¢å“è¶Š RocketMQï¼šé˜¿é‡Œå¼€æºäº§å“ RabbitMQï¼šä¸»æµ äºŒã€RabbitMQä»‹ç» 2.1ã€RabbitMQ ç®€ä»‹ RabbitMQæ˜¯ä¸€ä¸ªåœ¨AMQPï¼ˆAdvanced Message Queuing Protocol ï¼‰åŸºç¡€ä¸Šå®ç°çš„ï¼Œå¯å¤ç”¨çš„ä¼ä¸šæ¶ˆæ¯ç³»ç»Ÿã€‚å®ƒå¯ä»¥ç”¨äºå¤§å‹è½¯ä»¶ç³»ç»Ÿå„ä¸ªæ¨¡å—ä¹‹é—´çš„é«˜æ•ˆé€šä¿¡ï¼Œæ”¯æŒé«˜å¹¶å‘ï¼Œæ”¯æŒå¯æ‰©å±•ã€‚"><meta property="og:locale" content="zh-CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-04-07T14:42:15+00:00"><meta property="article:modified_time" content="2022-04-07T14:42:15+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="RabbitMQåŸºç¡€"><meta name=twitter:description content="ä¸€ã€æ¦‚è¿°
1.1ã€ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—
æ¶ˆæ¯ï¼šæŒ‡çš„æ˜¯ä¸¤ä¸ªåº”ç”¨é—´ä¼ é€’çš„æ•°æ®ã€‚æ•°æ®çš„ç±»å‹æœ‰å¾ˆå¤šç§å½¢å¼ï¼Œå¯èƒ½åªåŒ…å«æ–‡æœ¬å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯èƒ½åŒ…å«åµŒå…¥å¯¹è±¡ã€‚
æ¶ˆæ¯åè®®ï¼šä¸ºäº†è®©æ¶ˆæ¯å‘é€è€…å’Œæ¶ˆæ¯æ¥æ”¶è€…éƒ½èƒ½å¤Ÿæ˜ç™½æ¶ˆæ¯æ‰€æ‰¿è½½çš„ä¿¡æ¯ï¼Œå®ƒä»¬å°±éœ€è¦æŒ‰ç…§ä¸€ç§ç»Ÿä¸€çš„æ ¼å¼æè¿°æ¶ˆæ¯ã€‚
æ¶ˆæ¯é˜Ÿåˆ—ï¼šï¼ˆMessage Queueï¼Œç®€ç§°MQï¼‰ï¼Œä»å­—é¢æ„æ€ä¸Šçœ‹ï¼Œæœ¬è´¨æ˜¯ä¸ªé˜Ÿåˆ—ï¼ŒFIFOå…ˆå…¥å…ˆå‡ºï¼Œåªä¸è¿‡é˜Ÿåˆ—ä¸­å­˜æ”¾çš„å†…å®¹æ˜¯messageã€‚
æ¶ˆæ¯ä»å‘é€è€…åˆ°æ¥æ”¶è€…çš„æ–¹å¼ä¹Ÿæœ‰ä¸¤ç§ã€‚
ä¸€ç§ä¸ºå³æ—¶æ¶ˆæ¯é€šè®¯ï¼Œä¹Ÿå°±æ˜¯è¯´æ¶ˆæ¯ä»ä¸€ç«¯å‘å‡ºåï¼ˆæ¶ˆæ¯å‘é€è€…ï¼‰ç«‹å³å°±å¯ä»¥è¾¾åˆ°å¦ä¸€ç«¯ï¼ˆæ¶ˆæ¯æ¥æ”¶è€…ï¼‰ï¼Œè¿™ç§æ–¹å¼çš„å…·ä½“å®ç°å°±æ˜¯RPCï¼ˆå½“ç„¶å•çº¯çš„httpé€šè®¯ä¹Ÿæ»¡è¶³è¿™ä¸ªå®šä¹‰ï¼‰ï¼›
å¦ä¸€ç§ä¸ºå»¶è¿Ÿæ¶ˆæ¯é€šè®¯ï¼Œå³æ¶ˆæ¯ä»æŸä¸€ç«¯å‘å‡ºåï¼Œé¦–å…ˆè¿›å…¥ä¸€ä¸ªå®¹å™¨è¿›è¡Œä¸´æ—¶å­˜å‚¨ï¼Œå½“è¾¾åˆ°æŸç§æ¡ä»¶åï¼Œå†ç”±è¿™ä¸ªå®¹å™¨å‘é€ç»™å¦ä¸€ç«¯ã€‚ è¿™ä¸ªå®¹å™¨çš„ä¸€ç§å…·ä½“å®ç°å°±æ˜¯æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¦‚RabbitMQã€‚
1.2ã€ä¸ºä»€ä¹ˆä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—

åº”ç”¨è§£è€¦ï¼šä¸åŒè¿›ç¨‹ï¼ˆprocessï¼‰ä¹‹é—´ä¼ é€’æ¶ˆæ¯æ—¶ï¼Œä¸¤ä¸ªè¿›ç¨‹ä¹‹é—´è€¦åˆç¨‹åº¦è¿‡é«˜ï¼Œæ”¹åŠ¨ä¸€ä¸ªè¿›ç¨‹ï¼Œå¼•å‘å¿…é¡»ä¿®æ”¹å¦ä¸€ä¸ªè¿›ç¨‹ï¼Œä¸ºäº†éš”ç¦»è¿™ä¸¤ä¸ªè¿›ç¨‹ï¼Œåœ¨ä¸¤è¿›ç¨‹é—´æŠ½ç¦»å‡ºä¸€å±‚ï¼ˆä¸€ä¸ªæ¨¡å—ï¼‰ï¼Œæ‰€æœ‰ä¸¤è¿›ç¨‹ä¹‹é—´ä¼ é€’çš„æ¶ˆæ¯ï¼Œéƒ½å¿…é¡»é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—æ¥ä¼ é€’ï¼Œå•ç‹¬ä¿®æ”¹æŸä¸€ä¸ªè¿›ç¨‹ï¼Œä¸ä¼šå½±å“å¦ä¸€ä¸ªï¼›
æµé‡å‰Šå³°ï¼šå¦‚æ•°æ®åº“åªèƒ½åŒæ—¶å¤„ç†ä¸€ä¸‡æ¡è¯·æ±‚ï¼Œå¦‚æœæ¥äº†ä¸¤ä¸‡æ¡è¯·æ±‚å°±æ‰§è¡Œä¸€ä¸‡æ¡ï¼Œå°†å‰©ä½™ä¸€ä¸‡æ¡æ”¾åœ¨æ¶ˆæ¯é˜Ÿåˆ—é¡ºåºæ‰§è¡Œã€‚
å¼‚æ­¥å¤„ç†ï¼šA è°ƒç”¨ B å¤„ç†æ•°æ®ï¼Œä½† B å¤„ç†æ—¶é—´å¾ˆé•¿ï¼›Aå¯ä»¥ä¸ç”¨ç­‰ï¼Œå½“Bæ‰§è¡Œå®Œå°†ç»“æœæ”¾åœ¨æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå†ç”±æ¶ˆæ¯é˜Ÿåˆ—å°†ç»“æœç»™Aï¼Œè¿™æ ·å°±ä¸ç”¨è½®è¯¢æˆ–æä¾›å›è°ƒå‡½æ•°äº†ã€‚
å¹¿æ’­
æœ€ç»ˆä¸€è‡´æ€§

1.3ã€mqtt ä¸ MQ çš„åŒºåˆ«
mqttï¼šä¸€ç§é€šä¿¡åè®®ï¼Œç±»ä¼¼äººç±»äº¤è°ˆä¸­çš„æ±‰è¯­ã€è‹±è¯­ã€ä¿„è¯­ä¸­çš„ä¸€ç§è¯­è¨€è§„èŒƒ
MQï¼šä¸€ç§é€šä¿¡é€šé“ï¼Œä¹Ÿå«æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç±»ä¼¼äººç±»äº¤è°ˆä¸­çš„ç”¨ç”µè¯ã€emailã€å¾®ä¿¡çš„ä¸€ç§é€šä¿¡æ–¹å¼
jsonï¼šä¸€ç§å†…å®¹æ ¼å¼ï¼Œç±»ä¼¼äººç±»äº¤è°ˆä¸­çš„æ’æ¯”å¥ç­‰æ–¹å¼
1.4ã€RPC æ‰§è¡Œæµç¨‹
RPCï¼ˆRemote Procedure Callï¼‰è¿œç¨‹è¿‡ç¨‹è°ƒç”¨åè®®ï¼Œä¸€ç§é€šè¿‡ç½‘ç»œä»è¿œç¨‹è®¡ç®—æœºä¸Šè¯·æ±‚æœåŠ¡ï¼Œè€Œä¸éœ€è¦äº†è§£åº•å±‚ç½‘ç»œæŠ€æœ¯çš„åè®®ã€‚å…¶ä¸»è¦ç›®çš„æ˜¯åšåˆ°ä¸åŒæœåŠ¡é—´è°ƒç”¨æ–¹æ³•åƒåŒä¸€æœåŠ¡é—´è°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·ã€‚
å½“ä¸šåŠ¡éœ€è¦å¼ºä¸€è‡´æ€§ï¼Œå…³æ³¨ä¸šåŠ¡é€»è¾‘çš„å¤„ç†ç»“æœï¼Œåˆ™ RPC æ¯”æ¶ˆæ¯é˜Ÿåˆ—æ›´åˆé€‚ã€‚
å¼ºä¸€è‡´æ€§æŒ‡ä¸è®ºåœ¨ä»»ä½•æ—¶å€™è¯»å–çš„éƒ½æ˜¯æœ€æ–°çš„æ•°æ®ï¼Œæœ€ç»ˆä¸€è‡´æ€§æ˜¯å…è®¸å¯ä»¥åœ¨ä¸€æ®µæ—¶é—´å†…æ¯ä¸ªç»“ç‚¹çš„æ•°æ®ä¸ä¸€è‡´ï¼Œä½†æ˜¯ç»è¿‡ä¸€æ®µæ—¶é—´æ¯ä¸ªç»“ç‚¹çš„æ•°æ®å¿…é¡»ä¸€è‡´ï¼Œå®ƒå¼ºè°ƒçš„æ˜¯æœ€ç»ˆæ•°æ®çš„ä¸€è‡´æ€§ã€‚

å®¢æˆ·ç«¯å¤„ç†è¿‡ç¨‹ä¸­è°ƒç”¨client subï¼Œå°±åƒè°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·ï¼Œä¼ å…¥å‚æ•°
client subå°†å‚æ•°ç¼–ç»„ä¸ºæ¶ˆæ¯ï¼Œç„¶åé€šè¿‡ç³»ç»Ÿè°ƒç”¨å‘æœåŠ¡ç«¯å‘é€æ¶ˆæ¯
æœåŠ¡ç«¯å°†æ¥æ”¶åˆ°çš„æ•°æ®åŒ…ä¼ é€’ç»™server sub
server subå°†æ¥æ”¶åˆ°çš„æ•°æ®è§£ç»„ä¸ºå‚æ•°
server subå†è°ƒç”¨æœåŠ¡ç«¯çš„è¿‡ç¨‹ï¼Œè¿‡ç¨‹æ‰§è¡Œçš„ç»“æœä»¥åæ–¹å‘çš„ç›¸åŒæ­¥éª¤å“åº”ç»™å®¢æˆ·ç«¯

ä»¥ Google çš„ grpc ä¸ºä¾‹ï¼šå…ˆåœ¨ proto æ–‡ä»¶ä¸­å£°æ˜æ¥å£ï¼ŒåŒ…æ‹¬æ–¹æ³•åã€å‚æ•°å’Œè¿”å›å€¼ï¼Œç„¶åä½¿ç”¨å·¥å…·ç”Ÿæˆ go å¯ä»¥ç”¨çš„åº“ï¼›æœåŠ¡ç«¯åˆ›å»º grpc æœåŠ¡å®ä¾‹å¹¶å°†æœ¬åœ°å®ç°çš„æœåŠ¡æ³¨å†Œè¿›è¯¥å®ä¾‹ä¸­ï¼Œç„¶åç›‘å¬æœ¬åœ°ç«¯å£ï¼Œæ”¶åˆ°è¯·æ±‚åå°±æ‰§è¡Œæœ¬åœ°æ–¹æ³•å¹¶å°†ç»“æœè¿”å›ï¼›å®¢æˆ·ç«¯åˆ›å»º grpc å®¢æˆ·ç«¯å®ä¾‹ï¼Œç„¶åè°ƒç”¨ proto ä¸­å£°æ˜çš„æ–¹æ³•å³å¯è·å¾—ç»“æœã€‚
1.5ã€MQ åˆ†ç±»

ActiveMQï¼šè€ã€è¾ƒå°‘ä½¿ç”¨
Kafkaï¼šå¤§æ•°æ®å®æ—¶è®¡ç®—å’Œæ—¥å¿—é‡‡é›†æ–¹é¢å“è¶Š
RocketMQï¼šé˜¿é‡Œå¼€æºäº§å“
RabbitMQï¼šä¸»æµ

äºŒã€RabbitMQä»‹ç»
2.1ã€RabbitMQ ç®€ä»‹
RabbitMQæ˜¯ä¸€ä¸ªåœ¨AMQPï¼ˆAdvanced Message Queuing Protocol ï¼‰åŸºç¡€ä¸Šå®ç°çš„ï¼Œå¯å¤ç”¨çš„ä¼ä¸šæ¶ˆæ¯ç³»ç»Ÿã€‚å®ƒå¯ä»¥ç”¨äºå¤§å‹è½¯ä»¶ç³»ç»Ÿå„ä¸ªæ¨¡å—ä¹‹é—´çš„é«˜æ•ˆé€šä¿¡ï¼Œæ”¯æŒé«˜å¹¶å‘ï¼Œæ”¯æŒå¯æ‰©å±•ã€‚"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ethereal-lu.github.io/posts/"},{"@type":"ListItem","position":2,"name":"RabbitMQåŸºç¡€","item":"https://ethereal-lu.github.io/posts/%E5%88%86%E5%B8%83%E5%BC%8F/rabbitmq/rabbitmq/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"RabbitMQåŸºç¡€","name":"RabbitMQåŸºç¡€","description":"ä¸€ã€æ¦‚è¿° 1.1ã€ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ— æ¶ˆæ¯ï¼šæŒ‡çš„æ˜¯ä¸¤ä¸ªåº”ç”¨é—´ä¼ é€’çš„æ•°æ®ã€‚æ•°æ®çš„ç±»å‹æœ‰å¾ˆå¤šç§å½¢å¼ï¼Œå¯èƒ½åªåŒ…å«æ–‡æœ¬å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯èƒ½åŒ…å«åµŒå…¥å¯¹è±¡ã€‚\næ¶ˆæ¯åè®®ï¼šä¸ºäº†è®©æ¶ˆæ¯å‘é€è€…å’Œæ¶ˆæ¯æ¥æ”¶è€…éƒ½èƒ½å¤Ÿæ˜ç™½æ¶ˆæ¯æ‰€æ‰¿è½½çš„ä¿¡æ¯ï¼Œå®ƒä»¬å°±éœ€è¦æŒ‰ç…§ä¸€ç§ç»Ÿä¸€çš„æ ¼å¼æè¿°æ¶ˆæ¯ã€‚\næ¶ˆæ¯é˜Ÿåˆ—ï¼šï¼ˆMessage Queueï¼Œç®€ç§°MQï¼‰ï¼Œä»å­—é¢æ„æ€ä¸Šçœ‹ï¼Œæœ¬è´¨æ˜¯ä¸ªé˜Ÿåˆ—ï¼ŒFIFOå…ˆå…¥å…ˆå‡ºï¼Œåªä¸è¿‡é˜Ÿåˆ—ä¸­å­˜æ”¾çš„å†…å®¹æ˜¯messageã€‚\næ¶ˆæ¯ä»å‘é€è€…åˆ°æ¥æ”¶è€…çš„æ–¹å¼ä¹Ÿæœ‰ä¸¤ç§ã€‚ ä¸€ç§ä¸ºå³æ—¶æ¶ˆæ¯é€šè®¯ï¼Œä¹Ÿå°±æ˜¯è¯´æ¶ˆæ¯ä»ä¸€ç«¯å‘å‡ºåï¼ˆæ¶ˆæ¯å‘é€è€…ï¼‰ç«‹å³å°±å¯ä»¥è¾¾åˆ°å¦ä¸€ç«¯ï¼ˆæ¶ˆæ¯æ¥æ”¶è€…ï¼‰ï¼Œè¿™ç§æ–¹å¼çš„å…·ä½“å®ç°å°±æ˜¯RPCï¼ˆå½“ç„¶å•çº¯çš„httpé€šè®¯ä¹Ÿæ»¡è¶³è¿™ä¸ªå®šä¹‰ï¼‰ï¼› å¦ä¸€ç§ä¸ºå»¶è¿Ÿæ¶ˆæ¯é€šè®¯ï¼Œå³æ¶ˆæ¯ä»æŸä¸€ç«¯å‘å‡ºåï¼Œé¦–å…ˆè¿›å…¥ä¸€ä¸ªå®¹å™¨è¿›è¡Œä¸´æ—¶å­˜å‚¨ï¼Œå½“è¾¾åˆ°æŸç§æ¡ä»¶åï¼Œå†ç”±è¿™ä¸ªå®¹å™¨å‘é€ç»™å¦ä¸€ç«¯ã€‚ è¿™ä¸ªå®¹å™¨çš„ä¸€ç§å…·ä½“å®ç°å°±æ˜¯æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¦‚RabbitMQã€‚\n1.2ã€ä¸ºä»€ä¹ˆä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ— åº”ç”¨è§£è€¦ï¼šä¸åŒè¿›ç¨‹ï¼ˆprocessï¼‰ä¹‹é—´ä¼ é€’æ¶ˆæ¯æ—¶ï¼Œä¸¤ä¸ªè¿›ç¨‹ä¹‹é—´è€¦åˆç¨‹åº¦è¿‡é«˜ï¼Œæ”¹åŠ¨ä¸€ä¸ªè¿›ç¨‹ï¼Œå¼•å‘å¿…é¡»ä¿®æ”¹å¦ä¸€ä¸ªè¿›ç¨‹ï¼Œä¸ºäº†éš”ç¦»è¿™ä¸¤ä¸ªè¿›ç¨‹ï¼Œåœ¨ä¸¤è¿›ç¨‹é—´æŠ½ç¦»å‡ºä¸€å±‚ï¼ˆä¸€ä¸ªæ¨¡å—ï¼‰ï¼Œæ‰€æœ‰ä¸¤è¿›ç¨‹ä¹‹é—´ä¼ é€’çš„æ¶ˆæ¯ï¼Œéƒ½å¿…é¡»é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—æ¥ä¼ é€’ï¼Œå•ç‹¬ä¿®æ”¹æŸä¸€ä¸ªè¿›ç¨‹ï¼Œä¸ä¼šå½±å“å¦ä¸€ä¸ªï¼› æµé‡å‰Šå³°ï¼šå¦‚æ•°æ®åº“åªèƒ½åŒæ—¶å¤„ç†ä¸€ä¸‡æ¡è¯·æ±‚ï¼Œå¦‚æœæ¥äº†ä¸¤ä¸‡æ¡è¯·æ±‚å°±æ‰§è¡Œä¸€ä¸‡æ¡ï¼Œå°†å‰©ä½™ä¸€ä¸‡æ¡æ”¾åœ¨æ¶ˆæ¯é˜Ÿåˆ—é¡ºåºæ‰§è¡Œã€‚ å¼‚æ­¥å¤„ç†ï¼šA è°ƒç”¨ B å¤„ç†æ•°æ®ï¼Œä½† B å¤„ç†æ—¶é—´å¾ˆé•¿ï¼›Aå¯ä»¥ä¸ç”¨ç­‰ï¼Œå½“Bæ‰§è¡Œå®Œå°†ç»“æœæ”¾åœ¨æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå†ç”±æ¶ˆæ¯é˜Ÿåˆ—å°†ç»“æœç»™Aï¼Œè¿™æ ·å°±ä¸ç”¨è½®è¯¢æˆ–æä¾›å›è°ƒå‡½æ•°äº†ã€‚ å¹¿æ’­ æœ€ç»ˆä¸€è‡´æ€§ 1.3ã€mqtt ä¸ MQ çš„åŒºåˆ« mqttï¼šä¸€ç§é€šä¿¡åè®®ï¼Œç±»ä¼¼äººç±»äº¤è°ˆä¸­çš„æ±‰è¯­ã€è‹±è¯­ã€ä¿„è¯­ä¸­çš„ä¸€ç§è¯­è¨€è§„èŒƒ MQï¼šä¸€ç§é€šä¿¡é€šé“ï¼Œä¹Ÿå«æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç±»ä¼¼äººç±»äº¤è°ˆä¸­çš„ç”¨ç”µè¯ã€emailã€å¾®ä¿¡çš„ä¸€ç§é€šä¿¡æ–¹å¼ jsonï¼šä¸€ç§å†…å®¹æ ¼å¼ï¼Œç±»ä¼¼äººç±»äº¤è°ˆä¸­çš„æ’æ¯”å¥ç­‰æ–¹å¼\n1.4ã€RPC æ‰§è¡Œæµç¨‹ RPCï¼ˆRemote Procedure Callï¼‰è¿œç¨‹è¿‡ç¨‹è°ƒç”¨åè®®ï¼Œä¸€ç§é€šè¿‡ç½‘ç»œä»è¿œç¨‹è®¡ç®—æœºä¸Šè¯·æ±‚æœåŠ¡ï¼Œè€Œä¸éœ€è¦äº†è§£åº•å±‚ç½‘ç»œæŠ€æœ¯çš„åè®®ã€‚å…¶ä¸»è¦ç›®çš„æ˜¯åšåˆ°ä¸åŒæœåŠ¡é—´è°ƒç”¨æ–¹æ³•åƒåŒä¸€æœåŠ¡é—´è°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·ã€‚\nå½“ä¸šåŠ¡éœ€è¦å¼ºä¸€è‡´æ€§ï¼Œå…³æ³¨ä¸šåŠ¡é€»è¾‘çš„å¤„ç†ç»“æœï¼Œåˆ™ RPC æ¯”æ¶ˆæ¯é˜Ÿåˆ—æ›´åˆé€‚ã€‚\nå¼ºä¸€è‡´æ€§æŒ‡ä¸è®ºåœ¨ä»»ä½•æ—¶å€™è¯»å–çš„éƒ½æ˜¯æœ€æ–°çš„æ•°æ®ï¼Œæœ€ç»ˆä¸€è‡´æ€§æ˜¯å…è®¸å¯ä»¥åœ¨ä¸€æ®µæ—¶é—´å†…æ¯ä¸ªç»“ç‚¹çš„æ•°æ®ä¸ä¸€è‡´ï¼Œä½†æ˜¯ç»è¿‡ä¸€æ®µæ—¶é—´æ¯ä¸ªç»“ç‚¹çš„æ•°æ®å¿…é¡»ä¸€è‡´ï¼Œå®ƒå¼ºè°ƒçš„æ˜¯æœ€ç»ˆæ•°æ®çš„ä¸€è‡´æ€§ã€‚\nå®¢æˆ·ç«¯å¤„ç†è¿‡ç¨‹ä¸­è°ƒç”¨client subï¼Œå°±åƒè°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·ï¼Œä¼ å…¥å‚æ•° client subå°†å‚æ•°ç¼–ç»„ä¸ºæ¶ˆæ¯ï¼Œç„¶åé€šè¿‡ç³»ç»Ÿè°ƒç”¨å‘æœåŠ¡ç«¯å‘é€æ¶ˆæ¯ æœåŠ¡ç«¯å°†æ¥æ”¶åˆ°çš„æ•°æ®åŒ…ä¼ é€’ç»™server sub server subå°†æ¥æ”¶åˆ°çš„æ•°æ®è§£ç»„ä¸ºå‚æ•° server subå†è°ƒç”¨æœåŠ¡ç«¯çš„è¿‡ç¨‹ï¼Œè¿‡ç¨‹æ‰§è¡Œçš„ç»“æœä»¥åæ–¹å‘çš„ç›¸åŒæ­¥éª¤å“åº”ç»™å®¢æˆ·ç«¯ ä»¥ Google çš„ grpc ä¸ºä¾‹ï¼šå…ˆåœ¨ proto æ–‡ä»¶ä¸­å£°æ˜æ¥å£ï¼ŒåŒ…æ‹¬æ–¹æ³•åã€å‚æ•°å’Œè¿”å›å€¼ï¼Œç„¶åä½¿ç”¨å·¥å…·ç”Ÿæˆ go å¯ä»¥ç”¨çš„åº“ï¼›æœåŠ¡ç«¯åˆ›å»º grpc æœåŠ¡å®ä¾‹å¹¶å°†æœ¬åœ°å®ç°çš„æœåŠ¡æ³¨å†Œè¿›è¯¥å®ä¾‹ä¸­ï¼Œç„¶åç›‘å¬æœ¬åœ°ç«¯å£ï¼Œæ”¶åˆ°è¯·æ±‚åå°±æ‰§è¡Œæœ¬åœ°æ–¹æ³•å¹¶å°†ç»“æœè¿”å›ï¼›å®¢æˆ·ç«¯åˆ›å»º grpc å®¢æˆ·ç«¯å®ä¾‹ï¼Œç„¶åè°ƒç”¨ proto ä¸­å£°æ˜çš„æ–¹æ³•å³å¯è·å¾—ç»“æœã€‚\n1.5ã€MQ åˆ†ç±» ActiveMQï¼šè€ã€è¾ƒå°‘ä½¿ç”¨ Kafkaï¼šå¤§æ•°æ®å®æ—¶è®¡ç®—å’Œæ—¥å¿—é‡‡é›†æ–¹é¢å“è¶Š RocketMQï¼šé˜¿é‡Œå¼€æºäº§å“ RabbitMQï¼šä¸»æµ äºŒã€RabbitMQä»‹ç» 2.1ã€RabbitMQ ç®€ä»‹ RabbitMQæ˜¯ä¸€ä¸ªåœ¨AMQPï¼ˆAdvanced Message Queuing Protocol ï¼‰åŸºç¡€ä¸Šå®ç°çš„ï¼Œå¯å¤ç”¨çš„ä¼ä¸šæ¶ˆæ¯ç³»ç»Ÿã€‚å®ƒå¯ä»¥ç”¨äºå¤§å‹è½¯ä»¶ç³»ç»Ÿå„ä¸ªæ¨¡å—ä¹‹é—´çš„é«˜æ•ˆé€šä¿¡ï¼Œæ”¯æŒé«˜å¹¶å‘ï¼Œæ”¯æŒå¯æ‰©å±•ã€‚\n","keywords":[],"articleBody":"ä¸€ã€æ¦‚è¿° 1.1ã€ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ— æ¶ˆæ¯ï¼šæŒ‡çš„æ˜¯ä¸¤ä¸ªåº”ç”¨é—´ä¼ é€’çš„æ•°æ®ã€‚æ•°æ®çš„ç±»å‹æœ‰å¾ˆå¤šç§å½¢å¼ï¼Œå¯èƒ½åªåŒ…å«æ–‡æœ¬å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯èƒ½åŒ…å«åµŒå…¥å¯¹è±¡ã€‚\næ¶ˆæ¯åè®®ï¼šä¸ºäº†è®©æ¶ˆæ¯å‘é€è€…å’Œæ¶ˆæ¯æ¥æ”¶è€…éƒ½èƒ½å¤Ÿæ˜ç™½æ¶ˆæ¯æ‰€æ‰¿è½½çš„ä¿¡æ¯ï¼Œå®ƒä»¬å°±éœ€è¦æŒ‰ç…§ä¸€ç§ç»Ÿä¸€çš„æ ¼å¼æè¿°æ¶ˆæ¯ã€‚\næ¶ˆæ¯é˜Ÿåˆ—ï¼šï¼ˆMessage Queueï¼Œç®€ç§°MQï¼‰ï¼Œä»å­—é¢æ„æ€ä¸Šçœ‹ï¼Œæœ¬è´¨æ˜¯ä¸ªé˜Ÿåˆ—ï¼ŒFIFOå…ˆå…¥å…ˆå‡ºï¼Œåªä¸è¿‡é˜Ÿåˆ—ä¸­å­˜æ”¾çš„å†…å®¹æ˜¯messageã€‚\næ¶ˆæ¯ä»å‘é€è€…åˆ°æ¥æ”¶è€…çš„æ–¹å¼ä¹Ÿæœ‰ä¸¤ç§ã€‚ ä¸€ç§ä¸ºå³æ—¶æ¶ˆæ¯é€šè®¯ï¼Œä¹Ÿå°±æ˜¯è¯´æ¶ˆæ¯ä»ä¸€ç«¯å‘å‡ºåï¼ˆæ¶ˆæ¯å‘é€è€…ï¼‰ç«‹å³å°±å¯ä»¥è¾¾åˆ°å¦ä¸€ç«¯ï¼ˆæ¶ˆæ¯æ¥æ”¶è€…ï¼‰ï¼Œè¿™ç§æ–¹å¼çš„å…·ä½“å®ç°å°±æ˜¯RPCï¼ˆå½“ç„¶å•çº¯çš„httpé€šè®¯ä¹Ÿæ»¡è¶³è¿™ä¸ªå®šä¹‰ï¼‰ï¼› å¦ä¸€ç§ä¸ºå»¶è¿Ÿæ¶ˆæ¯é€šè®¯ï¼Œå³æ¶ˆæ¯ä»æŸä¸€ç«¯å‘å‡ºåï¼Œé¦–å…ˆè¿›å…¥ä¸€ä¸ªå®¹å™¨è¿›è¡Œä¸´æ—¶å­˜å‚¨ï¼Œå½“è¾¾åˆ°æŸç§æ¡ä»¶åï¼Œå†ç”±è¿™ä¸ªå®¹å™¨å‘é€ç»™å¦ä¸€ç«¯ã€‚ è¿™ä¸ªå®¹å™¨çš„ä¸€ç§å…·ä½“å®ç°å°±æ˜¯æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¦‚RabbitMQã€‚\n1.2ã€ä¸ºä»€ä¹ˆä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ— åº”ç”¨è§£è€¦ï¼šä¸åŒè¿›ç¨‹ï¼ˆprocessï¼‰ä¹‹é—´ä¼ é€’æ¶ˆæ¯æ—¶ï¼Œä¸¤ä¸ªè¿›ç¨‹ä¹‹é—´è€¦åˆç¨‹åº¦è¿‡é«˜ï¼Œæ”¹åŠ¨ä¸€ä¸ªè¿›ç¨‹ï¼Œå¼•å‘å¿…é¡»ä¿®æ”¹å¦ä¸€ä¸ªè¿›ç¨‹ï¼Œä¸ºäº†éš”ç¦»è¿™ä¸¤ä¸ªè¿›ç¨‹ï¼Œåœ¨ä¸¤è¿›ç¨‹é—´æŠ½ç¦»å‡ºä¸€å±‚ï¼ˆä¸€ä¸ªæ¨¡å—ï¼‰ï¼Œæ‰€æœ‰ä¸¤è¿›ç¨‹ä¹‹é—´ä¼ é€’çš„æ¶ˆæ¯ï¼Œéƒ½å¿…é¡»é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—æ¥ä¼ é€’ï¼Œå•ç‹¬ä¿®æ”¹æŸä¸€ä¸ªè¿›ç¨‹ï¼Œä¸ä¼šå½±å“å¦ä¸€ä¸ªï¼› æµé‡å‰Šå³°ï¼šå¦‚æ•°æ®åº“åªèƒ½åŒæ—¶å¤„ç†ä¸€ä¸‡æ¡è¯·æ±‚ï¼Œå¦‚æœæ¥äº†ä¸¤ä¸‡æ¡è¯·æ±‚å°±æ‰§è¡Œä¸€ä¸‡æ¡ï¼Œå°†å‰©ä½™ä¸€ä¸‡æ¡æ”¾åœ¨æ¶ˆæ¯é˜Ÿåˆ—é¡ºåºæ‰§è¡Œã€‚ å¼‚æ­¥å¤„ç†ï¼šA è°ƒç”¨ B å¤„ç†æ•°æ®ï¼Œä½† B å¤„ç†æ—¶é—´å¾ˆé•¿ï¼›Aå¯ä»¥ä¸ç”¨ç­‰ï¼Œå½“Bæ‰§è¡Œå®Œå°†ç»“æœæ”¾åœ¨æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå†ç”±æ¶ˆæ¯é˜Ÿåˆ—å°†ç»“æœç»™Aï¼Œè¿™æ ·å°±ä¸ç”¨è½®è¯¢æˆ–æä¾›å›è°ƒå‡½æ•°äº†ã€‚ å¹¿æ’­ æœ€ç»ˆä¸€è‡´æ€§ 1.3ã€mqtt ä¸ MQ çš„åŒºåˆ« mqttï¼šä¸€ç§é€šä¿¡åè®®ï¼Œç±»ä¼¼äººç±»äº¤è°ˆä¸­çš„æ±‰è¯­ã€è‹±è¯­ã€ä¿„è¯­ä¸­çš„ä¸€ç§è¯­è¨€è§„èŒƒ MQï¼šä¸€ç§é€šä¿¡é€šé“ï¼Œä¹Ÿå«æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç±»ä¼¼äººç±»äº¤è°ˆä¸­çš„ç”¨ç”µè¯ã€emailã€å¾®ä¿¡çš„ä¸€ç§é€šä¿¡æ–¹å¼ jsonï¼šä¸€ç§å†…å®¹æ ¼å¼ï¼Œç±»ä¼¼äººç±»äº¤è°ˆä¸­çš„æ’æ¯”å¥ç­‰æ–¹å¼\n1.4ã€RPC æ‰§è¡Œæµç¨‹ RPCï¼ˆRemote Procedure Callï¼‰è¿œç¨‹è¿‡ç¨‹è°ƒç”¨åè®®ï¼Œä¸€ç§é€šè¿‡ç½‘ç»œä»è¿œç¨‹è®¡ç®—æœºä¸Šè¯·æ±‚æœåŠ¡ï¼Œè€Œä¸éœ€è¦äº†è§£åº•å±‚ç½‘ç»œæŠ€æœ¯çš„åè®®ã€‚å…¶ä¸»è¦ç›®çš„æ˜¯åšåˆ°ä¸åŒæœåŠ¡é—´è°ƒç”¨æ–¹æ³•åƒåŒä¸€æœåŠ¡é—´è°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·ã€‚\nå½“ä¸šåŠ¡éœ€è¦å¼ºä¸€è‡´æ€§ï¼Œå…³æ³¨ä¸šåŠ¡é€»è¾‘çš„å¤„ç†ç»“æœï¼Œåˆ™ RPC æ¯”æ¶ˆæ¯é˜Ÿåˆ—æ›´åˆé€‚ã€‚\nå¼ºä¸€è‡´æ€§æŒ‡ä¸è®ºåœ¨ä»»ä½•æ—¶å€™è¯»å–çš„éƒ½æ˜¯æœ€æ–°çš„æ•°æ®ï¼Œæœ€ç»ˆä¸€è‡´æ€§æ˜¯å…è®¸å¯ä»¥åœ¨ä¸€æ®µæ—¶é—´å†…æ¯ä¸ªç»“ç‚¹çš„æ•°æ®ä¸ä¸€è‡´ï¼Œä½†æ˜¯ç»è¿‡ä¸€æ®µæ—¶é—´æ¯ä¸ªç»“ç‚¹çš„æ•°æ®å¿…é¡»ä¸€è‡´ï¼Œå®ƒå¼ºè°ƒçš„æ˜¯æœ€ç»ˆæ•°æ®çš„ä¸€è‡´æ€§ã€‚\nå®¢æˆ·ç«¯å¤„ç†è¿‡ç¨‹ä¸­è°ƒç”¨client subï¼Œå°±åƒè°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·ï¼Œä¼ å…¥å‚æ•° client subå°†å‚æ•°ç¼–ç»„ä¸ºæ¶ˆæ¯ï¼Œç„¶åé€šè¿‡ç³»ç»Ÿè°ƒç”¨å‘æœåŠ¡ç«¯å‘é€æ¶ˆæ¯ æœåŠ¡ç«¯å°†æ¥æ”¶åˆ°çš„æ•°æ®åŒ…ä¼ é€’ç»™server sub server subå°†æ¥æ”¶åˆ°çš„æ•°æ®è§£ç»„ä¸ºå‚æ•° server subå†è°ƒç”¨æœåŠ¡ç«¯çš„è¿‡ç¨‹ï¼Œè¿‡ç¨‹æ‰§è¡Œçš„ç»“æœä»¥åæ–¹å‘çš„ç›¸åŒæ­¥éª¤å“åº”ç»™å®¢æˆ·ç«¯ ä»¥ Google çš„ grpc ä¸ºä¾‹ï¼šå…ˆåœ¨ proto æ–‡ä»¶ä¸­å£°æ˜æ¥å£ï¼ŒåŒ…æ‹¬æ–¹æ³•åã€å‚æ•°å’Œè¿”å›å€¼ï¼Œç„¶åä½¿ç”¨å·¥å…·ç”Ÿæˆ go å¯ä»¥ç”¨çš„åº“ï¼›æœåŠ¡ç«¯åˆ›å»º grpc æœåŠ¡å®ä¾‹å¹¶å°†æœ¬åœ°å®ç°çš„æœåŠ¡æ³¨å†Œè¿›è¯¥å®ä¾‹ä¸­ï¼Œç„¶åç›‘å¬æœ¬åœ°ç«¯å£ï¼Œæ”¶åˆ°è¯·æ±‚åå°±æ‰§è¡Œæœ¬åœ°æ–¹æ³•å¹¶å°†ç»“æœè¿”å›ï¼›å®¢æˆ·ç«¯åˆ›å»º grpc å®¢æˆ·ç«¯å®ä¾‹ï¼Œç„¶åè°ƒç”¨ proto ä¸­å£°æ˜çš„æ–¹æ³•å³å¯è·å¾—ç»“æœã€‚\n1.5ã€MQ åˆ†ç±» ActiveMQï¼šè€ã€è¾ƒå°‘ä½¿ç”¨ Kafkaï¼šå¤§æ•°æ®å®æ—¶è®¡ç®—å’Œæ—¥å¿—é‡‡é›†æ–¹é¢å“è¶Š RocketMQï¼šé˜¿é‡Œå¼€æºäº§å“ RabbitMQï¼šä¸»æµ äºŒã€RabbitMQä»‹ç» 2.1ã€RabbitMQ ç®€ä»‹ RabbitMQæ˜¯ä¸€ä¸ªåœ¨AMQPï¼ˆAdvanced Message Queuing Protocol ï¼‰åŸºç¡€ä¸Šå®ç°çš„ï¼Œå¯å¤ç”¨çš„ä¼ä¸šæ¶ˆæ¯ç³»ç»Ÿã€‚å®ƒå¯ä»¥ç”¨äºå¤§å‹è½¯ä»¶ç³»ç»Ÿå„ä¸ªæ¨¡å—ä¹‹é—´çš„é«˜æ•ˆé€šä¿¡ï¼Œæ”¯æŒé«˜å¹¶å‘ï¼Œæ”¯æŒå¯æ‰©å±•ã€‚\n2.2ã€AMQP AMQPï¼Œå³Advanced Message Queuing Protocol,ä¸€ä¸ªæä¾›ç»Ÿä¸€æ¶ˆæ¯æœåŠ¡çš„åº”ç”¨å±‚æ ‡å‡†é«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®,æ˜¯åº”ç”¨å±‚åè®®çš„ä¸€ä¸ªå¼€æ”¾æ ‡å‡†,ä¸ºé¢å‘æ¶ˆæ¯çš„ä¸­é—´ä»¶è®¾è®¡ã€‚åŸºäºæ­¤åè®®çš„å®¢æˆ·ç«¯ä¸æ¶ˆæ¯ä¸­é—´ä»¶å¯ä¼ é€’æ¶ˆæ¯ï¼Œå¹¶ä¸å—å®¢æˆ·ç«¯/ä¸­é—´ä»¶ä¸åŒäº§å“ï¼Œä¸åŒçš„å¼€å‘è¯­è¨€ç­‰æ¡ä»¶çš„é™åˆ¶ã€‚\n2.3ã€ç›¸å…³æ¦‚å¿µ Brokerï¼šç®€å•æ¥è¯´å°±æ˜¯æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡å™¨å®ä½“ã€‚\nExchangeï¼šæ¶ˆæ¯äº¤æ¢æœºï¼Œå®ƒæŒ‡å®šæ¶ˆæ¯æŒ‰ä»€ä¹ˆè§„åˆ™ï¼Œè·¯ç”±åˆ°å“ªä¸ªé˜Ÿåˆ—ã€‚\nQueueï¼šæ¶ˆæ¯é˜Ÿåˆ—è½½ä½“ï¼Œæ¯ä¸ªæ¶ˆæ¯éƒ½ä¼šè¢«æŠ•å…¥åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªé˜Ÿåˆ—ã€‚\nBindingï¼šç»‘å®šï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯æŠŠexchangeå’ŒqueueæŒ‰ç…§è·¯ç”±è§„åˆ™ç»‘å®šèµ·æ¥ã€‚\nRouting Keyï¼šè·¯ç”±å…³é”®å­—ï¼Œexchangeæ ¹æ®è¿™ä¸ªå…³é”®å­—è¿›è¡Œæ¶ˆæ¯æŠ•é€’ã€‚\nvhostï¼šè™šæ‹Ÿä¸»æœºï¼Œä¸€ä¸ªbrokeré‡Œå¯ä»¥å¼€è®¾å¤šä¸ªvhostï¼Œç”¨ä½œä¸åŒç”¨æˆ·çš„æƒé™åˆ†ç¦»ã€‚\nproducerï¼šæ¶ˆæ¯ç”Ÿäº§è€…ï¼Œå°±æ˜¯æŠ•é€’æ¶ˆæ¯çš„ç¨‹åºã€‚\nconsumerï¼šæ¶ˆæ¯æ¶ˆè´¹è€…ï¼Œå°±æ˜¯æ¥å—æ¶ˆæ¯çš„ç¨‹åºã€‚\nchannelï¼šæ¶ˆæ¯é€šé“ï¼Œåœ¨å®¢æˆ·ç«¯çš„æ¯ä¸ªè¿æ¥é‡Œï¼Œå¯å»ºç«‹å¤šä¸ªchannelï¼Œæ¯ä¸ªchannelä»£è¡¨ä¸€ä¸ªä¼šè¯ä»»åŠ¡ã€‚\nä¸‰ã€åˆä½“éªŒ 3.1ã€å¼€å¯ rabbitmq æ‹‰é•œåƒå¹¶å¯åŠ¨ï¼Œæ˜ å°„ 15672 ç«¯å£\ndocker pull rabbitmq:management è¿›å…¥å®¹å™¨ï¼Œæ·»åŠ ç”¨æˆ·ã€‚è¿™äº›æ“ä½œå…¨éƒ¨å¯ä»¥åœ¨webç•Œé¢ä¸Šè¿›è¡Œ\nrabbitmqctl add_user admin admin // æ·»åŠ ç”¨æˆ·\rrabbitmqctl set_user_tars admin administsrstor // è®¾ç½®è§’è‰²\rrabbitmqctl set_permissions admin \".*\" \".*\" \".*\" // è®¾ç½®æƒé™ 3.2ã€java ä½¿ç”¨ rabbitmq åˆä½“éªŒ ä½¿ç”¨é»˜è®¤äº¤æ¢æœºï¼Œå³ç©ºå­—ç¬¦ä¸²â€œâ€æ—¶ï¼Œåˆ›å»ºä¸€ä¸ªqueueæ—¶,é»˜è®¤çš„éƒ½ä¼šæœ‰ä¸€ä¸ªå’Œæ–°å»ºqueueåŒåçš„routingKeyç»‘å®šåˆ°è¿™ä¸ªé»˜è®¤çš„exchangeä¸Šå»\nå¼•åŒ… com.rabbitmq amqp-client 5.14.2 commons-io commons-io 2.11.0 Producer å‘å¸ƒè€… public class Producer { public static final String QUEUE_NAME = \"hello\"; public static void main(String[] args) throws IOException, TimeoutException { // è¿æ¥å·¥å‚ ConnectionFactory factory = new ConnectionFactory(); factory.setHost(\"192.168.36.128\"); // java è¿æ¥ rabbitmq çš„ç«¯å£æ˜¯ 5672 .å¤§å‘ã€‚æ‰€ä»¥docker ä¹Ÿå¿…é¡»æš´éœ² 5672 ç«¯å£ã€‚ factory.setPort(5672); factory.setUsername(\"admin\"); factory.setPassword(\"admin\"); factory.setConnectionTimeout(50000); // è¿æ¥ Connection connection = factory.newConnection(); // è·å–ä¿¡é“ Channel channel = connection.createChannel(); /** * å£°æ˜ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå‚æ•°å¦‚ä¸‹ï¼š * 1ã€name: é˜Ÿåˆ—åç§° * 2ã€durable: æ˜¯å¦æŒä¹…åŒ– * 3ã€exclusive: æ˜¯å¦æ’å¤–çš„ã€‚å¦‚æœè®¾ç½®ä¸ºtrueï¼Œå®šä¹‰ä¸ºæ’ä»–é˜Ÿåˆ—ã€‚åˆ™åªæœ‰åˆ›å»ºè€…å¯ä»¥ä½¿ç”¨æ­¤é˜Ÿåˆ—ã€‚ä¹Ÿå°±æ˜¯privateç§æœ‰çš„ã€‚ * 4ã€autoDelete: æ˜¯å¦è‡ªåŠ¨åˆ é™¤ã€‚ä¹Ÿå°±æ˜¯ä¸´æ—¶é˜Ÿåˆ—ã€‚å½“æœ€åä¸€ä¸ªæ¶ˆè´¹è€…æ–­å¼€è¿æ¥åï¼Œä¼šè‡ªåŠ¨åˆ é™¤ã€‚ * 5ã€å…¶ä»–å‚æ•° * */ channel.queueDeclare(QUEUE_NAME, false, false, false, null); String message = \"Hello World\"; // å‘é€æ¶ˆæ¯ å‚æ•°ï¼š1.äº¤æ¢æœºï¼Œè¿™é‡Œä½¿ç”¨é»˜è®¤äº¤æ¢æœº 2.Routing Key 3. å…¶ä»–å‚æ•° 4.æ¶ˆæ¯ channel.basicPublish(\"\", QUEUE_NAME, null, message.getBytes(StandardCharsets.UTF_8)); } } Consumer æ¶ˆè´¹è€… public class Consumer { public static final String QUEUE_NAME = \"hello\"; public static void main(String[] args) throws IOException, TimeoutException { ConnectionFactory factory = new ConnectionFactory(); factory.setHost(\"192.168.36.128\"); factory.setPort(5672); factory.setUsername(\"guest\"); factory.setPassword(\"guest\"); Connection connection = factory.newConnection(); Channel channel = connection.createChannel(); // å‘å¸ƒè€…å·²ç»å£°æ˜äº†é˜Ÿåˆ—ï¼Œæ¶ˆè´¹è€…å°±æ— éœ€å£°æ˜ // channel.queueDeclare(QUEUE_NAME, false, true, false, null); // å‚æ•°ï¼š1.é˜Ÿåˆ—å 2.æ˜¯å¦ä½¿ç”¨è‡ªåŠ¨åº”ç­” 3.æˆåŠŸæ¶ˆè´¹çš„å›è°ƒ 4.å¤±è´¥æ¶ˆè´¹çš„å›è°ƒ DeliverCallback deliverCallback = (consumerTag, message) -\u003e System.out.println(\"æˆåŠŸæ¶ˆè´¹ï¼š\" + new String(message.getBody())); CancelCallback cancelCallback = (consumerTag) -\u003e System.out.println(\"å¤±è´¥æ¶ˆè´¹\"); channel.basicConsume(QUEUE_NAME, true, deliverCallback, cancelCallback); } } å››ã€å·¥ä½œé˜Ÿåˆ— å°†å·¥ä½œå°è£…æˆä¸€ä¸ªä¸ªæ¶ˆæ¯å‘é€åˆ°é˜Ÿåˆ—ï¼Œç„¶åç”±å¤šä¸ªåå°çº¿ç¨‹ä¸€èµ·å¤„ç†è¿™äº›æ¶ˆæ¯ï¼Œä»è€Œé¿å…åŒæ—¶å¤„ç†å¤§é‡æ¶ˆæ¯ã€‚\nå½“å¤šä¸ªæ¶ˆè´¹è€…è®¢é˜…åŒä¸€ä¸ªé˜Ÿåˆ—æ—¶ï¼Œrabbitmq é»˜è®¤ä½¿ç”¨è½®è¯¢çš„æ–¹å¼å°†æ¶ˆæ¯å‘é€ç»™æ¶ˆè´¹è€…ï¼ŒåŒæ ·ä¿è¯æ¯ä¸ªæ¶ˆæ¯åªèƒ½è¢«ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ã€‚\n4.1ã€æ¶ˆæ¯åº”ç­” æ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯åï¼Œçªç„¶å®•æœºå¯¼è‡´å·¥ä½œå¹¶æ²¡æœ‰å®Œæˆï¼Œæ­¤æ—¶mqå·²ç»å°†æ¶ˆæ¯åˆ é™¤ï¼Œå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ã€‚ä¸ºé¿å…è¯¥äº‹ä»¶ï¼Œå¼•å…¥æ¶ˆæ¯åº”ç­”æœºåˆ¶ï¼šæ¶ˆè´¹è€…åœ¨æ¥æ”¶åˆ°æ¶ˆæ¯å¹¶ä¸”å¤„ç†å®Œæˆè¯¥æ¶ˆæ¯åï¼Œå‘Šè¯‰ rabbitmq å®ƒå·²ç»æ­£ç¡®å¤„ç†äº†ï¼Œæ­¤æ—¶ mq å¯ä»¥æ”¾å¿ƒåˆ é™¤è¯¥æ¶ˆæ¯ã€‚\n4.1.1ã€è‡ªåŠ¨åº”ç­” æ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯åï¼Œè‡ªåŠ¨å‘Šè¯‰rabbitmqæœåŠ¡è¯¥æ¶ˆæ¯å·²å®Œæˆï¼Œå®é™…ä¸Šæ¶ˆè´¹è€…ä¹Ÿä»…ä»…æ˜¯æ¥å—åˆ°äº†æ¶ˆæ¯ï¼Œæœ‰å¯èƒ½è¿˜æ²¡æœ‰æ‰§è¡Œå®Œæˆã€‚\nå½“æ¶ˆæ¯å¤§é‡ä¼ é€’ï¼Œæ¶ˆè´¹è€…æ¥ä¸åŠå¤„ç†å¯¼è‡´æ¶ˆæ¯ç§¯å‹ï¼Œå†…å­˜è€—å°½ï¼Œå°±ä¼šè¢«æ“ä½œç³»ç»Ÿæ€æ­»ï¼Œæ‰€ä»¥è¿™ç§æ–¹å¼åªé€‚ç”¨äºæ¶ˆè´¹è€…å¯ä»¥é«˜æ•ˆå¤„ç†çš„æƒ…å†µã€‚æ‰€ä»¥ä¸æ¨èä½¿ç”¨è‡ªåŠ¨åº”ç­”ã€‚\n4.1.2ã€æ‰‹åŠ¨åº”ç­” å½“autoAck å‚æ•°ä¸º false æ—¶ï¼Œå¯¹äº RabbitMQ æœåŠ¡å™¨ç«¯è€Œè¨€ï¼Œé˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯åˆ†æˆäº†ä¸¤éƒ¨åˆ†ï¼šä¸€éƒ¨åˆ†æ˜¯ç­‰å¾…æŠ•é€’ç»™æ¶ˆè´¹è€…çš„æ¶ˆæ¯ï¼›ä¸€éƒ¨åˆ†æ˜¯å·²ç»æŠ•é€’ç»™æ¶ˆè´¹è€…ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰æ”¶åˆ°æ¶ˆè´¹è€…ç¡®è®¤ä¿¡å·çš„æ¶ˆæ¯ã€‚å¦‚æœ RabbitMQ æœåŠ¡å™¨ç«¯ä¸€ç›´æ²¡æœ‰æ”¶åˆ°æ¶ˆè´¹è€…çš„ç¡®è®¤ä¿¡å·ï¼Œå¹¶ä¸”æ¶ˆè´¹æ­¤æ¶ˆæ¯çš„æ¶ˆè´¹è€…å·²ç»æ–­å¼€è¿æ¥ï¼Œåˆ™æœåŠ¡å™¨ç«¯ä¼šå®‰æ’è¯¥æ¶ˆæ¯é‡æ–°è¿›å…¥é˜Ÿåˆ—ï¼Œç­‰å¾…æŠ•é€’ç»™ä¸‹ä¸€ä¸ªæ¶ˆè´¹è€…ï¼ˆä¹Ÿå¯èƒ½è¿˜æ˜¯åŸæ¥çš„é‚£ä¸ªæ¶ˆè´¹è€…ï¼‰ã€‚\nRabbitMQ ä¸ä¼šä¸ºæœªç¡®è®¤çš„æ¶ˆæ¯è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå®ƒåˆ¤æ–­æ­¤æ¶ˆæ¯æ˜¯å¦éœ€è¦é‡æ–°æŠ•é€’ç»™æ¶ˆè´¹è€…çš„å”¯ä¸€ä¾æ®æ˜¯æ¶ˆè´¹è€…çš„è¿æ¥æ˜¯å¦å·²ç»æ–­å¼€ï¼Œè¿™ä¸ªè®¾ç½®çš„åŸå› æ˜¯ RabbitMQ å…è®¸æ¶ˆè´¹è€…æ¶ˆè´¹ä¸€æ¡æ¶ˆæ¯çš„æ—¶é—´å¯ä»¥å¾ˆä¹…å¾ˆä¹…ã€‚\nchannel.basicAck(); // è‚¯å®šç¡®è®¤ channel.basicNack(); // å¦å®šç¡®è®¤ channel.basicReject(); // å¦å®šç¡®è®¤ï¼Œæ¯” basicNack å°‘äº†æ‰¹é‡å¤„ç†çš„å‚æ•° æ‰¹é‡åº”ç­”ç±»ä¼¼äº TCP ä¼ è¾“çš„ç´¯è®¡ç¡®è®¤ï¼Œå³è‹¥é˜Ÿåˆ—æ¥æ”¶åˆ°æ¶ˆè´¹è€…å¯¹äº 8 å·æ¶ˆæ¯çš„ç¡®è®¤ï¼Œåˆ™è®¤ä¸ºæ¶ˆè´¹è€…å·²ç»æˆåŠŸå¤„ç†äº† 1 ~ 8 å·æ¶ˆæ¯ï¼Œå°½ç®¡ä¹‹å‰å¯èƒ½æ²¡æœ‰æ”¶åˆ°æ¥è‡ª 1~7 å·çš„ç¡®è®¤ã€‚ä½†æ˜¯ä¸å»ºè®®ä½¿ç”¨æ‰¹é‡åº”ç­”ï¼Œå½“æœ‰å¤šä¸ªæ¶ˆè´¹è€…æ—¶ï¼Œè‹¥æ¶ˆè´¹è€…1å¤„ç† 3 å·æ¶ˆæ¯ï¼Œä½†è¿˜æ²¡æœ‰å¤„ç†å®Œå°±å®•æœºäº†ï¼Œæ­¤æ—¶æ¶ˆè´¹è€… 2 å·²ç»å¤„ç†å®Œäº† 5 å·æ¶ˆæ¯å¹¶æ‰¹é‡åº”ç­”ï¼Œå°±ä¼šé€ æˆ 3 å·æ¶ˆæ¯çš„ä¸¢å¤±ã€‚è€Œ TCP ç”±äºæ˜¯ç‚¹å¯¹ç‚¹åè®®ï¼Œå› æ­¤æ²¡æœ‰è¿™ç§æƒ…å†µçš„å‘ç”Ÿã€‚\n4.1.3ã€æ¶ˆæ¯è‡ªåŠ¨é‡æ–°å…¥é˜Ÿ å¦‚æœæ¶ˆè´¹è€…ç”±äºæŸäº›åŸå› å¤±å»è¿æ¥(å…¶é€šé“å…³é—­ï¼Œè¿æ¥å…³é—­æˆ– TCP è¿æ¥ä¸¢å¤±ï¼Œå®•æœº)ï¼Œå¯¼è‡´æ¶ˆæ¯æœªå‘é€ ACK ç¡®è®¤ï¼ŒRabbitMQ å°†äº†è§£åˆ°æ¶ˆæ¯æœªå®Œå…¨å¤„ç†ï¼Œå¹¶å°†å¯¹å…¶é‡æ–°æ’é˜Ÿã€‚å¦‚æœæ­¤æ—¶å…¶ä»–æ¶ˆè´¹è€…å¯ä»¥å¤„ç†ï¼Œå®ƒå°†å¾ˆå¿«å°†å…¶é‡æ–°åˆ†å‘ç»™å¦ä¸€ä¸ªæ¶ˆè´¹è€…ã€‚è¿™æ ·ï¼Œå³ä½¿æŸä¸ªæ¶ˆè´¹è€…å¶å°”æ­»äº¡ï¼Œä¹Ÿå¯ä»¥ç¡®ä¿ä¸ä¼šä¸¢å¤±ä»»ä½•æ¶ˆæ¯ã€‚\npublic class Consumer { public static void main(String[] args) throws IOException, TimeoutException { Channel channel = RabbitMqUtil.getChannel(); DeliverCallback deliverCallback = (consumerTag, message) -\u003e { System.out.println(\"æˆåŠŸæ¶ˆè´¹ï¼š\" + new String(message.getBody())); // æ‰‹åŠ¨åº”ç­”ï¼Œä¸”å–æ¶ˆæ‰¹é‡åº”ç­” channel.basicAck(message.getEnvelope().getDeliveryTag(), false); }; CancelCallback cancelCallback = (consumerTag) -\u003e System.out.println(\"å¤±è´¥æ¶ˆè´¹\"); // å–æ¶ˆè‡ªåŠ¨åº”ç­” channel.basicConsume(HELLO, false, deliverCallback, cancelCallback); } } 4.2ã€æŒä¹…åŒ– rabbitmq æœåŠ¡å™¨é€€å‡ºæˆ–å®•æœºæ—¶ï¼Œå­˜åœ¨äºå†…å­˜ä¸­çš„é˜Ÿåˆ—å’Œæ¶ˆæ¯å°±ä¼šä¸¢å¤±ï¼Œå› æ­¤éœ€è¦å°†é˜Ÿåˆ—å’Œæ¶ˆæ¯æŒä¹…åŒ–ã€‚\n4.2.1ã€é˜Ÿåˆ—æŒä¹…åŒ– channel.queueDeclare(QUEUE_NAME, true, false, false, null); // ç¬¬äºŒä¸ªå‚æ•°ä¸º durable: æ˜¯å¦æŒä¹…åŒ– å£°æ˜é˜Ÿåˆ—æ—¶å°†å…¶è®¾ç½®ä¸ºæŒä¹…åŒ–å³å¯ï¼Œä½†æ˜¯è‹¥æƒ³è¦å°†ä¸€ä¸ªå·²ç»å­˜åœ¨çš„éæŒä¹…åŒ–é˜Ÿåˆ—ä¿®æ”¹ä¸ºæŒä¹…åŒ–ï¼Œéœ€è¦å…ˆåˆ é™¤åŸæœ‰é˜Ÿåˆ—ï¼Œå†åˆ›å»ºæ–°é˜Ÿåˆ—ï¼Œå¦åˆ™æŠ¥é”™ã€‚\n4.2.2ã€æ¶ˆæ¯æŒä¹…åŒ– channel.basicPublish(\"\", HELLO, MessageProperties.PERSISTENT_TEXT_PLAIN, message.getBytes()); å‘å¸ƒæ¶ˆæ¯æ—¶ï¼Œå°†æ¶ˆæ¯å±æ€§è®¾ä¸ºæŒä¹…åŒ–ï¼Œæ­¤å¤„è®¾ç½®ä¸ºæ–‡æœ¬æŒä¹…åŒ–ã€‚ä½†æ˜¯è¿˜ä¸èƒ½ä¿è¯æ¶ˆæ¯ä¸ä¼šå®Œå…¨ä¸¢å¤±ï¼Œå½“ mq å­˜å…¥ç£ç›˜ä¹‹å‰å°±å®•æœºäº†ï¼Œä»ç„¶ä¼šå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ï¼Œå¯ä»¥é€šè¿‡å‘å¸ƒç¡®è®¤ç¡®ä¿ä¸ä¸¢å¤±ã€‚\nè®¾ç½®äº†é˜Ÿåˆ—å’Œæ¶ˆæ¯çš„æŒä¹…åŒ–ä¹‹åï¼Œå½“brokeræœåŠ¡é‡å¯çš„ä¹‹åï¼Œæ¶ˆæ¯ä¾æ—§å­˜åœ¨ã€‚å•åªè®¾ç½®é˜Ÿåˆ—æŒä¹…åŒ–ï¼Œé‡å¯ä¹‹åæ¶ˆæ¯ä¼šä¸¢å¤±ï¼›å•åªè®¾ç½®æ¶ˆæ¯çš„æŒä¹…åŒ–ï¼Œé‡å¯ä¹‹åé˜Ÿåˆ—æ¶ˆå¤±ï¼Œæ—¢è€Œæ¶ˆæ¯ä¹Ÿä¸¢å¤±ã€‚å•å•è®¾ç½®æ¶ˆæ¯æŒä¹…åŒ–è€Œä¸è®¾ç½®é˜Ÿåˆ—çš„æŒä¹…åŒ–æ˜¾å¾—æ¯«æ— æ„ä¹‰ã€‚\n4.3ã€å…¬å¹³åˆ†å‘ rabbitmq é»˜è®¤é‡‡ç”¨è½®è¯¢åˆ†å‘ã€‚å½“å¤šä¸ªæ¶ˆè´¹è€…çš„å¤„ç†æ€§èƒ½ç›¸å·®å¾ˆå¤šæ—¶ï¼Œè‹¥é‡‡ç”¨è½®è¯¢åˆ†å‘ä¼šé™ä½ååç‡ï¼Œå› æ­¤åº”è¯¥ä½¿ç”¨å…¬å¹³åˆ†å‘ã€‚\n// æ¶ˆè´¹è€…ç«¯è®¾ç½® channel.basicQos(int prefetch_count); ä¸€å¥è¯è¡¨ç¤ºå°±æ˜¯ prefetch_count è¡¨ç¤ºå½“å‰ä¿¡é“èƒ½å­˜åœ¨çš„æœ€å¤šçš„æœªackçš„æ¶ˆæ¯ä¸ªæ•°\næ¯ä¸ª channe éƒ½ä¼šè®°å½•è‡ªå·± prefetch_count çš„å€¼ï¼ŒåŒæ—¶è®°å½•çš„è¿˜æœ‰è¯¥channelæœªackçš„æ¶ˆæ¯ä¸ªæ•°ã€‚\nå½“rabbitmqè¦å°†é˜Ÿåˆ—ä¸­çš„ä¸€æ¡æ¶ˆæ¯æŠ•é€’ç»™æ¶ˆè´¹è€…æ—¶ï¼Œä¼šéå†è¯¥é˜Ÿåˆ—ä¸Šçš„æ¶ˆè´¹è€…åˆ—è¡¨ï¼Œé€‰ä¸€ä¸ªåˆé€‚çš„æ¶ˆè´¹è€…ï¼Œç„¶åå°†æ¶ˆæ¯æŠ•é€’å‡ºå»ï¼ŒæŠ•é€’çš„æ—¶å€™æ˜¯åœ¨åŒä¸€æ—¶åˆ»å°†å¤§é‡æ¶ˆæ¯æŠ•é€’è¿›å»ï¼Œä½¿å…¶ç›´æ¥å˜æ»¡ã€‚å…¶ä¸­æŒ‘é€‰æ¶ˆè´¹è€…çš„ä¸€ä¸ªä¾æ®å°±æ˜¯çœ‹æ¶ˆè´¹è€…å¯¹åº”çš„channelä¸Šæœªackçš„æ¶ˆæ¯æ•°æ˜¯å¦è¾¾åˆ°è®¾ç½®çš„prefetch_countä¸ªæ•°ï¼Œå¦‚æœæœªackçš„æ¶ˆæ¯æ•°è¾¾åˆ°äº†prefetch_countçš„ä¸ªæ•°ï¼Œåˆ™ä¸ç¬¦åˆè¦æ±‚ã€‚å½“æŒ‘é€‰åˆ°åˆé€‚çš„æ¶ˆè´¹è€…åï¼Œä¸­æ–­åç»­çš„éå†ã€‚å½“æ¶ˆè´¹è€…å¯¹æ¶ˆæ¯è¿›è¡Œackåï¼Œä¼šä¿®æ”¹è¯¥æ¶ˆè´¹è€…å¯¹åº”channelä¸­æœªackçš„æ¶ˆæ¯æ•°ï¼Œè¿™æ ·é˜Ÿåˆ—åˆå¯ä»¥å°†æ¶ˆæ¯æŠ•é€’ç»™è¯¥æ¶ˆè´¹è€…ã€‚\næ³¨ï¼šprefetch_count å¿…é¡»åœ¨æ‰‹åŠ¨åº”ç­”æ—¶æ‰ç”Ÿæ•ˆï¼Œå¦‚æœæ˜¯è‡ªåŠ¨åº”ç­”è¿˜æ˜¯è½®è¯¢ã€‚\nprefetch_count é»˜è®¤ä¸º 0 ï¼Œå³è½®è¯¢åˆ†å‘ã€‚\näº”ã€å‘å¸ƒç¡®è®¤ å½“é˜Ÿåˆ—å°†æ¶ˆæ¯ä¿å­˜åœ¨ç£ç›˜ä¹‹åï¼Œå‘å‘å¸ƒè€…å‘é€ç¡®è®¤æ¶ˆæ¯ï¼Œå¦‚æ­¤èƒ½ç¡®ä¿ mq å°†æ¶ˆæ¯æŒä¹…åŒ–äº†ã€‚\nchannel.confirmSelect(); // å‘å¸ƒè€…ç«¯è®¾ç½®ï¼Œå¼€å¯å‘å¸ƒç¡®è®¤ å¦‚æœè®¾ç½®äº†æŒä¹…åŒ–ï¼Œåˆ™å¿…é¡»ä¿å­˜åˆ°ç£ç›˜ä¹‹åæ‰ä¼šç¡®è®¤ï¼Œå¦åˆ™ï¼Œæ”¶åˆ°æ¶ˆæ¯å°±ç›´æ¥ç¡®è®¤ã€‚\n5.1ã€å•ä¸ªç¡®è®¤å‘å¸ƒ æ¯å‘ä¸€æ¡æ¶ˆæ¯ï¼Œå¿…é¡»æ”¶åˆ°ç¡®è®¤æ‰ä¼šå‘é€ä¸‹ä¸€æ¡æ¶ˆæ¯ã€‚é€Ÿåº¦æ…¢ã€‚\nboolean confirm = channel.waitForConfirms(); // æ¯æ¬¡å‘é€æ¶ˆæ¯åéƒ½è¦åˆ¤æ–­ confirm ä¸º true æ‰èƒ½å‘é€ä¸‹ä¸€æ¡æ¶ˆæ¯ 5.2ã€æ‰¹é‡ç¡®è®¤å‘å¸ƒ å‘å¸ƒä¸€æ‰¹æ¶ˆæ¯åä¸€èµ·ç¡®è®¤ï¼Œå¯ä»¥æé«˜ååç‡ï¼Œä½†æ˜¯è‹¥å‡ºç°æ•…éšœï¼Œä¸çŸ¥é“æ˜¯å“ªä¸€æ¡æ¶ˆæ¯çš„é—®é¢˜ã€‚\nint batch = 100; for (int i = 0; i \u003c 1000; i++) { String message = i + \"Hello World\"; channel.basicPublish(\"\", HELLO, MessageProperties.PERSISTENT_TEXT_PLAIN, message.getBytes()); if (i % batch == 0) // æ‰‹åŠ¨æ‰¹é‡ğŸ˜€ channel.waitForConfirms(); } 5.3ã€å¼‚æ­¥ç¡®è®¤å‘å¸ƒ æ•ˆç‡å’Œå¯é æ–°éƒ½èƒ½ä¿éšœã€‚é€šè¿‡å›è°ƒå‡½æ•°è¾¾åˆ°æ¶ˆæ¯å¯é ä¼ è¾“ã€‚\nå‘å¸ƒçš„æ¶ˆæ¯å°è£…åœ¨ä¸€ä¸ª map ä¸­ï¼Œkey ä¸ºæ¶ˆæ¯çš„åºå·ï¼Œvalue ä¸ºæ¶ˆæ¯çš„å€¼ã€‚å‘å¸ƒè€…æ— éœ€æ‹…å¿ƒæ¶ˆæ¯æ˜¯å¦æ¥æ”¶æˆåŠŸï¼Œåªç®¡å‘é€å³å¯ï¼Œbroke ä¼šå¯¹ map ä¸­çš„æ¯ä¸€æ¡æ¶ˆæ¯å¤„ç†ï¼Œå¦‚æœæ¥æ”¶æˆåŠŸï¼Œåˆ™å‘å‘é€è€…å›å¤æ”¶åˆ°ï¼Œå¦åˆ™å‘å‘é€è€…å›å¤æœªæ”¶åˆ°ã€‚å¯¹æ¯ä¸€æ¡æ¶ˆæ¯éƒ½å›å¤ã€‚\npublic class ProduceAsync { public static void main(String[] args) throws IOException, TimeoutException { Channel channel = RabbitMqUtil.getChannel(); channel.queueDeclare(HELLO, true, false, false, null); // å¼€å¯å‘å¸ƒç¡®è®¤ channel.confirmSelect(); // æ­¤å¤„é€»è¾‘ä¸ºï¼šå…ˆå°†æ‰€æœ‰æ¶ˆæ¯è®°å½•ä¸‹æ¥ï¼Œåœ¨ç¡®è®¤å›è°ƒä¸­åˆ é™¤æ‰å·²ç¡®è®¤çš„ï¼Œå‰©ä¸‹çš„æ—¢æ˜¯æœªç¡®è®¤çš„ã€‚ // ä¹‹æ‰€ä»¥æ²¡æœ‰åœ¨æœªç¡®è®¤å›è°ƒä¸­ç›´æ¥æ·»åŠ æ•°æ®ï¼Œæ˜¯å› ä¸ºå›è°ƒå‡½æ•°åªèƒ½è·å–åˆ°åºå·ï¼Œæ— æ³•è·å–æ¶ˆæ¯ä½“ã€‚ ConcurrentSkipListMap\u003cLong, Object\u003e information = new ConcurrentSkipListMap\u003c\u003e(); // æ¶ˆæ¯æ¥å—æˆåŠŸå›è°ƒå‡½æ•° ConfirmCallback ackCallback = (deliveryTag, multiple) -\u003e { // æ‰¹é‡æ“ä½œ if (multiple) { // æ­¤å¤„ confirmed æ˜¯ outstandingConfirms çš„è§†å›¾ï¼Œå¯¹ confirm çš„æ“ä½œä¼šå½±å“åˆ° outstandingConfirmã€‚ // å› æ­¤ï¼Œè¿™ä¸€æ­¥çš„ç»“æœæ˜¯åˆ é™¤æ‰æ‰€æœ‰å·²ç¡®è®¤çš„æ¶ˆæ¯ ConcurrentNavigableMap\u003cLong, Object\u003e confirmed = information.headMap(deliveryTag); confirmed.clear(); } else { information.remove(deliveryTag); } }; // æ¶ˆæ¯æ¥å—å¤±è´¥å›è°ƒå‡½æ•° ConfirmCallback nackCallback = (deliveryTag, multiple) -\u003e {}; // ç›‘å¬å™¨ï¼Œå¼‚æ­¥é€šçŸ¥ã€‚è¿™é‡Œä¼šå¼€è¾Ÿä¸€ä¸ªçº¿ç¨‹è´Ÿè´£ç›‘å¬å¹¶å›è°ƒã€‚ // è¿™é‡Œåªæ˜¯å°†æœªç¡®è®¤çš„æ¶ˆæ¯ä¿å­˜äº†ä¸‹æ¥ï¼Œè¿™äº›æ¶ˆæ¯è¯¥å¦‚ä½•å¤„ç†ï¼Ÿç›´æ¥ä½¿ç”¨å—ï¼Ÿ channel.addConfirmListener(ackCallback, nackCallback); for (int i = 0; i \u003c 100; i++) { String message = \"hello\" + i; information.put(channel.getNextPublishSeqNo(), message); channel.basicPublish(\"\", HELLO, MessageProperties.PERSISTENT_TEXT_PLAIN, message.getBytes()); } } } å…­ã€äº¤æ¢æœº ç”Ÿäº§è€…ç”Ÿäº§çš„æ¶ˆæ¯ä¸ä¼šç›´æ¥å‘é€åˆ°é˜Ÿåˆ—ï¼Œåªèƒ½å‘ç»™äº¤æ¢æœºã€‚äº¤æ¢æœºçš„å·¥ä½œæœ‰ä¸¤ä¸ªï¼Œä¸€æ˜¯æ¥æ”¶æ¥è‡ªç”Ÿäº§è€…çš„æ¶ˆæ¯ï¼ŒäºŒæ˜¯å°†ä»–ä»¬æ¨å…¥é˜Ÿåˆ—ã€‚äº¤æ¢æœºå¿…é¡»ç¡®åˆ‡çŸ¥é“è¯¥å¦‚ä½•å¤„ç†æ¥æ”¶åˆ°çš„æ¶ˆæ¯ï¼Œæ˜¯å°†å…¶å‘é€åˆ°ç‰¹å®šçš„ä¸€ä¸ªæˆ–å¤šä¸ªé˜Ÿåˆ—è¿˜æ˜¯ä¸¢å¼ƒã€‚è¿™äº›éƒ½ç”±äº¤æ¢æœºçš„ç±»å‹å†³å®šã€‚ç±»å‹å¦‚ä¸‹ï¼š\nDirect Exchangeï¼šç›´è¿äº¤æ¢æœºï¼Œæ ¹æ®Routing Key(è·¯ç”±é”®)è¿›è¡ŒæŠ•é€’åˆ°ä¸åŒé˜Ÿåˆ—ã€‚ï¼ˆé»˜è®¤ï¼‰ Fanout Exchangeï¼šæ‰‡å½¢äº¤æ¢æœºï¼Œé‡‡ç”¨å¹¿æ’­æ¨¡å¼ï¼Œæ ¹æ®ç»‘å®šçš„äº¤æ¢æœºï¼Œè·¯ç”±åˆ°ä¸ä¹‹å¯¹åº”çš„æ‰€æœ‰é˜Ÿåˆ—ã€‚ Topic Exchangeï¼šä¸»é¢˜äº¤æ¢æœºï¼Œå¯¹è·¯ç”±é”®è¿›è¡Œæ¨¡å¼åŒ¹é…åè¿›è¡ŒæŠ•é€’ï¼Œç¬¦å·#è¡¨ç¤º0ä¸ªæˆ–å¤šä¸ªè¯ï¼Œ*è¡¨ç¤ºä¸€ä¸ªè¯ã€‚ Header Exchangeï¼šå¤´äº¤æ¢æœºï¼Œä¸å¤„ç†è·¯ç”±é”®ã€‚è€Œæ˜¯æ ¹æ®å‘é€çš„æ¶ˆæ¯å†…å®¹ä¸­çš„headerså±æ€§è¿›è¡ŒåŒ¹é…ã€‚ï¼ˆåŸºæœ¬åºŸå¼ƒï¼‰ è‹¥æƒ³è¦æ”¹å˜ä¸€ä¸ªäº¤æ¢æœºçš„ç±»å‹ï¼Œéœ€è¦å…ˆåˆ é™¤åŸæœ‰äº¤æ¢æœºï¼Œå†åˆ›å»ºæ–°äº¤æ¢æœºï¼Œå¦åˆ™æŠ¥é”™ã€‚\n6.1ã€ç»‘å®šï¼ˆbindingï¼‰ Binding å°±æ˜¯ Exchange å’Œ Queue ä¹‹é—´çš„æ¡¥æ¢ã€‚Exchange æ ¹æ®ç»‘å®šå…³ç³»å°†æ•°æ®å‘é€ç»™ Queue ã€‚\n6.2ã€Fanout Exchange Fanout Exchange ä¸ Routing_Key æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œå³ Exchange ä¼šå‘æ‰€æœ‰ä¸å®ƒç»‘å®šçš„é˜Ÿåˆ—å¹¿æ’­æ¶ˆæ¯ï¼Œå°½ç®¡æŸäº›é˜Ÿåˆ—ä½¿ç”¨çš„ Routing_Key å‘å¸ƒè€…æŒ‡å®šçš„ Routing_Key ä¸åŒï¼Œä¹Ÿä¼šå‘é€ã€‚\npublic class Producer { public static final String EXCHANGE_NAME = \"first_exchange\"; public static final String ROUTING_KEY = \"first_routing_key\"; public static void main(String[] args) throws IOException, TimeoutException { Channel channel = RabbitMqUtil.getChannel(); // å£°æ˜äº¤æ¢æœºï¼Œç±»å‹ä¸º FANOUT å¹¿æ’­ç±»å‹ channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.FANOUT); Scanner sc = new Scanner(System.in); while (sc.hasNext()) { String message = sc.next(); // å‘é€æ¶ˆæ¯åˆ°æŒ‡å®šçš„äº¤æ¢æœºå¹¶æŒ‡æ˜ä½¿ç”¨çš„ ROUTING_KEY channel.basicPublish(EXCHANGE_NAME, ROUTING_KEY, null, message.getBytes(StandardCharsets.UTF_8)); } } } public class Consumer1 { public static void main(String[] args) throws IOException, TimeoutException { Channel channel = RabbitMqUtil.getChannel(); // å£°æ˜ä¸€ä¸ªä¸´æ—¶é˜Ÿåˆ—ï¼Œæ¶ˆè´¹è€…æ–­å¼€å°±è‡ªåŠ¨åˆ é™¤ String queueName = channel.queueDeclare().getQueue(); // ç»‘å®š channel.queueBind(queueName, EXCHANGE_NAME, ROUTING_KEY); DeliverCallback deliverCallback = (consumerTag, message) -\u003e System.out.println(\"Consumer1: \" + new String(message.getBody())); channel.basicConsume(queueName, true, deliverCallback, (consumerTag, message) -\u003e {}); } } public class Consumer2 {} // Consumer2 ä¸ Consumer1 å®Œå…¨ç›¸åŒ 6.3ã€Direct Exchange Direct Exchange ä»…ä¼šå‘ä¸å®ƒé€šè¿‡ç‰¹å®šçš„ Routing_Key ç»‘å®šçš„é˜Ÿåˆ—å‘é€æ¶ˆæ¯ï¼Œè¿™ä¸ªç‰¹å®šçš„ Routing_Key å°±æ˜¯å‘å¸ƒè€…æŒ‡å®šçš„ Routing_Keyã€‚\n6.4ã€Topic Exchange Topic Exchange ä¸­ï¼Œå¯ä»¥ä½¿ç”¨å¸¦æœ‰é€šé…ç¬¦çš„ Routing_Key å°† Exchange å’Œ Queue è¿›è¡Œç»‘å®šã€‚\nåœ¨è¯¥æ¨¡å¼ä¸­ï¼Œå‘å¸ƒè€…æŒ‡å®šçš„ Routing_Key å¿…é¡»ä»¥ç‚¹å·éš”å¼€çš„å•è¯åˆ—è¡¨ï¼Œå¦‚ com.lu.mq\n#åŒ¹é… 0 ä¸ªæˆ–å¤šä¸ªè¯ï¼Œ*è¡¨ç¤º 1 ä¸ªè¯ã€‚æ³¨æ„æ˜¯ç‚¹ä¸ç‚¹ä¹‹é—´çš„å®Œæˆçš„è¯ï¼Œä¸æ˜¯å­—æ¯ã€‚å¦‚ com.*.mqã€ com.#\npublic class Producer { public static final String EXCHANGE_NAME = \"third_exchange\"; public static final String ROUTING_KEY = \"com.lu.mq\"; public static void main(String[] args) throws IOException, TimeoutException { Channel channel = RabbitMqUtil.getChannel(); // å£°æ˜äº¤æ¢æœºï¼Œç±»å‹ä¸º TOPIC ä¸»é¢˜ç±»å‹ channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.TOPIC); Scanner sc = new Scanner(System.in); while (sc.hasNext()) { String message = sc.next(); channel.basicPublish(EXCHANGE_NAME, ROUTING_KEY, null, message.getBytes(StandardCharsets.UTF_8)); } } } public class Consumer1 { public static void main(String[] args) throws IOException, TimeoutException { Channel channel = RabbitMqUtil.getChannel(); String queueName = channel.queueDeclare().getQueue(); channel.queueBind(queueName, EXCHANGE_NAME, \"com.#\"); DeliverCallback deliverCallback = (consumerTag, message) -\u003e System.out.println(\"Consumer1: \" + new String(message.getBody())); channel.basicConsume(queueName, true, deliverCallback, (consumerTag, message) -\u003e {}); } } public class Consumer2 { public static void main(String[] args) throws IOException, TimeoutException { Channel channel = RabbitMqUtil.getChannel(); String queueName = channel.queueDeclare().getQueue(); // ä¸€ä¸ªé˜Ÿåˆ—å¯ä»¥é€šè¿‡ä¸åŒçš„ Routing_Key ç»‘å®šä¸€ä¸ªæˆ–å¤šä¸ªäº¤æ¢æœº channel.queueBind(queueName, EXCHANGE_NAME, \"com.*.mq\"); channel.queueBind(queueName, EXCHANGE_NAME, \"com.lu.*\"); DeliverCallback deliverCallback = (consumerTag, message) -\u003e System.out.println(\"Consumer2: \" + new String(message.getBody())); channel.basicConsume(queueName, true, deliverCallback, (consumerTag, message) -\u003e {}); } } ä¸ƒã€æ­»ä¿¡é˜Ÿåˆ— æ²¡æœ‰è¢«æ¶ˆè´¹è€…æ¶ˆè´¹çš„æ¶ˆæ¯å«åšæ­»ä¿¡ï¼Œå­˜æ”¾æ­»ä¿¡çš„é˜Ÿåˆ—å«åšæ­»ä¿¡é˜Ÿåˆ—ã€‚\næœ‰ç‚¹ç±»ä¼¼äºé˜»å¡é˜Ÿåˆ—ï¼Œæ¡ä»¶ä¸æ»¡è¶³å°±é˜»å¡ï¼Œç›´åˆ°æ¡ä»¶æ»¡è¶³è¢«å”¤é†’ã€‚\nåº”ç”¨åœºæ™¯ï¼šæ¶ˆæ¯æ¶ˆè´¹å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œæ”¾å…¥æ­»ä¿¡é˜Ÿåˆ—ï¼Œä»¥é˜²æ­¢æ¶ˆæ¯ä¸¢å¤±ï¼›ç”¨æˆ·ä¸‹å•æœªæ”¯ä»˜ï¼Œè¶…æ—¶åå°†è®¢å•æ”¾å…¥æ­»ä¿¡é˜Ÿåˆ—ã€‚\n7.1ã€æ­»ä¿¡çš„æ¥æº æ¶ˆæ¯ TTL è¿‡æœŸ TTLæ˜¯Time To Liveçš„ç¼©å†™ï¼Œä¹Ÿå°±æ˜¯ç”Ÿå­˜æ—¶é—´ã€‚ RabbitMQæ”¯æŒæ¶ˆæ¯çš„è¿‡æœŸæ—¶é—´ï¼Œåœ¨æ¶ˆæ¯å‘é€æ—¶å¯ä»¥è¿›è¡ŒæŒ‡å®šï¼Œä»…ä½œç”¨äºè¯¥æ¶ˆæ¯ RabbitMQæ”¯æŒä¸ºæ¯ä¸ªé˜Ÿåˆ—è®¾ç½®æ¶ˆæ¯çš„è¶…æ—¶æ—¶é—´ï¼Œä»æ¶ˆæ¯å…¥é˜Ÿåˆ—å¼€å§‹è®¡ç®—ï¼Œå¦‚æœè¶…æ—¶æ¶ˆæ¯ä¼šè‡ªåŠ¨æ¸…é™¤ï¼Œä½œç”¨äºæ•´ä¸ªé˜Ÿåˆ— é˜Ÿåˆ—å·²æ»¡ æ¶ˆæ¯è¢«æ‹’ç»ï¼ˆrejectã€nackï¼‰ä¸” requeue = false 7.2ã€æ¶ˆæ¯ TTL è¿‡æœŸ // äº¤æ¢æœºå’Œé˜Ÿåˆ—çš„å£°æ˜æ”¾åœ¨å“ªé‡Œéƒ½å¯ä»¥ public class Consumer1 { public static final String NORMAL_EXCHANGE = \"normal_exchange\"; public static final String DEAD_EXCHANGE = \"dead_exchange\"; public static final String NORMAL_QUEUE = \"normal_queue\"; public static final String DEAD_QUEUE = \"dead_queue\"; public static final String NORMAL_ROUTING_KEY = \"normal_routing_key\"; public static final String DEAD_ROUTING_KEY = \"dead_routing_key\"; public static void main(String[] args) throws IOException, TimeoutException { Channel channel = RabbitMqUtil.getChannel(); channel.exchangeDeclare(NORMAL_EXCHANGE, BuiltinExchangeType.DIRECT); channel.exchangeDeclare(DEAD_EXCHANGE, BuiltinExchangeType.DIRECT); Map\u003cString, Object\u003e arguments = new HashMap\u003c\u003e(); arguments.put(\"x-dead-letter-exchange\", DEAD_EXCHANGE); // æŒ‡å®šæ­»ä¿¡æ¶ˆæ¯åº”è¯¥å‘é€ç»™å“ªä¸ªæ­»ä¿¡äº¤æ¢æœº arguments.put(\"x-dead-letter-routing-key\", DEAD_ROUTING_KEY); // è®¾ç½®æ­»ä¿¡äº¤æ¢æœºåˆ°æ­»ä¿¡é˜Ÿåˆ—çš„è·¯ç”± channel.queueDeclare(NORMAL_QUEUE, false, false, false, arguments); channel.queueDeclare(DEAD_QUEUE, false, false, false, null); channel.queueBind(NORMAL_QUEUE, NORMAL_EXCHANGE, NORMAL_ROUTING_KEY); channel.queueBind(DEAD_QUEUE, DEAD_EXCHANGE, DEAD_ROUTING_KEY); DeliverCallback deliverCallback = (consumerTag, message) -\u003e System.out.println(\"Consumer1: \" + new String(message.getBody())); channel.basicConsume(NORMAL_QUEUE, true, deliverCallback, (consumerTag, message) -\u003e {}); } } public class Producer { public static void main(String[] args) throws IOException, TimeoutException { Channel channel = RabbitMqUtil.getChannel(); AMQP.BasicProperties properties = new AMQP.BasicProperties().builder().expiration(\"10000\").build(); for (int i = 0; i \u003c 10; i++) { String message = \"hello\" + i; channel.basicPublish(NORMAL_EXCHANGE, NORMAL_ROUTING_KEY, properties, message.getBytes()); } } } // æ¶ˆè´¹æ­»ä¿¡ public class Consumer2 { public static void main(String[] args) throws IOException, TimeoutException { Channel channel = RabbitMqUtil.getChannel(); DeliverCallback deliverCallback = (consumerTag, message) -\u003e System.out.println(\"Consumer2: \" + new String(message.getBody())); channel.basicConsume(DEAD_QUEUE, true, deliverCallback, (consumerTag, message) -\u003e {}); } } 7.3ã€é˜Ÿåˆ—å·²æ»¡ åœ¨ consumer1 çš„ arguments ä¸­è®¾ç½®é˜Ÿåˆ—é•¿åº¦ï¼Œä¸”å°†ç”Ÿäº§è€…çš„è¿‡æœŸæ—¶é—´å–æ¶ˆå³å¯ã€‚\narguments.put(\"x-max-length\", 6); // è®¾ç½®é˜Ÿåˆ—é•¿åº¦ 7.4ã€æ¶ˆæ¯è¢«æ‹’ç» åœ¨ consumer1 ä¸­å…³é—­è‡ªåŠ¨åº”ç­”å¹¶æ‰‹åŠ¨å‘é€æ‹’ç» ack å³å¯ã€‚\nå…«ã€å»¶è¿Ÿé˜Ÿåˆ— 8.1ã€æ¦‚å¿µ å»¶è¿Ÿé˜Ÿåˆ—å…¶å®å°±æ˜¯ç¬¬ä¸ƒç« ä¸­ç”±äº ttl è¿‡æœŸå¯¼è‡´çš„æ­»ä¿¡é˜Ÿåˆ—çš„æ¼”åŒ–ã€‚\næ‰€è°“çš„å»¶æ—¶æ¶ˆæ¯ï¼Œæ˜¯æŒ‡æ¶ˆæ¯è¢«å‘é€ä»¥åï¼Œå¹¶ä¸æƒ³è®©æ¶ˆè´¹è€…ç«‹åˆ»è·å–ï¼Œè€Œæ˜¯ç­‰å¾…ç‰¹å®šçš„æ—¶é—´åï¼Œæ¶ˆè´¹è€…æ‰èƒ½è·å–è¿™ä¸ªæ¶ˆæ¯è¿›è¡Œæ¶ˆè´¹ã€‚\nå’Œå®šæ—¶ä»»åŠ¡çš„åŒºåˆ«ï¼š\nå®šæ—¶ä»»åŠ¡æœ‰æ˜ç¡®çš„è§¦å‘æ—¶é—´ï¼Œå»¶æ—¶ä»»åŠ¡æ²¡æœ‰ å®šæ—¶ä»»åŠ¡æœ‰æ‰§è¡Œå‘¨æœŸï¼Œè€Œå»¶æ—¶ä»»åŠ¡åœ¨æŸäº‹ä»¶è§¦å‘ä¸€æ®µæ—¶é—´å†…æ‰§è¡Œï¼Œæ²¡æœ‰æ‰§è¡Œå‘¨æœŸ å®šæ—¶ä»»åŠ¡ä¸€èˆ¬æ‰§è¡Œçš„æ‰¹å¤„ç†æ“ä½œæ˜¯å¤šä¸ªä»»åŠ¡ï¼Œè€Œå»¶æ—¶ä»»åŠ¡ä¸€èˆ¬æ˜¯å•ä¸ªä»»åŠ¡ 8.2ã€ä½¿ç”¨åœºæ™¯ åœ¨è®¢å•ç³»ç»Ÿä¸­ï¼Œè®¢å•å¦‚æœ30åˆ†é’Ÿä¹‹å†…æ²¡æœ‰æ”¯ä»˜æˆåŠŸï¼Œé‚£ä¹ˆè¿™ä¸ªè®¢å•å°†è¢«å…³é—­ï¼›ç”Ÿæˆè®¢å•60sä¹‹åç»™ç”¨æˆ·å‘é€šçŸ¥çŸ­ä¿¡ï¼›è¿™æ—¶å°±å¯ä»¥ä½¿ç”¨å»¶æ—¶é˜Ÿåˆ—æ¥å¤„ç†è¿™äº›è®¢å•ã€‚ ç”¨æˆ·æ³¨å†ŒæˆåŠŸåï¼Œè‹¥ 15 å¤©æœªç™»å½•åˆ™é‚®ç®±æé†’ã€‚ ç”¨æˆ·å¸Œæœ›é€šè¿‡æ‰‹æœºè¿œç¨‹é¥æ§å®¶é‡Œçš„æ™ºèƒ½è®¾å¤‡åœ¨æŒ‡å®šçš„æ—¶é—´è¿›è¡Œå·¥ä½œã€‚è¿™æ—¶å°±å¯ä»¥å°†ç”¨æˆ·æŒ‡ä»¤å‘é€åˆ°å»¶æ—¶é˜Ÿåˆ—ï¼Œå½“æŒ‡ä»¤çš„æ—¶é—´åˆ°äº†ä¹‹åå†å°†å®ƒæ¨é€åˆ°æ™ºèƒ½è®¾å¤‡ è®¢å•7å¤©è‡ªåŠ¨ç¡®è®¤æ”¶è´§ï¼Œåœ¨æˆ‘ä»¬ç­¾æ”¶å•†å“åï¼Œç‰©æµç³»ç»Ÿä¼šåœ¨7å¤©åå»¶æ—¶å‘é€ä¸€ä¸ªæ¶ˆæ¯ç»™æ”¯ä»˜ç³»ç»Ÿï¼Œé€šçŸ¥æ”¯ä»˜ç³»ç»Ÿå°†æ¬¾æ‰“ç»™å•†å®¶ é¢„å®šä¼šè®®åï¼Œåœ¨å¼€ä¼š 10 åˆ†é’Ÿå‰é€šçŸ¥ä¸ä¼šäººå‘˜ã€‚ 8.3ã€å»¶è¿Ÿé˜Ÿåˆ—å®ç° ç”±äºé˜Ÿåˆ—å…ˆè¿›å…ˆå‡ºçš„ç‰¹æ€§ï¼Œåªæœ‰å½“è¿‡æœŸçš„æ¶ˆæ¯åˆ°è¾¾é˜Ÿé¦–ï¼Œæ‰ä¼šè¢«ä¸¢å¼ƒæˆ–è¿›å…¥æ­»ä¿¡é˜Ÿåˆ—ã€‚æ‰€ä»¥å½“ä½¿ç”¨ Rabbitmq åšå»¶è¿Ÿé˜Ÿåˆ—æ¥å®ç°ä¸€ä¸ªä¸šåŠ¡æ—¶ï¼Œéœ€è¦ç¡®ä¿ä¸šåŠ¡ä¸Šçš„æ¶ˆæ¯çš„å»¶è¿Ÿæ—¶é—´ä¸€è‡´ã€‚è‹¥æœ‰ä¸åŒçš„å»¶è¿Ÿæ—¶é—´ï¼Œå°±å¿…é¡»ä¸ºæ¯ç§ä¸åŒçš„å»¶è¿Ÿæ—¶é—´å»ºç«‹ä¸åŒçš„é˜Ÿåˆ—ã€‚\nä¸æ¨èä½¿ç”¨ï¼Œè‹¥è¦é€šè¿‡ Rabbitmq ä½¿ç”¨å»¶è¿Ÿé˜Ÿåˆ—åº”è¯¥ä½¿ç”¨æ’ä»¶\nä¸Šå›¾ä¸­ï¼ŒX ä¸ºæ™®é€šäº¤æ¢æœºï¼ŒYä¸ºæ­»ä¿¡äº¤æ¢æœºã€‚QA å’Œ QB é˜Ÿåˆ—åˆ†åˆ«å»¶è¿Ÿ 10s å’Œ 40sï¼ŒQC é˜Ÿåˆ—ä¸è®¾ç½®å»¶è¿Ÿã€‚QD ä¸ºæ­»ä¿¡é˜Ÿåˆ—ã€‚\nspring bootå¼•å…¥ä¾èµ–\norg.springframework.boot spring-boot-starter-amqp ä¸»é…ç½®æ–‡ä»¶é…ç½®æœåŠ¡å™¨\nspring: rabbitmq: host: 192.168.36.128 port: 5672 username: guest password: guest å†™é…ç½®ç±»\n@Configuration public class TtlQueueConfig { // äº¤æ¢æœº public static final String X_EXCHANGE = \"X\"; public static final String DEAD_LETTER_Y_EXCHANGE = \"Y\"; // é˜Ÿåˆ— public static final String QUEUE_A = \"QA\"; public static final String QUEUE_B = \"QB\"; public static final String QUEUE_C = \"QC\"; public static final String DEAD_LETTER_QUEUE_D = \"QD\"; // é˜Ÿåˆ— A B çš„è¿‡æœŸæ—¶é—´ public static final Integer QUEUE_A_TTL = 10000; public static final Integer QUEUE_B_TTL = 40000; // è·¯ç”± public static final String XA_ROUTING_KEY = \"XA\"; public static final String XB_ROUTING_KEY = \"XB\"; public static final String XC_ROUTING_KEY = \"XC\"; public static final String DEAD_LETTER_ROUTING_KEY = \"YD\"; // å£°æ˜äº¤æ¢æœº @Bean public DirectExchange xExchange() { return new DirectExchange(X_EXCHANGE); } @Bean public DirectExchange yExchange() { return new DirectExchange(DEAD_LETTER_Y_EXCHANGE); } // å£°æ˜é˜Ÿåˆ—å¹¶é…ç½®æ­»ä¿¡äº¤æ¢æœº @Bean public Queue queueA() { Map\u003cString, Object\u003e arguments = new HashMap\u003c\u003e(); arguments.put(\"x-dead-letter-exchange\", DEAD_LETTER_Y_EXCHANGE); arguments.put(\"x-dead-letter-routing-key\", DEAD_LETTER_ROUTING_KEY); arguments.put(\"x-message-ttl\", QUEUE_A_TTL); return QueueBuilder.durable(QUEUE_A).withArguments(arguments).build(); } @Bean public Queue queueB() { Map\u003cString, Object\u003e arguments = new HashMap\u003c\u003e(); arguments.put(\"x-dead-letter-exchange\", DEAD_LETTER_Y_EXCHANGE); arguments.put(\"x-dead-letter-routing-key\", DEAD_LETTER_ROUTING_KEY); arguments.put(\"x-message-ttl\", QUEUE_B_TTL); return QueueBuilder.durable(QUEUE_B).withArguments(arguments).build(); } @Bean public Queue queueC() { Map\u003cString, Object\u003e arguments = new HashMap\u003c\u003e(); arguments.put(\"x-dead-letter-exchange\", DEAD_LETTER_Y_EXCHANGE); arguments.put(\"x-dead-letter-routing-key\", DEAD_LETTER_ROUTING_KEY); return QueueBuilder.durable(QUEUE_C).withArguments(arguments).build(); } @Bean public Queue queueD() { return QueueBuilder.durable(DEAD_LETTER_QUEUE_D).build(); } // ç»‘å®š @Bean public Binding queueABindingX(@Qualifier(\"queueA\") Queue queueA, @Qualifier(\"xExchange\") DirectExchange xExchange) { return BindingBuilder.bind(queueA).to(xExchange).with(XA_ROUTING_KEY); } @Bean public Binding queueBBindingX(@Qualifier(\"queueB\") Queue queueB, @Qualifier(\"xExchange\") DirectExchange xExchange) { return BindingBuilder.bind(queueB).to(xExchange).with(XB_ROUTING_KEY); } @Bean public Binding queueCBindingX(@Qualifier(\"queueC\") Queue queueC, @Qualifier(\"xExchange\") DirectExchange xExchange) { return BindingBuilder.bind(queueC).to(xExchange).with(XC_ROUTING_KEY); } @Bean public Binding queueDBindingY(@Qualifier(\"queueD\") Queue queueD, @Qualifier(\"yExchange\") DirectExchange yExchange) { return BindingBuilder.bind(queueD).to(yExchange).with(DEAD_LETTER_ROUTING_KEY); } } å‘é€è€…ä¸æ¥å—è€…\n// Controller æ¥æ”¶ web çš„å‚æ•°å¹¶å‘é€åˆ° mq @RestController public class SendMsgController { @Autowired private RabbitTemplate rabbitTemplate; @GetMapping(\"/ttl/msg/{message}\") public void sendMessage(@PathVariable String message) { rabbitTemplate.convertAndSend(\"X\", \"XA\", \"10s \" + message); // å‘é˜Ÿåˆ—Aå‘æ¶ˆæ¯ rabbitTemplate.convertAndSend(\"X\", \"XB\", \"40s \" + message); // å‘é˜Ÿåˆ—Bå‘æ¶ˆæ¯ } @GetMapping(\"/ttl/msg/{message}/{ttlTime}\") public void sendMessage(@PathVariable String message, @PathVariable String ttlTime) { rabbitTemplate.convertAndSend(\"X\", \"XC\", message, msg -\u003e { msg.getMessageProperties().setExpiration(ttlTime); return msg; }); } } // æ¥æ”¶æ­»ä¿¡é˜Ÿåˆ—çš„æ¶ˆæ¯ @Component public class DeadLetterConsumer { @RabbitListener(queues = \"QD\") public void receiveD(Message message) { String msg = new String(message.getBody()); System.out.println(\"receive message \" + msg); } } 8.4ã€å»¶è¿Ÿé˜Ÿåˆ—æ’ä»¶ å¯¹é˜Ÿåˆ—è®¾ç½® TTL ä¼šå¯¼è‡´ç³»ç»Ÿéœ€è¦å¾ˆå¤šçš„é˜Ÿåˆ—ï¼Œä½¿ç³»ç»Ÿå¤æ‚ã€‚å¯¹æ¶ˆæ¯è®¾ç½® TTL ç”±äºæ¶ˆæ¯ç§¯å‹ä¼šå¯¼è‡´ä¸åœ¨é˜Ÿé¦–çš„æ¶ˆæ¯ä¸èƒ½åŠæ—¶è¿›å…¥æ­»ä¿¡é˜Ÿåˆ—ã€‚ä¸ºå¼¥è¡¥ä¸è¶³ï¼Œå¼•å…¥æ’ä»¶æ¥å®ç°å»¶è¿Ÿé˜Ÿåˆ—ã€‚\n# ç”±äº mq å®¹å™¨å†…æ²¡æœ‰ wget ï¼Œæ•…å…ˆåœ¨ä¸»æœºä¸‹è½½æ’ä»¶ wget https://github.com/rabbitmq/rabbitmq-delayed-message-exchange/releases/download/3.10.0/rabbitmq_delayed_message_exchange-3.10.0.ez # å¤åˆ¶åˆ°å®¹å™¨ä¸­çš„æ’ä»¶ç›®å½•ï¼Œ mq æ˜¯å®¹å™¨å docker cp rabbitmq_delayed_message_exchange-3.10.0.ez mq:/opt/rabbitmq/plugin # è¿›å…¥å®¹å™¨å¯ç”¨æ’ä»¶ rabbitmq-plugins enable rabbitmq_delayed_message_exchange æˆåŠŸå¯åŠ¨ä¹‹åï¼Œè¿›å…¥ web æ§åˆ¶å°çš„ exchangesï¼Œæ·»åŠ äº¤æ¢æœºï¼Œtype æ ä¸­å¤šäº†ä¸€ä¸ª x-delayed-message é€‰é¡¹ã€‚\nåŸºäºæ’ä»¶çš„å»¶è¿Ÿé˜Ÿåˆ—ä¸éœ€è¦ä¸“é—¨è®¾ç½®è¿‡æœŸé˜Ÿåˆ—\n@Configuration public class DelayQueueConfig { public static final String DELAYED_QUEUE = \"delayed_queue\"; public static final String DELAYED_EXCHANGE = \"delayed_exchange\"; public static final String DELAYED_ROUTING_KEY = \"delayed_routing_key\"; @Bean public CustomExchange delayedExchange() { Map\u003cString, Object\u003e arguments = new HashMap\u003c\u003e(); arguments.put(\"x-delayed-message\", \"direct\"); // å»¶è¿Ÿäº¤æ¢æœºçš„ç±»å‹ä¸ºç›´è¿ç±»å‹ /* * 1. äº¤æ¢æœºåç§° * 2. äº¤æ¢æœºç±»å‹ * 3. æ˜¯å¦éœ€è¦æŒä¹…åŒ– * 4. æ˜¯å¦è‡ªåŠ¨åˆ é™¤ * 5. å…¶ä»–å‚æ•° */ return new CustomExchange(DELAYED_EXCHANGE, \"x-delayed-message\", true, false, arguments); } @Bean public Queue delayedQueue() { return QueueBuilder.durable(DELAYED_QUEUE).build(); } @Bean public Binding delayedBinding(@Qualifier(\"delayedQueue\") Queue delayedQueue, @Qualifier(\"delayedExchange\") CustomExchange delayedExchange) { return BindingBuilder.bind(delayedQueue).to(delayedExchange).with(DELAYED_ROUTING_KEY).noargs(); } } ä½¿ç”¨æ—¶ä¼ å…¥æ¶ˆæ¯å’Œè¿‡æœŸæ—¶é—´ã€‚\nä¹ã€é«˜çº§å‘å¸ƒç¡®è®¤ å‘å¸ƒç¡®è®¤æœºåˆ¶åŒ…æ‹¬ä¸¤ä¸ªéƒ¨åˆ†\n1ã€äº¤æ¢æœºç¡®è®¤: ä¿è¯ Producer ç”Ÿäº§çš„æ¶ˆæ¯æˆåŠŸæŠ•é€’åˆ°äº¤æ¢æœºä¸Šè€Œä¸å‘ç”Ÿä¸¢å¤±\n2ã€æ¶ˆæ¯çš„å›é€€: ä¿è¯äº¤æ¢æœºæˆåŠŸå°†æ¶ˆæ¯è·¯ç”±åˆ°é˜Ÿåˆ—ä¸Šè€Œä¸å‘ç”Ÿæ¶ˆæ¯\n9.1ã€å‘å¸ƒç¡®è®¤+æ¶ˆæ¯å›é€€ äº¤æ¢æœºç¡®è®¤ï¼šäº¤æ¢æœºæ¥æ”¶åˆ°æ¶ˆæ¯åï¼Œä¼šç›´æ¥ç»™æ¶ˆæ¯ç”Ÿäº§è€…å‘é€ç¡®è®¤æ¶ˆæ¯ã€‚ä½†å¦‚æœå‘ç°æ¶ˆæ¯ä¸å¯è·¯ç”±å°±ä¼šç›´æ¥ä¸¢å¼ƒè¯¥æ¶ˆæ¯ï¼Œæ­¤æ—¶ç”Ÿäº§è€…æ— æ³•æ„ŸçŸ¥æ¶ˆæ¯å·²è¢«ä¸¢å¼ƒã€‚\næ¶ˆæ¯å›é€€ï¼šäº¤æ¢æœºå‘é˜Ÿåˆ—ä¼ é€’è¿‡ç¨‹ä¸­ä¸å¯è¾¾çš„æ¶ˆæ¯è¿”å›ç»™ç”Ÿäº§è€…ã€‚\nå³äº¤æ¢æœºç¡®è®¤ä¿è¯å‘å¸ƒè€…åˆ°äº¤æ¢æœºçš„æ¶ˆæ¯ä¸ä¸¢å¤±ï¼Œæ¶ˆæ¯å›é€€ä¿è¯äº¤æ¢æœºåˆ°é˜Ÿåˆ—çš„æ¶ˆæ¯ä¸ä¸¢å¤±ã€‚\nå¼€å¯å‘å¸ƒç¡®è®¤æ¨¡å¼+æ¶ˆæ¯å›é€€\nspring: rabbitmq: publisher-returns: true # å¼€å¯æ¶ˆæ¯å›é€€ publisher-confirm-type: correlated # correlatedï¼šå¼€å¯å‘å¸ƒç¡®è®¤ï¼Œå¼‚æ­¥ç¡®è®¤ # noneï¼šç¦ç”¨å‘å¸ƒç¡®è®¤ # simpleï¼šåŒæ­¥ç¡®è®¤ï¼Œå•ä¸ªç¡®è®¤ã€‚å¯ä»¥é€šè¿‡ rabbitTemplate è°ƒç”¨ waitForConfirms() æ–¹æ³•æ§åˆ¶é€»è¾‘ã€‚ è‡ªå®šä¹‰å›è°ƒå‡½æ•°\n@Component public class MyConfirmCallback implements RabbitTemplate.ConfirmCallback, RabbitTemplate.ReturnsCallback { @Autowired private RabbitTemplate rabbitTemplate; // è¯¥æ³¨è§£çš„ä½œç”¨ï¼šå¯¹è±¡åˆ›å»ºå®Œæˆå¹¶å®Œæˆæ³¨å…¥ä¹‹åæ‰§è¡Œã€‚å³æ‰§è¡Œé¡ºåºä¸ºï¼š Construct -\u003e Autowired -\u003e PostConstruct @PostConstruct public void init() { rabbitTemplate.setConfirmCallback(this); rabbitTemplate.setReturnsCallback(this); } /** * è‹¥äº¤æ¢æœºæ¥æ”¶æ¶ˆæ¯æˆåŠŸ * @param correlationData æ¶ˆæ¯çš„ ID åŠç›¸å…³ä¿¡æ¯ * @param ack b = true * @param s s = null * * è‹¥äº¤æ¢æœºæ¥æ”¶æ¶ˆæ¯å¤±è´¥ï¼ˆå®•æœºæˆ–ç½‘ç»œè¿æ¥å¤±è´¥ç­‰) * @param correlationData æ¶ˆæ¯çš„ ID åŠç›¸å…³ä¿¡æ¯ * @param ack b = false * @param s s = å¤±è´¥çš„åŸå›  */ @Override public void confirm(CorrelationData correlationData, boolean ack, String s) { if (ack) System.out.println(correlationData.getId()); else System.out.println(s + \" \" + correlationData.getId()); } // æ¶ˆæ¯å›é€€ @Override public void returnedMessage(ReturnedMessage returned) { System.out.printf(\"message %s, backed by exchange %s, reason by %s, routing key is %s%n\", new String(returned.getMessage().getBody()), returned.getExchange(), returned.getReplyText(), returned.getRoutingKey()); } } å‘é€è€…\n@GetMapping(\"/confirm/msg/{msg}\") public void sendMsg(@PathVariable String msg) { // å›è°ƒå‡½æ•°ä¸­çš„ CorrelationData éœ€è¦åœ¨è¿™é‡Œå®šä¹‰ï¼Œå¯ä»¥æŒ‡å®šæ¶ˆæ¯çš„åºå·å’Œéœ€è¦è¿”å›çš„æ¶ˆæ¯ã€‚æ­¤å¤„æ¨¡æ‹Ÿäº†ä¸€ä¸ªåºå· CorrelationData correlationData = new CorrelationData(\"1\"); // äº¤æ¢æœºä¸å­˜åœ¨ï¼Œç”±å‘å¸ƒç¡®è®¤ä¿è¯å›è°ƒ MyConfirmCallback ä¸­çš„ confirm æ–¹æ³• rabbitTemplate.convertAndSend(ConfirmConfig.CONFIRM_EXCHANGE + \"12\", ConfirmConfig.CONFIRM_ROUTING_KEY, msg, correlationData); // è·¯ç”±ä¸å¯è¾¾ï¼Œç”±æ¶ˆæ¯å›é€€ä¿è¯å›è°ƒ MyConfirmCallback ä¸­çš„ returnedMessage æ–¹æ³• rabbitTemplate.convertAndSend(ConfirmConfig.CONFIRM_EXCHANGE, ConfirmConfig.CONFIRM_ROUTING_KEY + \"12\", msg, correlationData); } 9.2ã€å¤‡ä»½äº¤æ¢æœº äº¤æ¢æœºåˆ°é˜Ÿåˆ—çš„è·¯ç”±ä¸å¯è¾¾æ—¶å¯ä»¥å°†æ¶ˆæ¯æŠ•æ”¾ç»™å¤‡ä»½äº¤æ¢æœºã€‚å¤‡ä»½äº¤æ¢æœºå°†æ¶ˆæ¯å¹¿æ’­ç»™ä¸¤ä¸ªé˜Ÿåˆ—ï¼Œåˆ†åˆ«ç”¨ä½œæ¶ˆæ¯çš„å¤‡ä»½ä¸æ£€æµ‹æŠ¥è­¦ã€‚\næ³¨æ„ï¼šå¦‚æœæ¶ˆæ¯æ— æ³•åˆ°è¾¾äº¤æ¢æœºï¼Œåˆ™ç›´æ¥ä¼šç”±å‘å¸ƒç¡®è®¤æœºåˆ¶å›è°ƒäº¤æ¢æœºä¸å¯è¾¾å‡½æ•°ï¼Œæ¶ˆæ¯å°†ä¸ä¼šè¿›å…¥å¤‡ä»½äº¤æ¢æœºã€‚\nå¦‚æœåŒæ—¶å¼€å¯äº†å¤‡ä»½äº¤æ¢å’Œæ¶ˆæ¯å›é€€ï¼Œå¤‡ä»½äº¤æ¢æœºçš„ä¼˜å…ˆçº§æ›´é«˜ã€‚\n@Component public class ConfirmConfig { public static final String CONFIRM_QUEUE = \"confirm_queue\"; public static final String CONFIRM_EXCHANGE = \"confirm_exchange\"; public static final String CONFIRM_ROUTING_KEY = \"confirm_routing_key\"; public static final String BACKUP_QUEUE = \"backup_queue\"; public static final String WARNING_QUEUE = \"warning_queue\"; public static final String BACKUP_EXCHANGE = \"backup_exchange\"; // å£°æ˜äº¤æ¢æœº @Bean public DirectExchange confirmExchange() { // æŒ‡å®šå¤‡ä»½äº¤æ¢æœº return ExchangeBuilder.directExchange(CONFIRM_EXCHANGE) .alternate(BACKUP_EXCHANGE).build(); } @Bean public FanoutExchange backupExchange() { return new FanoutExchange(BACKUP_EXCHANGE); } // å£°æ˜é˜Ÿåˆ— @Bean public Queue confirmQueue() { return QueueBuilder.durable(CONFIRM_QUEUE).build(); } @Bean public Queue backupQueue() { return QueueBuilder.durable(BACKUP_QUEUE).build(); } @Bean public Queue warningQueue() { return QueueBuilder.durable(WARNING_QUEUE).build(); } // ç»‘å®š @Bean public Binding confirmBinding(@Qualifier(\"confirmQueue\") Queue confirmQueue, @Qualifier(\"confirmExchange\") DirectExchange confirmExchange) { return BindingBuilder.bind(confirmQueue).to(confirmExchange).with(CONFIRM_ROUTING_KEY); } @Bean public Binding backToBackBinding(@Qualifier(\"backupQueue\") Queue backupQueue, @Qualifier(\"backupExchange\") FanoutExchange backupExchange) { return BindingBuilder.bind(backupQueue).to(backupExchange); } @Bean public Binding warningToBackBinding(@Qualifier(\"warningQueue\") Queue warningQueue, @Qualifier(\"backupExchange\") FanoutExchange backupExchange) { return BindingBuilder.bind(warningQueue).to(backupExchange); } } // ç›‘å¬æŠ¥è­¦é˜Ÿåˆ— @Component public class WarningConsumer { @RabbitListener(queues = ConfirmConfig.WARNING_QUEUE) public void receiveWarningMsg(Message message) { System.out.printf(\"warning! message {%s} does not execute success. \", new String(message.getBody())); } } åã€ç›¸å…³çŸ¥è¯†ç‚¹ 10.1ã€å¹‚ç­‰æ€§ åœ¨ç¼–ç¨‹ä¸­ä¸€ä¸ªå¹‚ç­‰æ“ä½œçš„ç‰¹ç‚¹æ˜¯å…¶ä»»æ„å¤šæ¬¡æ‰§è¡Œæ‰€äº§ç”Ÿçš„å½±å“å‡ä¸ä¸€æ¬¡æ‰§è¡Œçš„å½±å“ç›¸åŒã€‚HTTPæ–¹æ³•çš„å¹‚ç­‰æ€§æ˜¯æŒ‡ä¸€æ¬¡å’Œå¤šæ¬¡è¯·æ±‚æŸä¸€ä¸ªèµ„æºåº”è¯¥å…·æœ‰åŒæ ·çš„å‰¯ä½œç”¨ã€‚ç®€ä¹‹ï¼šä¸€ä¸ªè¯·æ±‚ï¼Œä¸ç®¡é‡å¤æ¥å¤šå°‘æ¬¡ï¼Œç»“æœæ˜¯ä¸ä¼šæ”¹å˜çš„ã€‚\næ¶ˆè´¹è€…åœ¨æ¶ˆè´¹ MQ ä¸­çš„æ¶ˆæ¯æ—¶ï¼ŒMQ å·²æŠŠæ¶ˆæ¯å‘é€ç»™æ¶ˆè´¹è€…ï¼Œæ¶ˆè´¹è€…åœ¨ç»™ MQ è¿”å› ack æ—¶ç½‘ç»œä¸­æ–­ï¼Œæ•… MQ æœªæ”¶åˆ°ç¡®è®¤ä¿¡æ¯ï¼Œè¯¥æ¡æ¶ˆæ¯ä¼šé‡æ–°å‘ç»™å…¶ä»–çš„æ¶ˆè´¹è€…ï¼Œæˆ–è€…åœ¨ç½‘ç»œé‡è¿åå†æ¬¡å‘é€ç»™è¯¥æ¶ˆè´¹è€…ï¼Œä½†å®é™…ä¸Šè¯¥æ¶ˆè´¹è€…å·²æˆåŠŸæ¶ˆè´¹äº†è¯¥æ¡æ¶ˆæ¯ï¼Œé€ æˆæ¶ˆè´¹è€…æ¶ˆè´¹äº†é‡å¤çš„æ¶ˆæ¯ï¼›æ³¨æ„ï¼ŒRabbitMQ è¿™ç§æ¶ˆæ¯é‡è¯•(è¡¥å¿)æœºåˆ¶æ˜¯é»˜è®¤çš„ã€‚\n@RabbitListener åº•å±‚ä½¿ç”¨ AOP è¿›è¡Œå¼‚å¸¸é€šçŸ¥æ‹¦æˆªï¼Œå¦‚æœç¨‹åºæ²¡æœ‰æŠ›å‡ºå¼‚å¸¸ä¿¡æ¯ï¼Œé‚£ä¹ˆå°±ä¼šè‡ªåŠ¨æäº¤äº‹åŠ¡ï¼›å¦‚æœ AOP å¼‚å¸¸é€šçŸ¥æ‹¦æˆªæœ‰æ•è·åˆ°å¼‚å¸¸ä¿¡æ¯çš„è¯ï¼Œå°±ä¼šè‡ªåŠ¨å®ç°é‡è¯•(è¡¥å¿)æœºåˆ¶ï¼ŒåŒæ—¶ï¼Œè¿™ä¸ªè¡¥å¿æœºåˆ¶çš„æ¶ˆæ¯ä¼šç¼“å­˜åˆ° RabbitMQ æœåŠ¡å™¨ç«¯è¿›è¡Œå­˜æ”¾ï¼Œä¸€ç›´é‡è¯•åˆ°ä¸æŠ›å‡ºå¼‚å¸¸ä¸ºæ­¢ã€‚\nè§£å†³æ–¹å¼ï¼š\nä¸ºæ¯ä¸ªæ¶ˆæ¯åˆ†é…å…¨å±€å”¯ä¸€IDï¼Œæ¶ˆè´¹å‰é€šè¿‡ redis çš„ setnx å‘½ä»¤å†™å…¥æ¶ˆæ¯çš„IDï¼Œè‹¥å†™å…¥æˆåŠŸå°±æ¶ˆè´¹ï¼Œå¦åˆ™ä¸¢å¼ƒï¼Œæ­¤æ—¶ä¸è®ºæ˜¯å¦æ¶ˆè´¹éƒ½åº”å‘é€ackã€‚\n10.2ã€ä¼˜å…ˆçº§é˜Ÿåˆ— é˜Ÿåˆ—çš„ç‰¹ç‚¹æ˜¯å…ˆè¿›å…ˆå‡ºï¼Œä½†æ˜¯æœ‰äº›åœºæ™¯ä¸‹éœ€è¦å¯¹é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯èµ‹äºˆä¼˜å…ˆçº§ï¼Œä½¿å¾—ä¼˜å…ˆçº§é«˜çš„æ¶ˆæ¯è¶Šå¿«è¢«æ¶ˆè´¹ã€‚ä¼˜å…ˆçº§é˜Ÿåˆ—åº•å±‚æ˜¯å¤§é¡¶å †ã€‚\nç”±äºç§ç§åŸå› ï¼ŒRabbitMQåˆ°ç›®å‰ä¸ºæ­¢ï¼Œå®˜æ–¹è¿˜æ²¡æœ‰å®ç°ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œåªå®ç°äº†Consumerçš„ä¼˜å…ˆçº§å¤„ç†ã€‚å³æ¯æ¬¡å¯¹é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯æŒ‰ä¼˜å…ˆçº§æ’åºåå–å‡ºä¼˜å…ˆçº§æœ€é«˜çš„æ¶ˆæ¯ã€‚\nå½“ç„¶ï¼Œåœ¨æ¶ˆè´¹ç«¯é€Ÿåº¦å¤§äºç”Ÿäº§ç«¯é€Ÿåº¦ï¼Œä¸”brokerä¸­æ²¡æœ‰æ¶ˆæ¯å †ç§¯çš„è¯ï¼Œå¯¹å‘é€çš„æ¶ˆæ¯è®¾ç½®ä¼˜å…ˆçº§ä¹Ÿæ²¡ä»€ä¹ˆå®é™…æ„ä¹‰ï¼Œæ²¡æœºä¼šæ’åºã€‚\né˜Ÿåˆ—å£°æ˜æ—¶æŒ‡å®šæœ€å¤§ä¼˜å…ˆçº§\n@Bean public Queue confirmQueue() { return QueueBuilder.durable(CONFIRM_QUEUE).maxPriority(10).build(); } å‘é€æ¶ˆæ¯æ—¶æŒ‡å®šæ¶ˆæ¯çš„ä¼˜å…ˆçº§\nrabbitTemplate.convertAndSend(\"X\", \"XC\", message, msg -\u003e { msg.getMessageProperties().setPriority(5); return msg; }); 10.3ã€æƒ°æ€§é˜Ÿåˆ— æƒ°æ€§é˜Ÿåˆ—å³æ”¶åˆ°æ¶ˆæ¯åç›´æ¥å­˜æ”¾åœ¨ç£ç›˜ä¸­ï¼Œå†…å­˜ä¸­ä¸å­˜ï¼Œæ¶ˆè´¹è€…æ¯æ¬¡å–æ¶ˆæ¯æ—¶ï¼Œéƒ½éœ€è¦å°†æ¶ˆæ¯åŠ è½½åˆ°å†…å­˜å†å‘é€ç»™æ¶ˆè´¹è€…ï¼Œæ‰€ä»¥å¾ˆæ…¢ã€‚\næŒä¹…åŒ–æ˜¯å°†æ¶ˆæ¯å³å­˜åœ¨å†…å­˜åˆå­˜åœ¨ç£ç›˜ï¼Œæ¶ˆè´¹è€…å»å†…å­˜å–ã€‚\næ¶ˆè´¹è€…å¤„ç†æ¶ˆæ¯å¾ˆæ…¢æˆ–æ— æ³•å¤„ç†æ¶ˆæ¯ä½¿å¾—é˜Ÿåˆ—ç§¯å‹äº†å¤§é‡æ¶ˆæ¯æ—¶å¯ä»¥é‡‡ç”¨æƒ°æ€§é˜Ÿåˆ—ï¼Œé‡Šæ”¾å†…å­˜ã€‚\né¢è¯•é¢˜\n","wordCount":"2148","inLanguage":"en","datePublished":"2022-04-07T14:42:15Z","dateModified":"2022-04-07T14:42:15Z","author":{"@type":"Person","name":"lu"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ethereal-lu.github.io/posts/%E5%88%86%E5%B8%83%E5%BC%8F/rabbitmq/rabbitmq/"},"publisher":{"@type":"Organization","name":"lu","logo":{"@type":"ImageObject","url":"https://ethereal-lu.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://ethereal-lu.github.io/ accesskey=h title="lu (Alt + H)">lu</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://ethereal-lu.github.io/categories/ title=categories><span>categories</span></a></li><li><a href=https://ethereal-lu.github.io/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://ethereal-lu.github.io/>Home</a>&nbsp;Â»&nbsp;<a href=https://ethereal-lu.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">RabbitMQåŸºç¡€</h1><div class=post-meta><span title='2022-04-07 14:42:15 +0000 UTC'>2022-04-07</span>&nbsp;Â·&nbsp;2148 words&nbsp;Â·&nbsp;lu</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#ä¸€æ¦‚è¿°>ä¸€ã€æ¦‚è¿°</a><ul><li><a href=#11ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—>1.1ã€ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—</a></li><li><a href=#12ä¸ºä»€ä¹ˆä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—>1.2ã€ä¸ºä»€ä¹ˆä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—</a></li><li><a href=#13mqtt-ä¸-mq-çš„åŒºåˆ«>1.3ã€mqtt ä¸ MQ çš„åŒºåˆ«</a></li><li><a href=#14rpc-æ‰§è¡Œæµç¨‹>1.4ã€RPC æ‰§è¡Œæµç¨‹</a></li><li><a href=#15mq-åˆ†ç±»>1.5ã€MQ åˆ†ç±»</a></li></ul></li><li><a href=#äºŒrabbitmqä»‹ç»>äºŒã€RabbitMQä»‹ç»</a><ul><li><a href=#21rabbitmq-ç®€ä»‹>2.1ã€RabbitMQ ç®€ä»‹</a></li><li><a href=#22amqp>2.2ã€AMQP</a></li><li><a href=#23ç›¸å…³æ¦‚å¿µ>2.3ã€ç›¸å…³æ¦‚å¿µ</a></li></ul></li><li><a href=#ä¸‰åˆä½“éªŒ>ä¸‰ã€åˆä½“éªŒ</a><ul><li><a href=#31å¼€å¯-rabbitmq>3.1ã€å¼€å¯ rabbitmq</a></li><li><a href=#32java-ä½¿ç”¨-rabbitmq-åˆä½“éªŒ>3.2ã€java ä½¿ç”¨ rabbitmq åˆä½“éªŒ</a></li></ul></li><li><a href=#å››å·¥ä½œé˜Ÿåˆ—>å››ã€å·¥ä½œé˜Ÿåˆ—</a><ul><li><a href=#41æ¶ˆæ¯åº”ç­”>4.1ã€æ¶ˆæ¯åº”ç­”</a></li><li><a href=#42æŒä¹…åŒ–>4.2ã€æŒä¹…åŒ–</a></li><li><a href=#43å…¬å¹³åˆ†å‘>4.3ã€å…¬å¹³åˆ†å‘</a></li></ul></li><li><a href=#äº”å‘å¸ƒç¡®è®¤>äº”ã€å‘å¸ƒç¡®è®¤</a><ul><li><a href=#51å•ä¸ªç¡®è®¤å‘å¸ƒ>5.1ã€å•ä¸ªç¡®è®¤å‘å¸ƒ</a></li><li><a href=#52æ‰¹é‡ç¡®è®¤å‘å¸ƒ>5.2ã€æ‰¹é‡ç¡®è®¤å‘å¸ƒ</a></li><li><a href=#53å¼‚æ­¥ç¡®è®¤å‘å¸ƒ>5.3ã€å¼‚æ­¥ç¡®è®¤å‘å¸ƒ</a></li></ul></li><li><a href=#å…­äº¤æ¢æœº>å…­ã€äº¤æ¢æœº</a><ul><li><a href=#61ç»‘å®šbinding>6.1ã€ç»‘å®šï¼ˆbindingï¼‰</a></li><li><a href=#62fanout-exchange>6.2ã€Fanout Exchange</a></li><li><a href=#63direct-exchange>6.3ã€Direct Exchange</a></li><li><a href=#64topic-exchange>6.4ã€Topic Exchange</a></li></ul></li><li><a href=#ä¸ƒæ­»ä¿¡é˜Ÿåˆ—>ä¸ƒã€æ­»ä¿¡é˜Ÿåˆ—</a><ul><li><a href=#71æ­»ä¿¡çš„æ¥æº>7.1ã€æ­»ä¿¡çš„æ¥æº</a></li><li><a href=#72æ¶ˆæ¯-ttl-è¿‡æœŸ>7.2ã€æ¶ˆæ¯ TTL è¿‡æœŸ</a></li><li><a href=#73é˜Ÿåˆ—å·²æ»¡>7.3ã€é˜Ÿåˆ—å·²æ»¡</a></li><li><a href=#74æ¶ˆæ¯è¢«æ‹’ç»>7.4ã€æ¶ˆæ¯è¢«æ‹’ç»</a></li></ul></li><li><a href=#å…«å»¶è¿Ÿé˜Ÿåˆ—>å…«ã€å»¶è¿Ÿé˜Ÿåˆ—</a><ul><li><a href=#81æ¦‚å¿µ>8.1ã€æ¦‚å¿µ</a></li><li><a href=#82ä½¿ç”¨åœºæ™¯>8.2ã€ä½¿ç”¨åœºæ™¯</a></li><li><a href=#83å»¶è¿Ÿé˜Ÿåˆ—å®ç°>8.3ã€å»¶è¿Ÿé˜Ÿåˆ—å®ç°</a></li><li><a href=#84å»¶è¿Ÿé˜Ÿåˆ—æ’ä»¶>8.4ã€å»¶è¿Ÿé˜Ÿåˆ—æ’ä»¶</a></li></ul></li><li><a href=#ä¹é«˜çº§å‘å¸ƒç¡®è®¤>ä¹ã€é«˜çº§å‘å¸ƒç¡®è®¤</a><ul><li><a href=#91å‘å¸ƒç¡®è®¤æ¶ˆæ¯å›é€€>9.1ã€å‘å¸ƒç¡®è®¤+æ¶ˆæ¯å›é€€</a></li><li><a href=#92å¤‡ä»½äº¤æ¢æœº>9.2ã€å¤‡ä»½äº¤æ¢æœº</a></li></ul></li><li><a href=#åç›¸å…³çŸ¥è¯†ç‚¹>åã€ç›¸å…³çŸ¥è¯†ç‚¹</a><ul><li><a href=#101å¹‚ç­‰æ€§>10.1ã€å¹‚ç­‰æ€§</a></li><li><a href=#102ä¼˜å…ˆçº§é˜Ÿåˆ—>10.2ã€ä¼˜å…ˆçº§é˜Ÿåˆ—</a></li><li><a href=#103æƒ°æ€§é˜Ÿåˆ—>10.3ã€æƒ°æ€§é˜Ÿåˆ—</a></li></ul></li></ul></nav></div></details></div><div class=post-content><h2 id=ä¸€æ¦‚è¿°>ä¸€ã€æ¦‚è¿°<a hidden class=anchor aria-hidden=true href=#ä¸€æ¦‚è¿°>#</a></h2><h3 id=11ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—>1.1ã€ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—<a hidden class=anchor aria-hidden=true href=#11ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—>#</a></h3><p><strong>æ¶ˆæ¯</strong>ï¼šæŒ‡çš„æ˜¯ä¸¤ä¸ªåº”ç”¨é—´ä¼ é€’çš„æ•°æ®ã€‚æ•°æ®çš„ç±»å‹æœ‰å¾ˆå¤šç§å½¢å¼ï¼Œå¯èƒ½åªåŒ…å«æ–‡æœ¬å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯èƒ½åŒ…å«åµŒå…¥å¯¹è±¡ã€‚</p><p><strong>æ¶ˆæ¯åè®®</strong>ï¼šä¸ºäº†è®©æ¶ˆæ¯å‘é€è€…å’Œæ¶ˆæ¯æ¥æ”¶è€…éƒ½èƒ½å¤Ÿæ˜ç™½æ¶ˆæ¯æ‰€æ‰¿è½½çš„ä¿¡æ¯ï¼Œå®ƒä»¬å°±éœ€è¦æŒ‰ç…§ä¸€ç§ç»Ÿä¸€çš„æ ¼å¼æè¿°æ¶ˆæ¯ã€‚</p><p><strong>æ¶ˆæ¯é˜Ÿåˆ—</strong>ï¼šï¼ˆMessage Queueï¼Œç®€ç§°MQï¼‰ï¼Œä»å­—é¢æ„æ€ä¸Šçœ‹ï¼Œæœ¬è´¨æ˜¯ä¸ªé˜Ÿåˆ—ï¼ŒFIFOå…ˆå…¥å…ˆå‡ºï¼Œåªä¸è¿‡é˜Ÿåˆ—ä¸­å­˜æ”¾çš„å†…å®¹æ˜¯messageã€‚</p><p>æ¶ˆæ¯ä»å‘é€è€…åˆ°æ¥æ”¶è€…çš„æ–¹å¼ä¹Ÿæœ‰ä¸¤ç§ã€‚
ä¸€ç§ä¸ºå³æ—¶æ¶ˆæ¯é€šè®¯ï¼Œä¹Ÿå°±æ˜¯è¯´æ¶ˆæ¯ä»ä¸€ç«¯å‘å‡ºåï¼ˆæ¶ˆæ¯å‘é€è€…ï¼‰ç«‹å³å°±å¯ä»¥è¾¾åˆ°å¦ä¸€ç«¯ï¼ˆæ¶ˆæ¯æ¥æ”¶è€…ï¼‰ï¼Œè¿™ç§æ–¹å¼çš„å…·ä½“å®ç°å°±æ˜¯RPCï¼ˆå½“ç„¶å•çº¯çš„httpé€šè®¯ä¹Ÿæ»¡è¶³è¿™ä¸ªå®šä¹‰ï¼‰ï¼›
å¦ä¸€ç§ä¸ºå»¶è¿Ÿæ¶ˆæ¯é€šè®¯ï¼Œå³æ¶ˆæ¯ä»æŸä¸€ç«¯å‘å‡ºåï¼Œé¦–å…ˆè¿›å…¥ä¸€ä¸ªå®¹å™¨è¿›è¡Œä¸´æ—¶å­˜å‚¨ï¼Œå½“è¾¾åˆ°æŸç§æ¡ä»¶åï¼Œå†ç”±è¿™ä¸ªå®¹å™¨å‘é€ç»™å¦ä¸€ç«¯ã€‚ è¿™ä¸ªå®¹å™¨çš„ä¸€ç§å…·ä½“å®ç°å°±æ˜¯æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¦‚RabbitMQã€‚</p><h3 id=12ä¸ºä»€ä¹ˆä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—>1.2ã€ä¸ºä»€ä¹ˆä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—<a hidden class=anchor aria-hidden=true href=#12ä¸ºä»€ä¹ˆä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—>#</a></h3><ul><li>åº”ç”¨è§£è€¦ï¼šä¸åŒè¿›ç¨‹ï¼ˆprocessï¼‰ä¹‹é—´ä¼ é€’æ¶ˆæ¯æ—¶ï¼Œä¸¤ä¸ªè¿›ç¨‹ä¹‹é—´è€¦åˆç¨‹åº¦è¿‡é«˜ï¼Œæ”¹åŠ¨ä¸€ä¸ªè¿›ç¨‹ï¼Œå¼•å‘å¿…é¡»ä¿®æ”¹å¦ä¸€ä¸ªè¿›ç¨‹ï¼Œä¸ºäº†éš”ç¦»è¿™ä¸¤ä¸ªè¿›ç¨‹ï¼Œåœ¨ä¸¤è¿›ç¨‹é—´æŠ½ç¦»å‡ºä¸€å±‚ï¼ˆä¸€ä¸ªæ¨¡å—ï¼‰ï¼Œæ‰€æœ‰ä¸¤è¿›ç¨‹ä¹‹é—´ä¼ é€’çš„æ¶ˆæ¯ï¼Œéƒ½å¿…é¡»é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—æ¥ä¼ é€’ï¼Œå•ç‹¬ä¿®æ”¹æŸä¸€ä¸ªè¿›ç¨‹ï¼Œä¸ä¼šå½±å“å¦ä¸€ä¸ªï¼›</li><li>æµé‡å‰Šå³°ï¼šå¦‚æ•°æ®åº“åªèƒ½åŒæ—¶å¤„ç†ä¸€ä¸‡æ¡è¯·æ±‚ï¼Œå¦‚æœæ¥äº†ä¸¤ä¸‡æ¡è¯·æ±‚å°±æ‰§è¡Œä¸€ä¸‡æ¡ï¼Œå°†å‰©ä½™ä¸€ä¸‡æ¡æ”¾åœ¨æ¶ˆæ¯é˜Ÿåˆ—é¡ºåºæ‰§è¡Œã€‚</li><li>å¼‚æ­¥å¤„ç†ï¼šA è°ƒç”¨ B å¤„ç†æ•°æ®ï¼Œä½† B å¤„ç†æ—¶é—´å¾ˆé•¿ï¼›Aå¯ä»¥ä¸ç”¨ç­‰ï¼Œå½“Bæ‰§è¡Œå®Œå°†ç»“æœæ”¾åœ¨æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå†ç”±æ¶ˆæ¯é˜Ÿåˆ—å°†ç»“æœç»™Aï¼Œè¿™æ ·å°±ä¸ç”¨è½®è¯¢æˆ–æä¾›å›è°ƒå‡½æ•°äº†ã€‚</li><li>å¹¿æ’­</li><li>æœ€ç»ˆä¸€è‡´æ€§</li></ul><h3 id=13mqtt-ä¸-mq-çš„åŒºåˆ«>1.3ã€mqtt ä¸ MQ çš„åŒºåˆ«<a hidden class=anchor aria-hidden=true href=#13mqtt-ä¸-mq-çš„åŒºåˆ«>#</a></h3><p><strong>mqtt</strong>ï¼šä¸€ç§é€šä¿¡åè®®ï¼Œç±»ä¼¼äººç±»äº¤è°ˆä¸­çš„æ±‰è¯­ã€è‹±è¯­ã€ä¿„è¯­ä¸­çš„ä¸€ç§è¯­è¨€è§„èŒƒ
<strong>MQ</strong>ï¼šä¸€ç§é€šä¿¡é€šé“ï¼Œä¹Ÿå«æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç±»ä¼¼äººç±»äº¤è°ˆä¸­çš„ç”¨ç”µè¯ã€emailã€å¾®ä¿¡çš„ä¸€ç§é€šä¿¡æ–¹å¼
<strong>json</strong>ï¼šä¸€ç§å†…å®¹æ ¼å¼ï¼Œç±»ä¼¼äººç±»äº¤è°ˆä¸­çš„æ’æ¯”å¥ç­‰æ–¹å¼</p><h3 id=14rpc-æ‰§è¡Œæµç¨‹>1.4ã€RPC æ‰§è¡Œæµç¨‹<a hidden class=anchor aria-hidden=true href=#14rpc-æ‰§è¡Œæµç¨‹>#</a></h3><p>RPCï¼ˆRemote Procedure Callï¼‰è¿œç¨‹è¿‡ç¨‹è°ƒç”¨åè®®ï¼Œä¸€ç§é€šè¿‡ç½‘ç»œä»è¿œç¨‹è®¡ç®—æœºä¸Šè¯·æ±‚æœåŠ¡ï¼Œè€Œä¸éœ€è¦äº†è§£åº•å±‚ç½‘ç»œæŠ€æœ¯çš„åè®®ã€‚å…¶ä¸»è¦ç›®çš„æ˜¯åšåˆ°ä¸åŒæœåŠ¡é—´è°ƒç”¨æ–¹æ³•åƒåŒä¸€æœåŠ¡é—´è°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·ã€‚</p><p>å½“ä¸šåŠ¡éœ€è¦å¼ºä¸€è‡´æ€§ï¼Œå…³æ³¨ä¸šåŠ¡é€»è¾‘çš„å¤„ç†ç»“æœï¼Œåˆ™ RPC æ¯”æ¶ˆæ¯é˜Ÿåˆ—æ›´åˆé€‚ã€‚</p><p>å¼ºä¸€è‡´æ€§æŒ‡ä¸è®ºåœ¨ä»»ä½•æ—¶å€™è¯»å–çš„éƒ½æ˜¯æœ€æ–°çš„æ•°æ®ï¼Œæœ€ç»ˆä¸€è‡´æ€§æ˜¯å…è®¸å¯ä»¥åœ¨ä¸€æ®µæ—¶é—´å†…æ¯ä¸ªç»“ç‚¹çš„æ•°æ®ä¸ä¸€è‡´ï¼Œä½†æ˜¯ç»è¿‡ä¸€æ®µæ—¶é—´æ¯ä¸ªç»“ç‚¹çš„æ•°æ®å¿…é¡»ä¸€è‡´ï¼Œå®ƒå¼ºè°ƒçš„æ˜¯æœ€ç»ˆæ•°æ®çš„ä¸€è‡´æ€§ã€‚</p><ol><li>å®¢æˆ·ç«¯å¤„ç†è¿‡ç¨‹ä¸­è°ƒç”¨client subï¼Œå°±åƒè°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·ï¼Œä¼ å…¥å‚æ•°</li><li>client subå°†å‚æ•°ç¼–ç»„ä¸ºæ¶ˆæ¯ï¼Œç„¶åé€šè¿‡ç³»ç»Ÿè°ƒç”¨å‘æœåŠ¡ç«¯å‘é€æ¶ˆæ¯</li><li>æœåŠ¡ç«¯å°†æ¥æ”¶åˆ°çš„æ•°æ®åŒ…ä¼ é€’ç»™server sub</li><li>server subå°†æ¥æ”¶åˆ°çš„æ•°æ®è§£ç»„ä¸ºå‚æ•°</li><li>server subå†è°ƒç”¨æœåŠ¡ç«¯çš„è¿‡ç¨‹ï¼Œè¿‡ç¨‹æ‰§è¡Œçš„ç»“æœä»¥åæ–¹å‘çš„ç›¸åŒæ­¥éª¤å“åº”ç»™å®¢æˆ·ç«¯</li></ol><p>ä»¥ Google çš„ grpc ä¸ºä¾‹ï¼šå…ˆåœ¨ proto æ–‡ä»¶ä¸­å£°æ˜æ¥å£ï¼ŒåŒ…æ‹¬æ–¹æ³•åã€å‚æ•°å’Œè¿”å›å€¼ï¼Œç„¶åä½¿ç”¨å·¥å…·ç”Ÿæˆ go å¯ä»¥ç”¨çš„åº“ï¼›æœåŠ¡ç«¯åˆ›å»º grpc æœåŠ¡å®ä¾‹å¹¶å°†æœ¬åœ°å®ç°çš„æœåŠ¡æ³¨å†Œè¿›è¯¥å®ä¾‹ä¸­ï¼Œç„¶åç›‘å¬æœ¬åœ°ç«¯å£ï¼Œæ”¶åˆ°è¯·æ±‚åå°±æ‰§è¡Œæœ¬åœ°æ–¹æ³•å¹¶å°†ç»“æœè¿”å›ï¼›å®¢æˆ·ç«¯åˆ›å»º grpc å®¢æˆ·ç«¯å®ä¾‹ï¼Œç„¶åè°ƒç”¨ proto ä¸­å£°æ˜çš„æ–¹æ³•å³å¯è·å¾—ç»“æœã€‚</p><h3 id=15mq-åˆ†ç±»>1.5ã€MQ åˆ†ç±»<a hidden class=anchor aria-hidden=true href=#15mq-åˆ†ç±»>#</a></h3><ul><li>ActiveMQï¼šè€ã€è¾ƒå°‘ä½¿ç”¨</li><li>Kafkaï¼šå¤§æ•°æ®å®æ—¶è®¡ç®—å’Œæ—¥å¿—é‡‡é›†æ–¹é¢å“è¶Š</li><li>RocketMQï¼šé˜¿é‡Œå¼€æºäº§å“</li><li>RabbitMQï¼šä¸»æµ</li></ul><h2 id=äºŒrabbitmqä»‹ç»>äºŒã€RabbitMQä»‹ç»<a hidden class=anchor aria-hidden=true href=#äºŒrabbitmqä»‹ç»>#</a></h2><h3 id=21rabbitmq-ç®€ä»‹>2.1ã€RabbitMQ ç®€ä»‹<a hidden class=anchor aria-hidden=true href=#21rabbitmq-ç®€ä»‹>#</a></h3><p>RabbitMQæ˜¯ä¸€ä¸ªåœ¨AMQPï¼ˆAdvanced Message Queuing Protocol ï¼‰åŸºç¡€ä¸Šå®ç°çš„ï¼Œå¯å¤ç”¨çš„ä¼ä¸šæ¶ˆæ¯ç³»ç»Ÿã€‚å®ƒå¯ä»¥ç”¨äºå¤§å‹è½¯ä»¶ç³»ç»Ÿå„ä¸ªæ¨¡å—ä¹‹é—´çš„é«˜æ•ˆé€šä¿¡ï¼Œæ”¯æŒé«˜å¹¶å‘ï¼Œæ”¯æŒå¯æ‰©å±•ã€‚</p><h3 id=22amqp>2.2ã€AMQP<a hidden class=anchor aria-hidden=true href=#22amqp>#</a></h3><p>AMQPï¼Œå³Advanced Message Queuing Protocol,ä¸€ä¸ªæä¾›ç»Ÿä¸€æ¶ˆæ¯æœåŠ¡çš„åº”ç”¨å±‚æ ‡å‡†<strong>é«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®</strong>,æ˜¯åº”ç”¨å±‚åè®®çš„ä¸€ä¸ªå¼€æ”¾æ ‡å‡†,ä¸ºé¢å‘æ¶ˆæ¯çš„ä¸­é—´ä»¶è®¾è®¡ã€‚åŸºäºæ­¤åè®®çš„å®¢æˆ·ç«¯ä¸æ¶ˆæ¯ä¸­é—´ä»¶å¯ä¼ é€’æ¶ˆæ¯ï¼Œå¹¶ä¸å—å®¢æˆ·ç«¯/ä¸­é—´ä»¶ä¸åŒäº§å“ï¼Œä¸åŒçš„å¼€å‘è¯­è¨€ç­‰æ¡ä»¶çš„é™åˆ¶ã€‚</p><h3 id=23ç›¸å…³æ¦‚å¿µ>2.3ã€ç›¸å…³æ¦‚å¿µ<a hidden class=anchor aria-hidden=true href=#23ç›¸å…³æ¦‚å¿µ>#</a></h3><p><strong>Broker</strong>ï¼šç®€å•æ¥è¯´å°±æ˜¯æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡å™¨å®ä½“ã€‚</p><p><strong>Exchange</strong>ï¼šæ¶ˆæ¯äº¤æ¢æœºï¼Œå®ƒæŒ‡å®šæ¶ˆæ¯æŒ‰ä»€ä¹ˆè§„åˆ™ï¼Œè·¯ç”±åˆ°å“ªä¸ªé˜Ÿåˆ—ã€‚</p><p><strong>Queue</strong>ï¼šæ¶ˆæ¯é˜Ÿåˆ—è½½ä½“ï¼Œæ¯ä¸ªæ¶ˆæ¯éƒ½ä¼šè¢«æŠ•å…¥åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªé˜Ÿåˆ—ã€‚</p><p><strong>Binding</strong>ï¼šç»‘å®šï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯æŠŠexchangeå’ŒqueueæŒ‰ç…§è·¯ç”±è§„åˆ™ç»‘å®šèµ·æ¥ã€‚</p><p><strong>Routing Key</strong>ï¼šè·¯ç”±å…³é”®å­—ï¼Œexchangeæ ¹æ®è¿™ä¸ªå…³é”®å­—è¿›è¡Œæ¶ˆæ¯æŠ•é€’ã€‚</p><p><strong>vhost</strong>ï¼šè™šæ‹Ÿä¸»æœºï¼Œä¸€ä¸ªbrokeré‡Œå¯ä»¥å¼€è®¾å¤šä¸ªvhostï¼Œç”¨ä½œä¸åŒç”¨æˆ·çš„æƒé™åˆ†ç¦»ã€‚</p><p><strong>producer</strong>ï¼šæ¶ˆæ¯ç”Ÿäº§è€…ï¼Œå°±æ˜¯æŠ•é€’æ¶ˆæ¯çš„ç¨‹åºã€‚</p><p><strong>consumer</strong>ï¼šæ¶ˆæ¯æ¶ˆè´¹è€…ï¼Œå°±æ˜¯æ¥å—æ¶ˆæ¯çš„ç¨‹åºã€‚</p><p><strong>channel</strong>ï¼šæ¶ˆæ¯é€šé“ï¼Œåœ¨å®¢æˆ·ç«¯çš„æ¯ä¸ªè¿æ¥é‡Œï¼Œå¯å»ºç«‹å¤šä¸ªchannelï¼Œæ¯ä¸ªchannelä»£è¡¨ä¸€ä¸ªä¼šè¯ä»»åŠ¡ã€‚</p><p><img alt=RabbitMQç»“æ„ loading=lazy src=/posts/%E5%88%86%E5%B8%83%E5%BC%8F/rabbitmq/rabbitmq/RabbitMQ%E7%BB%93%E6%9E%84.png></p><h2 id=ä¸‰åˆä½“éªŒ>ä¸‰ã€åˆä½“éªŒ<a hidden class=anchor aria-hidden=true href=#ä¸‰åˆä½“éªŒ>#</a></h2><h3 id=31å¼€å¯-rabbitmq>3.1ã€å¼€å¯ rabbitmq<a hidden class=anchor aria-hidden=true href=#31å¼€å¯-rabbitmq>#</a></h3><ol><li><p>æ‹‰é•œåƒå¹¶å¯åŠ¨ï¼Œæ˜ å°„ 15672 ç«¯å£</p><pre tabindex=0><code>docker pull rabbitmq:management
</code></pre></li><li><p>è¿›å…¥å®¹å™¨ï¼Œæ·»åŠ ç”¨æˆ·ã€‚è¿™äº›æ“ä½œå…¨éƒ¨å¯ä»¥åœ¨webç•Œé¢ä¸Šè¿›è¡Œ</p><pre tabindex=0><code>rabbitmqctl add_user admin admin                        // æ·»åŠ ç”¨æˆ·
rabbitmqctl set_user_tars admin administsrstor          // è®¾ç½®è§’è‰²
rabbitmqctl set_permissions admin &#34;.*&#34; &#34;.*&#34; &#34;.*&#34;        // è®¾ç½®æƒé™
</code></pre></li></ol><h3 id=32java-ä½¿ç”¨-rabbitmq-åˆä½“éªŒ>3.2ã€java ä½¿ç”¨ rabbitmq åˆä½“éªŒ<a hidden class=anchor aria-hidden=true href=#32java-ä½¿ç”¨-rabbitmq-åˆä½“éªŒ>#</a></h3><p>ä½¿ç”¨é»˜è®¤äº¤æ¢æœºï¼Œå³ç©ºå­—ç¬¦ä¸²â€œâ€æ—¶ï¼Œåˆ›å»ºä¸€ä¸ªqueueæ—¶,é»˜è®¤çš„éƒ½ä¼šæœ‰ä¸€ä¸ªå’Œæ–°å»ºqueueåŒåçš„routingKeyç»‘å®šåˆ°è¿™ä¸ªé»˜è®¤çš„exchangeä¸Šå»</p><ol><li>å¼•åŒ…</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;dependencies&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;groupId&gt;</span>com.rabbitmq<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;artifactId&gt;</span>amqp-client<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;version&gt;</span>5.14.2<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;groupId&gt;</span>commons-io<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;artifactId&gt;</span>commons-io<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;version&gt;</span>2.11.0<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependencies&gt;</span>
</span></span></code></pre></div><ol start=2><li>Producer å‘å¸ƒè€…</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Producer</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String QUEUE_NAME <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hello&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) <span style=color:#66d9ef>throws</span> IOException, TimeoutException {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// è¿æ¥å·¥å‚</span>
</span></span><span style=display:flex><span>        ConnectionFactory factory <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ConnectionFactory();
</span></span><span style=display:flex><span>        factory.<span style=color:#a6e22e>setHost</span>(<span style=color:#e6db74>&#34;192.168.36.128&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#75715e>// java è¿æ¥ rabbitmq çš„ç«¯å£æ˜¯ 5672 .å¤§å‘ã€‚æ‰€ä»¥docker ä¹Ÿå¿…é¡»æš´éœ² 5672 ç«¯å£ã€‚</span>
</span></span><span style=display:flex><span>        factory.<span style=color:#a6e22e>setPort</span>(5672);
</span></span><span style=display:flex><span>        factory.<span style=color:#a6e22e>setUsername</span>(<span style=color:#e6db74>&#34;admin&#34;</span>);
</span></span><span style=display:flex><span>        factory.<span style=color:#a6e22e>setPassword</span>(<span style=color:#e6db74>&#34;admin&#34;</span>);
</span></span><span style=display:flex><span>        factory.<span style=color:#a6e22e>setConnectionTimeout</span>(50000);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// è¿æ¥</span>
</span></span><span style=display:flex><span>        Connection connection <span style=color:#f92672>=</span> factory.<span style=color:#a6e22e>newConnection</span>();
</span></span><span style=display:flex><span>        <span style=color:#75715e>// è·å–ä¿¡é“</span>
</span></span><span style=display:flex><span>        Channel channel <span style=color:#f92672>=</span> connection.<span style=color:#a6e22e>createChannel</span>();
</span></span><span style=display:flex><span>        <span style=color:#75715e>/** 
</span></span></span><span style=display:flex><span><span style=color:#75715e>         * å£°æ˜ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå‚æ•°å¦‚ä¸‹ï¼š
</span></span></span><span style=display:flex><span><span style=color:#75715e>         * 1ã€name:    é˜Ÿåˆ—åç§°
</span></span></span><span style=display:flex><span><span style=color:#75715e>         * 2ã€durable: æ˜¯å¦æŒä¹…åŒ–
</span></span></span><span style=display:flex><span><span style=color:#75715e>         * 3ã€exclusive: æ˜¯å¦æ’å¤–çš„ã€‚å¦‚æœè®¾ç½®ä¸ºtrueï¼Œå®šä¹‰ä¸ºæ’ä»–é˜Ÿåˆ—ã€‚åˆ™åªæœ‰åˆ›å»ºè€…å¯ä»¥ä½¿ç”¨æ­¤é˜Ÿåˆ—ã€‚ä¹Ÿå°±æ˜¯privateç§æœ‰çš„ã€‚
</span></span></span><span style=display:flex><span><span style=color:#75715e>         * 4ã€autoDelete: æ˜¯å¦è‡ªåŠ¨åˆ é™¤ã€‚ä¹Ÿå°±æ˜¯ä¸´æ—¶é˜Ÿåˆ—ã€‚å½“æœ€åä¸€ä¸ªæ¶ˆè´¹è€…æ–­å¼€è¿æ¥åï¼Œä¼šè‡ªåŠ¨åˆ é™¤ã€‚
</span></span></span><span style=display:flex><span><span style=color:#75715e>         * 5ã€å…¶ä»–å‚æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e>         * */</span>
</span></span><span style=display:flex><span>        channel.<span style=color:#a6e22e>queueDeclare</span>(QUEUE_NAME, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span>        String message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Hello World&#34;</span>;
</span></span><span style=display:flex><span>        <span style=color:#75715e>// å‘é€æ¶ˆæ¯  å‚æ•°ï¼š1.äº¤æ¢æœºï¼Œè¿™é‡Œä½¿ç”¨é»˜è®¤äº¤æ¢æœº 2.Routing Key 3. å…¶ä»–å‚æ•°  4.æ¶ˆæ¯</span>
</span></span><span style=display:flex><span>        channel.<span style=color:#a6e22e>basicPublish</span>(<span style=color:#e6db74>&#34;&#34;</span>, QUEUE_NAME, <span style=color:#66d9ef>null</span>, message.<span style=color:#a6e22e>getBytes</span>(StandardCharsets.<span style=color:#a6e22e>UTF_8</span>));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>Consumer æ¶ˆè´¹è€…</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Consumer</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String QUEUE_NAME <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hello&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) <span style=color:#66d9ef>throws</span> IOException, TimeoutException {
</span></span><span style=display:flex><span>        ConnectionFactory factory <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ConnectionFactory();
</span></span><span style=display:flex><span>        factory.<span style=color:#a6e22e>setHost</span>(<span style=color:#e6db74>&#34;192.168.36.128&#34;</span>);
</span></span><span style=display:flex><span>        factory.<span style=color:#a6e22e>setPort</span>(5672);
</span></span><span style=display:flex><span>        factory.<span style=color:#a6e22e>setUsername</span>(<span style=color:#e6db74>&#34;guest&#34;</span>);
</span></span><span style=display:flex><span>        factory.<span style=color:#a6e22e>setPassword</span>(<span style=color:#e6db74>&#34;guest&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Connection connection <span style=color:#f92672>=</span> factory.<span style=color:#a6e22e>newConnection</span>();
</span></span><span style=display:flex><span>        Channel channel <span style=color:#f92672>=</span> connection.<span style=color:#a6e22e>createChannel</span>();
</span></span><span style=display:flex><span>        <span style=color:#75715e>// å‘å¸ƒè€…å·²ç»å£°æ˜äº†é˜Ÿåˆ—ï¼Œæ¶ˆè´¹è€…å°±æ— éœ€å£°æ˜</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// channel.queueDeclare(QUEUE_NAME, false, true, false, null);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// å‚æ•°ï¼š1.é˜Ÿåˆ—å 2.æ˜¯å¦ä½¿ç”¨è‡ªåŠ¨åº”ç­” 3.æˆåŠŸæ¶ˆè´¹çš„å›è°ƒ 4.å¤±è´¥æ¶ˆè´¹çš„å›è°ƒ</span>
</span></span><span style=display:flex><span>        DeliverCallback deliverCallback <span style=color:#f92672>=</span> (consumerTag,  message) <span style=color:#f92672>-&gt;</span> 
</span></span><span style=display:flex><span>                System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;æˆåŠŸæ¶ˆè´¹ï¼š&#34;</span> <span style=color:#f92672>+</span> <span style=color:#66d9ef>new</span> String(message.<span style=color:#a6e22e>getBody</span>()));
</span></span><span style=display:flex><span>        CancelCallback cancelCallback <span style=color:#f92672>=</span> (consumerTag) <span style=color:#f92672>-&gt;</span> System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;å¤±è´¥æ¶ˆè´¹&#34;</span>);
</span></span><span style=display:flex><span>        channel.<span style=color:#a6e22e>basicConsume</span>(QUEUE_NAME, <span style=color:#66d9ef>true</span>, deliverCallback, cancelCallback);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=å››å·¥ä½œé˜Ÿåˆ—>å››ã€å·¥ä½œé˜Ÿåˆ—<a hidden class=anchor aria-hidden=true href=#å››å·¥ä½œé˜Ÿåˆ—>#</a></h2><p>å°†å·¥ä½œå°è£…æˆä¸€ä¸ªä¸ªæ¶ˆæ¯å‘é€åˆ°é˜Ÿåˆ—ï¼Œç„¶åç”±å¤šä¸ªåå°çº¿ç¨‹ä¸€èµ·å¤„ç†è¿™äº›æ¶ˆæ¯ï¼Œä»è€Œé¿å…åŒæ—¶å¤„ç†å¤§é‡æ¶ˆæ¯ã€‚</p><p>å½“å¤šä¸ªæ¶ˆè´¹è€…è®¢é˜…åŒä¸€ä¸ªé˜Ÿåˆ—æ—¶ï¼Œrabbitmq é»˜è®¤ä½¿ç”¨è½®è¯¢çš„æ–¹å¼å°†æ¶ˆæ¯å‘é€ç»™æ¶ˆè´¹è€…ï¼ŒåŒæ ·ä¿è¯æ¯ä¸ªæ¶ˆæ¯åªèƒ½è¢«ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ã€‚</p><h3 id=41æ¶ˆæ¯åº”ç­”>4.1ã€æ¶ˆæ¯åº”ç­”<a hidden class=anchor aria-hidden=true href=#41æ¶ˆæ¯åº”ç­”>#</a></h3><p>æ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯åï¼Œçªç„¶å®•æœºå¯¼è‡´å·¥ä½œå¹¶æ²¡æœ‰å®Œæˆï¼Œæ­¤æ—¶mqå·²ç»å°†æ¶ˆæ¯åˆ é™¤ï¼Œå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ã€‚ä¸ºé¿å…è¯¥äº‹ä»¶ï¼Œå¼•å…¥<strong>æ¶ˆæ¯åº”ç­”</strong>æœºåˆ¶ï¼šæ¶ˆè´¹è€…åœ¨æ¥æ”¶åˆ°æ¶ˆæ¯å¹¶ä¸”å¤„ç†å®Œæˆè¯¥æ¶ˆæ¯åï¼Œå‘Šè¯‰ rabbitmq å®ƒå·²ç»æ­£ç¡®å¤„ç†äº†ï¼Œæ­¤æ—¶ mq å¯ä»¥æ”¾å¿ƒåˆ é™¤è¯¥æ¶ˆæ¯ã€‚</p><h4 id=411è‡ªåŠ¨åº”ç­”>4.1.1ã€è‡ªåŠ¨åº”ç­”<a hidden class=anchor aria-hidden=true href=#411è‡ªåŠ¨åº”ç­”>#</a></h4><p>æ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯åï¼Œè‡ªåŠ¨å‘Šè¯‰rabbitmqæœåŠ¡è¯¥æ¶ˆæ¯å·²å®Œæˆï¼Œå®é™…ä¸Šæ¶ˆè´¹è€…ä¹Ÿä»…ä»…æ˜¯æ¥å—åˆ°äº†æ¶ˆæ¯ï¼Œæœ‰å¯èƒ½è¿˜æ²¡æœ‰æ‰§è¡Œå®Œæˆã€‚</p><p>å½“æ¶ˆæ¯å¤§é‡ä¼ é€’ï¼Œæ¶ˆè´¹è€…æ¥ä¸åŠå¤„ç†å¯¼è‡´æ¶ˆæ¯ç§¯å‹ï¼Œå†…å­˜è€—å°½ï¼Œå°±ä¼šè¢«æ“ä½œç³»ç»Ÿæ€æ­»ï¼Œæ‰€ä»¥è¿™ç§æ–¹å¼åªé€‚ç”¨äºæ¶ˆè´¹è€…å¯ä»¥é«˜æ•ˆå¤„ç†çš„æƒ…å†µã€‚æ‰€ä»¥ä¸æ¨èä½¿ç”¨è‡ªåŠ¨åº”ç­”ã€‚</p><h4 id=412æ‰‹åŠ¨åº”ç­”>4.1.2ã€æ‰‹åŠ¨åº”ç­”<a hidden class=anchor aria-hidden=true href=#412æ‰‹åŠ¨åº”ç­”>#</a></h4><p>å½“autoAck å‚æ•°ä¸º false æ—¶ï¼Œå¯¹äº RabbitMQ æœåŠ¡å™¨ç«¯è€Œè¨€ï¼Œé˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯åˆ†æˆäº†ä¸¤éƒ¨åˆ†ï¼šä¸€éƒ¨åˆ†æ˜¯ç­‰å¾…æŠ•é€’ç»™æ¶ˆè´¹è€…çš„æ¶ˆæ¯ï¼›ä¸€éƒ¨åˆ†æ˜¯å·²ç»æŠ•é€’ç»™æ¶ˆè´¹è€…ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰æ”¶åˆ°æ¶ˆè´¹è€…ç¡®è®¤ä¿¡å·çš„æ¶ˆæ¯ã€‚å¦‚æœ RabbitMQ æœåŠ¡å™¨ç«¯ä¸€ç›´æ²¡æœ‰æ”¶åˆ°æ¶ˆè´¹è€…çš„ç¡®è®¤ä¿¡å·ï¼Œå¹¶ä¸”æ¶ˆè´¹æ­¤æ¶ˆæ¯çš„æ¶ˆè´¹è€…å·²ç»æ–­å¼€è¿æ¥ï¼Œåˆ™æœåŠ¡å™¨ç«¯ä¼šå®‰æ’è¯¥æ¶ˆæ¯é‡æ–°è¿›å…¥é˜Ÿåˆ—ï¼Œç­‰å¾…æŠ•é€’ç»™ä¸‹ä¸€ä¸ªæ¶ˆè´¹è€…ï¼ˆä¹Ÿå¯èƒ½è¿˜æ˜¯åŸæ¥çš„é‚£ä¸ªæ¶ˆè´¹è€…ï¼‰ã€‚</p><p>RabbitMQ <strong>ä¸ä¼š</strong>ä¸ºæœªç¡®è®¤çš„æ¶ˆæ¯<strong>è®¾ç½®è¿‡æœŸæ—¶é—´</strong>ï¼Œå®ƒåˆ¤æ–­æ­¤æ¶ˆæ¯æ˜¯å¦éœ€è¦é‡æ–°æŠ•é€’ç»™æ¶ˆè´¹è€…çš„å”¯ä¸€ä¾æ®æ˜¯æ¶ˆè´¹è€…çš„è¿æ¥æ˜¯å¦å·²ç»æ–­å¼€ï¼Œè¿™ä¸ªè®¾ç½®çš„åŸå› æ˜¯ RabbitMQ å…è®¸æ¶ˆè´¹è€…æ¶ˆè´¹ä¸€æ¡æ¶ˆæ¯çš„æ—¶é—´å¯ä»¥å¾ˆä¹…å¾ˆä¹…ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>channel.<span style=color:#a6e22e>basicAck</span>();       <span style=color:#75715e>// è‚¯å®šç¡®è®¤</span>
</span></span><span style=display:flex><span>channel.<span style=color:#a6e22e>basicNack</span>();      <span style=color:#75715e>// å¦å®šç¡®è®¤</span>
</span></span><span style=display:flex><span>channel.<span style=color:#a6e22e>basicReject</span>();    <span style=color:#75715e>// å¦å®šç¡®è®¤ï¼Œæ¯” basicNack å°‘äº†æ‰¹é‡å¤„ç†çš„å‚æ•°</span>
</span></span></code></pre></div><p>æ‰¹é‡åº”ç­”ç±»ä¼¼äº TCP ä¼ è¾“çš„ç´¯è®¡ç¡®è®¤ï¼Œå³è‹¥é˜Ÿåˆ—æ¥æ”¶åˆ°æ¶ˆè´¹è€…å¯¹äº 8 å·æ¶ˆæ¯çš„ç¡®è®¤ï¼Œåˆ™è®¤ä¸ºæ¶ˆè´¹è€…å·²ç»æˆåŠŸå¤„ç†äº† 1 ~ 8 å·æ¶ˆæ¯ï¼Œå°½ç®¡ä¹‹å‰å¯èƒ½æ²¡æœ‰æ”¶åˆ°æ¥è‡ª 1~7 å·çš„ç¡®è®¤ã€‚ä½†æ˜¯<strong>ä¸å»ºè®®ä½¿ç”¨æ‰¹é‡åº”ç­”</strong>ï¼Œå½“æœ‰å¤šä¸ªæ¶ˆè´¹è€…æ—¶ï¼Œè‹¥æ¶ˆè´¹è€…1å¤„ç† 3 å·æ¶ˆæ¯ï¼Œä½†è¿˜æ²¡æœ‰å¤„ç†å®Œå°±å®•æœºäº†ï¼Œæ­¤æ—¶æ¶ˆè´¹è€… 2 å·²ç»å¤„ç†å®Œäº† 5 å·æ¶ˆæ¯å¹¶æ‰¹é‡åº”ç­”ï¼Œå°±ä¼šé€ æˆ 3 å·æ¶ˆæ¯çš„ä¸¢å¤±ã€‚è€Œ TCP ç”±äºæ˜¯ç‚¹å¯¹ç‚¹åè®®ï¼Œå› æ­¤æ²¡æœ‰è¿™ç§æƒ…å†µçš„å‘ç”Ÿã€‚</p><h4 id=413æ¶ˆæ¯è‡ªåŠ¨é‡æ–°å…¥é˜Ÿ>4.1.3ã€æ¶ˆæ¯è‡ªåŠ¨é‡æ–°å…¥é˜Ÿ<a hidden class=anchor aria-hidden=true href=#413æ¶ˆæ¯è‡ªåŠ¨é‡æ–°å…¥é˜Ÿ>#</a></h4><p>å¦‚æœæ¶ˆè´¹è€…ç”±äºæŸäº›åŸå› å¤±å»è¿æ¥(å…¶é€šé“å…³é—­ï¼Œè¿æ¥å…³é—­æˆ– TCP è¿æ¥ä¸¢å¤±ï¼Œå®•æœº)ï¼Œå¯¼è‡´æ¶ˆæ¯æœªå‘é€ ACK ç¡®è®¤ï¼ŒRabbitMQ å°†äº†è§£åˆ°æ¶ˆæ¯æœªå®Œå…¨å¤„ç†ï¼Œå¹¶å°†å¯¹å…¶é‡æ–°æ’é˜Ÿã€‚å¦‚æœæ­¤æ—¶å…¶ä»–æ¶ˆè´¹è€…å¯ä»¥å¤„ç†ï¼Œå®ƒå°†å¾ˆå¿«å°†å…¶é‡æ–°åˆ†å‘ç»™å¦ä¸€ä¸ªæ¶ˆè´¹è€…ã€‚è¿™æ ·ï¼Œå³ä½¿æŸä¸ªæ¶ˆè´¹è€…å¶å°”æ­»äº¡ï¼Œä¹Ÿå¯ä»¥ç¡®ä¿ä¸ä¼šä¸¢å¤±ä»»ä½•æ¶ˆæ¯ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Consumer</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) <span style=color:#66d9ef>throws</span> IOException, TimeoutException {
</span></span><span style=display:flex><span>        Channel channel <span style=color:#f92672>=</span> RabbitMqUtil.<span style=color:#a6e22e>getChannel</span>();
</span></span><span style=display:flex><span>        DeliverCallback deliverCallback <span style=color:#f92672>=</span> (consumerTag,  message) <span style=color:#f92672>-&gt;</span> {
</span></span><span style=display:flex><span>            System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;æˆåŠŸæ¶ˆè´¹ï¼š&#34;</span> <span style=color:#f92672>+</span> <span style=color:#66d9ef>new</span> String(message.<span style=color:#a6e22e>getBody</span>()));
</span></span><span style=display:flex><span>            <span style=color:#75715e>// æ‰‹åŠ¨åº”ç­”ï¼Œä¸”å–æ¶ˆæ‰¹é‡åº”ç­”</span>
</span></span><span style=display:flex><span>            channel.<span style=color:#a6e22e>basicAck</span>(message.<span style=color:#a6e22e>getEnvelope</span>().<span style=color:#a6e22e>getDeliveryTag</span>(), <span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>        CancelCallback cancelCallback <span style=color:#f92672>=</span> (consumerTag) <span style=color:#f92672>-&gt;</span> System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;å¤±è´¥æ¶ˆè´¹&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#75715e>// å–æ¶ˆè‡ªåŠ¨åº”ç­”</span>
</span></span><span style=display:flex><span>        channel.<span style=color:#a6e22e>basicConsume</span>(HELLO, <span style=color:#66d9ef>false</span>, deliverCallback, cancelCallback);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=42æŒä¹…åŒ–>4.2ã€æŒä¹…åŒ–<a hidden class=anchor aria-hidden=true href=#42æŒä¹…åŒ–>#</a></h3><p>rabbitmq æœåŠ¡å™¨é€€å‡ºæˆ–å®•æœºæ—¶ï¼Œå­˜åœ¨äºå†…å­˜ä¸­çš„é˜Ÿåˆ—å’Œæ¶ˆæ¯å°±ä¼šä¸¢å¤±ï¼Œå› æ­¤éœ€è¦å°†é˜Ÿåˆ—å’Œæ¶ˆæ¯æŒä¹…åŒ–ã€‚</p><h4 id=421é˜Ÿåˆ—æŒä¹…åŒ–>4.2.1ã€é˜Ÿåˆ—æŒä¹…åŒ–<a hidden class=anchor aria-hidden=true href=#421é˜Ÿåˆ—æŒä¹…åŒ–>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>channel.<span style=color:#a6e22e>queueDeclare</span>(QUEUE_NAME, <span style=color:#66d9ef>true</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>null</span>);   <span style=color:#75715e>// ç¬¬äºŒä¸ªå‚æ•°ä¸º durable: æ˜¯å¦æŒä¹…åŒ–</span>
</span></span></code></pre></div><p>å£°æ˜é˜Ÿåˆ—æ—¶å°†å…¶è®¾ç½®ä¸ºæŒä¹…åŒ–å³å¯ï¼Œä½†æ˜¯è‹¥æƒ³è¦å°†ä¸€ä¸ªå·²ç»å­˜åœ¨çš„éæŒä¹…åŒ–é˜Ÿåˆ—ä¿®æ”¹ä¸ºæŒä¹…åŒ–ï¼Œéœ€è¦å…ˆåˆ é™¤åŸæœ‰é˜Ÿåˆ—ï¼Œå†åˆ›å»ºæ–°é˜Ÿåˆ—ï¼Œå¦åˆ™æŠ¥é”™ã€‚</p><h4 id=422æ¶ˆæ¯æŒä¹…åŒ–>4.2.2ã€æ¶ˆæ¯æŒä¹…åŒ–<a hidden class=anchor aria-hidden=true href=#422æ¶ˆæ¯æŒä¹…åŒ–>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>channel.<span style=color:#a6e22e>basicPublish</span>(<span style=color:#e6db74>&#34;&#34;</span>, HELLO, MessageProperties.<span style=color:#a6e22e>PERSISTENT_TEXT_PLAIN</span>, message.<span style=color:#a6e22e>getBytes</span>());
</span></span></code></pre></div><p>å‘å¸ƒæ¶ˆæ¯æ—¶ï¼Œå°†æ¶ˆæ¯å±æ€§è®¾ä¸ºæŒä¹…åŒ–ï¼Œæ­¤å¤„è®¾ç½®ä¸ºæ–‡æœ¬æŒä¹…åŒ–ã€‚ä½†æ˜¯è¿˜ä¸èƒ½ä¿è¯æ¶ˆæ¯ä¸ä¼šå®Œå…¨ä¸¢å¤±ï¼Œå½“ mq å­˜å…¥ç£ç›˜ä¹‹å‰å°±å®•æœºäº†ï¼Œä»ç„¶ä¼šå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ï¼Œå¯ä»¥é€šè¿‡å‘å¸ƒç¡®è®¤ç¡®ä¿ä¸ä¸¢å¤±ã€‚</p><p>è®¾ç½®äº†é˜Ÿåˆ—å’Œæ¶ˆæ¯çš„æŒä¹…åŒ–ä¹‹åï¼Œå½“brokeræœåŠ¡é‡å¯çš„ä¹‹åï¼Œæ¶ˆæ¯ä¾æ—§å­˜åœ¨ã€‚å•åªè®¾ç½®é˜Ÿåˆ—æŒä¹…åŒ–ï¼Œé‡å¯ä¹‹åæ¶ˆæ¯ä¼šä¸¢å¤±ï¼›å•åªè®¾ç½®æ¶ˆæ¯çš„æŒä¹…åŒ–ï¼Œé‡å¯ä¹‹åé˜Ÿåˆ—æ¶ˆå¤±ï¼Œæ—¢è€Œæ¶ˆæ¯ä¹Ÿä¸¢å¤±ã€‚å•å•è®¾ç½®æ¶ˆæ¯æŒä¹…åŒ–è€Œä¸è®¾ç½®é˜Ÿåˆ—çš„æŒä¹…åŒ–æ˜¾å¾—æ¯«æ— æ„ä¹‰ã€‚</p><h3 id=43å…¬å¹³åˆ†å‘>4.3ã€å…¬å¹³åˆ†å‘<a hidden class=anchor aria-hidden=true href=#43å…¬å¹³åˆ†å‘>#</a></h3><p>rabbitmq é»˜è®¤é‡‡ç”¨è½®è¯¢åˆ†å‘ã€‚å½“å¤šä¸ªæ¶ˆè´¹è€…çš„å¤„ç†æ€§èƒ½ç›¸å·®å¾ˆå¤šæ—¶ï¼Œè‹¥é‡‡ç”¨è½®è¯¢åˆ†å‘ä¼šé™ä½ååç‡ï¼Œå› æ­¤åº”è¯¥ä½¿ç”¨å…¬å¹³åˆ†å‘ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// æ¶ˆè´¹è€…ç«¯è®¾ç½®</span>
</span></span><span style=display:flex><span>channel.<span style=color:#a6e22e>basicQos</span>(<span style=color:#66d9ef>int</span> prefetch_count);
</span></span></code></pre></div><p>ä¸€å¥è¯è¡¨ç¤ºå°±æ˜¯ prefetch_count è¡¨ç¤ºå½“å‰ä¿¡é“èƒ½å­˜åœ¨çš„æœ€å¤šçš„æœªackçš„æ¶ˆæ¯ä¸ªæ•°</p><p>æ¯ä¸ª channe éƒ½ä¼šè®°å½•è‡ªå·± prefetch_count çš„å€¼ï¼ŒåŒæ—¶è®°å½•çš„è¿˜æœ‰è¯¥channelæœªackçš„æ¶ˆæ¯ä¸ªæ•°ã€‚</p><p>å½“rabbitmqè¦å°†é˜Ÿåˆ—ä¸­çš„ä¸€æ¡æ¶ˆæ¯æŠ•é€’ç»™æ¶ˆè´¹è€…æ—¶ï¼Œä¼šéå†è¯¥é˜Ÿåˆ—ä¸Šçš„æ¶ˆè´¹è€…åˆ—è¡¨ï¼Œé€‰ä¸€ä¸ªåˆé€‚çš„æ¶ˆè´¹è€…ï¼Œç„¶åå°†æ¶ˆæ¯æŠ•é€’å‡ºå»ï¼ŒæŠ•é€’çš„æ—¶å€™æ˜¯åœ¨åŒä¸€æ—¶åˆ»å°†å¤§é‡æ¶ˆæ¯æŠ•é€’è¿›å»ï¼Œä½¿å…¶ç›´æ¥å˜æ»¡ã€‚å…¶ä¸­æŒ‘é€‰æ¶ˆè´¹è€…çš„ä¸€ä¸ªä¾æ®å°±æ˜¯çœ‹æ¶ˆè´¹è€…å¯¹åº”çš„channelä¸Šæœªackçš„æ¶ˆæ¯æ•°æ˜¯å¦è¾¾åˆ°è®¾ç½®çš„prefetch_countä¸ªæ•°ï¼Œå¦‚æœæœªackçš„æ¶ˆæ¯æ•°è¾¾åˆ°äº†prefetch_countçš„ä¸ªæ•°ï¼Œåˆ™ä¸ç¬¦åˆè¦æ±‚ã€‚å½“æŒ‘é€‰åˆ°åˆé€‚çš„æ¶ˆè´¹è€…åï¼Œä¸­æ–­åç»­çš„éå†ã€‚å½“æ¶ˆè´¹è€…å¯¹æ¶ˆæ¯è¿›è¡Œackåï¼Œä¼šä¿®æ”¹è¯¥æ¶ˆè´¹è€…å¯¹åº”channelä¸­æœªackçš„æ¶ˆæ¯æ•°ï¼Œè¿™æ ·é˜Ÿåˆ—åˆå¯ä»¥å°†æ¶ˆæ¯æŠ•é€’ç»™è¯¥æ¶ˆè´¹è€…ã€‚</p><p>æ³¨ï¼šprefetch_count å¿…é¡»åœ¨æ‰‹åŠ¨åº”ç­”æ—¶æ‰ç”Ÿæ•ˆï¼Œå¦‚æœæ˜¯è‡ªåŠ¨åº”ç­”è¿˜æ˜¯è½®è¯¢ã€‚</p><p>prefetch_count é»˜è®¤ä¸º 0 ï¼Œå³è½®è¯¢åˆ†å‘ã€‚</p><h2 id=äº”å‘å¸ƒç¡®è®¤>äº”ã€å‘å¸ƒç¡®è®¤<a hidden class=anchor aria-hidden=true href=#äº”å‘å¸ƒç¡®è®¤>#</a></h2><p>å½“é˜Ÿåˆ—å°†æ¶ˆæ¯ä¿å­˜åœ¨ç£ç›˜ä¹‹åï¼Œå‘å‘å¸ƒè€…å‘é€ç¡®è®¤æ¶ˆæ¯ï¼Œå¦‚æ­¤èƒ½ç¡®ä¿ mq å°†æ¶ˆæ¯æŒä¹…åŒ–äº†ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>channel.<span style=color:#a6e22e>confirmSelect</span>();  <span style=color:#75715e>// å‘å¸ƒè€…ç«¯è®¾ç½®ï¼Œå¼€å¯å‘å¸ƒç¡®è®¤</span>
</span></span></code></pre></div><p>å¦‚æœè®¾ç½®äº†æŒä¹…åŒ–ï¼Œåˆ™å¿…é¡»ä¿å­˜åˆ°ç£ç›˜ä¹‹åæ‰ä¼šç¡®è®¤ï¼Œå¦åˆ™ï¼Œæ”¶åˆ°æ¶ˆæ¯å°±ç›´æ¥ç¡®è®¤ã€‚</p><h3 id=51å•ä¸ªç¡®è®¤å‘å¸ƒ>5.1ã€å•ä¸ªç¡®è®¤å‘å¸ƒ<a hidden class=anchor aria-hidden=true href=#51å•ä¸ªç¡®è®¤å‘å¸ƒ>#</a></h3><p>æ¯å‘ä¸€æ¡æ¶ˆæ¯ï¼Œå¿…é¡»æ”¶åˆ°ç¡®è®¤æ‰ä¼šå‘é€ä¸‹ä¸€æ¡æ¶ˆæ¯ã€‚é€Ÿåº¦æ…¢ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>boolean</span> confirm <span style=color:#f92672>=</span> channel.<span style=color:#a6e22e>waitForConfirms</span>();   <span style=color:#75715e>// æ¯æ¬¡å‘é€æ¶ˆæ¯åéƒ½è¦åˆ¤æ–­ confirm ä¸º true æ‰èƒ½å‘é€ä¸‹ä¸€æ¡æ¶ˆæ¯</span>
</span></span></code></pre></div><h3 id=52æ‰¹é‡ç¡®è®¤å‘å¸ƒ>5.2ã€æ‰¹é‡ç¡®è®¤å‘å¸ƒ<a hidden class=anchor aria-hidden=true href=#52æ‰¹é‡ç¡®è®¤å‘å¸ƒ>#</a></h3><p>å‘å¸ƒä¸€æ‰¹æ¶ˆæ¯åä¸€èµ·ç¡®è®¤ï¼Œå¯ä»¥æé«˜ååç‡ï¼Œä½†æ˜¯è‹¥å‡ºç°æ•…éšœï¼Œä¸çŸ¥é“æ˜¯å“ªä¸€æ¡æ¶ˆæ¯çš„é—®é¢˜ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>int</span> batch <span style=color:#f92672>=</span> 100;
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0; i <span style=color:#f92672>&lt;</span> 1000; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>    String message <span style=color:#f92672>=</span> i <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;Hello World&#34;</span>;
</span></span><span style=display:flex><span>    channel.<span style=color:#a6e22e>basicPublish</span>(<span style=color:#e6db74>&#34;&#34;</span>, HELLO, MessageProperties.<span style=color:#a6e22e>PERSISTENT_TEXT_PLAIN</span>, message.<span style=color:#a6e22e>getBytes</span>());
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (i <span style=color:#f92672>%</span> batch <span style=color:#f92672>==</span> 0)    <span style=color:#75715e>// æ‰‹åŠ¨æ‰¹é‡ğŸ˜€</span>
</span></span><span style=display:flex><span>        channel.<span style=color:#a6e22e>waitForConfirms</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=53å¼‚æ­¥ç¡®è®¤å‘å¸ƒ>5.3ã€å¼‚æ­¥ç¡®è®¤å‘å¸ƒ<a hidden class=anchor aria-hidden=true href=#53å¼‚æ­¥ç¡®è®¤å‘å¸ƒ>#</a></h3><p>æ•ˆç‡å’Œå¯é æ–°éƒ½èƒ½ä¿éšœã€‚é€šè¿‡å›è°ƒå‡½æ•°è¾¾åˆ°æ¶ˆæ¯å¯é ä¼ è¾“ã€‚</p><p>å‘å¸ƒçš„æ¶ˆæ¯å°è£…åœ¨ä¸€ä¸ª map ä¸­ï¼Œkey ä¸ºæ¶ˆæ¯çš„åºå·ï¼Œvalue ä¸ºæ¶ˆæ¯çš„å€¼ã€‚å‘å¸ƒè€…æ— éœ€æ‹…å¿ƒæ¶ˆæ¯æ˜¯å¦æ¥æ”¶æˆåŠŸï¼Œåªç®¡å‘é€å³å¯ï¼Œbroke ä¼šå¯¹ map ä¸­çš„æ¯ä¸€æ¡æ¶ˆæ¯å¤„ç†ï¼Œå¦‚æœæ¥æ”¶æˆåŠŸï¼Œåˆ™å‘å‘é€è€…å›å¤æ”¶åˆ°ï¼Œå¦åˆ™å‘å‘é€è€…å›å¤æœªæ”¶åˆ°ã€‚å¯¹æ¯ä¸€æ¡æ¶ˆæ¯éƒ½å›å¤ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ProduceAsync</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) <span style=color:#66d9ef>throws</span> IOException, TimeoutException {
</span></span><span style=display:flex><span>        Channel channel <span style=color:#f92672>=</span> RabbitMqUtil.<span style=color:#a6e22e>getChannel</span>();
</span></span><span style=display:flex><span>        channel.<span style=color:#a6e22e>queueDeclare</span>(HELLO, <span style=color:#66d9ef>true</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span>        <span style=color:#75715e>// å¼€å¯å‘å¸ƒç¡®è®¤</span>
</span></span><span style=display:flex><span>        channel.<span style=color:#a6e22e>confirmSelect</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// æ­¤å¤„é€»è¾‘ä¸ºï¼šå…ˆå°†æ‰€æœ‰æ¶ˆæ¯è®°å½•ä¸‹æ¥ï¼Œåœ¨ç¡®è®¤å›è°ƒä¸­åˆ é™¤æ‰å·²ç¡®è®¤çš„ï¼Œå‰©ä¸‹çš„æ—¢æ˜¯æœªç¡®è®¤çš„ã€‚</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ä¹‹æ‰€ä»¥æ²¡æœ‰åœ¨æœªç¡®è®¤å›è°ƒä¸­ç›´æ¥æ·»åŠ æ•°æ®ï¼Œæ˜¯å› ä¸ºå›è°ƒå‡½æ•°åªèƒ½è·å–åˆ°åºå·ï¼Œæ— æ³•è·å–æ¶ˆæ¯ä½“ã€‚</span>
</span></span><span style=display:flex><span>        ConcurrentSkipListMap<span style=color:#f92672>&lt;</span>Long, Object<span style=color:#f92672>&gt;</span> information <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ConcurrentSkipListMap<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// æ¶ˆæ¯æ¥å—æˆåŠŸå›è°ƒå‡½æ•°</span>
</span></span><span style=display:flex><span>        ConfirmCallback ackCallback <span style=color:#f92672>=</span> (deliveryTag, multiple) <span style=color:#f92672>-&gt;</span> {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// æ‰¹é‡æ“ä½œ</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (multiple) {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// æ­¤å¤„ confirmed æ˜¯ outstandingConfirms çš„è§†å›¾ï¼Œå¯¹ confirm çš„æ“ä½œä¼šå½±å“åˆ° outstandingConfirmã€‚</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// å› æ­¤ï¼Œè¿™ä¸€æ­¥çš„ç»“æœæ˜¯åˆ é™¤æ‰æ‰€æœ‰å·²ç¡®è®¤çš„æ¶ˆæ¯</span>
</span></span><span style=display:flex><span>                ConcurrentNavigableMap<span style=color:#f92672>&lt;</span>Long, Object<span style=color:#f92672>&gt;</span> confirmed <span style=color:#f92672>=</span> information.<span style=color:#a6e22e>headMap</span>(deliveryTag);
</span></span><span style=display:flex><span>                confirmed.<span style=color:#a6e22e>clear</span>();
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                information.<span style=color:#a6e22e>remove</span>(deliveryTag);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// æ¶ˆæ¯æ¥å—å¤±è´¥å›è°ƒå‡½æ•°</span>
</span></span><span style=display:flex><span>        ConfirmCallback nackCallback <span style=color:#f92672>=</span> (deliveryTag, multiple) <span style=color:#f92672>-&gt;</span> {};
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ç›‘å¬å™¨ï¼Œå¼‚æ­¥é€šçŸ¥ã€‚è¿™é‡Œä¼šå¼€è¾Ÿä¸€ä¸ªçº¿ç¨‹è´Ÿè´£ç›‘å¬å¹¶å›è°ƒã€‚</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// è¿™é‡Œåªæ˜¯å°†æœªç¡®è®¤çš„æ¶ˆæ¯ä¿å­˜äº†ä¸‹æ¥ï¼Œè¿™äº›æ¶ˆæ¯è¯¥å¦‚ä½•å¤„ç†ï¼Ÿç›´æ¥ä½¿ç”¨å—ï¼Ÿ</span>
</span></span><span style=display:flex><span>        channel.<span style=color:#a6e22e>addConfirmListener</span>(ackCallback, nackCallback);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0; i <span style=color:#f92672>&lt;</span> 100; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>            String message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hello&#34;</span> <span style=color:#f92672>+</span> i;
</span></span><span style=display:flex><span>            information.<span style=color:#a6e22e>put</span>(channel.<span style=color:#a6e22e>getNextPublishSeqNo</span>(), message);
</span></span><span style=display:flex><span>            channel.<span style=color:#a6e22e>basicPublish</span>(<span style=color:#e6db74>&#34;&#34;</span>, HELLO, MessageProperties.<span style=color:#a6e22e>PERSISTENT_TEXT_PLAIN</span>, message.<span style=color:#a6e22e>getBytes</span>());
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=å…­äº¤æ¢æœº>å…­ã€äº¤æ¢æœº<a hidden class=anchor aria-hidden=true href=#å…­äº¤æ¢æœº>#</a></h2><p>ç”Ÿäº§è€…ç”Ÿäº§çš„æ¶ˆæ¯ä¸ä¼šç›´æ¥å‘é€åˆ°é˜Ÿåˆ—ï¼Œåªèƒ½å‘ç»™äº¤æ¢æœºã€‚äº¤æ¢æœºçš„å·¥ä½œæœ‰ä¸¤ä¸ªï¼Œä¸€æ˜¯æ¥æ”¶æ¥è‡ªç”Ÿäº§è€…çš„æ¶ˆæ¯ï¼ŒäºŒæ˜¯å°†ä»–ä»¬æ¨å…¥é˜Ÿåˆ—ã€‚äº¤æ¢æœºå¿…é¡»ç¡®åˆ‡çŸ¥é“è¯¥å¦‚ä½•å¤„ç†æ¥æ”¶åˆ°çš„æ¶ˆæ¯ï¼Œæ˜¯å°†å…¶å‘é€åˆ°ç‰¹å®šçš„ä¸€ä¸ªæˆ–å¤šä¸ªé˜Ÿåˆ—è¿˜æ˜¯ä¸¢å¼ƒã€‚è¿™äº›éƒ½ç”±äº¤æ¢æœºçš„ç±»å‹å†³å®šã€‚ç±»å‹å¦‚ä¸‹ï¼š</p><ul><li>Direct Exchangeï¼šç›´è¿äº¤æ¢æœºï¼Œæ ¹æ®Routing Key(è·¯ç”±é”®)è¿›è¡ŒæŠ•é€’åˆ°ä¸åŒé˜Ÿåˆ—ã€‚ï¼ˆé»˜è®¤ï¼‰</li><li>Fanout Exchangeï¼šæ‰‡å½¢äº¤æ¢æœºï¼Œé‡‡ç”¨å¹¿æ’­æ¨¡å¼ï¼Œæ ¹æ®ç»‘å®šçš„äº¤æ¢æœºï¼Œè·¯ç”±åˆ°ä¸ä¹‹å¯¹åº”çš„æ‰€æœ‰é˜Ÿåˆ—ã€‚</li><li>Topic Exchangeï¼šä¸»é¢˜äº¤æ¢æœºï¼Œå¯¹è·¯ç”±é”®è¿›è¡Œæ¨¡å¼åŒ¹é…åè¿›è¡ŒæŠ•é€’ï¼Œç¬¦å·<code>#</code>è¡¨ç¤º0ä¸ªæˆ–å¤šä¸ªè¯ï¼Œ<code>*</code>è¡¨ç¤ºä¸€ä¸ªè¯ã€‚</li><li>Header Exchangeï¼šå¤´äº¤æ¢æœºï¼Œä¸å¤„ç†è·¯ç”±é”®ã€‚è€Œæ˜¯æ ¹æ®å‘é€çš„æ¶ˆæ¯å†…å®¹ä¸­çš„headerså±æ€§è¿›è¡ŒåŒ¹é…ã€‚ï¼ˆåŸºæœ¬åºŸå¼ƒï¼‰</li></ul><p>è‹¥æƒ³è¦æ”¹å˜ä¸€ä¸ªäº¤æ¢æœºçš„ç±»å‹ï¼Œéœ€è¦å…ˆåˆ é™¤åŸæœ‰äº¤æ¢æœºï¼Œå†åˆ›å»ºæ–°äº¤æ¢æœºï¼Œå¦åˆ™æŠ¥é”™ã€‚</p><h3 id=61ç»‘å®šbinding>6.1ã€ç»‘å®šï¼ˆbindingï¼‰<a hidden class=anchor aria-hidden=true href=#61ç»‘å®šbinding>#</a></h3><p>Binding å°±æ˜¯ Exchange å’Œ Queue ä¹‹é—´çš„æ¡¥æ¢ã€‚Exchange æ ¹æ®ç»‘å®šå…³ç³»å°†æ•°æ®å‘é€ç»™ Queue ã€‚</p><h3 id=62fanout-exchange>6.2ã€Fanout Exchange<a hidden class=anchor aria-hidden=true href=#62fanout-exchange>#</a></h3><p>Fanout Exchange ä¸ Routing_Key æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œå³ Exchange ä¼šå‘<strong>æ‰€æœ‰</strong>ä¸å®ƒç»‘å®šçš„é˜Ÿåˆ—å¹¿æ’­æ¶ˆæ¯ï¼Œå°½ç®¡æŸäº›é˜Ÿåˆ—ä½¿ç”¨çš„ Routing_Key å‘å¸ƒè€…æŒ‡å®šçš„ Routing_Key ä¸åŒï¼Œä¹Ÿä¼šå‘é€ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Producer</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String EXCHANGE_NAME <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;first_exchange&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String ROUTING_KEY <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;first_routing_key&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) <span style=color:#66d9ef>throws</span> IOException, TimeoutException {
</span></span><span style=display:flex><span>        Channel channel <span style=color:#f92672>=</span> RabbitMqUtil.<span style=color:#a6e22e>getChannel</span>();
</span></span><span style=display:flex><span>        <span style=color:#75715e>// å£°æ˜äº¤æ¢æœºï¼Œç±»å‹ä¸º FANOUT å¹¿æ’­ç±»å‹</span>
</span></span><span style=display:flex><span>        channel.<span style=color:#a6e22e>exchangeDeclare</span>(EXCHANGE_NAME, BuiltinExchangeType.<span style=color:#a6e22e>FANOUT</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Scanner sc <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Scanner(System.<span style=color:#a6e22e>in</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> (sc.<span style=color:#a6e22e>hasNext</span>()) {
</span></span><span style=display:flex><span>            String message <span style=color:#f92672>=</span> sc.<span style=color:#a6e22e>next</span>();
</span></span><span style=display:flex><span>            <span style=color:#75715e>// å‘é€æ¶ˆæ¯åˆ°æŒ‡å®šçš„äº¤æ¢æœºå¹¶æŒ‡æ˜ä½¿ç”¨çš„ ROUTING_KEY</span>
</span></span><span style=display:flex><span>            channel.<span style=color:#a6e22e>basicPublish</span>(EXCHANGE_NAME, ROUTING_KEY, <span style=color:#66d9ef>null</span>, message.<span style=color:#a6e22e>getBytes</span>(StandardCharsets.<span style=color:#a6e22e>UTF_8</span>));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Consumer1</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) <span style=color:#66d9ef>throws</span> IOException, TimeoutException {
</span></span><span style=display:flex><span>        Channel channel <span style=color:#f92672>=</span> RabbitMqUtil.<span style=color:#a6e22e>getChannel</span>();
</span></span><span style=display:flex><span>        <span style=color:#75715e>// å£°æ˜ä¸€ä¸ªä¸´æ—¶é˜Ÿåˆ—ï¼Œæ¶ˆè´¹è€…æ–­å¼€å°±è‡ªåŠ¨åˆ é™¤</span>
</span></span><span style=display:flex><span>        String queueName <span style=color:#f92672>=</span> channel.<span style=color:#a6e22e>queueDeclare</span>().<span style=color:#a6e22e>getQueue</span>();
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ç»‘å®š</span>
</span></span><span style=display:flex><span>        channel.<span style=color:#a6e22e>queueBind</span>(queueName, EXCHANGE_NAME, ROUTING_KEY);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        DeliverCallback deliverCallback <span style=color:#f92672>=</span> (consumerTag, message) <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span>                System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;Consumer1: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#66d9ef>new</span> String(message.<span style=color:#a6e22e>getBody</span>()));
</span></span><span style=display:flex><span>        channel.<span style=color:#a6e22e>basicConsume</span>(queueName, <span style=color:#66d9ef>true</span>, deliverCallback, (consumerTag, message) <span style=color:#f92672>-&gt;</span> {});
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Consumer2</span> {}  <span style=color:#75715e>// Consumer2 ä¸ Consumer1 å®Œå…¨ç›¸åŒ</span>
</span></span></code></pre></div><h3 id=63direct-exchange>6.3ã€Direct Exchange<a hidden class=anchor aria-hidden=true href=#63direct-exchange>#</a></h3><p>Direct Exchange ä»…ä¼šå‘ä¸å®ƒé€šè¿‡ç‰¹å®šçš„ Routing_Key ç»‘å®šçš„é˜Ÿåˆ—å‘é€æ¶ˆæ¯ï¼Œè¿™ä¸ªç‰¹å®šçš„ Routing_Key å°±æ˜¯å‘å¸ƒè€…æŒ‡å®šçš„ Routing_Keyã€‚</p><h3 id=64topic-exchange>6.4ã€Topic Exchange<a hidden class=anchor aria-hidden=true href=#64topic-exchange>#</a></h3><p>Topic Exchange ä¸­ï¼Œå¯ä»¥ä½¿ç”¨å¸¦æœ‰é€šé…ç¬¦çš„ Routing_Key å°† Exchange å’Œ Queue è¿›è¡Œç»‘å®šã€‚</p><p>åœ¨è¯¥æ¨¡å¼ä¸­ï¼Œå‘å¸ƒè€…æŒ‡å®šçš„ Routing_Key å¿…é¡»ä»¥ç‚¹å·éš”å¼€çš„å•è¯åˆ—è¡¨ï¼Œå¦‚ com.lu.mq</p><p><code>#</code>åŒ¹é… 0 ä¸ªæˆ–å¤šä¸ªè¯ï¼Œ<code>*</code>è¡¨ç¤º 1 ä¸ªè¯ã€‚æ³¨æ„æ˜¯ç‚¹ä¸ç‚¹ä¹‹é—´çš„å®Œæˆçš„è¯ï¼Œä¸æ˜¯å­—æ¯ã€‚å¦‚ com.*.mqã€ com.#</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Producer</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String EXCHANGE_NAME <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;third_exchange&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String ROUTING_KEY <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;com.lu.mq&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) <span style=color:#66d9ef>throws</span> IOException, TimeoutException {
</span></span><span style=display:flex><span>        Channel channel <span style=color:#f92672>=</span> RabbitMqUtil.<span style=color:#a6e22e>getChannel</span>();
</span></span><span style=display:flex><span>        <span style=color:#75715e>// å£°æ˜äº¤æ¢æœºï¼Œç±»å‹ä¸º TOPIC ä¸»é¢˜ç±»å‹</span>
</span></span><span style=display:flex><span>        channel.<span style=color:#a6e22e>exchangeDeclare</span>(EXCHANGE_NAME, BuiltinExchangeType.<span style=color:#a6e22e>TOPIC</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Scanner sc <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Scanner(System.<span style=color:#a6e22e>in</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> (sc.<span style=color:#a6e22e>hasNext</span>()) {
</span></span><span style=display:flex><span>            String message <span style=color:#f92672>=</span> sc.<span style=color:#a6e22e>next</span>();
</span></span><span style=display:flex><span>            channel.<span style=color:#a6e22e>basicPublish</span>(EXCHANGE_NAME, ROUTING_KEY, <span style=color:#66d9ef>null</span>, message.<span style=color:#a6e22e>getBytes</span>(StandardCharsets.<span style=color:#a6e22e>UTF_8</span>));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Consumer1</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) <span style=color:#66d9ef>throws</span> IOException, TimeoutException {
</span></span><span style=display:flex><span>        Channel channel <span style=color:#f92672>=</span> RabbitMqUtil.<span style=color:#a6e22e>getChannel</span>();
</span></span><span style=display:flex><span>        String queueName <span style=color:#f92672>=</span> channel.<span style=color:#a6e22e>queueDeclare</span>().<span style=color:#a6e22e>getQueue</span>();
</span></span><span style=display:flex><span>        channel.<span style=color:#a6e22e>queueBind</span>(queueName, EXCHANGE_NAME, <span style=color:#e6db74>&#34;com.#&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        DeliverCallback deliverCallback <span style=color:#f92672>=</span> (consumerTag, message) <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span>                System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;Consumer1: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#66d9ef>new</span> String(message.<span style=color:#a6e22e>getBody</span>()));
</span></span><span style=display:flex><span>        channel.<span style=color:#a6e22e>basicConsume</span>(queueName, <span style=color:#66d9ef>true</span>, deliverCallback, (consumerTag, message) <span style=color:#f92672>-&gt;</span> {});
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Consumer2</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) <span style=color:#66d9ef>throws</span> IOException, TimeoutException {
</span></span><span style=display:flex><span>        Channel channel <span style=color:#f92672>=</span> RabbitMqUtil.<span style=color:#a6e22e>getChannel</span>();
</span></span><span style=display:flex><span>        String queueName <span style=color:#f92672>=</span> channel.<span style=color:#a6e22e>queueDeclare</span>().<span style=color:#a6e22e>getQueue</span>();
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ä¸€ä¸ªé˜Ÿåˆ—å¯ä»¥é€šè¿‡ä¸åŒçš„ Routing_Key ç»‘å®šä¸€ä¸ªæˆ–å¤šä¸ªäº¤æ¢æœº</span>
</span></span><span style=display:flex><span>        channel.<span style=color:#a6e22e>queueBind</span>(queueName, EXCHANGE_NAME, <span style=color:#e6db74>&#34;com.*.mq&#34;</span>);
</span></span><span style=display:flex><span>        channel.<span style=color:#a6e22e>queueBind</span>(queueName, EXCHANGE_NAME, <span style=color:#e6db74>&#34;com.lu.*&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        DeliverCallback deliverCallback <span style=color:#f92672>=</span> (consumerTag, message) <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span>                System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;Consumer2: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#66d9ef>new</span> String(message.<span style=color:#a6e22e>getBody</span>()));
</span></span><span style=display:flex><span>        channel.<span style=color:#a6e22e>basicConsume</span>(queueName, <span style=color:#66d9ef>true</span>, deliverCallback, (consumerTag, message) <span style=color:#f92672>-&gt;</span> {});
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=ä¸ƒæ­»ä¿¡é˜Ÿåˆ—>ä¸ƒã€æ­»ä¿¡é˜Ÿåˆ—<a hidden class=anchor aria-hidden=true href=#ä¸ƒæ­»ä¿¡é˜Ÿåˆ—>#</a></h2><p>æ²¡æœ‰è¢«æ¶ˆè´¹è€…æ¶ˆè´¹çš„æ¶ˆæ¯å«åšæ­»ä¿¡ï¼Œå­˜æ”¾æ­»ä¿¡çš„é˜Ÿåˆ—å«åšæ­»ä¿¡é˜Ÿåˆ—ã€‚</p><p>æœ‰ç‚¹ç±»ä¼¼äºé˜»å¡é˜Ÿåˆ—ï¼Œæ¡ä»¶ä¸æ»¡è¶³å°±é˜»å¡ï¼Œç›´åˆ°æ¡ä»¶æ»¡è¶³è¢«å”¤é†’ã€‚</p><p>åº”ç”¨åœºæ™¯ï¼šæ¶ˆæ¯æ¶ˆè´¹å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œæ”¾å…¥æ­»ä¿¡é˜Ÿåˆ—ï¼Œä»¥é˜²æ­¢æ¶ˆæ¯ä¸¢å¤±ï¼›ç”¨æˆ·ä¸‹å•æœªæ”¯ä»˜ï¼Œè¶…æ—¶åå°†è®¢å•æ”¾å…¥æ­»ä¿¡é˜Ÿåˆ—ã€‚</p><h3 id=71æ­»ä¿¡çš„æ¥æº>7.1ã€æ­»ä¿¡çš„æ¥æº<a hidden class=anchor aria-hidden=true href=#71æ­»ä¿¡çš„æ¥æº>#</a></h3><ul><li>æ¶ˆæ¯ TTL è¿‡æœŸ<ul><li>TTLæ˜¯<code>Time To Live</code>çš„ç¼©å†™ï¼Œä¹Ÿå°±æ˜¯ç”Ÿå­˜æ—¶é—´ã€‚</li><li>RabbitMQæ”¯æŒæ¶ˆæ¯çš„è¿‡æœŸæ—¶é—´ï¼Œåœ¨æ¶ˆæ¯å‘é€æ—¶å¯ä»¥è¿›è¡ŒæŒ‡å®šï¼Œä»…ä½œç”¨äºè¯¥æ¶ˆæ¯</li><li>RabbitMQæ”¯æŒä¸ºæ¯ä¸ªé˜Ÿåˆ—è®¾ç½®æ¶ˆæ¯çš„è¶…æ—¶æ—¶é—´ï¼Œä»æ¶ˆæ¯å…¥é˜Ÿåˆ—å¼€å§‹è®¡ç®—ï¼Œå¦‚æœè¶…æ—¶æ¶ˆæ¯ä¼šè‡ªåŠ¨æ¸…é™¤ï¼Œä½œç”¨äºæ•´ä¸ªé˜Ÿåˆ—</li></ul></li><li>é˜Ÿåˆ—å·²æ»¡</li><li>æ¶ˆæ¯è¢«æ‹’ç»ï¼ˆrejectã€nackï¼‰ä¸” requeue = false</li></ul><h3 id=72æ¶ˆæ¯-ttl-è¿‡æœŸ>7.2ã€æ¶ˆæ¯ TTL è¿‡æœŸ<a hidden class=anchor aria-hidden=true href=#72æ¶ˆæ¯-ttl-è¿‡æœŸ>#</a></h3><p><img alt=æ­»ä¿¡é˜Ÿåˆ— loading=lazy src=/posts/%E5%88%86%E5%B8%83%E5%BC%8F/rabbitmq/rabbitmq/%E6%AD%BB%E4%BF%A1%E9%98%9F%E5%88%97.png></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// äº¤æ¢æœºå’Œé˜Ÿåˆ—çš„å£°æ˜æ”¾åœ¨å“ªé‡Œéƒ½å¯ä»¥</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Consumer1</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String NORMAL_EXCHANGE <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;normal_exchange&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String DEAD_EXCHANGE <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;dead_exchange&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String NORMAL_QUEUE <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;normal_queue&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String DEAD_QUEUE <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;dead_queue&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String NORMAL_ROUTING_KEY <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;normal_routing_key&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String DEAD_ROUTING_KEY <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;dead_routing_key&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) <span style=color:#66d9ef>throws</span> IOException, TimeoutException {
</span></span><span style=display:flex><span>        Channel channel <span style=color:#f92672>=</span> RabbitMqUtil.<span style=color:#a6e22e>getChannel</span>();
</span></span><span style=display:flex><span>        channel.<span style=color:#a6e22e>exchangeDeclare</span>(NORMAL_EXCHANGE, BuiltinExchangeType.<span style=color:#a6e22e>DIRECT</span>);
</span></span><span style=display:flex><span>        channel.<span style=color:#a6e22e>exchangeDeclare</span>(DEAD_EXCHANGE, BuiltinExchangeType.<span style=color:#a6e22e>DIRECT</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Map<span style=color:#f92672>&lt;</span>String, Object<span style=color:#f92672>&gt;</span> arguments <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>        arguments.<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>&#34;x-dead-letter-exchange&#34;</span>, DEAD_EXCHANGE);  <span style=color:#75715e>// æŒ‡å®šæ­»ä¿¡æ¶ˆæ¯åº”è¯¥å‘é€ç»™å“ªä¸ªæ­»ä¿¡äº¤æ¢æœº</span>
</span></span><span style=display:flex><span>        arguments.<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>&#34;x-dead-letter-routing-key&#34;</span>, DEAD_ROUTING_KEY);  <span style=color:#75715e>// è®¾ç½®æ­»ä¿¡äº¤æ¢æœºåˆ°æ­»ä¿¡é˜Ÿåˆ—çš„è·¯ç”±</span>
</span></span><span style=display:flex><span>        channel.<span style=color:#a6e22e>queueDeclare</span>(NORMAL_QUEUE, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>false</span>, arguments);
</span></span><span style=display:flex><span>        channel.<span style=color:#a6e22e>queueDeclare</span>(DEAD_QUEUE, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        channel.<span style=color:#a6e22e>queueBind</span>(NORMAL_QUEUE, NORMAL_EXCHANGE, NORMAL_ROUTING_KEY);
</span></span><span style=display:flex><span>        channel.<span style=color:#a6e22e>queueBind</span>(DEAD_QUEUE, DEAD_EXCHANGE, DEAD_ROUTING_KEY);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        DeliverCallback deliverCallback <span style=color:#f92672>=</span> (consumerTag, message) <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span>                System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;Consumer1: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#66d9ef>new</span> String(message.<span style=color:#a6e22e>getBody</span>()));
</span></span><span style=display:flex><span>        channel.<span style=color:#a6e22e>basicConsume</span>(NORMAL_QUEUE, <span style=color:#66d9ef>true</span>, deliverCallback, (consumerTag, message) <span style=color:#f92672>-&gt;</span> {});
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Producer</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) <span style=color:#66d9ef>throws</span> IOException, TimeoutException {
</span></span><span style=display:flex><span>        Channel channel <span style=color:#f92672>=</span> RabbitMqUtil.<span style=color:#a6e22e>getChannel</span>();
</span></span><span style=display:flex><span>        AMQP.<span style=color:#a6e22e>BasicProperties</span> properties <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> AMQP.<span style=color:#a6e22e>BasicProperties</span>().<span style=color:#a6e22e>builder</span>().<span style=color:#a6e22e>expiration</span>(<span style=color:#e6db74>&#34;10000&#34;</span>).<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0; i <span style=color:#f92672>&lt;</span> 10; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>            String message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hello&#34;</span> <span style=color:#f92672>+</span> i;
</span></span><span style=display:flex><span>            channel.<span style=color:#a6e22e>basicPublish</span>(NORMAL_EXCHANGE, NORMAL_ROUTING_KEY, properties, message.<span style=color:#a6e22e>getBytes</span>());
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// æ¶ˆè´¹æ­»ä¿¡</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Consumer2</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) <span style=color:#66d9ef>throws</span> IOException, TimeoutException {
</span></span><span style=display:flex><span>        Channel channel <span style=color:#f92672>=</span> RabbitMqUtil.<span style=color:#a6e22e>getChannel</span>();
</span></span><span style=display:flex><span>        DeliverCallback deliverCallback <span style=color:#f92672>=</span> (consumerTag, message) <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span>                System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;Consumer2: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#66d9ef>new</span> String(message.<span style=color:#a6e22e>getBody</span>()));
</span></span><span style=display:flex><span>        channel.<span style=color:#a6e22e>basicConsume</span>(DEAD_QUEUE, <span style=color:#66d9ef>true</span>, deliverCallback, (consumerTag, message) <span style=color:#f92672>-&gt;</span> {});
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=73é˜Ÿåˆ—å·²æ»¡>7.3ã€é˜Ÿåˆ—å·²æ»¡<a hidden class=anchor aria-hidden=true href=#73é˜Ÿåˆ—å·²æ»¡>#</a></h3><p>åœ¨ consumer1 çš„ arguments ä¸­è®¾ç½®é˜Ÿåˆ—é•¿åº¦ï¼Œä¸”å°†ç”Ÿäº§è€…çš„è¿‡æœŸæ—¶é—´å–æ¶ˆå³å¯ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>arguments.<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>&#34;x-max-length&#34;</span>, 6);   <span style=color:#75715e>// è®¾ç½®é˜Ÿåˆ—é•¿åº¦</span>
</span></span></code></pre></div><h3 id=74æ¶ˆæ¯è¢«æ‹’ç»>7.4ã€æ¶ˆæ¯è¢«æ‹’ç»<a hidden class=anchor aria-hidden=true href=#74æ¶ˆæ¯è¢«æ‹’ç»>#</a></h3><p>åœ¨ consumer1 ä¸­å…³é—­è‡ªåŠ¨åº”ç­”å¹¶æ‰‹åŠ¨å‘é€æ‹’ç» ack å³å¯ã€‚</p><h2 id=å…«å»¶è¿Ÿé˜Ÿåˆ—>å…«ã€å»¶è¿Ÿé˜Ÿåˆ—<a hidden class=anchor aria-hidden=true href=#å…«å»¶è¿Ÿé˜Ÿåˆ—>#</a></h2><h3 id=81æ¦‚å¿µ>8.1ã€æ¦‚å¿µ<a hidden class=anchor aria-hidden=true href=#81æ¦‚å¿µ>#</a></h3><p>å»¶è¿Ÿé˜Ÿåˆ—å…¶å®å°±æ˜¯ç¬¬ä¸ƒç« ä¸­ç”±äº ttl è¿‡æœŸå¯¼è‡´çš„æ­»ä¿¡é˜Ÿåˆ—çš„æ¼”åŒ–ã€‚</p><p>æ‰€è°“çš„å»¶æ—¶æ¶ˆæ¯ï¼Œæ˜¯æŒ‡æ¶ˆæ¯è¢«å‘é€ä»¥åï¼Œå¹¶ä¸æƒ³è®©æ¶ˆè´¹è€…ç«‹åˆ»è·å–ï¼Œè€Œæ˜¯ç­‰å¾…ç‰¹å®šçš„æ—¶é—´åï¼Œæ¶ˆè´¹è€…æ‰èƒ½è·å–è¿™ä¸ªæ¶ˆæ¯è¿›è¡Œæ¶ˆè´¹ã€‚</p><p>å’Œå®šæ—¶ä»»åŠ¡çš„åŒºåˆ«ï¼š</p><ol><li>å®šæ—¶ä»»åŠ¡æœ‰æ˜ç¡®çš„è§¦å‘æ—¶é—´ï¼Œå»¶æ—¶ä»»åŠ¡æ²¡æœ‰</li><li>å®šæ—¶ä»»åŠ¡æœ‰æ‰§è¡Œå‘¨æœŸï¼Œè€Œå»¶æ—¶ä»»åŠ¡åœ¨æŸäº‹ä»¶è§¦å‘ä¸€æ®µæ—¶é—´å†…æ‰§è¡Œï¼Œæ²¡æœ‰æ‰§è¡Œå‘¨æœŸ</li><li>å®šæ—¶ä»»åŠ¡ä¸€èˆ¬æ‰§è¡Œçš„æ‰¹å¤„ç†æ“ä½œæ˜¯å¤šä¸ªä»»åŠ¡ï¼Œè€Œå»¶æ—¶ä»»åŠ¡ä¸€èˆ¬æ˜¯å•ä¸ªä»»åŠ¡</li></ol><h3 id=82ä½¿ç”¨åœºæ™¯>8.2ã€ä½¿ç”¨åœºæ™¯<a hidden class=anchor aria-hidden=true href=#82ä½¿ç”¨åœºæ™¯>#</a></h3><ul><li>åœ¨è®¢å•ç³»ç»Ÿä¸­ï¼Œè®¢å•å¦‚æœ30åˆ†é’Ÿä¹‹å†…æ²¡æœ‰æ”¯ä»˜æˆåŠŸï¼Œé‚£ä¹ˆè¿™ä¸ªè®¢å•å°†è¢«å…³é—­ï¼›ç”Ÿæˆè®¢å•60sä¹‹åç»™ç”¨æˆ·å‘é€šçŸ¥çŸ­ä¿¡ï¼›è¿™æ—¶å°±å¯ä»¥ä½¿ç”¨å»¶æ—¶é˜Ÿåˆ—æ¥å¤„ç†è¿™äº›è®¢å•ã€‚</li><li>ç”¨æˆ·æ³¨å†ŒæˆåŠŸåï¼Œè‹¥ 15 å¤©æœªç™»å½•åˆ™é‚®ç®±æé†’ã€‚</li><li>ç”¨æˆ·å¸Œæœ›é€šè¿‡æ‰‹æœºè¿œç¨‹é¥æ§å®¶é‡Œçš„æ™ºèƒ½è®¾å¤‡åœ¨æŒ‡å®šçš„æ—¶é—´è¿›è¡Œå·¥ä½œã€‚è¿™æ—¶å°±å¯ä»¥å°†ç”¨æˆ·æŒ‡ä»¤å‘é€åˆ°å»¶æ—¶é˜Ÿåˆ—ï¼Œå½“æŒ‡ä»¤çš„æ—¶é—´åˆ°äº†ä¹‹åå†å°†å®ƒæ¨é€åˆ°æ™ºèƒ½è®¾å¤‡</li><li>è®¢å•7å¤©è‡ªåŠ¨ç¡®è®¤æ”¶è´§ï¼Œåœ¨æˆ‘ä»¬ç­¾æ”¶å•†å“åï¼Œç‰©æµç³»ç»Ÿä¼šåœ¨7å¤©åå»¶æ—¶å‘é€ä¸€ä¸ªæ¶ˆæ¯ç»™æ”¯ä»˜ç³»ç»Ÿï¼Œé€šçŸ¥æ”¯ä»˜ç³»ç»Ÿå°†æ¬¾æ‰“ç»™å•†å®¶</li><li>é¢„å®šä¼šè®®åï¼Œåœ¨å¼€ä¼š 10 åˆ†é’Ÿå‰é€šçŸ¥ä¸ä¼šäººå‘˜ã€‚</li></ul><h3 id=83å»¶è¿Ÿé˜Ÿåˆ—å®ç°>8.3ã€å»¶è¿Ÿé˜Ÿåˆ—å®ç°<a hidden class=anchor aria-hidden=true href=#83å»¶è¿Ÿé˜Ÿåˆ—å®ç°>#</a></h3><p>ç”±äºé˜Ÿåˆ—å…ˆè¿›å…ˆå‡ºçš„ç‰¹æ€§ï¼Œåªæœ‰å½“è¿‡æœŸçš„æ¶ˆæ¯åˆ°è¾¾é˜Ÿé¦–ï¼Œæ‰ä¼šè¢«ä¸¢å¼ƒæˆ–è¿›å…¥æ­»ä¿¡é˜Ÿåˆ—ã€‚æ‰€ä»¥å½“ä½¿ç”¨ Rabbitmq åšå»¶è¿Ÿé˜Ÿåˆ—æ¥å®ç°ä¸€ä¸ªä¸šåŠ¡æ—¶ï¼Œéœ€è¦ç¡®ä¿ä¸šåŠ¡ä¸Šçš„æ¶ˆæ¯çš„å»¶è¿Ÿæ—¶é—´ä¸€è‡´ã€‚è‹¥æœ‰ä¸åŒçš„å»¶è¿Ÿæ—¶é—´ï¼Œå°±å¿…é¡»ä¸ºæ¯ç§ä¸åŒçš„å»¶è¿Ÿæ—¶é—´å»ºç«‹ä¸åŒçš„é˜Ÿåˆ—ã€‚</p><p><strong>ä¸æ¨èä½¿ç”¨ï¼Œè‹¥è¦é€šè¿‡ Rabbitmq ä½¿ç”¨å»¶è¿Ÿé˜Ÿåˆ—åº”è¯¥ä½¿ç”¨æ’ä»¶</strong></p><p><img alt=å»¶è¿Ÿé˜Ÿåˆ—æ¶æ„ loading=lazy src=/posts/%E5%88%86%E5%B8%83%E5%BC%8F/rabbitmq/rabbitmq/%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97%E6%9E%B6%E6%9E%84.png></p><p>ä¸Šå›¾ä¸­ï¼ŒX ä¸ºæ™®é€šäº¤æ¢æœºï¼ŒYä¸ºæ­»ä¿¡äº¤æ¢æœºã€‚QA å’Œ QB é˜Ÿåˆ—åˆ†åˆ«å»¶è¿Ÿ 10s å’Œ 40sï¼ŒQC é˜Ÿåˆ—ä¸è®¾ç½®å»¶è¿Ÿã€‚QD ä¸ºæ­»ä¿¡é˜Ÿåˆ—ã€‚</p><ol><li><p>spring bootå¼•å…¥ä¾èµ–</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>spring-boot-starter-amqp<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></div></li><li><p>ä¸»é…ç½®æ–‡ä»¶é…ç½®æœåŠ¡å™¨</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>spring</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>rabbitmq</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>host</span>: <span style=color:#ae81ff>192.168.36.128</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>port</span>: <span style=color:#ae81ff>5672</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>username</span>: <span style=color:#ae81ff>guest</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>password</span>: <span style=color:#ae81ff>guest</span>
</span></span></code></pre></div></li><li><p>å†™é…ç½®ç±»</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TtlQueueConfig</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// äº¤æ¢æœº</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String X_EXCHANGE <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;X&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String DEAD_LETTER_Y_EXCHANGE <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Y&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// é˜Ÿåˆ—</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String QUEUE_A <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;QA&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String QUEUE_B <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;QB&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String QUEUE_C <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;QC&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String DEAD_LETTER_QUEUE_D <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;QD&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// é˜Ÿåˆ— A B çš„è¿‡æœŸæ—¶é—´</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Integer QUEUE_A_TTL <span style=color:#f92672>=</span> 10000;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Integer QUEUE_B_TTL <span style=color:#f92672>=</span> 40000;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è·¯ç”±</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String XA_ROUTING_KEY <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;XA&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String XB_ROUTING_KEY <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;XB&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String XC_ROUTING_KEY <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;XC&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String DEAD_LETTER_ROUTING_KEY <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;YD&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å£°æ˜äº¤æ¢æœº</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> DirectExchange <span style=color:#a6e22e>xExchange</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> DirectExchange(X_EXCHANGE);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> DirectExchange <span style=color:#a6e22e>yExchange</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> DirectExchange(DEAD_LETTER_Y_EXCHANGE);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å£°æ˜é˜Ÿåˆ—å¹¶é…ç½®æ­»ä¿¡äº¤æ¢æœº</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Queue <span style=color:#a6e22e>queueA</span>() {
</span></span><span style=display:flex><span>        Map<span style=color:#f92672>&lt;</span>String, Object<span style=color:#f92672>&gt;</span> arguments <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>        arguments.<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>&#34;x-dead-letter-exchange&#34;</span>, DEAD_LETTER_Y_EXCHANGE);
</span></span><span style=display:flex><span>        arguments.<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>&#34;x-dead-letter-routing-key&#34;</span>, DEAD_LETTER_ROUTING_KEY);
</span></span><span style=display:flex><span>        arguments.<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>&#34;x-message-ttl&#34;</span>, QUEUE_A_TTL);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> QueueBuilder.<span style=color:#a6e22e>durable</span>(QUEUE_A).<span style=color:#a6e22e>withArguments</span>(arguments).<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Queue <span style=color:#a6e22e>queueB</span>() {
</span></span><span style=display:flex><span>        Map<span style=color:#f92672>&lt;</span>String, Object<span style=color:#f92672>&gt;</span> arguments <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>        arguments.<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>&#34;x-dead-letter-exchange&#34;</span>, DEAD_LETTER_Y_EXCHANGE);
</span></span><span style=display:flex><span>        arguments.<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>&#34;x-dead-letter-routing-key&#34;</span>, DEAD_LETTER_ROUTING_KEY);
</span></span><span style=display:flex><span>        arguments.<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>&#34;x-message-ttl&#34;</span>, QUEUE_B_TTL);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> QueueBuilder.<span style=color:#a6e22e>durable</span>(QUEUE_B).<span style=color:#a6e22e>withArguments</span>(arguments).<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Queue <span style=color:#a6e22e>queueC</span>() {
</span></span><span style=display:flex><span>        Map<span style=color:#f92672>&lt;</span>String, Object<span style=color:#f92672>&gt;</span> arguments <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>        arguments.<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>&#34;x-dead-letter-exchange&#34;</span>, DEAD_LETTER_Y_EXCHANGE);
</span></span><span style=display:flex><span>        arguments.<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>&#34;x-dead-letter-routing-key&#34;</span>, DEAD_LETTER_ROUTING_KEY);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> QueueBuilder.<span style=color:#a6e22e>durable</span>(QUEUE_C).<span style=color:#a6e22e>withArguments</span>(arguments).<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Queue <span style=color:#a6e22e>queueD</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> QueueBuilder.<span style=color:#a6e22e>durable</span>(DEAD_LETTER_QUEUE_D).<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ç»‘å®š</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Binding <span style=color:#a6e22e>queueABindingX</span>(<span style=color:#a6e22e>@Qualifier</span>(<span style=color:#e6db74>&#34;queueA&#34;</span>) Queue queueA, 
</span></span><span style=display:flex><span>                                  <span style=color:#a6e22e>@Qualifier</span>(<span style=color:#e6db74>&#34;xExchange&#34;</span>) DirectExchange xExchange) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> BindingBuilder.<span style=color:#a6e22e>bind</span>(queueA).<span style=color:#a6e22e>to</span>(xExchange).<span style=color:#a6e22e>with</span>(XA_ROUTING_KEY);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Binding <span style=color:#a6e22e>queueBBindingX</span>(<span style=color:#a6e22e>@Qualifier</span>(<span style=color:#e6db74>&#34;queueB&#34;</span>) Queue queueB,
</span></span><span style=display:flex><span>                                  <span style=color:#a6e22e>@Qualifier</span>(<span style=color:#e6db74>&#34;xExchange&#34;</span>) DirectExchange xExchange) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> BindingBuilder.<span style=color:#a6e22e>bind</span>(queueB).<span style=color:#a6e22e>to</span>(xExchange).<span style=color:#a6e22e>with</span>(XB_ROUTING_KEY);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Binding <span style=color:#a6e22e>queueCBindingX</span>(<span style=color:#a6e22e>@Qualifier</span>(<span style=color:#e6db74>&#34;queueC&#34;</span>) Queue queueC,
</span></span><span style=display:flex><span>                                  <span style=color:#a6e22e>@Qualifier</span>(<span style=color:#e6db74>&#34;xExchange&#34;</span>) DirectExchange xExchange) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> BindingBuilder.<span style=color:#a6e22e>bind</span>(queueC).<span style=color:#a6e22e>to</span>(xExchange).<span style=color:#a6e22e>with</span>(XC_ROUTING_KEY);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Binding <span style=color:#a6e22e>queueDBindingY</span>(<span style=color:#a6e22e>@Qualifier</span>(<span style=color:#e6db74>&#34;queueD&#34;</span>) Queue queueD,
</span></span><span style=display:flex><span>                                  <span style=color:#a6e22e>@Qualifier</span>(<span style=color:#e6db74>&#34;yExchange&#34;</span>) DirectExchange yExchange) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> BindingBuilder.<span style=color:#a6e22e>bind</span>(queueD).<span style=color:#a6e22e>to</span>(yExchange).<span style=color:#a6e22e>with</span>(DEAD_LETTER_ROUTING_KEY);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li><li><p>å‘é€è€…ä¸æ¥å—è€…</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// Controller æ¥æ”¶ web çš„å‚æ•°å¹¶å‘é€åˆ° mq</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SendMsgController</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> RabbitTemplate rabbitTemplate;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;/ttl/msg/{message}&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>@PathVariable</span> String message) {
</span></span><span style=display:flex><span>        rabbitTemplate.<span style=color:#a6e22e>convertAndSend</span>(<span style=color:#e6db74>&#34;X&#34;</span>, <span style=color:#e6db74>&#34;XA&#34;</span>, <span style=color:#e6db74>&#34;10s &#34;</span> <span style=color:#f92672>+</span> message);  <span style=color:#75715e>// å‘é˜Ÿåˆ—Aå‘æ¶ˆæ¯</span>
</span></span><span style=display:flex><span>        rabbitTemplate.<span style=color:#a6e22e>convertAndSend</span>(<span style=color:#e6db74>&#34;X&#34;</span>, <span style=color:#e6db74>&#34;XB&#34;</span>, <span style=color:#e6db74>&#34;40s &#34;</span> <span style=color:#f92672>+</span> message);  <span style=color:#75715e>// å‘é˜Ÿåˆ—Bå‘æ¶ˆæ¯</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;/ttl/msg/{message}/{ttlTime}&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>@PathVariable</span> String message, <span style=color:#a6e22e>@PathVariable</span> String ttlTime) {
</span></span><span style=display:flex><span>        rabbitTemplate.<span style=color:#a6e22e>convertAndSend</span>(<span style=color:#e6db74>&#34;X&#34;</span>, <span style=color:#e6db74>&#34;XC&#34;</span>, message, msg  <span style=color:#f92672>-&gt;</span> {
</span></span><span style=display:flex><span>            msg.<span style=color:#a6e22e>getMessageProperties</span>().<span style=color:#a6e22e>setExpiration</span>(ttlTime);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> msg;
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// æ¥æ”¶æ­»ä¿¡é˜Ÿåˆ—çš„æ¶ˆæ¯</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DeadLetterConsumer</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RabbitListener</span>(queues <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;QD&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>receiveD</span>(Message message) {
</span></span><span style=display:flex><span>        String msg <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> String(message.<span style=color:#a6e22e>getBody</span>());
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;receive message &#34;</span> <span style=color:#f92672>+</span> msg);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li></ol><h3 id=84å»¶è¿Ÿé˜Ÿåˆ—æ’ä»¶>8.4ã€å»¶è¿Ÿé˜Ÿåˆ—æ’ä»¶<a hidden class=anchor aria-hidden=true href=#84å»¶è¿Ÿé˜Ÿåˆ—æ’ä»¶>#</a></h3><p>å¯¹é˜Ÿåˆ—è®¾ç½® TTL ä¼šå¯¼è‡´ç³»ç»Ÿéœ€è¦å¾ˆå¤šçš„é˜Ÿåˆ—ï¼Œä½¿ç³»ç»Ÿå¤æ‚ã€‚å¯¹æ¶ˆæ¯è®¾ç½® TTL ç”±äºæ¶ˆæ¯ç§¯å‹ä¼šå¯¼è‡´ä¸åœ¨é˜Ÿé¦–çš„æ¶ˆæ¯ä¸èƒ½åŠæ—¶è¿›å…¥æ­»ä¿¡é˜Ÿåˆ—ã€‚ä¸ºå¼¥è¡¥ä¸è¶³ï¼Œå¼•å…¥æ’ä»¶æ¥å®ç°å»¶è¿Ÿé˜Ÿåˆ—ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># ç”±äº mq å®¹å™¨å†…æ²¡æœ‰ wget ï¼Œæ•…å…ˆåœ¨ä¸»æœºä¸‹è½½æ’ä»¶</span>
</span></span><span style=display:flex><span>wget https://github.com/rabbitmq/rabbitmq-delayed-message-exchange/releases/download/3.10.0/rabbitmq_delayed_message_exchange-3.10.0.ez
</span></span><span style=display:flex><span><span style=color:#75715e># å¤åˆ¶åˆ°å®¹å™¨ä¸­çš„æ’ä»¶ç›®å½•ï¼Œ mq æ˜¯å®¹å™¨å</span>
</span></span><span style=display:flex><span>docker cp rabbitmq_delayed_message_exchange-3.10.0.ez mq:/opt/rabbitmq/plugin
</span></span><span style=display:flex><span><span style=color:#75715e># è¿›å…¥å®¹å™¨å¯ç”¨æ’ä»¶</span>
</span></span><span style=display:flex><span>rabbitmq-plugins enable rabbitmq_delayed_message_exchange
</span></span></code></pre></div><p>æˆåŠŸå¯åŠ¨ä¹‹åï¼Œè¿›å…¥ web æ§åˆ¶å°çš„ exchangesï¼Œæ·»åŠ äº¤æ¢æœºï¼Œtype æ ä¸­å¤šäº†ä¸€ä¸ª x-delayed-message é€‰é¡¹ã€‚</p><p><img alt=åŸºäºæ’ä»¶çš„å»¶è¿Ÿé˜Ÿåˆ— loading=lazy src=/posts/%E5%88%86%E5%B8%83%E5%BC%8F/rabbitmq/rabbitmq/%E5%9F%BA%E4%BA%8E%E6%8F%92%E4%BB%B6%E7%9A%84%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97.png></p><p>åŸºäºæ’ä»¶çš„å»¶è¿Ÿé˜Ÿåˆ—ä¸éœ€è¦ä¸“é—¨è®¾ç½®è¿‡æœŸé˜Ÿåˆ—</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DelayQueueConfig</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String DELAYED_QUEUE <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;delayed_queue&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String DELAYED_EXCHANGE <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;delayed_exchange&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String DELAYED_ROUTING_KEY <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;delayed_routing_key&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> CustomExchange <span style=color:#a6e22e>delayedExchange</span>() {
</span></span><span style=display:flex><span>        Map<span style=color:#f92672>&lt;</span>String, Object<span style=color:#f92672>&gt;</span> arguments <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>        arguments.<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>&#34;x-delayed-message&#34;</span>, <span style=color:#e6db74>&#34;direct&#34;</span>);  <span style=color:#75715e>// å»¶è¿Ÿäº¤æ¢æœºçš„ç±»å‹ä¸ºç›´è¿ç±»å‹</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>         * 1. äº¤æ¢æœºåç§°
</span></span></span><span style=display:flex><span><span style=color:#75715e>         * 2. äº¤æ¢æœºç±»å‹
</span></span></span><span style=display:flex><span><span style=color:#75715e>         * 3. æ˜¯å¦éœ€è¦æŒä¹…åŒ–
</span></span></span><span style=display:flex><span><span style=color:#75715e>         * 4. æ˜¯å¦è‡ªåŠ¨åˆ é™¤
</span></span></span><span style=display:flex><span><span style=color:#75715e>         * 5. å…¶ä»–å‚æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e>         */</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> CustomExchange(DELAYED_EXCHANGE, <span style=color:#e6db74>&#34;x-delayed-message&#34;</span>, <span style=color:#66d9ef>true</span>, <span style=color:#66d9ef>false</span>, arguments);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Queue <span style=color:#a6e22e>delayedQueue</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> QueueBuilder.<span style=color:#a6e22e>durable</span>(DELAYED_QUEUE).<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Binding <span style=color:#a6e22e>delayedBinding</span>(<span style=color:#a6e22e>@Qualifier</span>(<span style=color:#e6db74>&#34;delayedQueue&#34;</span>) Queue delayedQueue,
</span></span><span style=display:flex><span>                                  <span style=color:#a6e22e>@Qualifier</span>(<span style=color:#e6db74>&#34;delayedExchange&#34;</span>) CustomExchange delayedExchange) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> BindingBuilder.<span style=color:#a6e22e>bind</span>(delayedQueue).<span style=color:#a6e22e>to</span>(delayedExchange).<span style=color:#a6e22e>with</span>(DELAYED_ROUTING_KEY).<span style=color:#a6e22e>noargs</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ä½¿ç”¨æ—¶ä¼ å…¥æ¶ˆæ¯å’Œè¿‡æœŸæ—¶é—´ã€‚</p><h2 id=ä¹é«˜çº§å‘å¸ƒç¡®è®¤>ä¹ã€é«˜çº§å‘å¸ƒç¡®è®¤<a hidden class=anchor aria-hidden=true href=#ä¹é«˜çº§å‘å¸ƒç¡®è®¤>#</a></h2><p>å‘å¸ƒç¡®è®¤æœºåˆ¶åŒ…æ‹¬ä¸¤ä¸ªéƒ¨åˆ†</p><p>1ã€äº¤æ¢æœºç¡®è®¤: ä¿è¯ Producer ç”Ÿäº§çš„æ¶ˆæ¯æˆåŠŸæŠ•é€’åˆ°äº¤æ¢æœºä¸Šè€Œä¸å‘ç”Ÿä¸¢å¤±</p><p>2ã€æ¶ˆæ¯çš„å›é€€: ä¿è¯äº¤æ¢æœºæˆåŠŸå°†æ¶ˆæ¯è·¯ç”±åˆ°é˜Ÿåˆ—ä¸Šè€Œä¸å‘ç”Ÿæ¶ˆæ¯</p><h3 id=91å‘å¸ƒç¡®è®¤æ¶ˆæ¯å›é€€>9.1ã€å‘å¸ƒç¡®è®¤+æ¶ˆæ¯å›é€€<a hidden class=anchor aria-hidden=true href=#91å‘å¸ƒç¡®è®¤æ¶ˆæ¯å›é€€>#</a></h3><p>äº¤æ¢æœºç¡®è®¤ï¼šäº¤æ¢æœºæ¥æ”¶åˆ°æ¶ˆæ¯åï¼Œä¼šç›´æ¥ç»™æ¶ˆæ¯ç”Ÿäº§è€…å‘é€ç¡®è®¤æ¶ˆæ¯ã€‚ä½†å¦‚æœå‘ç°æ¶ˆæ¯ä¸å¯è·¯ç”±å°±ä¼šç›´æ¥ä¸¢å¼ƒè¯¥æ¶ˆæ¯ï¼Œæ­¤æ—¶ç”Ÿäº§è€…æ— æ³•æ„ŸçŸ¥æ¶ˆæ¯å·²è¢«ä¸¢å¼ƒã€‚</p><p>æ¶ˆæ¯å›é€€ï¼šäº¤æ¢æœºå‘é˜Ÿåˆ—ä¼ é€’è¿‡ç¨‹ä¸­ä¸å¯è¾¾çš„æ¶ˆæ¯è¿”å›ç»™ç”Ÿäº§è€…ã€‚</p><p>å³äº¤æ¢æœºç¡®è®¤ä¿è¯å‘å¸ƒè€…åˆ°äº¤æ¢æœºçš„æ¶ˆæ¯ä¸ä¸¢å¤±ï¼Œæ¶ˆæ¯å›é€€ä¿è¯äº¤æ¢æœºåˆ°é˜Ÿåˆ—çš„æ¶ˆæ¯ä¸ä¸¢å¤±ã€‚</p><ol><li><p>å¼€å¯å‘å¸ƒç¡®è®¤æ¨¡å¼+æ¶ˆæ¯å›é€€</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>spring</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>rabbitmq</span>:
</span></span><span style=display:flex><span>  	<span style=color:#f92672>publisher-returns</span>: <span style=color:#66d9ef>true</span>    <span style=color:#75715e># å¼€å¯æ¶ˆæ¯å›é€€</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>publisher-confirm-type</span>: <span style=color:#ae81ff>correlated</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># correlatedï¼šå¼€å¯å‘å¸ƒç¡®è®¤ï¼Œå¼‚æ­¥ç¡®è®¤</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># noneï¼šç¦ç”¨å‘å¸ƒç¡®è®¤</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># simpleï¼šåŒæ­¥ç¡®è®¤ï¼Œå•ä¸ªç¡®è®¤ã€‚å¯ä»¥é€šè¿‡ rabbitTemplate è°ƒç”¨ waitForConfirms() æ–¹æ³•æ§åˆ¶é€»è¾‘ã€‚</span>
</span></span></code></pre></div></li><li><p>è‡ªå®šä¹‰å›è°ƒå‡½æ•°</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyConfirmCallback</span> <span style=color:#66d9ef>implements</span> RabbitTemplate.<span style=color:#a6e22e>ConfirmCallback</span>, RabbitTemplate.<span style=color:#a6e22e>ReturnsCallback</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> RabbitTemplate rabbitTemplate;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è¯¥æ³¨è§£çš„ä½œç”¨ï¼šå¯¹è±¡åˆ›å»ºå®Œæˆå¹¶å®Œæˆæ³¨å…¥ä¹‹åæ‰§è¡Œã€‚å³æ‰§è¡Œé¡ºåºä¸ºï¼š Construct -&gt; Autowired -&gt; PostConstruct</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@PostConstruct</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>init</span>() {
</span></span><span style=display:flex><span>        rabbitTemplate.<span style=color:#a6e22e>setConfirmCallback</span>(<span style=color:#66d9ef>this</span>);
</span></span><span style=display:flex><span>        rabbitTemplate.<span style=color:#a6e22e>setReturnsCallback</span>(<span style=color:#66d9ef>this</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * è‹¥äº¤æ¢æœºæ¥æ”¶æ¶ˆæ¯æˆåŠŸ
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param correlationData æ¶ˆæ¯çš„ ID åŠç›¸å…³ä¿¡æ¯
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param ack b = true
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param s s = null
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * è‹¥äº¤æ¢æœºæ¥æ”¶æ¶ˆæ¯å¤±è´¥ï¼ˆå®•æœºæˆ–ç½‘ç»œè¿æ¥å¤±è´¥ç­‰)
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param correlationData æ¶ˆæ¯çš„ ID åŠç›¸å…³ä¿¡æ¯
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param ack b = false
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param s s = å¤±è´¥çš„åŸå› 
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>confirm</span>(CorrelationData correlationData, <span style=color:#66d9ef>boolean</span> ack, String s) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (ack) System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(correlationData.<span style=color:#a6e22e>getId</span>());
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span> System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(s <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; &#34;</span> <span style=color:#f92672>+</span> correlationData.<span style=color:#a6e22e>getId</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ¶ˆæ¯å›é€€</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>returnedMessage</span>(ReturnedMessage returned) {
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;message %s, backed by exchange %s, reason by %s, routing key is %s%n&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>new</span> String(returned.<span style=color:#a6e22e>getMessage</span>().<span style=color:#a6e22e>getBody</span>()), returned.<span style=color:#a6e22e>getExchange</span>(),
</span></span><span style=display:flex><span>                returned.<span style=color:#a6e22e>getReplyText</span>(), returned.<span style=color:#a6e22e>getRoutingKey</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li><li><p>å‘é€è€…</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;/confirm/msg/{msg}&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>sendMsg</span>(<span style=color:#a6e22e>@PathVariable</span> String msg) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// å›è°ƒå‡½æ•°ä¸­çš„ CorrelationData éœ€è¦åœ¨è¿™é‡Œå®šä¹‰ï¼Œå¯ä»¥æŒ‡å®šæ¶ˆæ¯çš„åºå·å’Œéœ€è¦è¿”å›çš„æ¶ˆæ¯ã€‚æ­¤å¤„æ¨¡æ‹Ÿäº†ä¸€ä¸ªåºå·</span>
</span></span><span style=display:flex><span>        CorrelationData correlationData <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CorrelationData(<span style=color:#e6db74>&#34;1&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#75715e>// äº¤æ¢æœºä¸å­˜åœ¨ï¼Œç”±å‘å¸ƒç¡®è®¤ä¿è¯å›è°ƒ MyConfirmCallback ä¸­çš„ confirm æ–¹æ³•</span>
</span></span><span style=display:flex><span>        rabbitTemplate.<span style=color:#a6e22e>convertAndSend</span>(ConfirmConfig.<span style=color:#a6e22e>CONFIRM_EXCHANGE</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;12&#34;</span>, 
</span></span><span style=display:flex><span>                                      ConfirmConfig.<span style=color:#a6e22e>CONFIRM_ROUTING_KEY</span>, msg, correlationData);
</span></span><span style=display:flex><span>        <span style=color:#75715e>// è·¯ç”±ä¸å¯è¾¾ï¼Œç”±æ¶ˆæ¯å›é€€ä¿è¯å›è°ƒ MyConfirmCallback ä¸­çš„ returnedMessage æ–¹æ³•</span>
</span></span><span style=display:flex><span>        rabbitTemplate.<span style=color:#a6e22e>convertAndSend</span>(ConfirmConfig.<span style=color:#a6e22e>CONFIRM_EXCHANGE</span>, 
</span></span><span style=display:flex><span>                                      ConfirmConfig.<span style=color:#a6e22e>CONFIRM_ROUTING_KEY</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;12&#34;</span>, msg, correlationData);
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div></li></ol><h3 id=92å¤‡ä»½äº¤æ¢æœº>9.2ã€å¤‡ä»½äº¤æ¢æœº<a hidden class=anchor aria-hidden=true href=#92å¤‡ä»½äº¤æ¢æœº>#</a></h3><p>äº¤æ¢æœºåˆ°é˜Ÿåˆ—çš„è·¯ç”±ä¸å¯è¾¾æ—¶å¯ä»¥å°†æ¶ˆæ¯æŠ•æ”¾ç»™å¤‡ä»½äº¤æ¢æœºã€‚å¤‡ä»½äº¤æ¢æœºå°†æ¶ˆæ¯å¹¿æ’­ç»™ä¸¤ä¸ªé˜Ÿåˆ—ï¼Œåˆ†åˆ«ç”¨ä½œæ¶ˆæ¯çš„å¤‡ä»½ä¸æ£€æµ‹æŠ¥è­¦ã€‚</p><p>æ³¨æ„ï¼šå¦‚æœæ¶ˆæ¯æ— æ³•åˆ°è¾¾äº¤æ¢æœºï¼Œåˆ™ç›´æ¥ä¼šç”±å‘å¸ƒç¡®è®¤æœºåˆ¶å›è°ƒäº¤æ¢æœºä¸å¯è¾¾å‡½æ•°ï¼Œæ¶ˆæ¯å°†ä¸ä¼šè¿›å…¥å¤‡ä»½äº¤æ¢æœºã€‚</p><p>å¦‚æœåŒæ—¶å¼€å¯äº†å¤‡ä»½äº¤æ¢å’Œæ¶ˆæ¯å›é€€ï¼Œå¤‡ä»½äº¤æ¢æœºçš„ä¼˜å…ˆçº§æ›´é«˜ã€‚</p><p><img alt=å¤‡ä»½äº¤æ¢æœº loading=lazy src=/posts/%E5%88%86%E5%B8%83%E5%BC%8F/rabbitmq/rabbitmq/%E5%A4%87%E4%BB%BD%E4%BA%A4%E6%8D%A2%E6%9C%BA.png></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ConfirmConfig</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String CONFIRM_QUEUE <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;confirm_queue&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String CONFIRM_EXCHANGE <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;confirm_exchange&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String CONFIRM_ROUTING_KEY <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;confirm_routing_key&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String BACKUP_QUEUE <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;backup_queue&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String WARNING_QUEUE <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;warning_queue&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String BACKUP_EXCHANGE <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;backup_exchange&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å£°æ˜äº¤æ¢æœº</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> DirectExchange <span style=color:#a6e22e>confirmExchange</span>() {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// æŒ‡å®šå¤‡ä»½äº¤æ¢æœº</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> ExchangeBuilder.<span style=color:#a6e22e>directExchange</span>(CONFIRM_EXCHANGE)
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>alternate</span>(BACKUP_EXCHANGE).<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> FanoutExchange <span style=color:#a6e22e>backupExchange</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> FanoutExchange(BACKUP_EXCHANGE);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å£°æ˜é˜Ÿåˆ—</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Queue <span style=color:#a6e22e>confirmQueue</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> QueueBuilder.<span style=color:#a6e22e>durable</span>(CONFIRM_QUEUE).<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Queue <span style=color:#a6e22e>backupQueue</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> QueueBuilder.<span style=color:#a6e22e>durable</span>(BACKUP_QUEUE).<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Queue <span style=color:#a6e22e>warningQueue</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> QueueBuilder.<span style=color:#a6e22e>durable</span>(WARNING_QUEUE).<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ç»‘å®š</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Binding <span style=color:#a6e22e>confirmBinding</span>(<span style=color:#a6e22e>@Qualifier</span>(<span style=color:#e6db74>&#34;confirmQueue&#34;</span>) Queue confirmQueue,
</span></span><span style=display:flex><span>                                  <span style=color:#a6e22e>@Qualifier</span>(<span style=color:#e6db74>&#34;confirmExchange&#34;</span>) DirectExchange confirmExchange) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> BindingBuilder.<span style=color:#a6e22e>bind</span>(confirmQueue).<span style=color:#a6e22e>to</span>(confirmExchange).<span style=color:#a6e22e>with</span>(CONFIRM_ROUTING_KEY);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Binding <span style=color:#a6e22e>backToBackBinding</span>(<span style=color:#a6e22e>@Qualifier</span>(<span style=color:#e6db74>&#34;backupQueue&#34;</span>) Queue backupQueue,
</span></span><span style=display:flex><span>                                     <span style=color:#a6e22e>@Qualifier</span>(<span style=color:#e6db74>&#34;backupExchange&#34;</span>) FanoutExchange backupExchange) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> BindingBuilder.<span style=color:#a6e22e>bind</span>(backupQueue).<span style=color:#a6e22e>to</span>(backupExchange);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Binding <span style=color:#a6e22e>warningToBackBinding</span>(<span style=color:#a6e22e>@Qualifier</span>(<span style=color:#e6db74>&#34;warningQueue&#34;</span>) Queue warningQueue,
</span></span><span style=display:flex><span>                                        <span style=color:#a6e22e>@Qualifier</span>(<span style=color:#e6db74>&#34;backupExchange&#34;</span>) FanoutExchange backupExchange) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> BindingBuilder.<span style=color:#a6e22e>bind</span>(warningQueue).<span style=color:#a6e22e>to</span>(backupExchange);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ç›‘å¬æŠ¥è­¦é˜Ÿåˆ—</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>WarningConsumer</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RabbitListener</span>(queues <span style=color:#f92672>=</span> ConfirmConfig.<span style=color:#a6e22e>WARNING_QUEUE</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>receiveWarningMsg</span>(Message message) {
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;warning! message {%s} does not execute success. &#34;</span>, <span style=color:#66d9ef>new</span> String(message.<span style=color:#a6e22e>getBody</span>()));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=åç›¸å…³çŸ¥è¯†ç‚¹>åã€ç›¸å…³çŸ¥è¯†ç‚¹<a hidden class=anchor aria-hidden=true href=#åç›¸å…³çŸ¥è¯†ç‚¹>#</a></h2><h3 id=101å¹‚ç­‰æ€§>10.1ã€å¹‚ç­‰æ€§<a hidden class=anchor aria-hidden=true href=#101å¹‚ç­‰æ€§>#</a></h3><p>åœ¨ç¼–ç¨‹ä¸­ä¸€ä¸ªå¹‚ç­‰æ“ä½œçš„ç‰¹ç‚¹æ˜¯å…¶ä»»æ„å¤šæ¬¡æ‰§è¡Œæ‰€äº§ç”Ÿçš„å½±å“å‡ä¸ä¸€æ¬¡æ‰§è¡Œçš„å½±å“ç›¸åŒã€‚HTTPæ–¹æ³•çš„å¹‚ç­‰æ€§æ˜¯æŒ‡ä¸€æ¬¡å’Œå¤šæ¬¡è¯·æ±‚æŸä¸€ä¸ªèµ„æºåº”è¯¥å…·æœ‰åŒæ ·çš„å‰¯ä½œç”¨ã€‚ç®€ä¹‹ï¼š<strong>ä¸€ä¸ªè¯·æ±‚ï¼Œä¸ç®¡é‡å¤æ¥å¤šå°‘æ¬¡ï¼Œç»“æœæ˜¯ä¸ä¼šæ”¹å˜çš„ã€‚</strong></p><p>æ¶ˆè´¹è€…åœ¨æ¶ˆè´¹ MQ ä¸­çš„æ¶ˆæ¯æ—¶ï¼ŒMQ å·²æŠŠæ¶ˆæ¯å‘é€ç»™æ¶ˆè´¹è€…ï¼Œæ¶ˆè´¹è€…åœ¨ç»™ MQ è¿”å› ack æ—¶ç½‘ç»œä¸­æ–­ï¼Œæ•… MQ æœªæ”¶åˆ°ç¡®è®¤ä¿¡æ¯ï¼Œè¯¥æ¡æ¶ˆæ¯ä¼šé‡æ–°å‘ç»™å…¶ä»–çš„æ¶ˆè´¹è€…ï¼Œæˆ–è€…åœ¨ç½‘ç»œé‡è¿åå†æ¬¡å‘é€ç»™è¯¥æ¶ˆè´¹è€…ï¼Œä½†å®é™…ä¸Šè¯¥æ¶ˆè´¹è€…å·²æˆåŠŸæ¶ˆè´¹äº†è¯¥æ¡æ¶ˆæ¯ï¼Œé€ æˆæ¶ˆè´¹è€…æ¶ˆè´¹äº†é‡å¤çš„æ¶ˆæ¯ï¼›æ³¨æ„ï¼ŒRabbitMQ è¿™ç§æ¶ˆæ¯é‡è¯•(è¡¥å¿)æœºåˆ¶æ˜¯é»˜è®¤çš„ã€‚</p><p>@RabbitListener åº•å±‚ä½¿ç”¨ AOP è¿›è¡Œå¼‚å¸¸é€šçŸ¥æ‹¦æˆªï¼Œå¦‚æœç¨‹åºæ²¡æœ‰æŠ›å‡ºå¼‚å¸¸ä¿¡æ¯ï¼Œé‚£ä¹ˆå°±ä¼šè‡ªåŠ¨æäº¤äº‹åŠ¡ï¼›å¦‚æœ AOP å¼‚å¸¸é€šçŸ¥æ‹¦æˆªæœ‰æ•è·åˆ°å¼‚å¸¸ä¿¡æ¯çš„è¯ï¼Œå°±ä¼šè‡ªåŠ¨å®ç°é‡è¯•(è¡¥å¿)æœºåˆ¶ï¼ŒåŒæ—¶ï¼Œè¿™ä¸ªè¡¥å¿æœºåˆ¶çš„æ¶ˆæ¯ä¼šç¼“å­˜åˆ° RabbitMQ æœåŠ¡å™¨ç«¯è¿›è¡Œå­˜æ”¾ï¼Œä¸€ç›´é‡è¯•åˆ°ä¸æŠ›å‡ºå¼‚å¸¸ä¸ºæ­¢ã€‚</p><p>è§£å†³æ–¹å¼ï¼š</p><p>ä¸ºæ¯ä¸ªæ¶ˆæ¯åˆ†é…å…¨å±€å”¯ä¸€IDï¼Œæ¶ˆè´¹å‰é€šè¿‡ redis çš„ setnx å‘½ä»¤å†™å…¥æ¶ˆæ¯çš„IDï¼Œè‹¥å†™å…¥æˆåŠŸå°±æ¶ˆè´¹ï¼Œå¦åˆ™ä¸¢å¼ƒï¼Œæ­¤æ—¶ä¸è®ºæ˜¯å¦æ¶ˆè´¹éƒ½åº”å‘é€ackã€‚</p><h3 id=102ä¼˜å…ˆçº§é˜Ÿåˆ—>10.2ã€ä¼˜å…ˆçº§é˜Ÿåˆ—<a hidden class=anchor aria-hidden=true href=#102ä¼˜å…ˆçº§é˜Ÿåˆ—>#</a></h3><p>é˜Ÿåˆ—çš„ç‰¹ç‚¹æ˜¯å…ˆè¿›å…ˆå‡ºï¼Œä½†æ˜¯æœ‰äº›åœºæ™¯ä¸‹éœ€è¦å¯¹é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯èµ‹äºˆä¼˜å…ˆçº§ï¼Œä½¿å¾—ä¼˜å…ˆçº§é«˜çš„æ¶ˆæ¯è¶Šå¿«è¢«æ¶ˆè´¹ã€‚ä¼˜å…ˆçº§é˜Ÿåˆ—åº•å±‚æ˜¯å¤§é¡¶å †ã€‚</p><p>ç”±äºç§ç§åŸå› ï¼ŒRabbitMQåˆ°ç›®å‰ä¸ºæ­¢ï¼Œå®˜æ–¹<strong>è¿˜æ²¡æœ‰å®ç°ä¼˜å…ˆçº§é˜Ÿåˆ—</strong>ï¼Œåªå®ç°äº†Consumerçš„ä¼˜å…ˆçº§å¤„ç†ã€‚å³æ¯æ¬¡å¯¹é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯æŒ‰ä¼˜å…ˆçº§æ’åºåå–å‡ºä¼˜å…ˆçº§æœ€é«˜çš„æ¶ˆæ¯ã€‚</p><p>å½“ç„¶ï¼Œåœ¨æ¶ˆè´¹ç«¯é€Ÿåº¦å¤§äºç”Ÿäº§ç«¯é€Ÿåº¦ï¼Œä¸”brokerä¸­æ²¡æœ‰æ¶ˆæ¯å †ç§¯çš„è¯ï¼Œå¯¹å‘é€çš„æ¶ˆæ¯è®¾ç½®ä¼˜å…ˆçº§ä¹Ÿæ²¡ä»€ä¹ˆå®é™…æ„ä¹‰ï¼Œæ²¡æœºä¼šæ’åºã€‚</p><ol><li><p>é˜Ÿåˆ—å£°æ˜æ—¶æŒ‡å®šæœ€å¤§ä¼˜å…ˆçº§</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Queue <span style=color:#a6e22e>confirmQueue</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> QueueBuilder.<span style=color:#a6e22e>durable</span>(CONFIRM_QUEUE).<span style=color:#a6e22e>maxPriority</span>(10).<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li><li><p>å‘é€æ¶ˆæ¯æ—¶æŒ‡å®šæ¶ˆæ¯çš„ä¼˜å…ˆçº§</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>rabbitTemplate.<span style=color:#a6e22e>convertAndSend</span>(<span style=color:#e6db74>&#34;X&#34;</span>, <span style=color:#e6db74>&#34;XC&#34;</span>, message, msg  <span style=color:#f92672>-&gt;</span> {
</span></span><span style=display:flex><span>    msg.<span style=color:#a6e22e>getMessageProperties</span>().<span style=color:#a6e22e>setPriority</span>(5);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> msg;
</span></span><span style=display:flex><span>});
</span></span></code></pre></div></li></ol><h3 id=103æƒ°æ€§é˜Ÿåˆ—>10.3ã€æƒ°æ€§é˜Ÿåˆ—<a hidden class=anchor aria-hidden=true href=#103æƒ°æ€§é˜Ÿåˆ—>#</a></h3><p>æƒ°æ€§é˜Ÿåˆ—å³æ”¶åˆ°æ¶ˆæ¯åç›´æ¥å­˜æ”¾åœ¨ç£ç›˜ä¸­ï¼Œå†…å­˜ä¸­ä¸å­˜ï¼Œæ¶ˆè´¹è€…æ¯æ¬¡å–æ¶ˆæ¯æ—¶ï¼Œéƒ½éœ€è¦å°†æ¶ˆæ¯åŠ è½½åˆ°å†…å­˜å†å‘é€ç»™æ¶ˆè´¹è€…ï¼Œæ‰€ä»¥å¾ˆæ…¢ã€‚</p><p>æŒä¹…åŒ–æ˜¯å°†æ¶ˆæ¯å³å­˜åœ¨å†…å­˜åˆå­˜åœ¨ç£ç›˜ï¼Œæ¶ˆè´¹è€…å»å†…å­˜å–ã€‚</p><p>æ¶ˆè´¹è€…å¤„ç†æ¶ˆæ¯å¾ˆæ…¢æˆ–æ— æ³•å¤„ç†æ¶ˆæ¯ä½¿å¾—é˜Ÿåˆ—ç§¯å‹äº†å¤§é‡æ¶ˆæ¯æ—¶å¯ä»¥é‡‡ç”¨æƒ°æ€§é˜Ÿåˆ—ï¼Œé‡Šæ”¾å†…å­˜ã€‚</p><p><a href=https://blog.csdn.net/m0_48795607/article/details/116064045>é¢è¯•é¢˜</a></p></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://ethereal-lu.github.io/posts/%E5%B0%8F%E7%A2%8E%E7%89%87%E7%9F%A5%E8%AF%86/%E7%BC%96%E7%A0%81/><span class=title>Â« Prev</span><br><span>ç¼–ç </span>
</a><a class=next href=https://ethereal-lu.github.io/posts/linux/ubuntu%E7%9A%84ufw%E4%B8%8Eiptables/><span class=title>Next Â»</span><br><span>ubuntuçš„ufwä¸iptables</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://ethereal-lu.github.io/>lu</a></span> Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>